<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
{# ë°œì£¼ëŒ€ë¹„ ì…ê³ ë“±ë¡ #}

<body style="overflow: hidden;">

{% load static %}

<div class="card m-2">
    <div class="card-body p-2">
       <i class="bi bi-exclamation-triangle"></i> ì¬ê³ ë¶€ì¡± ì•Œë¦¼
    </div>
</div>
<div class="card m-2">
    <div class="card-body p-2">
        <!-- ë³¸ë¬¸ -->
        <div
                class="content-search row no-gutters align-items-center content-input-group"
        >
            <div
                    class="col-11"
                    id="material_status_main-form"
            >
                <div class="row no-gutters">

                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ë¸Œëœë“œ</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control brand-dropdown-search"
                                    id="brand_search"
                                    name="brand_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ì œí’ˆêµ°</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control item_group-dropdown-search"
                                    id="item_group_search"
                                    name="item_group_search"
                            ></select>
                        </div>
                    </div>
                      <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>í’ˆë²ˆ</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control item-code-dropdown-search"
                                    id="item_code_search"
                                    name="item_code_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ë‚˜ì´ìŠ¤ë²ˆí˜¸</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control nice_number-dropdown-search"
                                    id="nice_number_search"
                                    name="nice_number_search"
                            ></select>
                        </div>
                    </div>
                </div>

                <div class="row no-gutters">
                      <div class="content-input-group col-4 mt-2">
                        <div class="content-input-group-input input-group">
                            <input class="form-control" id="multiSearch" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                            "/>
                          <div class="input-group-append">
                     <button class="btn btn-outline-secondary" type="button" onclick="ordering_search();"> ğŸ”</button>

                        </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-1 px-0 ml-auto">
                <button
                        class="btn button-search rounded-0 w-100 h-100"
                        onclick="nation1.page =1; ordering_search()"
                >
                    ê²€ìƒ‰
                </button>
            </div>
        </div>
    </div>
</div>
<div class="card m-2">
    <div class="card-body p-2">
        <div class="content-table" style="overflow-x:auto; overflow-y:hidden; height:700px">
        <table class="table table-sm text-center" id="amount_inform_table">
            <thead>
            <th>ì¬ê³ ë¶„ë¥˜</th>
            <th>ë¸Œëœë“œ</th>
            <th>ì œí’ˆêµ°</th>
            <th class="sorting_item_name" onclick="ordering_search('name')">í’ˆëª…</th>
            <th class="sorting_item_code" onclick="ordering_search('code')">í’ˆë²ˆ</th>
            <th class="sorting_item_nice_number" onclick="ordering_search('nice_number')">ë‚˜ì´ìŠ¤ë²ˆí˜¸</th>
            <th>í’ˆëª…ìƒì„¸</th>
            <th>í˜•íƒœ</th>
            <th>í˜„ì¬ê³ </th>
            <th>ì•ˆì „ì¬ê³ ìˆ˜ëŸ‰</th>
            </thead>
            <tbody id="amount_inform_tbody">
            </tbody>
        </table>
                 <div class="row no-gutters d-flex justify-content-center" id="item_nation"
                 style="margin-top: -20px;">
            </div>
        </div>
    </div>
</div>
</body>
<script src="{% static 'js/html2canvas.js' %}" type="text/javascript"></script>
<script src="{% static 'js/jspdf.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_customer.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_request.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>
<script>

    let nation_data1 = {
        cname : 'nation1',  // ì¸ìŠ¤í„´ìŠ¤ ëª…ê³¼ ì¼ì¹˜í•´ì•¼í•¨
        table_id: 'item_nation',
        range: 5,
        page_size: 15,
    };

    let nation1 = new Pnations(nation_data1, ordering_search);

    $(function(){
        material_status_init()
        ordering_search()
    })
    let order = ""
    function material_status_init() {
        function make_dropdown(data, selectors) {
            let list = "<option value=''>ì„ íƒ ë° ê²€ìƒ‰</option>";
            let distinct = [];
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                if (selectors.includes('.item-code-dropdown')) {
                    list += "<option value='" + item.id + "'>" + item.code + "</option>";
                } else if (selectors.includes('.nice_number-dropdown')) {
                    list += "<option value='" + item.id + "'>" + item.nice_number + "</option>";
                } else if (selectors.includes('.item-name-dropdown')) {
                    if (distinct.indexOf(item.name) === -1) {
                        list += "<option value='" + item.id + "'>" + item.name + "</option>";
                        distinct.push(item.name);
                    }
                }else {
                    list += "<option value='" + item.id + "'>" + item.name + "</option>";
                }
            }
            $(selectors).html(list);
            $(selectors).select2({width: '100%'});
        }

        api_gp('/items_part/', 'GET', {}, (data) => {
            make_dropdown(data, '.item-code-dropdown-search');
            make_dropdown(data, '.item-name-dropdown-search');
            make_dropdown(data, '.nice_number-dropdown-search');
        });


        // ë¸Œëœë“œ
        api_gp('/codes_select/?group=127&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.brand-dropdown-search');
        });

        // ì œí’ˆêµ°
        api_gp('/codes_select/?group=128&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.item_group-dropdown-search');
        });

    }
    function ordering_search(ordering){
        let query ="?"

        let brand = ($('#brand_search option:selected').val() ? $('#brand_search option:selected').val() : "");
        let item_group = ($('#item_group_search option:selected').val() ? $('#item_group_search option:selected').val() : "");
        let nice_number = ($('#nice_number_search option:selected').val() ? $('#nice_number_search option:selected').val() : "");
        let item_code = ($('#item_code_search option:selected').val() ? $('#item_code_search option:selected').val() : "");


        let multiSearch = $("#multiSearch").val()


        if (brand !== '') query += "brand=" + brand + "&";
        if (item_group !== '') query += "item_group=" + item_group + "&";
        if (nice_number !== '') query += "nice_number=" + nice_number + "&";
        if (item_code !== '') query += "item_code=" + item_code + "&";
        if (multiSearch !=='') query += 'search=' + multiSearch +"&"

         if (ordering === '' || ordering === null || ordering=== undefined ){
        } else {
              order === ordering ? order = "-" +ordering : order = ordering
        }
        $(".sorting_item_name").html("í’ˆëª…â–½")
        $(".sorting_item_code").html("í’ˆë²ˆâ–½")
        $(".sorting_item_nice_number").html("ë‚˜ì´ìŠ¤ë²ˆí˜¸â–½")
        switch(order){
            case "name":
                $(".sorting_item_name").html("í’ˆëª…â–¼")
                break;
            case "-name":
                $(".sorting_item_name").html("í’ˆëª…â–²")
                break;
            case "code":
                $(".sorting_item_code").html("í’ˆë²ˆâ–¼")
                break;
            case "-code":
                $(".sorting_item_code").html("í’ˆë²ˆâ–²")
                break;
             case "nice_number":
                $(".sorting_item_nice_number").html("ë‚˜ì´ìŠ¤ë²ˆí˜¸â–¼")
                break;
            case "-nice_number":
                $(".sorting_item_nice_number").html("ë‚˜ì´ìŠ¤ë²ˆí˜¸â–²")
                break;
            default:
                break;
        }
           query += "ordering=" + order + "&";
         query += `page=${nation1.page}` + "&"
        query += 'safe_amount=1'
        api_gp(`/items/calculate/${query}`, "GET", {}, (done) => {
            draw_item_amount(done.results);
            nation1.nation_display(done)
        });
    }
    function draw_item_amount(data){
        let rows = ""
        let result = []
        for(let i=0; i<data.length; i++){
             data[i].total <= 0 ?
            result.push(data[i]) : result.unshift(data[i])
        }
        for(let i=0; i<result.length; i++){
            let item = result[i]
            let row = `<tr>
                    <td>${item.division_name}</td>
                    <td title='${item.brand_name}' data-toggle="tooltip">${nullapply(item.brand_name ? item.brand_name.length >10 ? item.brand_name.slice(0,10) + "...": item.brand_name : "")}</td>
                    <td title='${item.item_group_name}' data-toggle="tooltip">${nullapply(item.item_group_name ? item.item_group_name.length >10 ? item.item_group_name.slice(0,10) + "...": item.item_group_name : "")}</td>
                    <td title='${item.name}' data-toggle="tooltip">${nullapply(item.name ? item.name.length >10 ? item.name.slice(0,10) + "...": item.name : "")}</td>
                    <td title='${item.code}' data-toggle="tooltip">${nullapply(item.code ? item.code.length >10 ? item.code.slice(0,10) + "...": item.code : "")}</td>
                    <td title='${item.nice_number}' data-toggle="tooltip">${nullapply(item.nice_number ? item?.nice_number.length >10 ? item.nice_number.slice(0,10) + "...": item.nice_number : "")}</td>
                    <td title='${item.detail}' data-toggle="tooltip">${nullapply(item.detail ? item.detail.length >10 ? item.detail.slice(0,10) + "...": item.detail : "")}</td>
                    <td title='${item.shape}' data-toggle="tooltip">${nullapply(item.shape ? item.shape.length >10 ? item.shape.slice(0,10) + "...": item.shape : "")}</td>
                    <td>${(item.stock < item.safe_amount ? `<span style="color: red">${item.stock}</span>` : item.stock )}</td>
                    <td>${item.safe_amount}</td>
                    </tr>`
            rows += row

        }
        $("#amount_inform_tbody").html(rows)
    }

</script>
</html>