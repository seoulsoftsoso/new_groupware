<!DOCTYPE HTML>
<html>
<header>
    {% include "header.html" %}
</header>
<body>

{% load static %}

<div class="row no-gutters" id="root">
    <div class="col-12">
        <h5 class="m-2"><strong>업체 등록</strong></h5>
        <div class="card m-2">
            <div class="card-body p-2">
                <!-- 본문 -->
                <form class="content-search row no-gutters content-input-group" id="enterprise_register_content">
                    {% csrf_token %}
                    <div class="content-title col-1 align-self-stretch">
                        등록
                    </div>
                    <div class="content-input-group col-2 px-0">
                        <div class="content-input-group-header">
                            <label><strong>*</strong>기업코드</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="new_enterprise_register_search_code" name="code">
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label><strong>*</strong>기업명</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="search_name_regist_ent_name" name="name">
                        </div>
                    </div>
                    <div class="content-input-group col-2 px-0">
                        <div class="content-input-group-header">
                            <label>관리명</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="search_name_manage" name="manage">
                        </div>
                    </div>
                    <div class="col-1 px-0 ml-2 mr-2">
                        <a class="btn button-custom2 w-100" role="button" onclick="add()">등록</a>
                    </div>

                    <div class="col-1 px-0 mr-2">
                        <a class="btn button-custom2 w-100" role="button" onclick="enterprise_register_edit()">수정</a>
                        {#                          <button#}
                        {#                            type="button"#}
                        {#                            class="btn button-custom2 w-100"#}
                        {#                            onclick="enterprise_register_edit()"#}
                        {#                          >#}
                        {#                            수정#}
                        {#                          </button>#}
                    </div>
                    <div class="col-1 px-0 mr-2">
                        {#                          <button#}
                        {#                            type="button"#}
                        {#                            class="btn button-custom2 w-100"#}
                        {#                            onclick="enterprise_register_delete()"#}
                        {#                          >#}
                        {#                            삭제#}
                        {#                          </button>#}

                        <a class="btn button-custom2 w-100" role="button" onclick="enterprise_register_delete()">삭제</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 테이블 -->
        <div class="card m-2">
            <div class="row no-gutters card-body p-2">
                <div class="content-table col-12" style="height: 600px;">
                    <table id="new_enterprise_register_data-table" class="table table-sm text-center">
                        <colgroup>
                            <col style="width: 10%">
                        </colgroup>
                        <thead>
                        <tr>
                            <th>순번</th>
                            <th>기업코드</th>
                            <th>기업명</th>
                            <th>관리명</th>
                        </tr>
                        </thead>
                        <tbody id="new_enterprise_register_main-tbody"></tbody>
                    </table>

                    <div class="row no-gutters d-flex justify-content-center" id="item_nation">
                    </div>

                </div>
            </div>
        </div>


    </div>
</div>

<script src="{% static 'js/api_enterprise_register.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>

<script>
    // draw main table
    let enterprise_register_columns = [
        "code",
        "name",
        "manage",
    ];

    //let enterprise_register_idx = ""; -> 이거 때문에 뒤에서 #id 할 때 신텍스 에러남.
    let enterprise_register_idx = null; //pk
    let enterprise_register_name = null;

    let page1_size = 15;

    let nation_data1 = {
        cname: 'nation1',  // 인스턴스 명과 일치해야함
        table_id: 'item_nation',
        range: 5,
        page_size: page1_size,
    };

    let nation1 = new Pnations(nation_data1, refresh);

    // starting point
    $(function () {
        refresh();
    });

    function refresh_data() {
        $("#new_enterprise_register_search_code").val("");
        $("#search_name_regist_ent_name").val("");
        $("#search_name_manage").val("");
    }

    function refresh() {
        // initial data loading
        request_table();
    }

    function request_table() {
        let query = "?page_size=" + page1_size + "&page=" + nation1.page;

        api_gp('/basic_information/enterprises_read/' + query, 'GET', {}, (done) => {
            new_enterprise_register_draw_table(done);
        });
    }

    function new_enterprise_register_draw_table(done) {

        let data = done.results;
        let num = (((nation1.page * 1) - 1) * nation_data1["page_size"]) + 1;

        let rows = "";
        for (let i = 0; i < data.length; i++) {
            let item = data[i];

            // append it
            let row = "<tr id='" + item.id + "' style='cursor:pointer;'>";
            row += "<td>" + (num + i) + "</td>";

            row += "<td data-item='code'>" + item.code + "</td>";
            row += "<td data-item='name'>" + item.name + "</td>";
            row += "<td data-item='manage'>" + (item.manage ? item.manage : '') + "</td>";
            row += "</tr>";

            rows += row;
        }

        nation1.nation_display(done);

        $('#new_enterprise_register_main-tbody').html(rows);

        $("#new_enterprise_register_main-tbody > tr").on('click', function () {

            $(this).parent().find("tr").removeClass("clicked");
            $(this).addClass("clicked");

            enterprise_register_idx = $(this).attr("id");
            enterprise_register_name = $(this).find("[data-item='name']").text();

            enterprise_register_columns.forEach((item) => {
                $("#enterprise_register_content [name='" + item + "']").val(
                    $(this)
                        .find("[data-item='" + item + "']")
                        .text()
                )
            });
        });

        // jquery.min.js:2 Uncaught Error: Syntax error, unrecognized expression: #
        // 초기 idx 값을 "" 하느냐 null 로 하느냐에 따른 문제
        if (enterprise_register_idx != null) {
            $("#" + enterprise_register_idx).addClass('clicked');
        }
    }

    // add action
    function add() {
        if ($('#new_enterprise_register_search_code').val() == "") {
            alert("기업코드를 입력해 주세요.");
            return;
        }

        if ($('#search_name_regist_ent_name').val() == "") {
            alert("기업명을 입력해 주세요.");
            return;
        }

        let data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',

            code: $('#new_enterprise_register_search_code').val(),
            name: $('#search_name_regist_ent_name').val(),
            manage: $('#search_name_manage').val(),
            permissions: 0// 관리자가 수정하므로, 초기 permission은 어떤 값이든 상관 없음.
        }

        api_gp('/basic_information/enterprises_create/', 'POST', data, (done) => {
            //nation1.page = 1;
            enterprise_register_idx = done.id;
            enterprise_register_name = done.name;

            refresh_data();

            alert('성공적으로 등록하였습니다.');
            request_table();
        });

        return false;
    }

    function enterprise_register_edit() {
        if (enterprise_register_idx == null) {
            alert("데이터를 먼저 선택하십시오.");
            return;

        } else {
            let code = $('#new_enterprise_register_search_code').val();
            let name = $('#search_name_regist_ent_name').val();
            let manage = $('#search_name_manage').val();

            if (code == "") {
                alert("기업코드를 입력하세요.");
                return;

            } else if (name == "") {
                alert("기업몀을 입력하세요.");
                return;
            }

            let data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: enterprise_register_idx,

                code: code,
                name: name,
                manage: manage,
            };

            api_gp('/basic_information/enterprises_update/', 'POST', data, (done) => {
                alert('수정 완료.');
                request_table();
            });
        }
    }

    function enterprise_register_delete() {
        if (enterprise_register_idx == null) {
            alert("데이터를 먼저 선택하십시오.");
        } else {


            let del = confirm(
                "기업명 : " + enterprise_register_name + " 을 삭제하시겠습니까?"
            );

            let allData = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: enterprise_register_idx,
            }

            if (del) {
                api_gp('/basic_information/enterprises_delete/', 'post', allData, (done_callback) => {
                    alert("삭제하였습니다.");
                    //nation1.page = 1;

                    request_table();
                });
            }
        }
    }

    // Table export
    $(parent.document).find("#excel-export").click(() => init_excel_export($('#new_enterprise_register_data-table'), '업체 목록'));


</script>
</body>
</html>
