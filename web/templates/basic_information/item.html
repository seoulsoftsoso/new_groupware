<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
<body style="overflow: hidden;">
{% load static %}
{{ it.media }}
{#<title>ÌíàÎ™© Í∏∞Ï§ÄÏ†ïÎ≥¥Í¥ÄÎ¶¨</title>#}

<!-- Í≤ÄÏÉâ -->
<div class="card m-2">
    <div class="card-body p-2">
        <!-- Î≥∏Î¨∏ -->
        <div
                class="content-search row no-gutters align-items-center content-input-group"
        >
            <div class="content-title col-1 align-self-stretch">Í≤ÄÏÉâ</div>
            <div class="col-11">
                <div class="row no-gutters">
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ÌíàÎ≤à</label>
                        </div>
                        <div class="content-input-group-input">
                            {{ it.it_code_sch }}
                            {#                            <input class="form-control" id="code_sch"/>#}
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ÌíàÎ™Ö</label>
                        </div>
                        <div class="content-input-group-input">
                            {{ it.it_name_sch }}

                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ÏûêÏû¨Î∂ÑÎ•ò</label>
                        </div>
                        <div class="content-input-group-input">
                            {{ it.it_division_sch }}

                        </div>
                    </div>
                    <div class="col-1 px-0">
                        <button class="btn button-search rounded-0 w-100 h-100" type="button" onclick="search_click();">
                            Í≤ÄÏÉâ
                        </button>
                    </div>
                </div>
            </div>
                        <div class="content-input-group col-4 mt-2">
                            <div class="content-input-group-input input-group">
                                <input class="form-control" id="multiSearch" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî
                                "/>
                              <div class="input-group-append">
                         <button class="btn btn-outline-secondary" type="button" onclick="nation1.page =1; search();"> üîç</button>

                            </div>
                            </div>
                        </div>

        </div>
    </div>
</div>

<!-- ÎÇ¥Ïö© -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- Î≥∏Î¨∏ -->
        <form id="item_master" class="content-content w-100">
            {% csrf_token %}
            <div class="row no-gutters w-100 mb-2">
                <div class="col-1 content-title">ÎÇ¥Ïö©</div>
                <div class="col-11" id="detail_itemmaster">
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌíàÎ≤à<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="code"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌíàÎ™Ö<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="name"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌíàÎ™ÖÏÉÅÏÑ∏</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="detail"/>

                            </div>
                        </div>
                        <div class="content-input-group col-3 px-0">
                            <div class="content-input-group-header">
                                <label>ÏûêÏû¨Î∂ÑÎ•ò</label>
                            </div>
                            <div class="content-input-group-input">
                            {{ it.it_division_add }}

                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Î™®Îç∏</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="detail"/>

                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Îã®ÏúÑ</label>
                            </div>
                            <div class="content-input-group-input">
                               {{ it.it_unit_add }}
                            </div>
                        </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>Í±∞ÎûòÏ≤ò</label>
                        </div>
                        <div class="content-input-group-input">
                            {{ it.it_division_add }}

                        </div>
                    </div>
                    <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÏïàÏ†ÑÏû¨Í≥†ÏàòÎüâ</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="safe_amount" />
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÏàòÏàòÎ£åÏú®</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="fee_rate"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÎπÑÍ≥†</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="etc"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>MOQ</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="moq"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label title="ÌëúÏ§ÄÎã®Í∞Ä : ÏûÖÍ≥†Îêú ÎßàÏßÄÎßâ Îã®Í∞Ä &#10;Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ïÌïòÏãúÍ∏∞ Î∞îÎûçÎãàÎã§">ÌëúÏ§ÄÎã®Í∞Ä</label>
                            </div>
                            <div class="content-input-group-input">
                                <input title="ÌëúÏ§ÄÎã®Í∞Ä : ÏûÖÍ≥†Îêú ÎßàÏßÄÎßâ Îã®Í∞Ä &#10;Í¥ÄÎ¶¨ÏûêÎßå ÏàòÏ†ïÌïòÏãúÍ∏∞ Î∞îÎûçÎãàÎã§" class="form-control"
                                       id="standard_price" onkeyup="_chkNumber(this, 2)"/>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">

                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>TYPE</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="bom_division" disabled/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>QR</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="btn button-custom2 w-100" id="qr"
                                       type="button" onclick="show_qr_print($(this).val())"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row no-gutters w-100 justify-content-end">
                {% comment %}<div class="col-5 d-flex ml-auto">
                    <form id="excel_upload_form" class="ml-auto ml-2 col-8" method="POST" enctype="multipart/form-data" action="{% url 'basic_information_items_excelupload' %}">{% csrf_token %}
                        <div class="form-box">
                            <div class="input-group mb-3">
                                <div class="custom-file">
                                    <input name="excel" type="file" class="custom-file-input" id="excel" style="width: 300px;" required>
                                    <label id="excel_label" class="custom-file-label" for="excel" aria-describedby="upload_excel">ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</label>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="col-4 ml-2">
                        <button
                                id="upload_excel"
                                class="btn button-custom2 w-100"
                                type="button"
                                onclick="excel_upload();"
                        >
                            ÏóëÏÖÄ ÏóÖÎ°úÎìú
                        </button>
                    </div>
                </div>{% endcomment %}
                <div class="col-1 px-0 mr-2">
                    <button
                            type="button"
                            class="btn button-custom2 w-100"
                            onclick="refresh_data()"
                    >
                        Ï¥àÍ∏∞Ìôî
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            type="button"
                            class="btn button-custom2 w-100"
                            onclick="qr_update()"
                    >
                        QRÏÉùÏÑ±
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            type="button"
                            class="btn button-custom2 w-100"
                            onclick="item_add()"
                    >
                        Ï∂îÍ∞Ä
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="modify()"
                    >
                        ÏàòÏ†ï
                    </button>
                </div>
                <div class="col-1 px-0">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="remove()"
                    >
                        ÏÇ≠Ï†ú
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ÌÖåÏù¥Î∏î -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- Î≥∏Î¨∏ -->
        <div class="content-table col-12" style="overflow-y: hidden; height:420px;">
            <table
                    id="item_table"
                    class="table table-sm text-center"
                    style="min-width: 1300px"
            >
                <thead>
                <tr>
                    <th rowspan="2">ÏàúÎ≤à</th>
                    <th class="sorting_item_name" onclick="search('name')">ÌíàÎ™Ö</th>
                    <th class="sorting_item_code" onclick="search('code')">ÌíàÎ≤à</th>
                    <th class="sorting_detail" onclick="search('detail')">ÌíàÎ™ÖÏÉÅÏÑ∏</th>
                    <th rowspan="2">Î™®Îç∏</th>
                    <th rowspan="2">ÏûêÏû¨Î∂ÑÎ•ò</th>
                    <th rowspan="2">Îã®ÏúÑ</th>
                    <th rowspan="2">Í±∞ÎûòÏ≤ò</th>
                    <th rowspan="2">MOQ</th>
                    <th rowspan="2">ÏïàÏ†ÑÏû¨Í≥†ÏàòÎüâ</th>
                    <th rowspan="2">ÎπÑÍ≥†</th>
                    <th rowspan="2">ÌëúÏ§ÄÎã®Í∞Ä</th>
                    <th rowspan="2">TYPE</th>
                    <th rowspan="2">ÏàòÏàòÎ£åÏú®</th>
                </tr>
                </thead>
                <tbody id="item_tbody"></tbody>
            </table>

            <div class="row no-gutters d-flex justify-content-center" id="item_nation">
            </div>

        </div>
    </div>
</div>

<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_item.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_BOMmaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>

<script>
    // Í≤ÄÏÉâÏù∏Ïûê - ÌíàÎ≤à, ÌíàÎ™Ö, ÏûêÏû¨Î∂ÑÎ•ò(ac)
    let it_code_sch = null;
    let it_nice_number_sch = null;
    let it_brand_sch = null;
    let it_item_group_sch = null;
    let it_division_sch = null;

    // add Ìï≠Î™© - ÏûêÏû¨Î∂ÑÎ•ò, Î™®Îç∏, Îã®ÏúÑ, Í±∞ÎûòÏ≤ò, Ïö©Í∏∞ÌÉÄÏûÖ, ÏπºÎùºÍµ¨Î∂Ñ, ÌíàÏ¢ÖÍµ¨Î∂ÑÎ∂Ñ
    let it_click_div_id = null;
    let it_click_div_name = null;

    let it_click_model_id = null;
    let it_click_model_name = null;

    let it_click_unit_id = null;
    let it_click_unit_name = null;

    let it_click_cu_id = null;
    let it_click_cu_name = null;

    let it_click_con_id = null;
    let it_click_con_name = null;

    let it_click_color_id = null;
    let it_click_color_name = null;

    let it_click_kind_id = null;
    let it_click_kind_name = null;

    let it_click_brand_id = null;
    let it_click_brand_name = null;

    let it_click_item_group_id = null;
    let it_click_item_group_name = null;

    let it_click_purchase_from_id = null;
    let it_click_purchase_from_name = null;
    let it_click_purchase_from_code = null;

    let it_click_purchase_from2_id = null;
    let it_click_purchase_from2_name = null;
    let it_click_purchase_from2_code = null;

    let it_click_purchase_from3_id = null;
    let it_click_purchase_from3_name = null;
    let it_click_purchase_from3_code = null;

    // ÏïÑÏù¥ÌÖú pk
    let item_id_idx = null;
    let item_name = null;

    let item_qr_path = null;

    let page1_size = 10;

    let nation_data1 = {
        cname: 'nation1',  // Ïù∏Ïä§ÌÑ¥Ïä§ Î™ÖÍ≥º ÏùºÏπòÌï¥ÏïºÌï®
        table_id: 'item_nation',
        range: 5,
        page_size: page1_size,
    };

    let nation1 = new Pnations(nation_data1, search);  // Ïù∏Ïä§ÌÑ¥Ïä§ Î™Ö

    $(function () {
        $("input[name=excel]").change(function (){
            $('#excel_label').text($(this).val());
        });

        $("#id_it_customer_add_code").on("select2:select", ()=>{
            let selector = $("#id_it_customer_add_code option:selected");
            console.log(selector.val());
            $("#id_it_customer_add").val(selector.val()).trigger("change");
        });
        $("#id_it_customer_add").on("select2:select", ()=>{
            let selector = $("#id_it_customer_add option:selected")
            console.log(selector.val());
            $("#id_it_customer_add_code").val(selector.val()).trigger("change")
        })

        $("#id_it_customer2_add_code").on("select2:select", ()=>{
            let selector = $("#id_it_customer2_add_code option:selected")
            $("#id_it_customer2_add").val($(selector).val()).trigger("change")

        })
        $("#id_it_customer2_add").on("select2:select", ()=>{
            let selector = $("#id_it_customer2_add option:selected")
            $("#id_it_customer2_add_code").val($(selector).val()).trigger("change")

        })

        $("#id_it_customer3_add_code").on("select2:select", ()=>{
            let selector = $("#id_it_customer3_add_code option:selected")
            $("#id_it_customer3_add").val($(selector).val()).trigger("change")

        })
        $("#id_it_customer3_add").on("select2:select", ()=>{
            let selector = $("#id_it_customer3_add option:selected")
            $("#id_it_customer3_add_code").val($(selector).val()).trigger("change")

        })

        set_naming();
        search();
        //refresh();
        // Table export
    });

    function excel_upload() {
        let form = new FormData();

        let fileSelector = document.getElementById('excel');
        let file = (fileSelector.files[0] ? fileSelector.files[0] : null);

        form.append("csrfmiddlewaretoken", '{{ csrf_token }}')
        form.append("excel", file)

        api_excel_upload(form, () => {
            alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÌïòÏòÄÏäµÎãàÎã§.");

            refresh_data();
        });
    }

    function api_excel_upload(allData, done_callback) {
        let v = allData.values();

        for (let value of v){
            console.log(value);
        }

        $.ajax({
            type: "POST",
            url: "/basic_informations/items/excelupload/",
            headers: {
                "Authorization": get_token()
            },
            processData: false,
            contentType: false,
            data: allData
        })
            .done(function () {
                done_callback();
            })
            .fail(handle_error);
    }

    function set_naming() {
        let enterprise_name = get_userinfo().enterprise_name;
        if (enterprise_name == '(Ï£º)Í±¥Í∞ïÏÉùÌôúÏó∞Íµ¨ÏÜå') {
            $("#n_model1").text("Ï†úÌíàÍµ∞");
            $("#n_model2").text("Ï†úÌíàÍµ∞");

            $("#n_container").text("ÌòïÌÉú");
            $("#n_color").text("Scent");
            $("#n_type").text("Î∏åÎûúÎìú");
        }
    }

    function refresh() {
        location.href = "/basic_information/items/";
    }

    {% comment %}
    function refresh() {
        init_drop_down();
        item_search();
    }
    {% endcomment %}

    function search_click() {
        nation1.page = 1;

        it_code_sch = $('#id_it_code_sch').val();
        it_nice_number_sch = $('#id_it_nice_number_sch').val();
        it_brand_sch = $('#id_it_brand_sch').val();
        it_item_group_sch = $('#id_it_item_group_sch').val();
        it_division_sch = $('#id_it_division_sch').val();

        search();
    }

    let order = ""

    function search(ordering) {

        if (ordering === '' || ordering === null || ordering=== undefined ){
        } else {
              order === ordering ? order = "-" +ordering : order = ordering
        }

        $(".sorting_item_name").html("ÌíàÎ™Ö‚ñΩ")
        $(".sorting_item_code").html("ÌíàÎ≤à‚ñΩ")
        $(".sorting_detail").html("ÌíàÎ™ÖÏÉÅÏÑ∏‚ñΩ")
        switch(order){
            case "name":
                $(".sorting_item_name").html("ÌíàÎ™Ö‚ñº")
                break;
            case "-name":
                $(".sorting_item_name").html("ÌíàÎ™Ö‚ñ≤")
                break;
            case "code":
                $(".sorting_item_code").html("ÌíàÎ≤à‚ñº")
                break;
            case "-code":
                $(".sorting_item_code").html("ÌíàÎ≤à‚ñ≤")
                break;
            case "nice_number":
                $(".sorting_detail").html("ÌíàÎ™ÖÏÉÅÏÑ∏‚ñº")
                break;
            case "-nice_number":
                $(".sorting_detail").html("ÌíàÎ™ÖÏÉÅÏÑ∏‚ñ≤")
                break;
            default:
                break;
        }

        let query = "?page_size=" + page1_size + "&page=" + nation1.page +"&";

        query += "ordering=" + order + "&";

        if (it_code_sch == '' || it_code_sch == null || it_code_sch == 'ÏÑ†ÌÉù Î∞è Í≤ÄÏÉâ') {
        } else {
            query += "&it_code_sch=" + it_code_sch;
        }
        if (it_nice_number_sch == '' || it_nice_number_sch == null || it_nice_number_sch == 'ÏÑ†ÌÉù Î∞è Í≤ÄÏÉâ') {
        } else {
            query += "&it_nice_number_sch=" + it_nice_number_sch;
        }
        if (it_brand_sch == '' || it_brand_sch == null || it_brand_sch == 'ÏÑ†ÌÉù Î∞è Í≤ÄÏÉâ') {
        } else {
            query += "&it_brand_sch=" + it_brand_sch;
        }
        if (it_item_group_sch == '' || it_item_group_sch == null || it_item_group_sch == 'ÏÑ†ÌÉù Î∞è Í≤ÄÏÉâ') {
        } else {
            query += "&it_item_group_sch=" + it_item_group_sch;
        }
        if (it_division_sch == '' || it_division_sch == null || it_division_sch == 'ÏÑ†ÌÉù Î∞è Í≤ÄÏÉâ') {
        } else {
            query += "&it_div_sch=" + it_division_sch;
        }

        let multiSearch = $("#multiSearch").val()
        if (multiSearch !=='') query += '&total_search=' + multiSearch;

        console.log(query);
        {#loading_start();#}
        api_gp("/basic_information/items_read/" + query, "GET", {}, (done) => {
            console.log(done);
            {#loading_finish();#}
            draw_items_table(done);
        });
    }


    function draw_items_table(done) {

        console.table(done);

        let data = done.results;
        let num = (((nation1.page * 1) - 1) * nation_data1["page_size"]) + 1;

        let rows = "";
        for (let i = 0; i < data.length; i++) {
            let item = data[i];

            let row = "<tr id='" + item.id + "' style='cursor:pointer;'>";
            row += "<td>" + (num + i) + "</td>";  // ÏàúÎ≤à

            row += "<td title='" + item.code + "'>" + (item.code.length > 10 ? item.code.slice(0,10) + "..." : item.code) + "</td>";  // ÌíàÎ≤à
            row += "<td class='d-none' data-item='code'>" +item.code + "</td>";  // ÌíàÎ≤à
            row += "<td title='" + item.name + "'>" + (item.name.length > 10 ? item.name.slice(0,10) + "..." : item.name) + "</td>";  // ÌíàÎ™Ö
            row += "<td class='d-none' data-item='name'>"  + item.name + "</td>";  // ÌíàÎ™Ö
            row += "<td data-item='detail'>" + nullapply(item.detail) + "</td>";  // ÌíàÎ™ÖÏÉÅÏÑ∏
            row += "<td data-item='model_name'>" + nullapply(item.model_name) + "</td>";  // Î™®Îç∏
            row += "<td data-item='division' " +
                "property='" + (item.division_id ? item.division_id : "") + "'>" +
                (item.division_id ? item.division_name : "") + "</td>";  // ÏûêÏû¨Î∂ÑÎ•ò

            row += "<td data-item='unit_name'>" + nullapply(item.unit_name) + "</td>";  // Îã®ÏúÑ
            row += "<td data-item='purchase_from' property='" + (item.purchase_from_id ? item.purchase_from_id : "") + "'>" +
                (item.purchase_from_name ? item.purchase_from_name : "") + "</td>";  // Í±∞ÎûòÏ≤ò1
            row += "<td style='display: none' data-item='purchase_from_code' property='" + (item.purchase_from_id ? item.purchase_from_id : "") + "'>" +
                (item.purchase_from_code ? item.purchase_from_code : "") + "</td>";  // Í±∞ÎûòÏ≤ò1
            row += "<td data-item='moq'>" + nullapply(item.moq) + "</td>";  // moq
            row += "<td data-item='safe_amount'>" + nullapply(item.safe_amount) + "</td>"; //ÏïàÏ†ÑÏû¨Í≥†ÏàòÎüâ
            row += "<td data-item='etc'>" + (item.etc ? item.etc : "") + "</td>";  // ÎπÑÍ≥†
            row += "<td data-item='standard_price'>" +
                (item.standard_price ? item.standard_price.toLocaleString() : 0) + "</td>";  // ÌëúÏ§ÄÎã®Í∞Ä
            row += "<td data-item='type'>" +
                (item.type ? item.type : 0) + "</td>";  // ÌÉÄÏûÖ
            row += "<td data-item='fee_rate'>" + Number(item.fee_rate) +"%"+ "</td>"; //ÏàòÏàòÎ£åÏú®
            row += "</tr>";
            rows += row;
        }

        nation1.nation_display(done);

        $('#item_tbody').html(rows);

        console.log('Ï∞çÌòÄÏûàÎäî id Í∞íÏùÄ?');
        console.log(item_id_idx);
        console.log($("#" + item_id_idx));

        if (item_id_idx != null) {
            $("#" + item_id_idx).addClass('clicked');
        }

        $('#item_tbody > tr').on('click', function () {

            // table click highlight
            $(this).parent().find('tr').removeClass('clicked');
            $(this).addClass('clicked');

            item_id_idx = $(this).attr("id");
            item_name = $(this).find("[data-item='name']").text();

            $("#code").val($(this).find("[data-item='code']").text());  // ÌíàÎ≤à
            $("#name").val($(this).find("[data-item='name']").text());  // ÌíàÎ™Ö
            $("#brand").val($(this).find("[data-item='brand']").text());  // Î∏åÎûúÎìú
            $("#family").val($(this).find("[data-item='family']").text());  // Ï†úÌíàÍµ∞
            $("#shape").val($(this).find("[data-item='shape']").text());  // ÌòïÌÉú
            $("#nice").val($(this).find("[data-item='nice']").text());  // ÎÇòÏù¥Ïä§Î≤àÌò∏
            $("#detail").val($(this).find("[data-item='detail']").text());// ÌíàÎ™ÖÏÉÅÏÑ∏

            it_click_div_id = $(this).find("[data-item='division']").attr("property");
            it_click_div_name = $(this).find("[data-item='division']").text();

            it_click_model_id = $(this).find("[data-item='model']").attr("property");
            it_click_model_name = $(this).find("[data-item='model']").text();

            it_click_unit_id = $(this).find("[data-item='unit']").attr("property");
            it_click_unit_name = $(this).find("[data-item='unit']").text();

            {#it_click_cu_id = $(this).find("[data-item='customers']").attr("property");#}
            {#it_click_cu_name = $(this).find("[data-item='customers']").text();#}

            it_click_con_id = $(this).find("[data-item='container']").attr("property");
            it_click_con_name = $(this).find("[data-item='container']").text();

            it_click_color_id = $(this).find("[data-item='color']").attr("property");
            it_click_color_name = $(this).find("[data-item='color']").text();

            it_click_kind_id = $(this).find("[data-item='type']").attr("property");
            it_click_kind_name = $(this).find("[data-item='type']").text();

            it_click_brand_id = $(this).find("[data-item='brand']").attr("property");
            it_click_brand_name = $(this).find("[data-item='brand']").text();

            it_click_item_group_id = $(this).find("[data-item='item_group']").attr("property");
            it_click_item_group_name = $(this).find("[data-item='item_group']").text();

            it_click_purchase_from_id = $(this).find("[data-item='purchase_from']").attr("property");
            it_click_purchase_from_name = $(this).find("[data-item='purchase_from']").text();
            it_click_purchase_from_code = $(this).find("[data-item='purchase_from_code']").text();

            it_click_purchase_from2_id = $(this).find("[data-item='purchase_from2']").attr("property");
            it_click_purchase_from2_name = $(this).find("[data-item='purchase_from2']").text();
            it_click_purchase_from2_code = $(this).find("[data-item='purchase_from2_code']").text();

            it_click_purchase_from3_id = $(this).find("[data-item='purchase_from3']").attr("property");
            it_click_purchase_from3_name = $(this).find("[data-item='purchase_from3']").text();
            it_click_purchase_from3_code = $(this).find("[data-item='purchase_from3_code']").text();




            let option1 = new Option(it_click_div_name, it_click_div_id, true, true);
            $('#id_it_division_add').append(option1).trigger('change');

            let option2 = new Option(it_click_model_name, it_click_model_id, true, true);
            $('#id_it_model_add').append(option2).trigger('change');

            let option3 = new Option(it_click_unit_name, it_click_unit_id, true, true);
            $('#id_it_unit_add').append(option3).trigger('change');

            {#let option4 = new Option(it_click_cu_name, it_click_cu_id, true, true);#}
            {#$('#id_it_customer_add').append(option4).trigger('change');#}

            let option5 = new Option(it_click_con_name, it_click_con_id, true, true);
            $('#id_it_container_add').append(option5).trigger('change');

            let option6 = new Option(it_click_color_name, it_click_color_id, true, true);
            $('#id_it_color_add').append(option6).trigger('change');

            let option7 = new Option(it_click_kind_name, it_click_kind_id, true, true);
            $('#id_it_kind_add').append(option7).trigger('change');

            let option8 = new Option(it_click_brand_name, it_click_brand_id, true, true);
            $('#id_it_brand').append(option8).trigger('change');

            let option9 = new Option(it_click_item_group_name, it_click_item_group_id, true, true);
            $('#id_it_item_group').append(option9).trigger('change');

            let option10 = new Option(it_click_purchase_from_name, it_click_purchase_from_id, true, true);
            $('#id_it_customer_add').append(option10).trigger('change');
            let option10_1 = new Option(it_click_purchase_from_code, it_click_purchase_from_id, true, true);
            $('#id_it_customer_add_code').append(option10_1).trigger('change');

            let option11 = new Option(it_click_purchase_from2_name, it_click_purchase_from2_id, true, true);
            $('#id_it_customer2_add').append(option11).trigger('change');
            let option11_1 = new Option(it_click_purchase_from2_code, it_click_purchase_from2_id, true, true);
            $('#id_it_customer2_add_code').append(option11_1).trigger('change');

            let option12 = new Option(it_click_purchase_from3_name, it_click_purchase_from3_id, true, true);
            $('#id_it_customer3_add').append(option12).trigger('change');
            let option12_1 = new Option(it_click_purchase_from3_code, it_click_purchase_from3_id, true, true);
            $('#id_it_customer3_add_code').append(option12_1).trigger('change');




            $("#fee_rate").val($(this).find("[data-item='fee_rate']").text());// ÏàòÏàòÎ£åÏú®
            $("#etc").val($(this).find("[data-item='etc']").text());// ÎπÑÍ≥†
            $("#standard_price").val($(this).find("[data-item='standard_price']").text());// ÌëúÏ§ÄÎã®Í∞Ä
            $("#bom_division").val($(this).find("[data-item='bom_division']").text());// BOM Íµ¨Î∂Ñ
            $("#qr").val($(this).find("[data-item='qr']").text());// qr

            {#$("#brand").val($(this).find("[data-item='brand']").text());// brand#}
            {#$("#item_group").val($(this).find("[data-item='item_group']").text());// item_group#}
            $("#nice_number").val($(this).find("[data-item='nice_number']").text());// nice_number
            $("#shape").val($(this).find("[data-item='shape']").text());// shape
            $("#safe_amount").val($(this).find("[data-item='safe_amount']").text());// safe_amount

            item_qr_path = $(this).find("[data-item='qr']").text();
        });
    }

    function qr_update() {
        if (!item_id_idx) {
            alert('ÌíàÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
            return;
        }

        let data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pk: item_id_idx,
        }

        console.log(data);

        api_gp('/basic_information/items_qr_update/', 'post', data, (done) => {
            alert('QR ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
            search();

            console.log(done);

            $("#qr").val(done.qr_path);
            $("#bom_division").val(done.bom_division_name);

        });

        {% comment %}
        api_item_update_qr(item_id_idx, (done) => {
            alert('QR ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
            search();
            //refresh();
        });
        {% endcomment %}
    }


    function item_add() {
        if ($('#code').val() == "") {
            alert("ÌíàÎ≤àÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        if ($('#name').val() == "") {
            alert("ÌíàÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        let data = get_data();
        api_gp("/basic_information/items_create/", "POST", data, (done) => {
            nation1.page = 1;
            item_id_idx = done.id;
            item_name = done.name;

            alert("Ï∂îÍ∞ÄÌïòÏòÄÏäµÎãàÎã§.");

            search();
            $("#qr").val(done.qr_path);
            $("#bom_division").val(done.bom_division_name);
        });
    }


    function modify() {
        if (item_id_idx == null) {
            alert("ÏàòÏ†ïÌï† ÌñâÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        if ($('#code').val() == "") {
            alert("ÌíàÎ≤àÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        if ($('#name').val() == "") {
            alert("ÌíàÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        if ($('#bom_division').val() == "BOM") {
            let enterprise_name = get_userinfo().enterprise_name;
            if (enterprise_name == '(Ï£º)Í±¥Í∞ïÏÉùÌôúÏó∞Íµ¨ÏÜå') {
                alert("[BOM TYPE]ÏùÄ [Î†àÏãúÌîº Í¥ÄÎ¶¨] > [Î†àÏãúÌîº ÌòïÏãù]ÏóêÏÑú ÏàòÏ†ïÌïòÏÑ∏Ïöî.");
            } else {
                alert("[BOM TYPE]ÏùÄ [BOM Í¥ÄÎ¶¨] > [BOM ÌòïÏãù ÏÉùÏÑ±]ÏóêÏÑú ÏàòÏ†ïÌïòÏÑ∏Ïöî.");
            }

            return;
        }

        let data = get_data();
        console.log(data);

        api_gp('/basic_information/items_update/', 'post', data, (done) => {
            alert("ÏàòÏ†ïÌñàÏäµÎãàÎã§..");

            search();

        });
    }


    function remove() {
        if (item_id_idx == null) {
            alert("ÏÇ≠Ï†úÌï† ÌíàÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        if ($('#bom_division').val() == "BOM") {
            alert("[BOM TYPE]ÏùÄ [BOM Í¥ÄÎ¶¨] > [BOM ÌòïÏãù ÏÉùÏÑ±]ÏóêÏÑú ÏÇ≠Ï†úÌïòÏÑ∏Ïöî.");
            return;
        }

        let allData = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pk: item_id_idx,
            qr_path: item_qr_path,// pk
        }

        let del = confirm(
            "ÌíàÎ™©: " + item_name + "ÏùÑ(Î•º) ÏÇ≠Ï†ú ÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
        );

        if (del) {
            api_gp('/basic_information/items_delete/', 'post', allData, (done_callback) => {
                alert("ÏÇ≠Ï†úÌïòÏòÄÏäµÎãàÎã§.");
                nation1.page = 1;

                refresh_data();
                search();

            });
        }
    }

    function show_qr_print(_imgurl) {

        var url = "/material/qr_print/?param1=";
        url = url + _imgurl;
        var name = "QR Print";
        var option = "width=1000px, height=1000px, location=no";
        window.open(url, name, option);

    }

    function api_item_update_qr(id_data, done_callback) {
        $.ajax({
            type: "POST",
            url: "/basic_information/items_qr_update/",
            headers: {
                "Authorization": get_token()
            },
            data: {
                id: id_data
            },
        })
            .done(function (json) {
                done_callback(json);
            })
            .fail(handle_error);
    }


    function get_data() {
        let standard_price = $("#standard_price").val().replace(/,/g, "");// ÌëúÏ§ÄÎã®Í∞Ä

        console.log('ÌëúÏ§ÄÎã®Í∞ÄÎäî');
        console.log(standard_price)
        console.log($('#id_it_customer2_add').val())
        console.log($('#id_it_customer3_add').val())

        if (standard_price == '' || standard_price == null) {
            standard_price = '0';
        }


        return {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pk: item_id_idx,

            code: $("#code").val(),  // ÌíàÎ≤à
            name: $("#name").val(),  // ÌíàÎ™Ö
            detail: $("#detail").val(),  // ÌíàÎ™ÖÏÉÅÏÑ∏

            item_division: $('#id_it_division_add').val(),  // ÏûêÏû¨Î∂ÑÎ•ò
            unit: $('#id_it_unit_add').val(),  // Îã®ÏúÑ
            model: $('#id_it_model_add').val(),  // Î™®Îç∏
            container: $('#id_it_container_add').val(),  // Ïö©Í∏∞ÌÉÄÏûÖ
            color: $('#id_it_color_add').val(),  // ÏπºÎùºÍµ¨Î∂Ñ
            type: $('#id_it_kind_add').val(),  // ÌíàÏ¢ÖÍµ¨Î∂Ñ
            purchase_from: $('#id_it_customer_add').val(), // Í±∞ÎûòÏ≤ò
            purchase_from2: $('#id_it_customer2_add').val(), // Í±∞ÎûòÏ≤ò
            purchase_from3: $('#id_it_customer3_add').val(), // Í±∞ÎûòÏ≤ò


            etc: $("#etc").val(),  // ÎπÑÍ≥†
            standard_price: standard_price,  // ÌëúÏ§ÄÎã®Í∞Ä

            brand_id: $('#id_it_brand').val(),
            item_group_id: $('#id_it_item_group').val(),
            nice_number: $('#nice_number').val(),
            shape: $('#shape').val(),
            safe_amount: $('#safe_amount').val(),

            qr_path: '',
        };
    }

    // Íµ≥Ïù¥?
    function refresh_search_data() {
        $("#code_sch").val("");
        $("#name_sch").val("");
        //$("#division_sch").val(null).trigger("change");
    }


    function refresh_data() {
        //refresh_search_data();

        $("#code").val("");  // ÌíàÎ≤à
        $("#name").val("");  // ÌíàÎ™Ö
        $("#detail").val("");  // ÌíàÎ™ÖÏÉÅÏÑ∏
        $("#shape").val("");  // ÌíàÎ™ÖÏÉÅÏÑ∏

        // 7Í∞úÏùò ac, ÌÉÄÏûÖ, qr
        let option1 = new Option('', '', true, true);
        $('#id_it_division_add').append(option1).trigger('change');

        let option2 = new Option('', '', true, true);
        $('#id_it_model_add').append(option2).trigger('change');

        let option3 = new Option('', '', true, true);
        $('#id_it_unit_add').append(option3).trigger('change');

        {#let option4 = new Option('', '', true, true);#}
        {#$('#id_it_customer_add').append(option4).trigger('change');#}

        let option5 = new Option('', '', true, true);
        $('#id_it_container_add').append(option5).trigger('change');

        let option6 = new Option('', '', true, true);
        $('#id_it_color_add').append(option6).trigger('change');

        let option7 = new Option('', '', true, true);
        $('#id_it_kind_add').append(option7).trigger('change');

        let option8 = new Option('', '', true, true);
        $('#id_it_brand').append(option8).trigger('change');

        let option9 = new Option('', '', true, true);
        $('#id_it_item_group').append(option9).trigger('change');

        let option10 = new Option('', '', true, true);
        $('#id_it_customer_add').append(option10).trigger('change');

        let option10_1 = new Option('', '', true, true);
        $('#id_it_customer_add_code').append(option10_1).trigger('change');

        let option11 = new Option('', '', true, true);
        $('#id_it_customer2_add').append(option11).trigger('change');

        let option11_1 = new Option('', '', true, true);
        $('#id_it_customer2_add_code').append(option11_1).trigger('change');

        let option12 = new Option('', '', true, true);
        $('#id_it_customer3_add').append(option12).trigger('change');

        let option12_1 = new Option('', '', true, true);
        $('#id_it_customer3_add_code').append(option12_1).trigger('change');

        $("#bom_division").val("");
        $("#qr").val("");

        $("#etc").val("");  // ÎπÑÍ≥†
        $("#standard_price").val(0);  // ÌëúÏ§ÄÎã®Í∞Ä
        $("#safe_amount").val(0);  // ÌëúÏ§ÄÎã®Í∞Ä

        item_id_idx = null;
        $('#item_tbody').find('tr').removeClass('clicked');
    }

</script>

</body>
</html>
