<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>

<body style="overflow: hidden;">
{% load static %}

<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px"/>
</div>


<div class="card m-2">
    <div class="card-body p-2">
        <!-- 본문 -->
        <form
                class="content-search row no-gutters align-items-center content-input-group"
                id="material_input_main-search-form"
                onsubmit="nation1.page =1; input_submit(event)"
        >
            <div class="content-title col-1 align-self-stretch">검색</div>
            <div class="col-11">
                <div class="row no-gutters">
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>입고기간</label>
                        </div>
                        <div class="input-group input-daterange">
                            <input
                                    type="text"
                                    class="form-control created_at_after datepicker h-100"
                                    id="fr_date"
                                    autocomplete="off"
                            />
                            <div class="input-group-addon px-3">~</div>
                            <input
                                    type="text"
                                    class="form-control created_at_before datepicker h-100"
                                    id="to_date"
                                    autocomplete="off"
                            />
                        </div>
                    </div>
                    <div class="content-input-group col-2 px-0">
                        <div class="content-input-group-header">
                            <label>거래처명</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control customer-search-dropdown"
                                    id="customer_search"
                            ></select>
                        </div>
                    </div>
                </div>
                 <div class="row no-gutters">
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>품번</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control material_input_item-code-dropdown-search"
                                    id="item_code_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>품명</label>
                        </div>
                        <div class="input-group input-daterange">
                            <select
                                    class="form-control material_input_item-code-dropdown-search"
                                    id="item_name_search"
                            ></select>
                        </div>
                    </div>

                    <div class="col-1 px-0">
                        <button
                                class="btn button-search rounded-0 w-100 h-100"
                                type="submit"
                        >
                            검색
                        </button>
                    </div>
                     <div class="content-input-group col-1 px-0">
                     </div>
{#                    <div class="content-input-group col-3 px-0">#}
{#                        <div class="content-input-group-header">#}
{#                            <label>품명상세</label>#}
{#                        </div>#}
{#                        <div class="content-input-group-input">#}
{#                            <input#}
{#                                    class="form-control"#}
{#                                    id="detail_search"#}
{#                            />#}
{#                        </div>#}
{#                    </div>#}
{#                    <div class="content-input-group col-2 px-0">#}
{#                        <div class="content-input-group-header">#}
{#                            <label>형태</label>#}
{#                        </div>#}
{#                        <div class="content-input-group-input">#}
{#                            <input#}
{#                                    class="form-control"#}
{#                                    id="shape_search"#}
{#                            />#}
{#                        </div>#}
{#                    </div>#}

                </div>
            </div>
        </form>
    </div>
        <div class="col-12">
            <div class="row no-gutters">
                <div class="content-title col-1 align-self-stretch">통합검색</div>
                 <div class="content-input-group col-3 px-0">
                    <div class="content-input-group-header">
                        <label>통합검색</label>
                    </div>
                    <div class="content-input-group-input">
                        <input
                                class="form-control"
                                id="total_input_search"
                                placeholder="검색어를 입력해 주세요"
                        />
                    </div>
                 </div>
                    <div class="col-1 px-0">
                        <button
                                class="btn button-search rounded-0 w-100 h-100"
                                id="total_search_button"
                                onclick="nation1.page =1; total_search();"
                        >
                            통합 검색
                        </button>
                    </div>
            </div>
        </div>
        <br>
</div>

<!-- 내용 -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        <form class="content-content w-100" id="material_input_main-form">
            <div class="row no-gutters w-100 mb-2">
                <div class="col-1 content-title">입고등록</div>
                <div class="col-11">
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>입고일자<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control datepicker"
                                        autocomplete="off"
                                        type="text"
                                        name="in-at"
                                        id="in-at"
                                />
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>거래처</label>
                            </div>
                            <div class="input-group">
                                <select
                                        class="form-control h-100 customer-dropdown"
                                        name="customer"
                                        id="material_input_customer"
                                ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>브랜드</label>
                            </div>
                            <div class="input-group">
                            <select
                                    class="form-control item-brand-dropdown"
                                    name="item-brand"
                                    id="item-brand"
                            ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>제품군</label>
                            </div>
                            <div class="content-input-group-input">
                            <select
                                    class="form-control item-item_group-dropdown"
                                    name="item-item_group"
                                    id="item-item_group"
                            ></select>
                            </div>
                        </div>
                        <!-- {# <div class="content-input-group col-2">#}
                                {# <div class="content-input-group-header" style="background-color: darkgrey;">#}
                                    {# -->
                        <!-- 현재 동작 X -->
                        <!-- {# <label>품명<strong>*</strong></label>#}
                                    {#
                                </div>#}
                                {# <div class="content-input-group-input">#}
                                    {# <select class="form-control item-name-dropdown" name="item-name"
                                        id="item-name">#}
                                        {# </select>#}
                                    {# </div>#}
                                {# </div>#}
                            {# <div class="content-input-group col-2">#}
                                {# <div class="content-input-group-header" style="background-color: darkgrey;">#}
                                    {# -->
                        <!-- 현재 동작 X -->
                        <!-- {# <label>품목</label>#}
                                    {#
                                </div>#}
                                {# <div class="content-input-group-input">#}
                                    {# <select class="form-control item-type-dropdown" name="item-type"
                                        id="item-type">#}
                                        {# </select>#}
                                    {# </div>#}
                                {# </div>#} -->
                    </div>
                    <div class="row no-gutters">
                               <div class="content-input-group col-4">
                            <div class="content-input-group-header">
                                <label>품명<strong>*</strong></label>
                            </div>
                            <div class="input-group">
                                <input
                                        class="form-control h-100"
                                        name="item-name-direct"
                                        id="material_input_item-name-direct"
                                />
                            </div>
                            <div class="input-group">
                                <select
                                        class="form-control material_input_item-name-dropdown"
                                        name="item-name"
                                        id="material_input_item-name"
                                ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-4">
                            <div class="content-input-group-header">
                                <label>품번<strong>*</strong></label>
                            </div>
                            <div class="input-group">
                                <input
                                        class="form-control h-100"
                                        name="item-code-direct"
                                        id="material_input_item-code-direct"
                                />
                            </div>
                            <div class="input-group">
                                <select
                                        class="form-control material_input_item-code-dropdown"
                                        name="item-code"
                                        id="material_input_item-code"
                                ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-4">
                            <div class="content-input-group-header">
                                <label>나이스번호<strong>*</strong></label>
                            </div>
                            <div class="input-group">
                                <input
                                        class="form-control h-100"
                                        name="item-nice_number-direct"
                                        id="material_input_item-nice_number-direct"
                                />
                            </div>
                            <div class="input-group">
                                 <select
                                        class="form-control material_input_item-nice_number-dropdown"
                                        name="item-nice_number"
                                        id="material_input_item-nice_number"
                                >
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>품명상세</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="item-detail"
                                        id="material_input_item-detail"
{#                                        onkeyup="_chkNumber(this, 3)"#}
                                />
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>형태</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="item-shape"
                                        id="material_input_item-shape"
                                />
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>자재분류</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control item-division-dropdown"
                                        name="item-item_division"
                                        id="material_input_item-item_division">
                                </select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>자재생산일자</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control datepicker"
                                        name="item-created-at"
                                        id="material_input_in-item_created_at"
                                />
                            </div>
                        </div>
                        </div>


                    <div class="row no-gutters">
                         <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>입하수량<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="receive-amount"
                                        id="material_input_receive-amount"
                                        onkeyup="_chkNumber(this, 3)"
                                        onchange="in_amount_calc()"
                                />
                            </div>
                        </div>

                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>불량수량</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="in-faulty-amount"
                                        id="material_input_in-faulty-amount"
                                        onkeyup="_chkNumber(this, 3)"
                                        onchange="in_amount_calc()"
                                />
                            </div>
                        </div>
                         <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>입고수량</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="in-amount"
                                        id="material_input_in-amount"
                                        disabled
                                />
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>입고단가</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="in-price"
                                        id="material_input_in-price"
                                        onkeyup="_chkNumber(this, 2)"
                                />
                            </div>
                        </div>
                    </div>
                <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label >부가세포함</label>
                            </div>
                            <div class="content-input-group-input">
                                 <div class="form-control h-100 w-100">
                                <input type="checkbox" class="form-control" name="tax" id="tax" value="X" checked/>
                                </div>
                            </div>
                        </div>

                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>창고저장위치</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control location-dropdown"
                                        name="location"
                                        id="material_input_location"
                                ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>비고</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="etc"
                                        id="etc"
                                />
                            </div>
                        </div>
                         <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>QR</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="btn button-custom2 w-100" name="qr"
                                       type="button" onclick="show_qr_print($(this).val())"/>
                            </div>
                        </div>
                    </div></div>
            </div>
            <div class="row no-gutters w-100 justify-content-end">
                <div class="content-input-group mr-2">
                    <div class="content-input-group-input">
                        <input placeholder="QR선택" autocomplete="off" onkeypress="enterkey(event)" class="form-control" name="qr_select" id="qr_select"/>
                    </div>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="form_blank()"
                    >
                        초기화
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="material_input_add()"
                    >
                        입고등록
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="material_input_edit()"
                    >
                        입고수정
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="material_input_remove()"
                    >
                        입고삭제
                    </button>
                </div>
                </div>
                <!--                    <div class="col-1 px-0">-->
                <!--                        <a class="btn button-custom2 w-100" role="button">저장</a>-->
                <!--                    </div>-->

        </form>
    </div>
</div>

<!-- 테이블 -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        <div class="content-table col-12" style="overflow-x: visible; height: 600px;" >
            <table
                    id="material_input_data-table"
                    class="table table-sm text-center"
            >
                <thead>
                <tr>
                    <th>순번</th>
                    <th>입고번호</th>
                    <th>입고일자</th>
                    <th>자재생산일자</th>
                    <th>거래처</th>
                    <th>브랜드</th>
                    <th>제품군</th>
                    <th class="sorting_item_name" onclick="search('item__name')">품명</th>
                    <th class="sorting_item_code" onclick="search('item__code')">품번</th>
                    <th class="sorting_item_nice_number" onclick="search('item__nice_number')">나이스번호</th>
                    <th>품명상세</th>
                    <th>형태</th>
                    <th>자재구분</th>
                    <th>입하수량</th>
                    <th>불량 수량</th>
                    <th>입고 수량</th>
                    <th>입고 단가</th>
                    <th>창고 위치</th>
                    <th>비고</th>
                    <th>qr path</th>
                </tr>
                </thead>
                <tbody id="material_input_tbody"></tbody>
            </table>

            <div class="row no-gutters d-flex justify-content-center" id="item_nation"
                 style="margin-top: -20px;">
            </div>
{#            <div class="col-1 ml-auto">#}
{#                 <a href="#" id="excel-export" class="col-1 text-center">#}
{#                    <img src="/static/img/i_excel_c.png" width="38" height="38" />#}
{#                    <p class="mb-0">엑셀 변환</p>#}
{#                </a>#}
{#            </div>#}
        </div>
    </div>

</div>

<script src="{% static 'js/api_materials.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_item.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>

<script>
    let nation_data1 = {
        cname : 'nation1',  // 인스턴스 명과 일치해야함
        table_id: 'item_nation',
        range: 5,
        page_size: 10,
    };

    let nation1 = new Pnations(nation_data1, search);  // 인스턴스 명

    let matarial_input_list = [];
    var material_input_id_idx = null;
    var material_input_columns = [
        "customer",
        "item-code",
        "item-name",
        "item-code-data",
        "item-name-data",
        "item-type",
        "item-model",
        "item-unit",
        "check-at",
        "in-at",
        "receive-amount",
        "in-faulty-amount",
        "in-amount",
        "location",
        "etc",
        "item-created-at",
        "in-price",
        "qr",
        "item-brand",
        "item-nice_number",
        "item-nice_number-data",
        "item-item_group",
        "item-detail",
        "item-shape",
        "item-item_division",
        "tax"
    ];
    // let filters = ['factory', 'process', 'enable', 'name'];

    $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
        todayHighlight: 'true',
    });

    {#$(".datepicker").datepicker("setDate", "today");#}

    // ANCHOR material_input_draw_in_table
    function material_input_draw_in_table(done) {

        let data = done.results;
        let num = (((nation1.page*1) - 1) * nation_data1["page_size"]) + 1 ;
        let rows = "";

        for (let i = 0; i < data.length; i++) {
            let material = data[i];
            console.log(material.item);

            // append it
            let row = "<tr id='" + material.id + "' style='cursor:pointer;'>";
            row += "<td>" + (num + i)  + "</td>";
            row += "<td data-item='num'>" + material.num + "</td>"; // 입고번호
             row += "<td data-item='in-at'>" + material.in_at + "</td>"; // 입고일자
            row += "<td data-item='item-created-at'>" + nullapply(material.item_created_at) + "</td>"; // 자재생산일자
            row += "<td data-item='customer' property='" + (material.customer && material.customer.id ? material.customer.id : "") + "'>" + (material.customer && material.customer.name ? material.customer.name : "") + "</td>"; // 구매처
            row += "<td data-item='item-brand' property='" + (material.item && material.item.brand_id ? material.item.brand_id : "") + "'>" + (material.item && material.item.brand_name ? material.item.brand_name : "") + "</td>"; // 브랜드
            row += "<td data-item='item-item_group' property='" + (material.item && material.item.item_group_id ? material.item.item_group_id : "") + "'>" + (material.item && material.item.item_group_name ? material.item.item_group_name : "") + "</td>"; // 제품군
            row += "<td data-item='item-name' title='" + material.item.name + "' property='" + (material.item ? material.item.id : "") + "'>" + (material.item.name.length > 10 ? material.item.name.slice(0,10) + "..." : material.item.name) + "</td>"; // 품명
            row += "<td data-item='item-code' title='" + material.item.code + "' property='" + (material.item ? material.item.id : "") + "'>" + (material.item.code.length > 10 ? material.item.code.slice(0,10) + "..." : material.item.code) + "</td>"; // 품번
            row += "<td data-item='item-nice_number' property='" + (material.item ? material.item.id : "") + "'>" + (material.item ? material.item.nice_number : "") + "</td>"; //나이스번호
            row += "<td data-item='item-detail' property='" + (material.item.detail ? material.item.detail : "") + "'>" + (material.item.detail ? material.item.detail : "") + "</td>"; //품명상세
            row += "<td data-item='item-shape' property='" + (material.item.shape ? material.item.shape : "") + "'>" + (material.item.shape ? material.item.shape : "") + "</td>"; // 모델
            row += "<td data-item='item-item_division' property='" + (material.item.division_id ? material.item.division_id : "") + "'>" + (material.item.division_id ? material.item.division_name : "") + "</td>"; // 자재구분
            row += "<td data-item='receive-amount'>" + (material.receive_amount ? material.receive_amount.toLocaleString() : 0) + "</td>"; // 입하수량
            row += "<td data-item='in-faulty-amount'>" + (material.in_faulty_amount ? material.in_faulty_amount.toLocaleString() : 0) + "</td>"; // 불량수량
            row += "<td data-item='in-amount'>" + (material.in_amount ? material.in_amount.toLocaleString() : 0) + "</td>"; // 입고수량
            row += "<td data-item='in-price'>" + (material.in_price ? material.in_price.toLocaleString() : 0) + "</td>"; // 단가
            row += "<td class='d-none'" + "data-item='in-tax'>" + (material.tax ? material.tax.toLocaleString() : "O") + "</td>"; // 부가세
            row += "<td data-item='location' property='" + (material.location ? material.location.id : "") + "'>" + (material.location ? material.location.name : "입고창고") + "</td>"; // 창고위치
            // row += "<td data-item='num'>" + material.num + "</td>";   // 입고 처리자
            row += "<td data-item='etc'>" + (material.etc ? material.etc : "") + "</td>"; // 비고
            row += "<td data-item='qr'>" + (material.qr_path ? material.qr_path : "") + "</td>"; // qr_path

            // hjlim : 불용자재 파악을 위한 선입선출 식 임시 계산
            {#row += "<td data-item='remain_stock'>" + (material.remain_stock) + "</td>";#}

            row += "</tr>";
            rows += row;
        }
        spinner();

        nation1.nation_display(done);
        $("#material_input_tbody").html(rows);

        // click check
        if (material_input_id_idx != null){
            $("#" + material_input_id_idx).addClass('clicked');
        }

        $("#material_input_tbody > tr").on("click", function () {
            $(this).parent().find("tr").removeClass("clicked");
            $(this).addClass("clicked");

            $("#material_input_item-code-direct").val('');
            $("#material_input_item-name-direct").val('');
            $("#material_input_item-code-direct").attr("disabled", true);
            $("#material_input_item-name-direct").attr("disabled", true);

            $("#material_input_item-code").attr("disabled", true);
            $("#material_input_item-name").attr("disabled", true);

            $("#material_input_item-item_division").attr("disabled", true);
            $("#item-brand").attr("disabled", true);
            $("#item-item_group").attr("disabled", true);

            $("#material_input_item-nice_number-direct").attr("disabled", true);
            $("#material_input_item-nice_number").attr("disabled", true);

            $("#material_input_item-shape").attr("disabled", true);
            $("#material_input_item-detail").attr("disabled", true);

            console.log($("#material_input_main-form"));
            material_input_columns.forEach((item) => {

                if (
                    item === "customer" ||
                    item === "location" ||
                    item === "item-code" ||
                    item === "item-name" ||
                    item === "item-unit" ||
                    item === "item-model" ||
                    item === "item-type" ||
                    item === "item-item_division" ||
                    item === "item-nice_number" ||
                    item === "item-brand" ||
                    item === "item-item_group"
                ) {
                    $("#material_input_main-form [name='" + item + "']").val($(this).find("[data-item='" + item + "']").attr("property")).trigger("change");
                }
                {#else if (item === "customer") {#}
                {#console.log($("#material_input_customer").find("option"));#}
                {#console.log(item);#}
                {#console.log($(this).find("[data-item='" + item + "']").attr("property"));#}
                {#    $("#material_input_customer").val($(this).find("[data-item='" + item + "']").attr("property")).trigger("change");}#}
                else if(item === "tax"){
                    if($(this).find("[data-item='" + item + "']").text() === "X"){
                          document.querySelector(`#${item}`).checked = true
                    }else{
                        document.querySelector(`#${item}`).checked = false
                    }
                     $(`#${item}`).click()
                }
                else {
                    $("#material_input_main-form [name='" + item + "']").val(
                        $(this)
                            .find("[data-item='" + item + "']")
                            .text()
                    );
                }
            });
            material_input_id_idx = $(this).attr("id");
        });
    }

    $(function () {
        set_naming();
        refresh();

        // Table Export
        $(parent.document).find("#excel-export").click(() =>
            init_excel_export($("#material_input_data-table"), "재고입고")
        );
    });


    function set_naming(){
        let enterprise_name = get_userinfo().enterprise_name;
        if (enterprise_name == '(주)건강생활연구소'){
            $("#n_bom_model1").text("제품군");
            $("#n_bom_model2").text("제품군");

            $("#n_check_date1").text("에이징타임");
            $("#n_check_date2").text("에이징타임");

        }
    }


    function refresh() {
        $("#in-at").datepicker("setDate", "today");
        material_input_init();
        search();
    }

    let order = ""
    function search(ordering){

        let customer_search = $('#customer_search :selected').val();

        let fr_date = $("#fr_date").val();
        let to_date = $("#to_date").val();

        let brand = ($('#item_brand_search :selected').val() ? $('#item_brand_search :selected').val() : "");
        let item_group = ($('#item_group_search :selected').val() ? $('#item_group_search :selected').val() : "");
        let nice_number = ($('#item_nice_number_search :selected').val() ? $('#item_nice_number_search :selected').val() : "");
        let item_name = ($('#item_name_search :selected').val() ? $('#item_name_search :selected').val() : "");
        {#let item_code = ($('#item_code_search :selected').val() ? $('#item_code_search :selected').val() : "");#}
        {#let detail = ($('#detail_search').val() ? $('#detail_search').val() : "");#}
        {#let shape = ($('#shape_search').val() ? $('#shape_search').val() : "");#}

        let query = "?page=" + nation1.page + "&";
        if (customer_search === '' || customer_search == null){
        } else {
            query += "customer=" + customer_search + "&";
        }
        {#if (item_name == '' || item_name == null){} else {#}
        {#    query += "item=" + item_name + "&";}#}
          if (ordering === '' || ordering === null || ordering=== undefined ){
        } else {
              order === ordering ? order = "-" +ordering : order = ordering
        }
        $(".sorting_item_name").html("품명▽")
        $(".sorting_item_code").html("품번▽")
        $(".sorting_item_nice_number").html("나이스번호▽")
        switch(order){
            case "item__name":
                $(".sorting_item_name").html("품명▼")
                break;
            case "-item__name":
                $(".sorting_item_name").html("품명▲")
                break;
            case "item__code":
                $(".sorting_item_code").html("품번▼")
                break;
            case "-item__code":
                $(".sorting_item_code").html("품번▲")
                break;
             case "item__nice_number":
                $(".sorting_item_nice_number").html("나이스번호▼")
                break;
            case "-item__nice_number":
                $(".sorting_item_nice_number").html("나이스번호▲")
                break;
            default:
                break;
        }
           query += "ordering=" + order + "&";


        if (fr_date !== '') query += "fr_date=" + fr_date + "&";
        if (to_date !== '') query += "to_date=" + to_date + "&";
        if (brand !== '') query += "brand=" + brand + "&";
        if (item_group !== '') query += "item_group=" + item_group + "&";
        if (nice_number !== '') query += "nice_number=" + nice_number + "&";
        if (item_name !== '') query += "item_name=" + item_name + "&";
        let total_search = ($('#total_input_search').val() ? $('#total_input_search').val() : "");
        if (total_search !== '') query += "total_search=" + total_search + "&";
        {#if (item_code !== '') query += "item_code=" + item_code + "&";#}
        {#if (detail !== '') query += "detail=" + detail + "&";#}
        {#if (shape !== '') query += "shape=" + shape + "&";#}

        console.log(query);

        api_gp("/items/in/" + query + "/", "GET", {}, (done) => {
            matarial_input_list = done;
            material_input_draw_in_table(done);
        });
    }

    function total_search(){
        let query = "?page=" + nation1.page + "&";

        let total_search = ($('#total_input_search').val() ? $('#total_input_search').val() : "");
        if (total_search !== '') query += "total_search=" + total_search + "&";

        api_gp("/items/in/" + query + "/", "GET", {}, (done) => {
            matarial_input_list = done;
            material_input_draw_in_table(done);
        });
    }

    function enterkey(e) {
        if (e.keyCode == 13) {
            // 엔터키가 눌렸을 때
            form_blank();
            let code = $('#qr_select').val();
            let item_id = '';
            console.log(code)

            api_gp("/items/?code=" + code, "GET", {}, (data) => {
                let item = data.results;
                item_id = item[0].id;
                console.log(item_id);
                $(".material_input_item-code-dropdown").val(item_id).trigger('change')
                    .trigger({type: 'select2:select',
                                params: {
                                    data: {
                                        id: item_id
                                    }
                                }});
            })

            $('#qr_select').val("");
        }
    }

    function make_dropdown(data, selectors) {
        let list = "<option value=''>선택 및 검색</option>";
        for (let i = 0; i < data.length; i++) {
            let item = data[i];
            if (selectors === ".bom-dropdown") {
                list +=
                    "<option value='" +
                    item.id +
                    "'>" +
                    item.bom_name +
                    "</option>";
            } else if (selectors.includes(".material_input_item-code-dropdown")) {
                {#console.table((item));#}
                list +=
                    "<option value='" + item.id + "'" +
                    " data-customer='" + (item.from_id ? item.from_id : "") + "'" +  // 구매처
                    " data-unit='" + (item.unit_id ? item.unit_id : "") + "'" +  // 품명단위
                    " data-name='" + (item.id ? item.id : "") + "'" +  // id
                    {#" data-type='" + (item.type ? item.type.id : "") + "'" +#}
                    " data-model='" + (item.model_id ? item.model_id : "") + "'" +  // 모델
                    " data-standard='" + (item.standard_price ? item.standard_price : "") + "'" +
                    " data-nice_number='" + (item.nice_number ? item.nice_number : "") + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'" +
                    " data-item_division='" + (item.division_id ? item.division_id : "") + "'>" +
                    item.code + "</option>";
            } else if (selectors.includes(".material_input_item-name-dropdown")) {
                list +=
                    "<option value='" + item.id + "'" +
                    " data-customer='" + (item.from_id ? item.from_id : "") + "'" +
                    " data-unit='" + (item.unit ? item.unit.id : "") + "'" +
                    " data-name='" + (item.id ? item.id : "") + "'" +
                    {#" data-type='" + (item.type ? item.type.id : "") + "'" +#}
                    " data-model='" + (item.model_id ? item.model_id : "") + "'" +
                    " data-standard='" + (item.standard_price ? item.standard_price : "") + "'" +
                    " data-nice_number='" + (item.nice_number ? item.nice_number : "") + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'" +
                    " data-item_division='" + (item.division_id ? item.division_id : "") + "'>"
                    + item.name + "</option>";
            } else if (selectors === ".material_input_item-nice_number-dropdown-search") {
                list +=
                    "<option value='" + item.id + "'" +
                    " data-customer='" + (item.from_id ? item.from_id : "") + "'" +
                    " data-unit='" + (item.unit ? item.unit.id : "") + "'" +
                    " data-name='" + (item.id ? item.id : "") + "'" +
                    {#" data-type='" + (item.type ? item.type.id : "") + "'" +#}
                    " data-model='" + (item.model_id ? item.model_id : "") + "'" +
                    " data-standard='" + (item.standard_price ? item.standard_price : "") + "'" +
                    " data-nice_number='" + (item.nice_number ? item.nice_number : "") + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'" +
                    " data-item_division='" + (item.division_id ? item.division_id : "") + "'>"
                    + item.nice_number + "</option>";
            }   else {
                list +=
                    "<option value='" + item.id + "'>" + item.name + "</option>";
            }
        }
        $(selectors).html(list);

        if (
            {#selectors === ".customer-dropdown" ||#}
            selectors === ".unit-dropdown"
        ) {
            $(selectors).select2({width: "100%"}).prop("disabled", true);
        } else {
            $(selectors).select2({width: "100%"});
        }
    }


    function init_item_select(){
        api_gp("/items_part/", "GET", {}, (data) => {
            make_dropdown(data, ".material_input_item-name-dropdown-search");
            make_dropdown(data, ".material_input_item-code-dropdown-search");
            make_dropdown(data, ".material_input_item-nice_number-dropdown-search")
            make_dropdown(data, ".material_input_item-name-dropdown")
            make_dropdown(data, ".material_input_item-code-dropdown");
            make_dropdown(data, ".material_input_item-nice_number-dropdown")
            {#make_dropdown(data, ".material_input_item-name-dropdown")#}

            $('#material_input_item-code').on('select2:select', function (e) { // items 품번을 선택했을때 작동을 함
                let select2_data = e.params.data;
                console.log("select2_data_id", select2_data);

                if (select2_data.id === '') {
                    $(".customer-dropdown").val("").trigger("change");
                    $(".unit-dropdown").val("").trigger("change");
                    $(".material_input_item-name-dropdown").val("").trigger("change");
                    $(".item-type-dropdown").val("").trigger("change");
                    $(".model-dropdown").val("").trigger("change");
                    $(".item-division-dropdown").val("").trigger("change");
                    $(".item-brand-dropdown").val("").trigger("change");
                    $(".item-item_group-dropdown").val("").trigger("change");
                    $(".material_input_item-nice_number-dropdown").val("").trigger('change');
                    $("#material_input_item-detail").val("");
                    $("#material_input_item-shape").val("");

                    $("#material_input_item-code-direct").attr("disabled", false);
                    $("#material_input_item-name-direct").attr("disabled", false);
                    $("#material_input_item-nice_number-direct").attr("disabled", false);
                } else {
                    let name_value = $(this).val();
                    let unit_value = $(this).find("option:selected").data("unit");
                    let type_value = $(this).find("option:selected").data("type");
                    let model_value = $(this).find("option:selected").data("model");
                    let item_division_value = $(this).find("option:selected").data("item_division");
                    let customer_value = $(this).find("option:selected").data("customer");
                    let standard = $(this).find("option:selected").data("standard");
                    let detail = $(this).find("option:selected").data("detail");
                    let brand = $(this).find("option:selected").data("brand");
                    let item_group = $(this).find("option:selected").data("item_group");
                    let shape = $(this).find("option:selected").data("shape");

                    $(".material_input_item-name-dropdown").val(name_value).trigger('change');
                    $(".customer-dropdown").val(customer_value).trigger('change');
                    $(".unit-dropdown").val(unit_value).trigger('change');
                    $(".item-type-dropdown").val(type_value).trigger('change');
                    $(".model-dropdown").val(model_value).trigger('change');
                    $("#material_input_item-detail").val(detail);
                    $(".material_input_item-nice_number-dropdown").val(name_value).trigger('change');
                    $(".item-item_group-dropdown").val(item_group).trigger('change');
                    $(".item-brand-dropdown").val(brand).trigger('change');
                    $("#material_input_item-shape").val(shape);
                    $(".item-division-dropdown").val(item_division_value).trigger('change');

                    $("#material_input_in-price").val(standard);
                    $("#material_input_item-code-direct").val("");
                    $("#material_input_item-name-direct").val("");
                    $("#material_input_item-nice_number-direct").val("");
                    $("#material_input_item-code-direct").attr("disabled", true);
                    $("#material_input_item-name-direct").attr("disabled", true);
                    $("#material_input_item-nice_number-direct").attr("disabled", true);
                }
            });

            $('#material_input_item-name').on('select2:select', function (e) { // items 품명을 선택했을때 작동을 함
                let select2_data = e.params.data;
                {#console.log("select2_data_id", select2_data.id);#}

                if (select2_data.id === '') {
                    $(".customer-dropdown").val("").trigger("change");
                    $(".unit-dropdown").val("").trigger("change");
                    $(".material_input_item-code-dropdown").val("").trigger("change");
                    $(".item-type-dropdown").val("").trigger("change");
                    $(".model-dropdown").val("").trigger("change");
                    $(".item-division-dropdown").val("").trigger("change");
                    $(".item-brand-dropdown").val("").trigger("change");
                    $(".item-item_group-dropdown").val("").trigger("change");
                    $(".material_input_item-nice_number-dropdown").val("").trigger('change');
                    $("#material_input_item-detail").val("");
                    $("#material_input_item-shape").val("");

                    $("#material_input_item-code-direct").attr("disabled", false);
                    $("#material_input_item-name-direct").attr("disabled", false);
                    $("#material_input_item-nice_number-direct").attr("disabled", false);
                } else {
                    let code_value = $(this).val();
                    let unit_value = $(this).find("option:selected").data("unit");
                    let type_value = $(this).find("option:selected").data("type");
                    let model_value = $(this).find("option:selected").data("model");
                    let item_division_value = $(this).find("option:selected").data("item_division");
                    let customer_value = $(this).find("option:selected").data("customer");
                    let standard = $(this).find("option:selected").data("standard");
                    let detail = $(this).find("option:selected").data("detail");
                    let brand = $(this).find("option:selected").data("brand");
                    let item_group = $(this).find("option:selected").data("item_group");
                    let shape = $(this).find("option:selected").data("shape");

                    $(".material_input_item-code-dropdown").val(code_value).trigger('change');
                    $(".customer-dropdown").val(customer_value).trigger('change');
                    $(".unit-dropdown").val(unit_value).trigger('change');
                    $(".item-type-dropdown").val(type_value).trigger('change');
                    $(".model-dropdown").val(model_value).trigger('change');
                    $(".item-division-dropdown").val(item_division_value).trigger('change');
                    $("#material_input_item-detail").val(detail);
                    $(".material_input_item-nice_number-dropdown").val(code_value).trigger('change');
                    $(".item-item_group-dropdown").val(item_group).trigger('change');
                    $(".item-brand-dropdown").val(brand).trigger('change');
                    $("#material_input_item-shape").val(shape);
                    $(".item-division-dropdown").val(item_division_value).trigger('change');

                    $("#material_input_in-price").val(standard);
                    $("#material_input_item-code-direct").val("");
                    $("#material_input_item-name-direct").val("");
                    $("#material_input_item-nice_number-direct").val("");

                    $("#material_input_item-code-direct").attr("disabled", true);
                    $("#material_input_item-name-direct").attr("disabled", true);
                    $("#material_input_item-nice_number-direct").attr("disabled", true);
                }
            });

            $('#material_input_item-nice_number').on('select2:select', function (e) { // items 품명을 선택했을때 작동을 함
                let select2_data = e.params.data;
                {#console.log("select2_data_id", select2_data.id);#}

                if (select2_data.id === '') {
                    $(".customer-dropdown").val("").trigger("change");
                    $(".unit-dropdown").val("").trigger("change");
                    $(".material_input_item-name-dropdown").val("").trigger("change");
                    $(".material_input_item-code-dropdown").val("").trigger("change");
                    $(".item-type-dropdown").val("").trigger("change");
                    $(".model-dropdown").val("").trigger("change");
                    $(".item-division-dropdown").val("").trigger("change");
                    $(".item-brand-dropdown").val("").trigger("change");
                    $(".item-item_group-dropdown").val("").trigger("change");
                    $("#material_input_item-detail").val("");
                    $("#material_input_item-shape").val("");

                    $("#material_input_item-code-direct").attr("disabled", false);
                    $("#material_input_item-name-direct").attr("disabled", false);
                    $("#material_input_item-nice_number-direct").attr("disabled", false);
                } else {
                    let code_value = $(this).val();
                    let unit_value = $(this).find("option:selected").data("unit");
                    let type_value = $(this).find("option:selected").data("type");
                    let model_value = $(this).find("option:selected").data("model");
                    let item_division_value = $(this).find("option:selected").data("item_division");
                    let customer_value = $(this).find("option:selected").data("customer");
                    let standard = $(this).find("option:selected").data("standard");
                    let detail = $(this).find("option:selected").data("detail");
                    let brand = $(this).find("option:selected").data("brand");
                    let item_group = $(this).find("option:selected").data("item_group");
                    let shape = $(this).find("option:selected").data("shape");

                    $(".material_input_item-code-dropdown").val(code_value).trigger('change');
                    $(".material_input_item-name-dropdown").val(code_value).trigger('change');
                    $(".customer-dropdown").val(customer_value).trigger('change');
                    $(".unit-dropdown").val(unit_value).trigger('change');
                    $(".item-type-dropdown").val(type_value).trigger('change');
                    $(".model-dropdown").val(model_value).trigger('change');
                    $(".item-division-dropdown").val(item_division_value).trigger('change');
                    $("#material_input_item-detail").val(detail);
                    $(".item-item_group-dropdown").val(item_group).trigger('change');
                    $(".item-brand-dropdown").val(brand).trigger('change');
                    $("#material_input_item-shape").val(shape);
                    $(".item-division-dropdown").val(item_division_value).trigger('change');

                    $("#material_input_in-price").val(standard);
                    $("#material_input_item-code-direct").val("");
                    $("#material_input_item-name-direct").val("");
                    $("#material_input_item-nice_number-direct").val("");

                    $("#material_input_item-code-direct").attr("disabled", true);
                    $("#material_input_item-name-direct").attr("disabled", true);
                    $("#material_input_item-nice_number-direct").attr("disabled", true);
                }
            });
        });
    }

    function material_input_init() {
        init_item_select();

        api_gp("/customers_select/", "GET", {}, (data) => {
            console.log(data);
            make_dropdown(data, ".customer-dropdown");
            make_dropdown(data, ".customer-search-dropdown");
        });

        api_gp("/bom/master/", "GET", {}, (data) => {
            make_dropdown(data, ".bom-dropdown");
        });

        api_gp("/codes/?group=115&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".item-type-dropdown");
        });

        api_gp("/codes/?group=116&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".model-dropdown");
        });

        api_gp("/codes/?group=118&enable=true", "GET", {}, (data) => {
            make_dropdown(data.results, ".item-division-dropdown");
        });

        api_gp("/codes/?group=105&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".unit-dropdown");
        });
        api_gp("/codes_select/?group=107&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".location-dropdown");
        });
        api_gp("/codes_select/?group=127&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".item-brand-dropdown");
            make_dropdown(data, ".item-brand-search-dropdown");
        });
        api_gp("/codes_select/?group=128&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".item-item_group-dropdown");
            make_dropdown(data, ".item-item_group-search-dropdown");
        });


        set_default_value();
    }

    function set_default_value(){
        $("#material_input_main-form [name='package-amount']").val('0');
        $("#material_input_main-form [name='receive-amount']").val('0');
        $("#material_input_main-form [name='in-faulty-amount']").val('0');
        $("#material_input_main-form [name='in-amount']").val('0');
        $("#material_input_main-form [name='in-price']").val('0');

        $("#material_input_item-code").attr("disabled", false);
        $("#material_input_item-name").attr("disabled", false);
        $("#item-brand").attr("disabled", false);
        $("#item-item_group").attr("disabled", false);
        $("#material_input_item-nice_number").attr("disabled", false);
        $("#material_input_item-shape").attr("disabled", false);
        $("#material_input_item-detail").attr("disabled", false);

        $("#material_input_item-code-direct").attr("disabled", false);
        $("#material_input_item-name-direct").attr("disabled", false);
        $("#material_input_item-nice_number-direct").attr("disabled", false);

        $("#material_input_item-code-direct").val("");
        $("#material_input_item-name-direct").val("");
        $("#material_input_item-nice_number-direct").val("");
    }

    function material_input_get_form_data() {
        let data = {};

        material_input_columns.forEach((item) => {
            if (item === "enable")
                data[item] =
                    $('#material_input_main-form [name="' + item + '"]').val() ===
                    "사용";
            else if (
                item === "receive-amount" ||
                item === "in-faulty-amount" ||
                item === "in-price"
            ) {
                data[item.replace(/-/gi, "_")] = parseFloat($('#material_input_main-form [name="' + item + '"]').val().replace(/,/g, ""));
            } else if (item === "in-amount") {
                data["package_amount"] = parseFloat($('#material_input_main-form [name="' + item + '"]').val().replace(/,/g, ""));
            } else
                data[item.replace(/-/gi, "_")] = $(
                    '#material_input_main-form [name="' + item + '"]'
                ).val();
        });
        data.item = data["item_code"];

        return data;
    }

    function form_blank() {
        material_input_columns.forEach((item) => {
            if(item ==="tax"){
                  document.querySelector("#material_input_main-form [name='" + item + "']").checked =true
            }else {
                $("#material_input_main-form [name='" + item + "']").val(null).trigger("change");
            }
        });
        document.querySelectorAll("#material_input_tbody > tr").forEach(data=>
        data.classList.remove("clicked"))
        material_input_id_idx = null;
        $("#in-at").datepicker("setDate", "today");
        set_default_value();
    }

    function add_item_in(_data) {
        api_gp("/items/in/", "POST", _data, (done) => {
            nation1.page = 1;
            material_input_id_idx = null;

            if (done.qr_path){
                $("[name=qr]").val(done.qr_path);
            }

            alert("등록하였습니다.");
            init_item_select();
            search();

        }, () => {
            alert("실패했습니다.");
        });
    }

    function validation_check(_item_code_direct, _item_name_direct, _item_nice_number_direct){
        let valid = true;

        if ($("#material_input_main-form [name='package-amount']").val() == "" ||
            $("#material_input_main-form [name='package-amount']").val() == null) {
            $("#material_input_main-form [name='package-amount']").val('0');
        }

        if ($("#material_input_main-form [name='receive-amount']").val() == "" ||
            $("#material_input_main-form [name='receive-amount']").val() == null) {
            $("#material_input_main-form [name='receive-amount']").val('0');
        }

        if ($("#material_input_main-form [name='in-faulty-amount']").val() == "" ||
            $("#material_input_main-form [name='in-faulty-amount']").val() == null) {
            $("#material_input_main-form [name='in-faulty-amount']").val('0');
        }

        if ($("#material_input_main-form [name='in-price']").val() == "" ||
            $("#material_input_main-form [name='in-price']").val() == null) {
            $("#material_input_main-form [name='in-price']").val('0');
        }

        $("#material_input_main-form [name='in-at']").css("border", "1px solid #ced4da");
        if ($("#material_input_main-form [name='in-at']").val() == "" ||
            $("#material_input_main-form [name='in-at']").val() == null) {
            $("#material_input_main-form [name='in-at']").css("border", "1px solid red");
            valid = false;
        }

        $("#material_input_main-form [name='item-code-direct']").css("border", "1px solid #ced4da");
        if ($("#material_input_main-form [name='item-code']").val() == "" ||
            $("#material_input_main-form [name='item-code']").val() == null) {

            if (_item_code_direct == ''){
                $("#material_input_main-form [name='item-code-direct']").css("border", "1px solid red");
                valid = false;
            }
        }

        $("#material_input_main-form [name='item-name-direct']").css("border", "1px solid #ced4da");
        if ($("#material_input_main-form [name='item-name']").val() === "" ||
            $("#material_input_main-form [name='item-name']").val() === null) {

            if (_item_name_direct === ''){
                $("#material_input_main-form [name='item-name-direct']").css("border", "1px solid red");
                valid = false;
            }
        }

        $("#material_input_main-form [name='item-nice_number-direct']").css("border", "1px solid #ced4da");
        if ($("#material_input_main-form [name='item-nice_number']").val() === "" ||
            $("#material_input_main-form [name='item-nice_number']").val() === null) {

            if (_item_nice_number_direct === ''){
                $("#material_input_main-form [name='item-nice_number-direct']").css("border", "1px solid red");
                valid = false;
            }
        }

        return valid;
    }

    function material_input_add() {
        let item_code_direct = $("#material_input_main-form [name='item-code-direct']").val();
        if (item_code_direct == '' || item_code_direct == null){
            item_code_direct = $("#material_input_main-form #material_input_item-code :selected").text();
            if (item_code_direct == '선택 및 검색') {
                item_code_direct = '';
            }
        }

        let item_name_direct = $("#material_input_main-form [name='item-name-direct']").val();
        if (item_name_direct == '' || item_name_direct == null){
            item_name_direct = $("#material_input_main-form #material_input_item-name :selected").text();
            if (item_name_direct == '선택 및 검색'){
                item_name_direct = '';
            }
        }

        let item_nice_number_direct = $("#material_input_main-form [name='item-nice_number-direct']").val();
        if (item_nice_number_direct == '' || item_nice_number_direct == null){
            item_nice_number_direct = $("#material_input_main-form #material_input_item-nice_number :selected").text();
            if (item_nice_number_direct == '선택 및 검색'){
                item_nice_number_direct = '';
            }
        }

        alert(item_code_direct);

        {#console.log(item_code_direct, item_name_direct, item_nice_number_direct, material_input_get_form_data());#}

        let valid = validation_check(item_code_direct, item_name_direct, item_nice_number_direct);
        {#console.log(valid);#}
        {#valid = false;#}
        if (valid) {
            // 품목 기준정보 관리에 있는지 검토
            api_gp("/items/?code_i=" + item_code_direct, "GET", {}, (data) => {

                console.table(data);

                if (data.count == 0) {  // 품목 기준정보가 없는 경우, 품목 추가
                    console.log("1");
                    let form = new FormData();

                    form.append("code", item_code_direct);
                    form.append("name", item_name_direct);
                    form.append("nice_number", item_nice_number_direct);
                    form.append("qr_path", '');
                    api_post_detail_itemmaster_form(form, () => {
                        api_gp("/items/?code_i=" + item_code_direct, "GET", {}, (data) => {

                            // 생성된 데이터가 있을때
                            let data2 = material_input_get_form_data();
                            data2.item = data.results[0].id;
                            data2["item-code"] = item_code_direct;
                            data2["item-name"] = item_name_direct;
                            data2["item-nice_number"] = item_nice_number_direct;
                            add_item_in(data2);
                            return true;
                        });
                    });
                } else {  // 품목 기준정보가 있는 경우, 재고 입고
                    let data3 = material_input_get_form_data();

                    if (item_code_direct != ''){  // Select 가 있는 경우
                        data3.item = data.results[0].id;
                    }

                    console.log("3");
                    data3["item-code"] = item_code_direct;
                    data3["item-name"] = item_name_direct;
                    data3["item-nice_number"] = item_nice_number_direct;
                    console.table(data3);

                    add_item_in(data3);
                    return true;
                }
            });
        } else {
            alert("데이터가 유효하지 않습니다.");
            return false;
        }
    }

    // Todo : 입고 수정시, 만약 품번을 변경 가능하도록 한다면, 현재고값이 틀어짐 >> 품번 변경 못하도록 함 (기획 요청)
    function material_input_edit() {

        let item_code_direct = $("#material_input_main-form [name='item-code-direct']").val();
        let item_name_direct = $("#material_input_main-form [name='item-name-direct']").val();
        let item_nice_number_direct = $("#material_input_main-form [name='item-nice_number-direct']").val();
        let valid = validation_check(item_code_direct, item_name_direct, item_nice_number_direct);

        if (valid) {
            // 품목 기준정보 관리에 있는지 검토
            api_gp("/items/?code_i=" + item_code_direct, "GET", {}, (data) => {

                if (data.length == 0) {  // 품목 기준정보가 없는 경우, 품목 추가
                    console.log("1");
                    let form = new FormData();

                    form.append("code", item_code_direct);
                    form.append("name", item_name_direct);
                    form.append("nice_number", item_nice_number_direct);
                    api_post_detail_itemmaster_form(form, () => {
                        api_gp("/items/?code_i=" + item_code_direct, "GET", {}, (data1) => {

                            // 생성된 데이터가 있을때
                            let data2 = material_input_get_form_data();
                            data2.item = data1[0].id;
                            api_gp(
                                "/items/in/" + material_input_id_idx + "/", "PATCH", data2, (done) => {
                                    search();
                                    alert("수정하였습니다.");
                                }
                            );
                            return true;
                        });
                    });
                } else {  // 품목 기준정보가 있는 경우, 재고 수정
                    console.log("2");

                    let data3 = material_input_get_form_data();
                    console.log(data3);
                    if (item_code_direct != ''){  // Select 가 있는 경우
                        data3.item = data[0].id;
                    }

                    api_gp(
                        "/items/in/" + material_input_id_idx + "/", "PATCH", data3, (done) => {
                            search();
                            alert("수정하였습니다.");
                        }
                    );
                    return true;
                }
            });
        } else return false;
    }

    function material_input_remove() {
        let data = material_input_get_form_data();
        api_gp("/items/in/" + material_input_id_idx + "/", "DELETE", data, (data) => {
                nation1.page = 1;
                form_blank();
                search();
                alert("삭제하였습니다.");
            }
        );
    }

    function in_amount_calc() {
        let sum = _numberWithCommas(
            parseFloat($("#material_input_receive-amount").val().replace(/[\{\}\[\]\/?,;:|\)*~`!^\+_<>@\#$%&\\\=\(\'\"]/g, '')) -
            parseFloat($("#material_input_in-faulty-amount").val().replace(/[\{\}\[\]\/?,;:|\)*~`!^\+_<>@\#$%&\\\=\(\'\"]/g, ''))
        );
        sum = parseFloat(sum.replace(/[\{\}\[\]\/?,;:|\)*~`!^\+_<>@\#$%&\\\=\(\'\"]/g, '')).toFixed(12);
        $("#material_input_in-amount").val(parseFloat(sum).toLocaleString());
    }

    // ANCHOR  input_submit
    function input_submit(e) {
        e.preventDefault();
        nation1.page = 1;
        material_input_id_idx = null;
        order= ""
        search();
        return false;
    }

    function spinner() {
        $("#spinner").remove();
    }

    function show_qr_print(_imgurl){

        var url = "/material/qr_print/?param1=";
        url = url + _imgurl;
        var name = "QR Print";
        var option = "width=1000px, height=1000px, location=no";
        window.open(url, name, option);

    }

</script>
</script>
<!-- {#{% endblock %}#} -->
</body>
</html>
