<!DOCTYPE html>
<html>
<header>{% include "header.html" %}

</header>
<body style="overflow: hidden;">
<!-- {#{% extends 'index.html' %}#} -->
{% load static %}
<!-- {#{% block title %}#}
{#    <title>ÏûêÏû¨Ïû¨Í≥†Ïã§ÏÇ¨ Ï°∞Ï†ï</title>#}
{#{% endblock title %}#}
{##}
{#{% block content %}#} -->

<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px"/>
</div>
<!-- Í≤ÄÏÉâ -->
<form class="card m-2" id="adjust_search">
    <div class="card-body p-2">
        <!-- Î≥∏Î¨∏ -->
        <div
                class="content-search row no-gutters align-items-center content-input-group"
        >
            <div class="col-11">
                <div class="row no-gutters">
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>Î∏åÎûúÎìú</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control brand-dropdown-search"
                                    id="brand_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>Ï†úÌíàÍµ∞</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control item_group-dropdown-search"
                                    id="item_group_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label>ÌíàÎ≤à</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control item-code-dropdown-search"
                                    id="item_code_search"
                            ></select>
                        </div>
                    </div>
                </div>
                <div class="row no-gutters">
                    <div class="content-input-group col-3 px-0">
                        <div class="content-input-group-header">
                            <label id="n_bom_model1">ÎÇòÏù¥Ïä§Î≤àÌò∏</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control nice_number-dropdown-search"
                                    id="nice_number_search"
                            ></select>
                        </div>
                    </div>
                </div>
            </div>
               <div class="col-1 ml-auto px-0">
                        <button class="btn button-search rounded-0 w-100 h-100">
                            Í≤ÄÏÉâ
                        </button>
                    </div>
        </div>
                <div class="row no-gutters">
                      <div class="content-input-group col-4 mt-2">
                        <div class="content-input-group-input input-group">
                            <input class="form-control" id="multiSearch" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî
                            "/>
                          <div class="input-group-append">
                     <button class="btn btn-outline-secondary" type="button" onclick="nation1.page =1; search();"> üîç</button>

                        </div>
                        </div>
                    </div>
                </div>
    </div>

</form>

<!-- ÎÇ¥Ïö© -->
<form class="card m-2" id="detail_adjust">
    <div class="row no-gutters card-body p-2">
        <!-- Î≥∏Î¨∏ -->
        <div class="content-content w-100">
            <div class="row no-gutters w-100">
                <div class="col-1 content-title">Ïû¨Í≥†Ï°∞Ï†ï</div>
                <div class="col-11">
                    <div class="row no-gutters">
                        <!-- TODO: Ïã§ÏÇ¨Ïû¨Í≥† ÏàòÎüâ Î°úÏßÅÏùÑ Ïûò Î™®Î•¥Í≤†Ïùå... -->
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Î∏åÎûúÎìú</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control brand-dropdown"
                                        name="item-brand"
                                        id="item-brand" disabled>
                                </select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Ï†úÌíàÍµ∞</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control item_group-dropdown"
                                        name="item_group"
                                        id="item_group" disabled>

                                </select>
                            </div>
                        </div>
                           <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌíàÎ™Ö<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control item-name-dropdown" id="item-name" name="item-name"></select>
                            </div>
                        </div>
                           <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌíàÎ≤à<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control item-code-dropdown" id="item-code" name="item-code"></select>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <!-- TODO: Ïã§ÏÇ¨Ïû¨Í≥† ÏàòÎüâ Î°úÏßÅÏùÑ Ïûò Î™®Î•¥Í≤†Ïùå... -->
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÎÇòÏù¥Ïä§ Î≤àÌò∏<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control nice_number-dropdown"
                                        name="nice_number"
                                        id="nice_number"
                                >
                                </select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌíàÎ™ÖÏÉÅÏÑ∏</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="item-detail"
                                        id="item-detail" disabled/>
                            </div>
                        </div>
                           <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ÌòïÌÉú</label>
                            </div>
                   <div class="content-input-group-input">
                                <input  class="form-control" name="item-shape" id="item-shape" disabled/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Ï°∞Ï†ïÏàòÎüâ<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="amount" name="amount" onkeyup="_chkNumber(this, 3)"/>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <!-- TODO: Ïã§ÏÇ¨Ïû¨Í≥† ÏàòÎüâ Î°úÏßÅÏùÑ Ïûò Î™®Î•¥Í≤†Ïùå... -->
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Ï°∞Ï†ï ÎÇ†Ïßú<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control datepicker" id="adjustDate" name="adjustDate"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>Ï°∞Ï†ï Ï∞ΩÍ≥†</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control location-dropdown" id="location" name="location">
                                </select>
                            </div>
                        </div>
                           <div class="content-input-group col-6">
                            <div class="content-input-group-header">
                                <label>Ï°∞Ï†ïÏÇ¨Ïú†</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="reason" name="reason"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row no-gutters w-100 justify-content-end">
                <div class="col-1 px-0 mr-2">
                    <button class="btn button-custom2 w-100" type="button" onclick="form_blank()">
                        Ï¥àÍ∏∞Ìôî
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button class="btn button-custom2 w-100" type="button" onclick="material_adjust_add()">
                        Îì±Î°ù
                    </button>
                </div>
{#                <div class="col-1 px-0 mr-2">#}
{#                    <button class="btn button-custom2 w-100" type="button" onclick="material_adjust_edit()">#}
{#                        ÏàòÏ†ï#}
{#                    </button>#}
{#                </div>#}
{#                <div class="col-1 px-0 mr-2">#}
{#                    <button class="btn button-custom2 w-100" type="button" onclick="material_adjust_delete()">#}
{#                        ÏÇ≠Ï†ú#}
{#                    </button>#}
{#                </div>#}
                </div>
        </div>
    </div>
</form>

<!-- ÌÖåÏù¥Î∏î -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- Î≥∏Î¨∏ -->
        <div class="content-table col-12" style="overflow-y: hidden;">
            <table id="material_adjust_data-table" class="table table-sm text-center" style="min-width: 1300px"
            >
                <thead>
                <tr>
                    <th>ÏàúÎ≤à</th>
                    <th>Ï°∞Ï†ïÎÇ†Ïßú</th>
                    <th>Î∏åÎûúÎìú</th>
                    <th>Ï†úÌíàÍµ∞</th>
                    <th class="sorting_item_name" onclick="search('name')">ÌíàÎ™Ö</th>
                    <th class="sorting_item_code" onclick="search('code')">ÌíàÎ≤à</th>
                    <th class="sorting_item_nice_number" onclick="search('nice_number')">ÎÇòÏù¥Ïä§Î≤àÌò∏</th>
                    <th>ÌíàÎ™ÖÏÉÅÏÑ∏</th>
                    <th>ÌòïÌÉú</th>
                    <th>Í∏∞Ï°¥ Ï†ÑÏÇ∞Ïû¨Í≥†</th>
                    <th>Ï°∞Ï†ï ÏàòÎüâ</th>
                    <th>Ï°∞Ï†ïÌõÑ ÏàòÎüâ</th>
                    <th>ÌòÑÏû¨Í≥†</th>
                    <th>Ï°∞Ï†ïÏ∞ΩÍ≥†</th>
                    <th>Ï°∞Ï†ïÏÇ¨Ïú†</th>
                    <th>Ïã§ÏÇ¨Ï°∞Ï†ïÏûê</th>
                </tr>
                </thead>
                <tbody id="material-adjust-tbody"></tbody>
            </table>
            <div class="row no-gutters d-flex justify-content-center" id="item_nation"
                 style="margin-top: -20px;">
            </div>
{#    <div class="col-1 ml-auto">#}
{#                 <a href="#" id="excel-export" class="col-1 text-center">#}
{#                    <img src="/static/img/i_excel_c.png" width="38" height="38" />#}
{#                    <p class="mb-0">ÏóëÏÖÄ Î≥ÄÌôò</pi>#}
{#                </a>#}
{#            </div>#}
        </div>
    </div>
</div>
<script src="{% static 'js/api_materials.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>
<script>
    let nation_data1 = {
        cname : 'nation1',  // Ïù∏Ïä§ÌÑ¥Ïä§ Î™ÖÍ≥º ÏùºÏπòÌï¥ÏïºÌï®
        table_id: 'item_nation',
        range: 5,
        page_size: 15,
    };

    let nation1 = new Pnations(nation_data1, search);  // Ïù∏Ïä§ÌÑ¥Ïä§ Î™Ö

    $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
    });

    // click on "Í≤ÄÏÉâ" on the right side of "Í∑∏Î£πÏΩîÎìú"
    $("#adjust_search").submit(function (e) {
        e.preventDefault();
        nation1.page = 1;
        material_adjust_id_idx = null;
        order =""
        $("#amount").val("");
        $("#reason").val("");
        search();
        return false;
    });

    var material_adjust_id_idx = null;
    var material_adjust_amount;
    // TODO: Ïã§ÏÇ¨Ïû¨Í≥†ÏàòÎüâ Ï∂îÍ∞ÄÌï¥ÏïºÌï®
    var material_adjust_columns = ["amount", "location", "reason", "item-brand", "item_group", "item-name", "item-code", "nice_number", "item-detail", "item-shape",  "adjustDate"];
    // let filters = ['factory', 'process', 'enable', 'name'];

    $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
    });
    $(".datepicker").datepicker("setDate", "today");

    function main_table_draw(done) {
        console.log(done);

        let data = done.results;
        let num = (((nation1.page*1) - 1) * nation_data1["page_size"]) + 1 ;

        let rows = "";
        for (let i = 0; i < data.length; i++) {
            let item = data[i];
            // TODO: Ïã§ÏÇ¨ÏùºÏûê Ïó¨Í∏∞ÏÑú filtering Ìï† Í≤É.
            let latest = {
                previous_amount: item.stock,
                current_amount: item.stock,
            };
            let reasons = "";
            let adjust_amount = 0;
            if(item.adjusts.length !== 0) {
                for (let a = 0; a < item.adjusts.length; a++) {
                    let num = 1;
                    let adjust = item.adjusts[a];
                    console.log(adjust);
                    reasons = nullapply(adjust.reason);
                    if (a === item.adjusts.length - 1) latest = adjust;
                    let row =
                        "<tr id='" +
                        item.id +
                        "' data-amount='" +
                        latest.current_amount +
                        "' style='cursor:pointer;'>";
                    row += "<td>" + (num++) + "</td>";
                    row += "<td data-item='adjustDate'>" + item.created_at + "</td>"; // Ï°∞Ï†ïÎÇ†Ïßú
                    row += "<td data-item='item-brand'" + `item-id='${item.brand_id}'>` + (item.brand_name ? item.brand_name : "") + "</td>"; // ÌíàÎ≤à
                    row += "<td data-item='item_group'" + `item-id='${item.item_group_id}'>` + (item.item_group_name ? item.item_group_name : "") + "</td>"; // ÌíàÎ≤à
                    row += "<td data-item='item-name'" + `item-id='${item.id}' class='d-none'>` + item.name + "</td>"; // ÌíàÎ™Ö
                    row += `<td data-item='item-name title=${item.name} data-toggle='tooltip'>${item.name.length >10 ? item.name.slice(0,10) + "...": item.name}</td>`
                    row += "<td data-item='item-code'" + `item-id='${item.id}' class='d-none'>` + item.code + "</td>"; // ÌíàÎ≤à
                    row += `<td data-item='item-code' title=${item.code} data-toggle='tooltip'>${item.code.length >10 ? item.code.slice(0,10) + "...": item.code}</td>`
                    row += "<td data-item='nice_number'" + `item-id='${item.id}' class='d-none'>` + (item.nice_number ? item.nice_number : "") + "</td>"; // ÌíàÎ≤à
                    row += `<td data-item='nice_number' title=${item.nice_number} data-toggle="tooltip">` + (item.nice_number ? item.nice_number.length >10 ? item.nice_number.slice(0,10) + "..." : item.nice_number : "") + "</td>"; // ÌíàÎ≤à
                    row += "<td data-item='item-detail' class='d-none'>" + (item.detail ? item.detail : "") + "</td>"; // ÌíàÎ≤à
                    row += `<td data-item='item-detail' title=${item.detail} data-toggle="tooltip">` + (item.detail ? item.detail.length>10 ? item.detail.slice(0,10) + "..." : item.detail : "") + "</td>"; // ÌíàÎ≤à
                    row += "<td data-item='item-shape'>" + (item.shape ? item.shape : "") + "</td>"; // ÌíàÎ≤à
                    "<td data-item='item-division'>" +
                    (item.division_name ? item.division_name : "") +
                    "</td>"; // ÏûêÏû¨Íµ¨Î∂Ñ
                    row +=
                        "<td data-item='current-amount'>" +
                        (adjust.previous_amount ? adjust.previous_amount.toLocaleString() : 0) +
                        "</td>"; // Í∏∞Ï°¥ Ï†ÑÏÇ∞Ïû¨Í≥†


                    let adjust_num = adjust.current_amount - adjust.previous_amount;
                    if (adjust_num > 1) {
                        row += "<td data-item='diff'>" + '+' + adjust_num.toLocaleString() + "</td>"; // Ï°∞Ï†ï ÏàòÎüâ
                    } else {
                        row += "<td data-item='diff'>" + adjust_num.toLocaleString() + "</td>"; // Ï°∞Ï†ï ÏàòÎüâ
                    }
                    adjust_amount += adjust_num

                    row += "<td data-item='amount'>" + (adjust.current_amount ? adjust.current_amount.toLocaleString() : 0) + "</td>"; // Ï°∞Ï†ïÌõÑ ÏàòÎüâ
                    row += "<td data-item='stock'>" + item.stock.toLocaleString() + "</td>"; // ÌòÑÏû¨Í≥†

                    row += "<td data-item='location'" + `item-id='${(adjust.location ? adjust.location.id : "")}'>` + (adjust.location ? adjust.location.name : "ÏûÖÍ≥†Ï∞ΩÍ≥†") + "</td>"; // Ï°∞Ï†ïÏÇ¨Ïú†
                    row += "<td data-item='reason'>" + nullapply(reasons) + "</td>"; // Ï°∞Ï†ïÏÇ¨Ïú†
                    row += "<td data-item=''>" + item.username + "</td>"; // Ïã§ÏÇ¨Ï°∞Ï†ïÏûê
                    row += "</tr>";

                    rows += row;
                }
                rows += `<tr><td></td> <td colspan="9">ÏÜåÍ≥Ñ</td><td>${numberWithCommas(adjust_amount)}</td><td colspan="5"></td></tr>`
            }
        }

        spinner();
        nation1.nation_display(done);
        $("#material-adjust-tbody").html(rows);

        if (material_adjust_id_idx != null){
            $("#material-adjust-tbody #" + material_adjust_id_idx).addClass('clicked');
        }

        $("#material-adjust-tbody > tr").on("click", function () {
                 if($(this).attr("id") !== undefined ){
                  document.querySelectorAll("#material-adjust-tbody > tr").forEach(subElement=>
                  subElement.classList.remove("clicked"))
                $(this).addClass("clicked");

                material_adjust_columns.forEach((item) => {
                    if (item === "location") {
                        {#let location_value = $(this).find("[data-item='" + item + "']").attr("property");#}
                        {#$("#detail_adjust [name='" + item + "']").val(location_value).trigger("change");#}
                        $("#detail_adjust .location-dropdown").val($(this)
                            .find("[data-item='" + item + "']")
                            .attr("item-id"))
                            .trigger("change");
                    } else if (item === "item-code" || item === "item-name" || item === "nice_number") {
                        $("#detail_adjust .item-name-dropdown").val($(this)
                            .find("[data-item='" + item + "']")
                            .attr("item-id"))
                            .trigger("change");
                        $("#detail_adjust .item-code-dropdown").val($(this)
                            .find("[data-item='" + item + "']")
                            .attr("item-id"))
                            .trigger("change");
                        $("#detail_adjust .nice_number-dropdown").val($(this)
                            .find("[data-item='" + item + "']")
                            .attr("item-id"))
                            .trigger("change");
                    } else if (item === "item-brand") {
                        $("#detail_adjust .brand-dropdown").val($(this)
                            .find("[data-item='" + item + "']")
                            .attr("item-id"))
                            .trigger("change");
                    } else if (item === "item_group") {
                        $("#detail_adjust .item_group-dropdown").val($(this)
                            .find("[data-item='" + item + "']")
                            .attr("item-id"))
                            .trigger("change");
                    } else {
                        $("#detail_adjust [name='" + item + "']").val(
                            $(this)
                                .find("[data-item='" + item + "']")
                                .text()
                        );
                    }
                });
                material_adjust_id_idx = $(this).attr("id");
                material_adjust_amount = $(this).attr("data-amount");

                 }
        });
    }

    $(function () {
        set_naming();
        refresh();

        // Table Export
        $(parent.document).find("#excel-export").click(() =>
            init_excel_export($("#material_adjust_data-table"), "Ïû¨Í≥†Ï°∞Ï†ï")
        );
    });


    function set_naming(){
        let enterprise_name = get_userinfo().enterprise_name;
        if (enterprise_name == '(Ï£º)Í±¥Í∞ïÏÉùÌôúÏó∞Íµ¨ÏÜå'){
            $("#n_bom_model1").text("Ï†úÌíàÍµ∞");
            $("#n_bom_model2").text("Ï†úÌíàÍµ∞");
        }
    }


    function refresh() {
        material_adjust_init();
        {#material_adjust_load_table();#}
        search();
    }

    function material_adjust_load_table() {
        api_gp("/items/adjust/status/", "GET", {}, (data) => {
            main_table_draw(data);
        });
    }
    function form_blank(){
        document.querySelectorAll("#material-adjust-tbody tr").forEach(element=>
                 element.classList.remove("clicked")
        )
        material_adjust_columns.forEach((item) => {
            $(`#detail_adjust [name=${item}]`).val("").trigger("change")
        });
        set_default_value();

    }

    function set_default_value(){
        {#$("#material_output_main-form [name='out-amount']").val('0');#}
        {#$("#material_output_main-form [name='out-price']").val('0');#}

        $("#item-code").attr("disabled", false);
        $("#item-name").attr("disabled", false);
        {#$("#material_output_customer").attr("disabled", false);#}
        $("#nice_number").attr("disabled", false);
    }

    let order = ""
    function search(ordering){
        let customer_search = $('#customer_search :selected').val();
        {#let division_search = $('#division_search :selected').val();#}
        let item_code_search = $('#item_code_search :selected').val();
        let nice_number_search = $('#nice_number_search :selected').val();
        {#let model_search = $('#model_search :selected').val();#}
        let brand = ($('#brand_search :selected').val() ? $('#brand_search :selected').val() : "");
        let item_group = ($('#item_group_search :selected').val() ? $('#item_group_search :selected').val() : "");

        let query = "?page=" + nation1.page + "&";

        let multiSearch = $("#multiSearch").val();

        if (ordering === '' || ordering === null || ordering=== undefined ){
        } else {
              order === ordering ? order = "-" +ordering : order = ordering
        }

        $(".sorting_item_name").html("ÌíàÎ™Ö‚ñΩ")
        $(".sorting_item_code").html("ÌíàÎ≤à‚ñΩ")
        $(".sorting_item_nice_number").html("ÎÇòÏù¥Ïä§Î≤àÌò∏‚ñΩ")
        switch(order){
            case "name":
                $(".sorting_item_name").html("ÌíàÎ™Ö‚ñº")
                break;
            case "-name":
                $(".sorting_item_name").html("ÌíàÎ™Ö‚ñ≤")
                break;
            case "code":
                $(".sorting_item_code").html("ÌíàÎ≤à‚ñº")
                break;
            case "-code":
                $(".sorting_item_code").html("ÌíàÎ≤à‚ñ≤")
                break;
             case "nice_number":
                $(".sorting_item_nice_number").html("ÎÇòÏù¥Ïä§Î≤àÌò∏‚ñº")
                break;
            case "-nice_number":
                $(".sorting_item_nice_number").html("ÎÇòÏù¥Ïä§Î≤àÌò∏‚ñ≤")
                break;
            default:
                break;
        }
        query += "ordering=" + order + "&";
        if (customer_search === '' || customer_search == null){
        } else { query += "purchase_from=" + customer_search + "&"; }
        {#if (division_search == '' || division_search == null){} else { query += "item_division=" + division_search + "&"; }#}
        if (item_code_search === '' || item_code_search == null){
        } else { query += "item_code=" + item_code_search + "&"; }
        if (nice_number_search === '' || nice_number_search == null){
        } else { query += "nice_number=" + nice_number_search + "&"; }
        if (brand !== '') query += "brand=" + brand + "&";
        if (item_group !== '') query += "item_group=" + item_group + "&";
        {#if (item_name_search == '' || item_name_search == null){} else { query += "item=" + item_name_search + "&"; }#}
        {#if (model_search == '' || model_search == null){} else { query += "model=" + model_search + "&"; }#}
        if (multiSearch !=='') query += 'search=' + multiSearch + "&";

        api_gp("/items/adjust/status/" + query + "/", "GET", {}, (done) => {
            main_table_draw(done);
        });
    }

    function material_adjust_init() {
        function make_dropdown(data, selectors) {
            let list = "<option value=''>ÏÑ†ÌÉù Î∞è Í≤ÄÏÉâ</option>";
            let distinct = [];
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                if (selectors.includes('.bom-dropdown')) {
                    list += "<option value='" + item.id + "'>" + item.bom_name + "</option>";
                } else if (selectors.includes('.item-code-dropdown')) {
                    list += "<option value='" + item.id + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                    item.code + "</option>";
                } else if (selectors.includes('.nice_number-dropdown')) {
                    list += "<option value='" + item.id + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                    item.nice_number + "</option>";
                } else if (selectors.includes('.item-name-dropdown')) {
                    if (distinct.indexOf(item.name) === -1) {
                        list += "<option value='" + item.id + "'" +
                        " data-shape='" + (item.shape ? item.shape : "") + "'" +
                        " data-detail='" + (item.detail ? item.detail : "") + "'" +
                        " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                        " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                        item.name + "</option>";
                        distinct.push(item.name);
                    }
                } else {
                    list += "<option value='" + item.id + "'>" + item.name + "</option>";
                }
            }
            $(selectors).html(list);
            $(selectors).select2({width: '100%'});
        }

        // Íµ¨Îß§Ï≤ò
        api_gp('/customers_select/', 'GET', {}, (data) => {
            make_dropdown(data, '.customer-dropdown');
        });

        // ÏûêÏû¨Íµ¨Î∂Ñ
        api_gp('/codes_select/?group=118&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.item-division-dropdown');
        });

        // Î™®Îç∏
        api_gp('/codes_select/?group=116&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.model-dropdown');
        });

        // Î∏åÎûúÎìú
        api_gp('/codes_select/?group=127&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.brand-dropdown');
            make_dropdown(data, '.brand-dropdown-search');
        });

        // Ï†úÌíàÍµ∞
        api_gp('/codes_select/?group=128&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.item_group-dropdown');
            make_dropdown(data, '.item_group-dropdown-search');
        });

        // ÌíàÎ≤à, ÌíàÎ™Ö
        api_gp('/items_part/', 'GET', {}, (data) => {
            make_dropdown(data, '.item-code-dropdown');
            make_dropdown(data, '.item-code-dropdown-search');
            make_dropdown(data, '.item-name-dropdown');
            make_dropdown(data, '.item-name-dropdown-search');
            make_dropdown(data, '.nice_number-dropdown');
            make_dropdown(data, '.nice_number-dropdown-search');

            $('.item-code-dropdown').on('select2:select', function (e) {
                let select2_data = e.params.data;

                let detail = $(this).find("option:selected").data("detail");
                let brand = $(this).find("option:selected").data("brand");
                let item_group = $(this).find("option:selected").data("item_group");
                let shape = $(this).find("option:selected").data("shape");

                $(".item_group-dropdown").val(item_group).trigger('change');
                $(".brand-dropdown").val(brand).trigger('change');
                $("#item-shape").val(shape);
                $("#item-detail").val(detail);

                $(".item-name-dropdown").val(select2_data.id).trigger("change")
                $(".nice_number-dropdown").val(select2_data.id).trigger("change")
                material_adjust_id_idx = select2_data.id;

            })
            $('.item-name-dropdown').on('select2:select', function (e) {
                let select2_data = e.params.data;

                let detail = $(this).find("option:selected").data("detail");
                let brand = $(this).find("option:selected").data("brand");
                let item_group = $(this).find("option:selected").data("item_group");
                let shape = $(this).find("option:selected").data("shape");

                $(".item_group-dropdown").val(item_group).trigger('change');
                $(".brand-dropdown").val(brand).trigger('change');
                $("#item-shape").val(shape);
                $("#item-detail").val(detail);

                $(".item-code-dropdown").val(select2_data.id).trigger("change")
                $(".nice_number-dropdown").val(select2_data.id).trigger("change")
                material_adjust_id_idx = select2_data.id;
            })
            $('.nice_number-dropdown').on('select2:select', function (e) {
                let select2_data = e.params.data;

                let detail = $(this).find("option:selected").data("detail");
                let brand = $(this).find("option:selected").data("brand");
                let item_group = $(this).find("option:selected").data("item_group");
                let shape = $(this).find("option:selected").data("shape");

                $(".item_group-dropdown").val(item_group).trigger('change');
                $(".brand-dropdown").val(brand).trigger('change');
                $("#item-shape").val(shape);
                $("#item-detail").val(detail);

                $(".item-code-dropdown").val(select2_data.id).trigger("change")
                $(".item-name-dropdown").val(select2_data.id).trigger("change")
                material_adjust_id_idx = select2_data.id;
            })

        });
          api_gp("/codes_select/?group=107&enable=true", "GET", {}, (data)=>{
            make_dropdown(data, ".location-dropdown")
        })
    }

    function material_adjust_get_form_data() {
        let current_amount_int = parseFloat($("#detail_adjust [name=amount]").val().replace(/,/g, ''));
        material_adjust_id_idx = $('.item-code-dropdown').val();
        return {
            item: material_adjust_id_idx,
            reason: nullapply($("#detail_adjust [name=reason]").val()),
            current_amount: current_amount_int,
            location: $("#detail_adjust [name=location] :selected").val()
        };

    }


    function material_adjust_add() {
        let data = material_adjust_get_form_data();
        console.log(data);
        api_gp("/items/adjust/", "POST", data, (data) => {
            alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞òÏòÅÌïòÏòÄÏäµÎãàÎã§.");
            material_adjust_load_table();});
    }



    function material_adjust_edit() {
        let data = material_adjust_get_form_data();
        api_gp(`/items/adjust/${material_adjust_id_idx}/`, "PATCH", data, (data) => {
            alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÏòÄÏäµÎãàÎã§.");
            material_adjust_load_table();
        });
    }

    function material_adjust_delete() {
        api_gp(`/items/adjust/${material_adjust_id_idx}/`, "DELETE", {}, (data) => {
            alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÏòÄÏäµÎãàÎã§.");
            material_adjust_load_table();
        });
    }
    // {#function init_excel_export() {#}
    // {#    let now = new Date();#}
    // {#    let month = now.getMonth()+1; if(month.toString().length < 2) { month = '0' + month }#}
    // {#    let day = now.getDate(); if(day.toString().length < 2) { day = '0' + month }#}
    // {#    let date = now.getFullYear() + '_' + month + '_' + day;#}
    // {##}
    // {#    let instance = new TableExport($('#material_adjust_data-table'), {#}
    // {#        formats: ['xlsx'],#}
    // {#        exportButtons: false,#}
    // {#        filename: 'ÏûêÏû¨Ïû¨Í≥†Ïã§ÏÇ¨Ï°∞Ï†ï-' + date,#}
    // {#    });#}
    // {#    let data = instance.getExportData();#}
    // {#    let exportData = data[Object.keys(data)[0]]['xlsx'];#}
    // {#    $("#excel-export").click(() => {#}
    // {#        instance.export2file(exportData.data, exportData.mimeType, exportData.filename, exportData.fileExtension);#}
    // {#    });#}
    // {# }#}

    function spinner() {
        $("#spinner").remove();
    }

</script>
<!-- {#{% endblock %}#} -->
</body>
</html>
