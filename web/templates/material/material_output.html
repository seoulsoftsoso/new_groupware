<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
<body style="overflow: hidden;">
<!-- {#{% extends 'index.html' %}#}  -->
{% load static %}

<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px"/>
</div>

<!-- ê²€ìƒ‰ -->
<div class="card m-2">
    <div class="card-body p-2">
        <!-- ë³¸ë¬¸ -->
        <div
                class="content-search row no-gutters align-items-center content-input-group"
        >
            <form
                    class="col-11"
                    id="material_import_main-form"
                    onsubmit="nation2.page = 1; return output_submit(event)"
            >
                <div class="row no-gutters">
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>ì¶œê³ ê¸°ê°„</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="datepicker form-control"
                                   id="fr_date"/>
                            <div class="btn">~</div>
                            <input class="datepicker form-control"
                                   id="to_date"/>
                        </div>
                    </div>

                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>ê±°ë˜ì²˜ëª…</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control customer-dropdown-search"
                                    id="customer_search"
                                    name="customer_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>ë¸Œëœë“œ</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control brand-dropdown-search"
                                    id="brand_search"
                                    name="brand_search"
                            ></select>
                        </div>
                    </div>

                </div>
                <div class="row no-gutters">
                    {#                     <div class="content-input-group col-2 px-0">#}
                    {#                        <div class="content-input-group-header">#}
                    {#                            <label>í’ˆëª…</label>#}
                    {#                        </div>#}
                    {#                        <div class="content-input-group-input">#}
                    {#                            <select#}
                    {#                                    class="form-control item-name-dropdown-search"#}
                    {#                                    id="item_name_search"#}
                    {#                                    name="item_name_search"#}
                    {#                            ></select>#}
                    {#                        </div>#}
                    {#                    </div>#}
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>ì œí’ˆêµ°</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control item_group-dropdown-search"
                                    id="item_group_search"
                                    name="item_group_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>í’ˆë²ˆ</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control item-code-dropdown-search"
                                    id="item_code_search"
                                    name="item_code_search"
                            ></select>
                        </div>
                    </div>
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>ë‚˜ì´ìŠ¤ë²ˆí˜¸</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control nice_number-dropdown-search"
                                    id="nice_number_search"
                                    name="nice_number_search"
                            ></select>
                        </div>
                    </div>
                    {#                    <div class="content-input-group col-3 px-0">#}
                    {#                        <div class="content-input-group-header">#}
                    {#                            <label>í’ˆëª…ìƒì„¸</label>#}
                    {#                        </div>#}
                    {#                        <div class="content-input-group-input">#}
                    {#                            <input#}
                    {#                                    class="form-control"#}
                    {#                                    id="detail_search"#}
                    {#                                    name="detail_search"#}
                    {#                            />#}
                    {#                        </div>#}
                    {#                    </div>#}
                    {#                    <div class="content-input-group col-2 px-0">#}
                    {#                        <div class="content-input-group-header">#}
                    {#                            <label>í˜•íƒœ</label>#}
                    {#                        </div>#}
                    {#                        <div class="content-input-group-input">#}
                    {#                            <input#}
                    {#                                    class="form-control"#}
                    {#                                    id="shape_search"#}
                    {#                                    name="shape_search"#}
                    {#                            />#}
                    {#                        </div>#}
                    {#                    </div>#}
                </div>
                <div class="row no-gutters">
                    <div class="content-input-group col-4 mt-2">
                        <div class="content-input-group-input input-group">
                            <input class="form-control" id="multiSearch" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                            "/>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="detail_search();">
                                    ğŸ”
                                </button>

                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="col-1 px-0 ml-auto">
                <button
                        class="btn button-search rounded-0 w-100 h-100"
                        type="submit"
                        form="material_import_main-form"
                >
                    ê²€ìƒ‰
                </button>
            </div>
        </div>
    </div>
</div>
{#</div>#}

<!-- í…Œì´ë¸” -->

<!-- ë‚´ìš© -->
<form class="card m-2" id="material_output_detail-form">
    <div class="row no-gutters card-body p-2">
        <!-- ë³¸ë¬¸ -->
        <div class="content-content w-100">
            <div class="row no-gutters w-100 mb-2">
                <div class="col-1 content-title">ì¶œê³ ë“±ë¡</div>
                <div class="col-11">
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ì¶œê³ ì¼ì<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control datepicker"
                                        name="out-at"
                                        id="out-at"
                                />
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ê±°ë˜ì²˜</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control customer-dropdown"
                                        name="purchase_from"
                                        id="rein-customer"
                                ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ë¸Œëœë“œ</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control brand-dropdown"
                                        name="brand"
                                        id="brand" disabled></select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ì œí’ˆêµ°</label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control item_group-dropdown"
                                        name="item_group"
                                        id="item_group" disabled></select>
                            </div>
                        </div>
                    </div>
                      <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>í’ˆëª…<strong>*</strong></label>
                            </div>
                           <div class="content-input-group-input">
                                <select class="form-control item-name-dropdown" name="item-name" id="item-name">
                                </select>
                                </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>í’ˆë²ˆ<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control item-code-dropdown"
                                        name="item-code"
                                        id="item-code"
                                >
                                </select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ë‚˜ì´ìŠ¤ë²ˆí˜¸<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <select
                                        class="form-control nice_number-dropdown"
                                        name="nice_number"
                                        id="nice_number"
                                >
                                </select>
                            </div>
                        </div>
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>í’ˆëª…ìƒì„¸</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="item-detail"
                                        id="item-detail" disabled/>
                            </div>
                        </div>
                    </div>
                      <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>í˜•íƒœ</label>
                            </div>
                           <div class="content-input-group-input">
                                <input  class="form-control" name="item-shape" id="item-shape" disabled/>
                            </div>
                        </div>
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ìì¬ë¶„ë¥˜</label>
                            </div>
                           <div class="content-input-group-input">
                                <select
                                        class="form-control item_division_dropdown"
                                        name="item_division"
                                        id="item_division" disabled></select>
                            </div>
                        </div>
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ì¶œê³ ìˆ˜ëŸ‰<strong>*</strong></label>
                            </div>
                           <div class="content-input-group-input">
                                <input  class="form-control" name="out-amount" id="out-amount" onkeyup="_chkNumber(this, 3)"/>
                            </div>
                        </div>
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ë‹¨ê°€</label>
                            </div>
                           <div class="content-input-group-input">
                                <input  class="form-control" name="out-price" id="out-price" onkeyup="_chkNumber(this, 3)"/>
                            </div>
                        </div>

                    </div>
                      <div class="row no-gutters">
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ë¶€ê°€ì„¸í¬í•¨</label>
                            </div>
                            <div class="content-input-group-input">
                                <div class="form-control w-100">
                                <input
                                        class="checkbox-row"
                                        type="checkbox"
                                        name="tax"
                                        id="tax"
                                        checked
                                />
                                </div>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ì¶œê³ ì°½ê³ </label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="w-100 h-100  btn-primary" type="button" value="" name="location" id="location" onclick="showLocationModal()"/>
                            </div>
                        </div>
                          <div class="content-input-group col-6">
                            <div class="content-input-group-header">
                                <label>ë°˜ì¶œì²˜(ëª©ì )</label>
                            </div>
                            <div class="content-input-group-input">
                                <input
                                        class="form-control"
                                        name="purpose"
                                        id="purpose"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>í˜„ì¬ê³ </label>
                            </div>
                            <div class="content-input-group-input">

                                <input
                                        class="form-control"
                                        name="item-amount"
                                        id="item-amount"
                                        onkeyup="_chkNumber(this, 3)"
                                disabled/>

                            </div>
                        </div>
                        <div class="content-input-group col-6">
                            <div class="content-input-group-header">
                                <label>ë¹„ê³ </label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" name="etc" id="etc"/>
                            </div>
                        </div>
                          <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>QR</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="btn button-custom2 w-100" name="qr" id="qr_search" type="button" onclick="show_qr_print($(this).val())">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            </div>
            <div class="row no-gutters w-100 justify-content-end">
                <div class="col-1 px-0 mr-2">
                        <input placeholder="QRì„ íƒ" autocomplete="off" class="form-control" name="qr_select" id="qr_select"/>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="resetDetailForm()"
                    >
                        ì´ˆê¸°í™”
                    </button>
                </div>
                 <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="material_output_add()"
                    >
                        ì¶œê³ ë“±ë¡
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="material_output_edit()"
                    >
                        ì¶œê³ ìˆ˜ì •
                    </button>
                </div>
                <div class="col-1 px-0 mr-2">
                    <button
                            class="btn button-custom2 w-100"
                            type="button"
                            onclick="material_output_remove()"
                    >
                        ì¶œê³ ì‚­ì œ
                    </button>
                </div>
                <!-- {#                    <div class="col-1 px-0 mr-2">#}
{#                        <a class="btn button-custom2 w-100" role="button">ì €ì¥</a>#}
{#                    </div>#} -->
            </div>
        </div>
    </div>
</form>

<!-- í…Œì´ë¸” -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- ë³¸ë¬¸ -->
        {# Todo hjlim : Table Line ìˆ˜ ì§€ì • #}
        <div class="content-table col-12" style="overflow-y:hidden">
            <table id="material_output_data-table" class="table table-sm text-center" >
                <thead>
                <tr>
                    <th>ìˆœë²ˆ</th>
                    <th>ì¶œê³ ë²ˆí˜¸</th>
                    <th>ì¶œê³ ì¼</th>
                    <th>ê±°ë˜ì²˜</th>
                    <th>ë¸Œëœë“œ</th>
                    <th>ì œí’ˆêµ°</th>
                    <!-- {# <th>êµ¬ë§¤ì²˜</th> #} -->
                    <th class="sorting_item_name" onclick="detail_search('item__name')">í’ˆëª…</th>
                    <th class="sorting_item_code" onclick="detail_search('item__code')">í’ˆë²ˆ</th>

                    <th class="sorting_item_nice_number" onclick="detail_search('item__nice_number')">ë‚˜ì´ìŠ¤ë²ˆí˜¸</th>
                    <th>í’ˆëª…ìƒì„¸</th>
                    <th>í˜•íƒœ</th>
                    <th>ì¶œê³ ìˆ˜ëŸ‰</th>
                    <th>ì¶œê³ ë‹¨ê°€</th>
                    <th>ì¶œê³ ì°½ê³ </th>
                    <th>ë°˜ì¶œì²˜(ëª©ì )</th>
                    <th>ë¹„ê³ </th>
                    <th>QR</th>
                </tr>
                </thead>
                <tbody id="material-output-tbody"></tbody>
            </table>

            <div class="row no-gutters d-flex justify-content-center" id="item_nation2"
                 style="margin-top: -20px;">
            </div>
{#                <div class="col-1 ml-auto">#}
{#                 <a href="#" id="excel-export" class="col-1 text-center">#}
{#                    <img src="/static/img/i_excel_c.png" width="38" height="38" />#}
{#                    <p class="mb-0">ì—‘ì…€ ë³€í™˜</p>#}
{#                </a>#}
{#                </div>#}

        </div>
    </div>

</div>

<!-- ëª¨ë‹¬ì°½ -->
<div class="card m-2">
    <div class="card-body">
      <div class="modal modal-center" id="locationModal" tabindex="-1" style="height:700px;" role="dialog" >
            <div class="modal-dialog modal-xl modal-center " >
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title font-weight-bold">ì°½ê³ ë“±ë¡</h5>
                </div>
                <div class="modal-body d-flex justify-content-center">
                    <div class="card m-2">
                        <div class="card-body p-2 ">
                            <div class="p-2 m-2 content-table" style="overflow-y:hidden; overflow-x: hidden; height: 100px;">
                                <table class="text-center">
                                    <thead>
                                        <tr style="font-weight: bold">í’ˆëª©ì •ë³´</tr>
                                    </thead>
                                    <thead>
                                        <tr>
                                        <th>ë¸Œëœë“œ</th>
                                        <th>ì œí’ˆêµ°</th>
                                        <th>í’ˆëª…</th>
                                        <th>í’ˆë²ˆ</th>
                                        <th>ë‚˜ì´ìŠ¤ë²ˆí˜¸</th>
                                        <th>í’ˆëª…ìƒì„¸</th>
                                        <th>í˜•íƒœ</th>
                                        <th>í˜„ì¬ê³ </th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemInform"></tbody>
                                </table>
                            </div>
                                <div class="card-title">ì°½ê³ ì •ë³´</div>
                                    <div class="card-body row" id="selectLocation" style="overflow-y:hidden;">
                                </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="resetLocation()">ì´ˆê¸°í™”</button>
                        <button type="button" class="btn btn-secondary" onclick="enrollLocation()">ë“±ë¡</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">ë‚˜ê°€ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

</div>

<script src="{% static 'js/api_item.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_materials.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>
<script>

    let nation_data2 = {
        cname : 'nation2',  // ì¸ìŠ¤í„´ìŠ¤ ëª…ê³¼ ì¼ì¹˜í•´ì•¼í•¨
        table_id: 'item_nation2',
        range: 5,
        page_size: 10,
    };

    let nation2 = new Pnations(nation_data2, detail_search);  // ì¸ìŠ¤í„´ìŠ¤ ëª…

    // material_output table ì— ì‚¬ìš©ë¨.
    var detail_click_id = null;
    var material_output_columns = ['out-at', 'purchase_from', 'item-code', 'item-name', 'item-model', 'item-unit',
        'current-amount', 'out-amount', 'etc', 'purpose',"out-price", "tax", "location", "qr_search", "nice_number",
        'item-shape', 'item_group', 'brand', 'item-detail', 'item_division', 'item-amount'];

    // material_input lookup table ì— ì‚¬ìš©ë¨.
    var main_click_id = null;
    var material_output_columns_in = ['purchase_from', 'item-code', 'check-at', 'in-at', 'item-unit', 'package-amount', "nice_number",
        'receive-amount', 'in-faulty-amount', 'in-amount', 'etc', 'item-created-at', "out-price", "tax", "location"];

    let location_dict = {};
    $('.datepicker').datepicker({
        format: 'yyyy-mm-dd',
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: 'ko',
        todayHighlight: 'true',
    });

    $("#out-at").datepicker("setDate", "today");

    let total_price = 0;
    function changeTotalPriceFromTax() {
        if ($("#tax").is(":checked")) {
            $("#total_price").val(total_price * 1.1)
        } else {
            $('#total_price').val(total_price)
        }
    }
    function changeTotalPrice(){
         total_price = $("#out-amount").val()*$("#out-price").val()
         $('#total_price').val(total_price)
    }
    $(function () {
        set_naming();
        refresh();

        // Table Export
        $(parent.document).find("#excel-export").click(() => {
            {#init_excel_export($('#material_output_data-table-up'), 'ìì¬í’ˆëª©');#}
            init_excel_export($('#material_output_data-table'), 'ì¬ê³ ì¶œê³ ');
        });
    });


    function set_naming(){
        let enterprise_name = get_userinfo().enterprise_name;
        if (enterprise_name == '(ì£¼)ê±´ê°•ìƒí™œì—°êµ¬ì†Œ'){
            $("#n_bom_model1").text("ì œí’ˆêµ°");
            $("#n_bom_model2").text("ì œí’ˆêµ°");
            $("#n_bom_model3").text("ì œí’ˆêµ°");
        }
    }


    function refresh() {
        material_output_init();
        detail_search()
    }




    function output_submit(e) {
        e.preventDefault();
        order = ""
        $("#out-at").datepicker("setDate", "today");
        $("#out-amount").val("");
        $("#purpose").val("");
        $("#etc").val("");

        $("#material-output-tbody").empty();

        main_click_id = null;

        nation2.page = 1;
        detail_click_id = null;

        detail_search()
        return false;
    }
    function resetDetailForm(){
        material_output_columns.forEach((item) => {

            {#$(`#material_output_detail-form input[name=${item}]`).val("").trigger("change");#}
            {#$(`#material_output_detail-form select[name=${item}]`).val("").trigger("change");#}
            if(item ==="tax"){
                document.querySelector(`#material_output_detail-form input[name=${item}]`).checked = true
            } else {
                $("#material_output_detail-form [name='" + item + "']").val(null).trigger("change");
            }
        });
        document.querySelectorAll("#material-output-tbody > tr").forEach(data => data.classList.remove("clicked"));
        detail_click_id = null;
        $("#out-at").datepicker("setDate", "today");
        set_default_value();
    }

    function set_default_value(){
        {#$("#material_output_main-form [name='package-amount']").val('0');#}
        {#$("#material_output_main-form [name='receive-amount']").val('0');#}
        $("#material_output_main-form [name='out-amount']").val('0');
        $("#material_output_main-form [name='out-price']").val('0');

        $("#item-code").attr("disabled", false);
        $("#item-name").attr("disabled", false);
        {#$("#material_output_customer").attr("disabled", false);#}
        $("#nice_number").attr("disabled", false);
    }


    let order =""

    function detail_table_load() {
        nation2.page = 1;
        detail_click_id = null;

        $("#out-at").datepicker("setDate", "today");
        $("#out-amount").val("");
        $("#purpose").val("");
        $("#etc").val("");
        detail_search();
    }


    function detail_search(ordering){

        let query = "?page=" + nation2.page + "&";

        let customer_search = ($('#customer_search :selected').val() ? $('#customer_search :selected').val() : "");

        let fr_date = $("#fr_date").val();
        let to_date = $("#to_date").val();

        let brand = ($('#brand_search :selected').val() ? $('#brand_search :selected').val() : "");
        let item_group = ($('#item_group_search :selected').val() ? $('#item_group_search :selected').val() : "");
        let nice_number = ($('#nice_number_search :selected').val() ? $('#nice_number_search :selected').val() : "");
        {#let item_name = ($('#item_name_search :selected').val() ? $('#item_name_search :selected').val() : "");#}
        let item_code = ($('#item_code_search :selected').val() ? $('#item_code_search :selected').val() : "");
        {#let detail = ($('#detail_search').val() ? $('#detail_search').val() : "");#}
        {#let shape = ($('#shape_search').val() ? $('#shape_search').val() : "");#}

        let multiSearch = $("#multiSearch").val()


        if (ordering === '' || ordering === null || ordering=== undefined ){
        } else {
              order === ordering ? order = "-" +ordering : order = ordering
        }

        $(".sorting_item_name").html("í’ˆëª…â–½")
        $(".sorting_item_code").html("í’ˆë²ˆâ–½")
        $(".sorting_item_nice_number").html("ë‚˜ì´ìŠ¤ë²ˆí˜¸â–½")
        switch(order){
            case "item__name":
                $(".sorting_item_name").html("í’ˆëª…â–¼")
                break;
            case "-item__name":
                $(".sorting_item_name").html("í’ˆëª…â–²")
                break;
            case "item__code":
                $(".sorting_item_code").html("í’ˆë²ˆâ–¼")
                break;
            case "-item__code":
                $(".sorting_item_code").html("í’ˆë²ˆâ–²")
                break;
             case "item__nice_number":
                $(".sorting_item_nice_number").html("ë‚˜ì´ìŠ¤ë²ˆí˜¸â–¼")
                break;
            case "-item__nice_number":
                $(".sorting_item_nice_number").html("ë‚˜ì´ìŠ¤ë²ˆí˜¸â–²")
                break;
            default:
                break;
        }
        query += "ordering=" + order + "&";
        if (fr_date !== '') query += "fr_date=" + fr_date + "&";
        if (to_date !== '') query += "to_date=" + to_date + "&";
        if (brand !== '') query += "brand=" + brand + "&";
        if (customer_search !== '') query += "customer=" + customer_search + "&";
        if (item_group !== '') query += "item_group=" + item_group + "&";
        if (nice_number !== '') query += "nice_number=" + nice_number + "&";
        {#if (item_name !== '') query += "item_name=" + item_name + "&";#}
        if (item_code !== '') query += "item_code=" + item_code + "&";
        {#if (detail !== '') query += "detail=" + detail + "&";#}
        {#if (shape !== '') query += "shape=" + shape + "&";#}
        if (multiSearch !=='') query += 'search=' + multiSearch;

        api_gp("/items/out/" + query, "GET", {}, (done) => {

            detail_table_draw(done)
        });
    }


    function detail_table_draw(done) {
        console.table(done);

        let data = done.results;
        let num = (((nation2.page*1) - 1) * nation_data2["page_size"]) + 1 ;

        let rows = "";
        for (let i = 0; i < data.length; i++) {
            let item = data[i];
            console.log(item);
            let row = `<tr id="${item.id}">
                           <td> ${i+1}</td>
                           <td data-item="num">${item.num !== undefined ? item.num: ""}</td>
                           <td data-item="out-at">${item.out_at !== undefined ? item.out_at: ""}</td>
                           <td data-item="purchase_from" item-id="${item.purchase_from !== null ? item.purchase_from.id : ""}">${item.purchase_from !== null ? item.purchase_from.name : ""}</td>
                           <td data-item="brand" item-id="${item.item.brand_id}">${item.item.brand_name !== undefined ? item.item.brand_name: ""}</td>
                           <td data-item="item_group" item-id="${item.item.item_group_id}">${item.item.item_group_name !== undefined ? item.item.item_group_name: ""}</td>
                           <td data-item="item-name"  title="${item.item.name}" item-id="${item.item.id}">${item.item.name.length > 10 ? item.item.name.slice(0,10) + "..." : item.item.name}</td>
                           <td data-item="item-code"  title="${item.item.code}" item-id="${item.item.id}">${item.item.code.length > 10 ? item.item.code.slice(0,10) + "..." : item.item.code}</td>
                           <td data-item="nice_number" item-id="${item.item.id}">${item.item.nice_number !== undefined ? item.item.nice_number.length >10 ? item.item.nice_number.slice(0,10) + "..." : item.item.nice_number : ""}</td>
                           <td data-item="item-detail">${item.item.detail !== null ? item.item.detail: ""}</td>
                           <td data-item="item-shape">${item.item.shape !== undefined ? item.item.shape: ""}</td>
                           <td data-item="out-amount">${item.out_amount !== undefined ? numberWithCommas(item.out_amount): ""}</td>
                           <td data-item="out-price">${item.out_price !== undefined ? numberWithCommas(item.out_price): ""}</td>
                           <td data-item="location">${item.location !== null ? item.location.name: "ì…ê³ ì°½ê³ "}</td>
                           <td data-item="purpose">${item.purpose !== null ? item.purpose: ""}</td>
                           <td class="d-none" data-item="tax">${item.tax !== "X" ? "O" : 'X'}</td>
                           <td data-item="etc">${item.etc !== null && item.etc !== "" ? item.etc: ""}</td>
                           <td data-item="qr_search" value="${item.item.qr_path}">${item.item.qr_path !== null ? item.item.qr_path: ""}</td>
                           <td data-item='item_division' class="d-none" item-id="${item.item.division_id}">${item.item.division_name !== undefined ? item.item.division_name: ""}</td>
                           <td data-item='item-amount' class="d-none" item-id="${item.item.id}">${item.item.stock !== undefined ? item.item.stock: ""}</td>
                       </tr>`

            rows += row;
        }
        spinner();

        nation2.nation_display(done);
        $('#material-output-tbody').html(rows);

        // click check
        if (detail_click_id != null){
            $("#material-output-tbody #" + detail_click_id).addClass('clicked');
        }

        $('#material-output-tbody > tr').on('click', function () {
            $(this).parent().find('tr').removeClass('clicked');
            $(this).addClass('clicked');

            $("#item-code").attr("disabled", true);
            $("#item-name").attr("disabled", true);
            $("#nice_number").attr("disabled", true);

            main_click_id = $(this).find("[data-item='item-code']").attr("item-id")

            material_output_columns.forEach((item) => {
                if (item === 'item-code' ||
                    item === "item-name" ||
                    item === "nice_number" ||
                    item === "brand" ||
                    item === "item_group" ||
                    item === "item_division" ||
                    item === "purchase_from") {

                    $("#material_output_detail-form [name='" + item + "']").val($(this).find("[data-item='" + item + "']").attr("item-id")).trigger("change");

                    {#$("#material_output_detail-form .item-name-dropdown").val(#}
                    {#    $(this).find("[data-item='" + item + "']").attr("item-id")#}
                    {#).trigger("change");#}
                    {#$("#material_output_detail-form .item-code-dropdown").val(#}
                    {#    $(this).find("[data-item='" + item + "']").attr("item-id")#}
                    {#).trigger("change");#}
                    {#$("#material_output_detail-form .nice_number-dropdown").val(#}
                    {#    $(this).find("[data-item='" + item + "']").attr("item-id")#}
                    {#).trigger("change");#}
                } else if(item === "tax"){
                    if($(this).find("[data-item='" + item + "']").text() === "X"){
                          document.querySelector(`#${item}`).checked = true
                         $('#out-amount').keyup()
                    }else{
                        document.querySelector(`#${item}`).checked = false
                        $('#out-amount').keyup()
                    }
                     $(`#${item}`).click()
                }else if(item ==="location"){
                    $(`#location`).val($(this).find("[data-item='" + item + "']").text() !== "" ? $(this).find("[data-item='" + item + "']").text() : "location")
                } else {
                    $("#" + item + "").val($(this).find("[data-item='" + item + "']").text());
                     $("#" + item + "").trigger("keyup")
                }
            });
            detail_click_id = $(this).attr('id');
            console.log(main_click_id, detail_click_id);
        });
    }

    function material_output_init() {
        function make_dropdown(data, selectors) {
            let list = "<option value=''>ì„ íƒ ë° ê²€ìƒ‰</option>";
            let distinct = [];
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                if (selectors.includes('.bom-dropdown')) {
                    list += "<option value='" + item.id + "'>" + item.bom_name + "</option>";
                } else if (selectors.includes('.item-code-dropdown')) {
                    list += "<option value='" + item.id + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                    item.code + "</option>";
                } else if (selectors.includes('.item-name-dropdown')) {
                    if (distinct.indexOf(item.name) === -1) {
                        list += "<option value='" + item.id + "'" +
                        " data-shape='" + (item.shape ? item.shape : "") + "'" +
                        " data-detail='" + (item.detail ? item.detail : "") + "'" +
                        " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                        " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                        item.name + "</option>";
                        distinct.push(item.name);
                    } else {
                        list += "<option value='" + item.id + "'" +
                        " data-shape='" + (item.shape ? item.shape : "") + "'" +
                        " data-detail='" + (item.detail ? item.detail : "") + "'" +
                        " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                        " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                        item.name + "</option>";
                    }
                }
                else if(selectors.includes(".nice_number-dropdown")){
                    list += "<option value='" + item.id + "'" +
                    " data-shape='" + (item.shape ? item.shape : "") + "'" +
                    " data-detail='" + (item.detail ? item.detail : "") + "'" +
                    " data-item_group='" + (item.item_group_id ? item.item_group_id : "") + "'" +
                    " data-brand='" + (item.brand_id ? item.brand_id : "") + "'>" +
                    item.nice_number + "</option>";
                } else if(selectors.includes(".product-dropdown")){
                     list += "<option value='" + item.product + "'>" + item.product + "</option>";
                } else if(selectors.includes(".shape-dropdown")){
                     list += "<option value='" + item.shape + "'>" + item.shape + "</option>";
                } else if(selectors.includes(".detail-dropdown")){
                     list += "<option value='" + item.detail + "'>" + item.detail + "</option>";
                } else{
                 list += "<option value='" + item.id + "'>" + item.name + "</option>";}
            }
            $(selectors).html(list);
            $(selectors).select2({width: '100%'});
        }

        // êµ¬ë§¤ì²˜
        api_gp('/customers_select/', 'GET', {}, (data) => {
            make_dropdown(data, '.customer-dropdown');
            make_dropdown(data, '.customer-dropdown-search');
        });

        // ìì¬êµ¬ë¶„
        api_gp('/codes_select/?group=118&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.item_division_dropdown');
        });

        // ì°½ê³  list
        api_gp('/codes_select/?group=107&enable=true', 'GET', {}, (data) => {
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                location_dict[item.name] = item.id;
            }
        });

        // ëª¨ë¸
        api_gp('/codes_select/?group=116&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.model-dropdown');
        });

        // ë¸Œëœë“œ
        api_gp('/codes_select/?group=127&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.brand-dropdown');
            make_dropdown(data, '.brand-dropdown-search');
        });

        // ì œí’ˆêµ°
        api_gp('/codes_select/?group=128&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '.item_group-dropdown');
            make_dropdown(data, '.item_group-dropdown-search');
        });


        // í’ˆë²ˆ, í’ˆëª…
        api_gp("/items_part/", "GET", {}, (data) => {
            make_dropdown(data, '.item-code-dropdown');
            make_dropdown(data, '.item-code-dropdown-search');
            make_dropdown(data, '.item-name-dropdown');
            make_dropdown(data, '.item-name-dropdown-search');
            make_dropdown(data, '.nice_number-dropdown');
            make_dropdown(data, '.nice_number-dropdown-search');

            $('.item-code-dropdown').on('select2:select', function (e) {
                let select2_data = e.params.data;

                let detail = $(this).find("option:selected").data("detail");
                let brand = $(this).find("option:selected").data("brand");
                let item_group = $(this).find("option:selected").data("item_group");
                let shape = $(this).find("option:selected").data("shape");

                $(".item_group-dropdown").val(item_group).trigger('change');
                $(".brand-dropdown").val(brand).trigger('change');
                $("#item-shape").val(shape);
                $("#item-detail").val(detail);

                $(".item-name-dropdown").val(select2_data.id).trigger("change")
                $(".nice_number-dropdown").val(select2_data.id).trigger("change")
                main_click_id = $('#item-name :selected').val();
            })
            $('.item-name-dropdown').on('select2:select', function (e) {
                let select2_data = e.params.data;

                let detail = $(this).find("option:selected").data("detail");
                let brand = $(this).find("option:selected").data("brand");
                let item_group = $(this).find("option:selected").data("item_group");
                let shape = $(this).find("option:selected").data("shape");

                $(".item_group-dropdown").val(item_group).trigger('change');
                $(".brand-dropdown").val(brand).trigger('change');
                $("#item-shape").val(shape);
                $("#item-detail").val(detail);

                $(".item-code-dropdown").val(select2_data.id).trigger("change")
                $(".nice_number-dropdown").val(select2_data.id).trigger("change")
                main_click_id = $('#item-name :selected').val();
            })
            $('.nice_number-dropdown').on('select2:select', function (e) {
                let select2_data = e.params.data;

                let detail = $(this).find("option:selected").data("detail");
                let brand = $(this).find("option:selected").data("brand");
                let item_group = $(this).find("option:selected").data("item_group");
                let shape = $(this).find("option:selected").data("shape");

                $(".item_group-dropdown").val(item_group).trigger('change');
                $(".brand-dropdown").val(brand).trigger('change');
                $("#item-shape").val(shape);
                $("#item-detail").val(detail);

                $(".item-code-dropdown").val(select2_data.id).trigger("change")
                $(".item-name-dropdown").val(select2_data.id).trigger("change")
                main_click_id = $('#item-name :selected').val();
            })
        });


        {#api_gp('/items_select/', 'GET', {}, (data) => {});#}
    }


        function show_qr_print(_imgurl){

        var url = "/material/qr_print/?param1=";
        url = url + _imgurl;
        var name = "QR Print";
        var option = "width=1000px, height=1000px, location=no";
        window.open(url, name, option);

    }



    function material_output_get_form_data() {
        let data = {item: main_click_id};
        material_output_columns.forEach((item) => {
            if (item === 'enable') data[item] = $('#material_output_detail-form [name=' + item + ']').val() === "ì‚¬ìš©";

            else if (item === "out-amount" ||
                    item === "out-price") {
                console.log("out-amount is: ");
                console.log(parseInt($('#material_output_detail-form [name=' + item + ']').val().replace(/,/g, '')));

                data[item.replace(/-/gi, '_')] = parseInt($('#material_output_detail-form [name=' + item + ']').val()
                    .replace(/,/g, ''));

                if (isNaN(data["out_amount"])) {
                    data["out_amount"] = null
                } else if (isNaN(data["out_price"])) {
                    data["out_price"] = 0
                }
            } else if (item ==="tax")
                 data[item.replace(/-/gi, '_')] = document.querySelector("#tax").checked === true ? "O": "X"
            else if (item==="location") {
                    let location = (document.querySelector("#location").value !== "location" ? document.querySelector("#location").value : "");
                    data[item.replace(/-/gi, '_')] = location_dict[location];
                }
            else data[item.replace(/-/gi, '_')] = nullapply($('#material_output_detail-form [name=' + item + ']').val());
        });

        return data;
    }

    function material_output_add() {

        let data = material_output_get_form_data();
        console.log(data);
        api_gp('/items/out/', 'POST', data, (data) => {
            alert("ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.");
            nation2.page = 1;
            detail_click_id = data.id;
            detail_search();
        });
    }

    function material_output_edit() {
        if (main_click_id === undefined || main_click_id === null) {
            alert("ìƒë‹¨ì˜ í’ˆëª©ì„ ì„ íƒí•´ ì£¼ì‹­ì‹œì˜¤.");
        }

        let data = material_output_get_form_data();
        console.log(data);
        api_gp('/items/out/' + detail_click_id + '/', 'PATCH', data, (data) => {
            alert("ìˆ˜ì •í•˜ì˜€ìŠµë‹ˆë‹¤.");
            detail_search();
        });
    }

    function material_output_remove() {
        if (main_click_id === undefined || main_click_id === null) {
            alert("ìƒë‹¨ì˜ í’ˆëª©ì„ ì„ íƒí•´ ì£¼ì‹­ì‹œì˜¤.");
        }

        let data = material_output_get_form_data();
        api_gp('/items/out/' + detail_click_id + '/', 'DELETE', data, (data) => {
            alert("ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤.");
            detail_table_load();
        });
    }

    function spinner() {
        $("#spinner").remove();
    }
    let itemInform = {
        brand: "í˜„ëŒ€",
        product: "ì—ì–´í•„í„°",
        item_name: "(ê°€ì†”ë¦°)GV70 2.5",
        item_code: "28113-AR100",
        nice_number: "MAA-113",
        detail: "",
        shape: "",
        amount: 3300
    }
    let itemAmountAtLocations = {
        ì…ê³ ì°½ê³ : 100,
        ì‡¼í•‘ëª°ì°½ê³ : 1000,
        Aì°½ê³ : 1500,
        Bì°½ê³ : 700,
        Cì°½ê³ : 0
    }

    function showLocationModal() {
        if (main_click_id === undefined || main_click_id === null) {
            alert("ì¬ê³ ëŸ‰ì„ ì¡°íšŒí•  í’ˆëª©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í’ˆëª© ì„ íƒ í›„ì— ì¡°íšŒí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.")
            return;
        }

        $("#locationModal").modal()
        console.log(main_click_id);
        api_gp(`/material/location/?item=${main_click_id}`, 'GET', {}, (data) => {
            console.log("data");
            console.log(data);
            itemAmountAtLocations = data;
            let location = '';
            for (let key in itemAmountAtLocations) {
                if (itemAmountAtLocations.hasOwnProperty(key)) {
                    let value = itemAmountAtLocations[key];

                    location += `<div class="col-sm-6 mb-4 col-xl-3" id="${key.replace(/\s/g, '')}" onclick="selectLocation('${key}','${value}')">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-uppercase mb-1"> ${key} </div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${value}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`
                }
            }
            $("#selectLocation").html(location)
        });

         api_gp("/items/" + main_click_id, "GET", {}, (done) => {
            itemInform = done
             console.log(itemInform)
             let row = `
            <tr>
            <td>${itemInform.brand_name !== undefined ? itemInform.brand_name :""}</td>
            <td>${itemInform.item_group_name !== undefined ? itemInform.item_group_name :""}</td>
            <td title = ${itemInform.name}>${itemInform.name.length > 10 ? itemInform.name.slice(0,10) + "..." : itemInform.name}</td>
            <td title = ${itemInform.code}>${itemInform.code.length > 10 ? itemInform.code.slice(0,10) + "..." : itemInform.code}</td>
            <td>${itemInform.nice_number !== undefined ? itemInform.nice_number :""}</td>
            <td>${itemInform.detail !== undefined ? itemInform.detail :""}</td>
            <td>${itemInform.shape !== undefined ? itemInform.shape :""}</td>
            <td>${itemInform.stock !== undefined ? itemInform.stock :""}</td>
            </tr>
            `
             $("#itemInform").html(row)
        });
    }
       function selectLocation(key, value) {
        let stock = parseInt(value);
        let out_amount = parseInt($('#out-amount').val().replace(/,/g, ''));

        if (stock <= 0 || out_amount > stock) {
            alert("í•´ë‹¹ ì°½ê³ ì— ì¬ê³ ê°€ ì—†ê±°ë‚˜ ì¶œê³ í•˜ë ¤ëŠ” ìˆ˜ëŸ‰ì´ ì¬ê³ ëŸ‰ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì°½ê³ ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.")
            return;
        }

        document.querySelectorAll("#selectLocation .col-sm-6").forEach(element =>
            element.classList.remove("text-info"));

        $(`#${key.replace(/\s/g, '')}`).addClass("text-info");
        {#document.querySelector(`#a${key}`).classList.add("text-info");#}
        $("#location").val(`${key}`);
    }
       function resetLocation() {
        document.querySelectorAll("#selectLocation .col-sm-6").forEach(element =>
            element.classList.remove("text-info"))
        $("#location").val("");
    }
        function enrollLocation(){
            alert("ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤")
            $("#locationModal").modal("hide")
        }

</script>
<!-- {#{% endblock %}#} -->
</body>
</html>
