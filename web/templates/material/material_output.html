<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
<body style="overflow: hidden;">
<!-- {#{% extends 'index.html' %}#}  -->
{% load static %}
{{ it.media }}
<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px"/>
</div>

<div class="col-12">
    <div class="main-content">
        <div class="main-content-inner">
            <!-- 검색  -->
            <div class="row align-items-center">
                <div class="col-lg-12 col-ml-12 mt-3">
                    <div class="card">

                            <div class="row ml-3">
                                <div class="col-md-3 clearfix">
                                    <div class="form-group">
                                        <label class="col-form-label">출고기간</label>
                                        <div class="input-group input-daterange">
                                        <input type="text"
                                            class="form-control created_at_after datepicker form-control-sm"
                                            id="fr_date"
                                            autocomplete="off"
                                        />
                                        <div class="input-group-addon px-3">~</div>
                                        <input type="text"
                                            class="form-control created_at_before datepicker form-control-sm"
                                            id="to_date"
                                            autocomplete="off"
                                        />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 clearfix">
                                    <div class="form-group">
                                        <label for="example-text-input" class="col-form-label">거래처</label>
                                        <div class="content-input-group-input">
                                         {{ it.cu_name_sch }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 clearfix">
                                    <div class="form-group">
                                        <label for="example-text-input" class="col-form-label">품명</label>
                                        <div class="content-input-group-input">
                                         {{ it.it_name_sch }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 clearfix">
                    <div class="gradient-buttons ml-1 col-md-3 mt-3">
                        <button type="button" class="btn btn-primary" onclick="search();"><i class="ti-search"></i>  검색</button>
                    </div>
                </div>
                <div class="col-md-1 mt-4">
                    <ul class="notification-area pull-right">
                        <li class="settings-btn">
                            <i class="ti-settings"></i>
                        </li>
                    </ul>
                </div>
                            </div>

                    </div>
                </div>
                </div>
            </div>
            <!-- 테이블  -->
            <div class="row no-gutters ml-4 mr-4">

                    <div class="card">
                        <div class="card-body">

                            <table id="material_output_data-table" class="table table-hover table-striped table-bordered display nowrap" style="width: 100%;">
                                <thead>
                                    <tr>
                                        {% for item in column %}
                                            {% if item.visual_flag %}
                                            <th>{{ item.label }}</th>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody id="material-output-tbody"></tbody>

                            </table>

                        </div>
                    </div>

            </div>
        </div>
    </div>
</div>

<!-- offset area start -->
<div class="offset-area">
    <div class="offset-close"><i class="ti-close"></i></div>
    <ul class="nav offset-menu-tab">
        <li><a class="active" data-toggle="tab" href="#ma_input_item">편집</a></li>
        <li></li>
    </ul>
    <div class="offset-content tab-content">
        <div id="ma_input_item" class="tab-pane fade in show active">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <form class="needs-validation" id="material_output_main-form">
                            <div class="form-row">
                                <div class="col-md-6 mb-3" id="id_it_code_form_div">
                                    <label><strong>*</strong>품번</label>
                                    <div class="input-group">
                                        {{ it.it_code_form }}
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3" id="id_it_name_form_div">
                                    <label><strong>*</strong>품명</label>
                                    <div class="input-group">
                                        {{ it.it_name_form }}
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3" id="id_cu_name_form_div">
                                    <label>거래처</label>
                                    <div>
                                    {{ it.it_customer_add }}
                                    </div>
                                </div>
                                {% for item in column %}
                                    {% if item.edit_flag %}


                                        {% if item.tag == "input" %}
                                    <div class="col-md-6 mb-3">
                                    <label><strong>{{ item.pre_label|default_if_none:'' }}</strong>{{ item.label }}</label>
                                    <input type="text" class="{{ item.class_name|safe }}"
                                           name="{{ item.label_en|safe }}"
                                           autocomplete="off"
                                            {% if item.attr != None %} {{ item.attr|safe }} {% endif %}
                                            {% if item.event != None %} {{ item.event|safe }} {% endif %}/>
                                     </div>
                                        {% elif item.tag == "btn" %}
                                            <div class="col-md-6 mb-3">
                                    <label><strong>{{ item.pre_label|default_if_none:'' }}</strong>{{ item.label }}</label>
                                    <input type="button" class="{{ item.class_name|safe }}" name="{{ item.label_en|safe }}" onclick="{{ item.event|safe }}" {{ item.attr }}/>
                                     </div>

                                        {% endif %}

                                    {% endif %}
                                {% endfor %}
                            </div>
                        </form>
                        <div class="gradient-buttons pull-right">
                        {% for item in column %}
                            {% if item.tag == "button" %}
                                <div class="{{ item.class_name|safe }}" onclick="{{ item.event|safe }}">{{ item.label }}</div>
                            {% endif %}
                        {% endfor %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 모달창 -->
<div class="card m-2">
    <div class="card-body">
      <div class="modal modal-center" id="locationModal" tabindex="-1" style="height:700px;" role="dialog" >
            <div class="modal-dialog modal-xl modal-center " >
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title font-weight-bold">창고등록</h5>
                </div>
                <div class="modal-body d-flex justify-content-center">
                    <div class="card m-2">
                        <div class="card-body p-2 ">
                            <div class="p-2 m-2 content-table" style="overflow-y:hidden; overflow-x: hidden; height: 100px;">
                                <table class="text-center">
                                    <thead>
                                        <tr style="font-weight: bold">품목정보</tr>
                                    </thead>
                                    <thead>
                                        <tr>
                                        <th>브랜드</th>
                                        <th>제품군</th>
                                        <th>품명</th>
                                        <th>품번</th>
                                        <th>나이스번호</th>
                                        <th>품명상세</th>
                                        <th>형태</th>
                                        <th>현재고</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemInform"></tbody>
                                </table>
                            </div>
                                <div class="card-title">창고정보</div>
                                    <div class="card-body row" id="selectLocation" style="overflow-y:hidden;">
                                </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="resetLocation()">초기화</button>
                        <button type="button" class="btn btn-secondary" onclick="enrollLocation()">등록</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">나가기</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

</div>

<script src="{% static 'js/api_item.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_materials.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>
<script src="{% static 'srtdash/assets/js/scripts.js' %}" type="text/javascript"></script>
<script>

    let main_table = null;
    let re_column = []
    let re_invisual_col = []
    let re_name = []
    let hidden_name = []
    let detail_click_id = null;
    {% for item in column %}
            {% if item.tag == "input" or item.tag == "btn" %}
                re_name.push("{{ item.label_en|safe }}")

            {% elif item.tag == "select" %}

                hidden_name.push({
                    "{{ item.label_en|safe }}":
                     "{{ item.type|safe }}"
                })
            {% endif %}
        {% if not item.visual_flag and item.edit_flag %}
            re_invisual_col.push("{{ item.type|safe }}")
            {% else %}
            re_column.push("{{ item.label_en|safe }}")
        {% endif %}
    {% endfor %}

    let location_dict = {};
    $('.datepicker').datepicker({
        format: 'yyyy-mm-dd',
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: 'ko',
        todayHighlight: 'true',
    });

    $("input[name='out-at']").datepicker("setDate", "today");

    let total_price = 0;
    function changeTotalPriceFromTax() {
        if ($("#tax").is(":checked")) {
            $("#total_price").val(total_price * 1.1)
        } else {
            $('#total_price').val(total_price)
        }
    }
    function changeTotalPrice(){
         total_price = $("#out-amount").val()*$("#out-price").val()
         $('#total_price').val(total_price)
    }
    $(function () {
        main_table = $('#material_output_data-table').DataTable({
            scrollX: true,
            "columnDefs": [
                    {
                        targets: 0,
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                    "targets": "_all",
                    "className": "ellipsis"
                  }
                ],
            "rowCallback": function(row, data) {
                    $(row).on('click', function() {
                        // 클릭 로우 색상
                        setRowColor(this, 'M');
                        // 데이터 셋팅


                        setInput_api(data,re_column, re_name, hidden_name);

                        //readonly 셋팅
                        $('#id_cu_name_form').attr("disabled",true);
                        $('#id_it_code_form').attr("disabled",true);
                        $('#id_it_name_form').attr("disabled",true);
                        $('#id_it_model_add').attr("disabled",true);
                        $('#id_it_division_add').attr("disabled",true);
                        $('#id_it_unit_add').attr("disabled",true);


                        detail_click_id = data[data.length-1];
                        console.log(data);
                    });
                }
                })
        refresh();
    });



    function refresh() {

        detail_search()
    }




    function output_submit(e) {
        e.preventDefault();
        order = ""
        $("#out-at").datepicker("setDate", "today");
        $("#out-amount").val("");
        $("#purpose").val("");
        $("#etc").val("");

        $("#material-output-tbody").empty();

        main_click_id = null;

        nation2.page = 1;
        detail_click_id = null;

        detail_search()
        return false;
    }
    function resetDetailForm(){

        detail_click_id = null;

        set_default_value();
    }

    function set_default_value(){

        $('#material_output_main-form input').val('');

        $('#material_output_main-form select').val(null).trigger('change');
        $('#material_output_main-form select').attr("disabled",false);

        $('#material_input_tbody').find('tr').siblings().css('background-color', '');

        $("#material_output_main-form [name='out_amount']").val('0');
        $("#material_output_main-form [name='out_price']").val('0');
        $("#material_output_main-form [name='fee_rate']").val('0');
        $("#material_output_main-form [name='out_at']").datepicker("setDate", "today");

    }


    let order =""

    function detail_table_load() {
        nation2.page = 1;
        detail_click_id = null;

        $("#out-at").datepicker("setDate", "today");
        $("#out-amount").val("");
        $("#purpose").val("");
        $("#etc").val("");
        detail_search();
    }


    function detail_search(ordering){

        let query = "?page=" + "1" + "&";

        let customer_search = ($('#customer_search :selected').val() ? $('#customer_search :selected').val() : "");

        let fr_date = $("#fr_date").val();
        let to_date = $("#to_date").val();

        let item_code = ($('#item_code_search :selected').val() ? $('#item_code_search :selected').val() : "");

        if (ordering === '' || ordering === null || ordering=== undefined ){
        } else {
              order === ordering ? order = "-" +ordering : order = ordering
        }

        query += "ordering=" + order + "&";
        if (fr_date !== '') query += "fr_date=" + fr_date + "&";
        if (to_date !== '') query += "to_date=" + to_date + "&";

        if (customer_search !== '') query += "customer=" + customer_search + "&";

        if (item_code !== '') query += "item_code=" + item_code + "&";

        api_gp("/items/out/" + query, "GET", {}, (done) => {

            detail_table_draw(done)
        });
    }


    function detail_table_draw(done) {
        console.table(done);

        let data = done.results;

        spinner();
    }

    function show_qr_print(_imgurl){

        var url = "/material/qr_print/?param1=";
        url = url + _imgurl;
        var name = "QR Print";
        var option = "width=1000px, height=1000px, location=no";
        window.open(url, name, option);

    }



    function material_output_get_form_data() {
        let data = {item: main_click_id};
        material_output_columns.forEach((item) => {
            if (item === 'enable') data[item] = $('#material_output_detail-form [name=' + item + ']').val() === "사용";

            else if (item === "out-amount" ||
                    item === "out-price") {
                console.log("out-amount is: ");
                console.log(parseInt($('#material_output_detail-form [name=' + item + ']').val().replace(/,/g, '')));

                data[item.replace(/-/gi, '_')] = parseInt($('#material_output_detail-form [name=' + item + ']').val()
                    .replace(/,/g, ''));

                if (isNaN(data["out_amount"])) {
                    data["out_amount"] = null
                } else if (isNaN(data["out_price"])) {
                    data["out_price"] = 0
                }
            } else if (item ==="tax")
                 data[item.replace(/-/gi, '_')] = document.querySelector("#tax").checked === true ? "O": "X"
            else if (item==="location") {
                    let location = (document.querySelector("#location").value !== "location" ? document.querySelector("#location").value : "");
                    data[item.replace(/-/gi, '_')] = location_dict[location];
                }
            else data[item.replace(/-/gi, '_')] = nullapply($('#material_output_detail-form [name=' + item + ']').val());
        });

        return data;
    }

    function material_output_add() {

        let data = material_output_get_form_data();
        console.log(data);
        api_gp('/items/out/', 'POST', data, (data) => {
            alert("등록하였습니다.");
            nation2.page = 1;
            detail_click_id = data.id;
            detail_search();
        });
    }

    function material_output_edit() {
        if (main_click_id === undefined || main_click_id === null) {
            alert("상단의 품목을 선택해 주십시오.");
        }

        let data = material_output_get_form_data();
        console.log(data);
        api_gp('/items/out/' + detail_click_id + '/', 'PATCH', data, (data) => {
            alert("수정하였습니다.");
            detail_search();
        });
    }

    function material_output_remove() {
        if (main_click_id === undefined || main_click_id === null) {
            alert("상단의 품목을 선택해 주십시오.");
        }

        let data = material_output_get_form_data();
        api_gp('/items/out/' + detail_click_id + '/', 'DELETE', data, (data) => {
            alert("삭제하였습니다.");
            detail_table_load();
        });
    }

    function spinner() {
        $("#spinner").remove();
    }
    let itemInform = {
        brand: "현대",
        product: "에어필터",
        item_name: "(가솔린)GV70 2.5",
        item_code: "28113-AR100",
        nice_number: "MAA-113",
        detail: "",
        shape: "",
        amount: 3300
    }
    let itemAmountAtLocations = {
        입고창고: 100,
        쇼핑몰창고: 1000,
        A창고: 1500,
        B창고: 700,
        C창고: 0
    }

    function showLocationModal() {
        if (main_click_id === undefined || main_click_id === null) {
            alert("재고량을 조회할 품목이 선택되지 않았습니다. 품목 선택 후에 조회하시기 바랍니다.")
            return;
        }

        $("#locationModal").modal()
        console.log(main_click_id);
        api_gp(`/material/location/?item=${main_click_id}`, 'GET', {}, (data) => {
            console.log("data");
            console.log(data);
            itemAmountAtLocations = data;
            let location = '';
            for (let key in itemAmountAtLocations) {
                if (itemAmountAtLocations.hasOwnProperty(key)) {
                    let value = itemAmountAtLocations[key];

                    location += `<div class="col-sm-6 mb-4 col-xl-3" id="${key.replace(/\s/g, '')}" onclick="selectLocation('${key}','${value}')">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-uppercase mb-1"> ${key} </div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${value}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`
                }
            }
            $("#selectLocation").html(location)
        });

         api_gp("/items/" + main_click_id, "GET", {}, (done) => {
            itemInform = done
             console.log(itemInform)
             let row = `
            <tr>
            <td>${itemInform.brand_name !== undefined ? itemInform.brand_name :""}</td>
            <td>${itemInform.item_group_name !== undefined ? itemInform.item_group_name :""}</td>
            <td title = ${itemInform.name}>${itemInform.name.length > 10 ? itemInform.name.slice(0,10) + "..." : itemInform.name}</td>
            <td title = ${itemInform.code}>${itemInform.code.length > 10 ? itemInform.code.slice(0,10) + "..." : itemInform.code}</td>
            <td>${itemInform.nice_number !== undefined ? itemInform.nice_number :""}</td>
            <td>${itemInform.detail !== undefined ? itemInform.detail :""}</td>
            <td>${itemInform.shape !== undefined ? itemInform.shape :""}</td>
            <td>${itemInform.stock !== undefined ? itemInform.stock :""}</td>
            </tr>
            `
             $("#itemInform").html(row)
        });
    }
       function selectLocation(key, value) {
        let stock = parseInt(value);
        let out_amount = parseInt($('#out-amount').val().replace(/,/g, ''));

        if (stock <= 0 || out_amount > stock) {
            alert("해당 창고에 재고가 없거나 출고하려는 수량이 재고량보다 많습니다. 다른 창고를 선택해 주세요.")
            return;
        }

        document.querySelectorAll("#selectLocation .col-sm-6").forEach(element =>
            element.classList.remove("text-info"));

        $(`#${key.replace(/\s/g, '')}`).addClass("text-info");
        {#document.querySelector(`#a${key}`).classList.add("text-info");#}
        $("#location").val(`${key}`);
    }
       function resetLocation() {
        document.querySelectorAll("#selectLocation .col-sm-6").forEach(element =>
            element.classList.remove("text-info"))
        $("#location").val("");
    }
        function enrollLocation(){
            alert("등록하였습니다")
            $("#locationModal").modal("hide")
        }

</script>
<!-- {#{% endblock %}#} -->
</body>
</html>
