{% load static %}
<!DOCTYPE html>

<meta charset="UTF-8">
{% include 'admins/admin_header.html' %}
<style>
    /* 모바일웹 텍스트 줄바꿈 방지 */
    .table td, .table th {
        white-space: nowrap;
    }

    @media (max-width: 1000px) {
        .control-buttons {
            height: 40px;
        }

    }
</style>
<body>

<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

        {% include 'admins/index_sidemenu.html' %}

        <!-- header -->
        <div class="layout-page" style="">
            {% include 'admins/topnav.html' %}

            <div class="d-flex justify-content-between flex-xl-row flex-md-column flex-sm-row flex-column px-3 pb-2">
                <div class="mb-xl-0 mb-4">
                    <div class="d-flex svg-illustration mb-2 gap-2">
                        <a href="{% url 'apv_list' %}">
                            <strong style="color: #000; font-size: x-large; margin-left: 20px; font-family: Pretendard;"></i><i class="fa-regular fa-file-lines" style="color: #000000;"></i>&nbsp; 전자결재</strong></a>
                    </div>
                </div>
            </div>

            <div class="px-4">
                <div id="template_include" style="border: 1px solid #ddd; padding: 2% 0 2% 0;"></div>

                <div class="d-flex justify-content-between py-4">
                    <div class="d-flex justify-content-start">
                        <div type="button" class="btn btn-danger mx-2 d-none" id="adminBtn" style="width: 150px;"
                             onclick="apv_delete()"> 완전 삭제
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div type="button" class="btn btn-outline-danger mx-2" style="width: 150px;"
                             onclick="apv_status_delete()"> 삭 제
                        </div>
                        <div type="button" class="btn btn-outline-secondary mx-2" style="width: 150px;"
                             onclick="apv_tempsave()"> 임시 저장
                        </div>
                        <div type="button" class="btn btn-outline-info mx-2" style="width: 150px;"
                             onclick="apv_send_progress()"> 결재 전송
                        </div>
                        <a href="/admins/apv/" class="btn btn-outline-warning mx-2" style="width: 150px;">목록 보기</a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

</body>
{% include 'admins/admin_footer.html' %}

<script>

    let currentUrl = window.location.href;
    let apv_click_id = currentUrl.split("/").slice(-2, -1)[0];
    let isSuperUser = {{ request.user.is_superuser|yesno:"true,false" }};

    document.addEventListener('DOMContentLoaded', function() {
        if (isSuperUser) {
            document.getElementById('adminBtn').classList.remove('d-none');
        }
    });

    $(function () {
        load_apv_temp_update()
    });

    function loadTemplateScripts() {
        $(document).ready(function () {
            $('#period_from, #period_to').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });

            $('#period_from, #period_to, #period_from_half, #period_to_half').change(function () {
                updatePeriodToOptions();
                calculatePeriod();
            });
            updatePeriodToOptions();
            checkApproverList();
        });
    }

    function checkApproverList() {
        const approvers = ['approver1', 'approver2', 'approver3', 'approver4', 'approver5', 'approver6'];
        approvers.forEach(function(approverId) {
            document.getElementById(approverId).addEventListener('blur', function() {
                let input = this.value;
                let dataList = document.getElementById('approver_list');
                let options = Array.from(dataList.options).map(option => option.value);

                if (!options.includes(input) && input !== "") {
                    alert('입력된 값이 정확하지 않습니다. 드랍다운목록에서 선택해주시기 바랍니다.');
                    this.value = ''; // 입력된 값을 초기화
                }
            });
        });
    }

    function calculatePeriod() {
        let periodFrom = $('#period_from').val();
        let periodTo = $('#period_to').val();
        let periodFromHalf = $('#period_from_half').val();
        let periodToHalf = $('#period_to_half').val();
        let periodCount = $('#period_count');

        let fromDate = new Date(periodFrom);
        let toDate = new Date(periodTo);

        if (isNaN(fromDate) || isNaN(toDate)) {
            periodCount.val('');
            return;
        }

        if (fromDate > toDate) {
            alert("시작 날짜는 종료 날짜보다 나중일 수 없습니다.");
            periodCount.val('');
            return;
        }

        let daysDiff = 0;
        let currentDate = fromDate;
        while (currentDate <= toDate) {
            let dayOfWeek = currentDate.getDay();
            if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 일요일(0)과 토요일(6) 제외
                daysDiff++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }

        if (fromDate.getTime() === toDate.getTime()) {
            if (periodFromHalf === 'am' && periodToHalf === 'pm') {
                daysDiff = 1; // 같은 날 오전과 오후를 선택하면 1일로 계산
            } else if (periodFromHalf === 'pm' && periodToHalf === 'am') {
                daysDiff = 0; // 같은 날 오후와 오전을 선택하면 0일로 계산
            } else if (periodFromHalf !== periodToHalf) {
                daysDiff = 0.5; // 같은 날 오전과 오후가 다른 경우 반나절로 계산
            }
        } else {
            if (periodFromHalf === 'pm') {
                daysDiff -= 0.5; // 시작일이 오후면 반나절 차감
            }
            if (periodToHalf === 'am') {
                daysDiff -= 0.5; // 종료일이 오전이면 반나절 차감
            }
        }

        if (daysDiff >= 0.5) {
            periodCount.val(daysDiff.toFixed(1));
        } else {
            periodCount.val('');
        }
    }

    function updatePeriodToOptions() {
        let periodFrom = $('#period_from').val();
        let periodFromHalf = $('#period_from_half').val();
        let periodToHalf = $('#period_to_half');

        let fromDate = new Date(periodFrom);
        let toDate = new Date($('#period_to').val());

        if (fromDate.getTime() === toDate.getTime()) {
            periodToHalf.val(periodFromHalf).prop('disabled', true);
        } else {
            periodToHalf.prop('disabled', false);
        }
    }

    function getApproverId(approverInputId) {
        let approverName = $(`#${approverInputId}`).val();
        let option = $(`#approver_list option`).filter(function() {
            return $(this).val() === approverName;
        });

        return option.length ? option.data('approver-id') : null;
    }

    function getSelectedCC(selectElement) {
        const selectedValues = [];
        const selectedOptions = selectElement && selectElement.options;

        for (let i = 0; i < selectedOptions.length; i++) {
            if (selectedOptions[i].selected) {
                selectedValues.push(selectedOptions[i].value);
            }
        }

        return selectedValues.length > 0 ? selectedValues : null;
    }


    function load_apv_temp_update() {
        let query = "?apv_id=" + apv_click_id;
        api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
            draw_apv_temp_update(done);
        })
    }

    function draw_apv_temp_update(done) {
        console.log("draw_apv_temp_update: ", done);
        let data = done.results[0];

        categoryId = data.apv_category.id;
        fetch(`/admins/apv/category/${categoryId}`)
            .then(response => response.text())
            .then(templateData => {
                loadTemplateScripts();
                document.getElementById('template_include').innerHTML = templateData;
                document.getElementById('doc_title').value = data.doc_title;
                document.getElementById('doc_no').value = data.doc_no;
                document.getElementById('create_date').value = data.updated_at;
                document.getElementById('username_md').value = data.created_by.username;
                document.getElementById('team').value = data.created_by.department_position;
                document.getElementById('approver1').value = data.approvers[0]?.approver1_name ? data.approvers[0].approver1_name.split(' ')[0] + ' (' + data.approvers[0].approver1_team + ')' : '';
                document.getElementById('approver2').value = data.approvers[0]?.approver2_name ? data.approvers[0].approver2_name.split(' ')[0] + ' (' + data.approvers[0].approver2_team + ')' : '';
                document.getElementById('approver3').value = data.approvers[0]?.approver3_name ? data.approvers[0].approver3_name.split(' ')[0] + ' (' + data.approvers[0].approver3_team + ')' : '';
                document.getElementById('approver4').value = data.approvers[0]?.approver4_name ? data.approvers[0].approver4_name.split(' ')[0] + ' (' + data.approvers[0].approver4_team + ')' : '';
                document.getElementById('approver5').value = data.approvers[0]?.approver5_name ? data.approvers[0].approver5_name.split(' ')[0] + ' (' + data.approvers[0].approver5_team + ')' : '';
                document.getElementById('approver6').value = data.approvers[0]?.approver6_name ? data.approvers[0].approver6_name.split(' ')[0] + ' (' + data.approvers[0].approver6_team + ')' : '';
                document.getElementById('leave_reason').value = data.leave_reason;
                document.getElementById('period_from').value = data.period_from;
                document.getElementById('period_from_half').value = data.period_from_half;
                document.getElementById('period_to').value = data.period_to;
                document.getElementById('period_to_half').value = data.period_to_half;
                document.getElementById('period_count').value = data.period_count;
                document.getElementById('special_comment').value = data.special_comment;

                let apvCcSelect = document.getElementById('apv_cc');
                let selectedCcIds = data.apv_cc.map(cc => cc.user_id);
                Array.from(apvCcSelect.options).forEach(option => {
                    if (selectedCcIds.includes(parseInt(option.value))) {
                        option.selected = true;
                    } else {
                        option.selected = false;
                    }
                });
            })

            .catch(error => {
                console.error('Error loading category detail:', error);
            });
    }


    // 임시저장 (첨부파일저장안함 + 필수필드없음)
    function apv_tempsave() {
        let apvCcElement = document.getElementById('apv_cc');
        let selectedCcValues = getSelectedCC(apvCcElement);

        let api_data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pk: nullapply(apv_click_id),
            apv_category_id: nullapply(categoryId),
            apv_status: '임시',
            doc_no: nullapply($('#doc_no').val()),
            doc_title: nullapply($('#doc_title').val()),
            leave_reason: nullapply($('#leave_reason').val()),
            period_from: nullapply($('#period_from').val()),
            period_from_half: nullapply($('#period_from_half').val()),
            period_to: nullapply($('#period_to').val()),
            period_to_half: nullapply($('#period_to_half').val()),
            period_count: nullapply($('#period_count').val()),
            special_comment: nullapply($('#special_comment').val()),
            approver1: getApproverId('approver1'),
            approver2: getApproverId('approver2'),
            approver3: getApproverId('approver3'),
            approver4: getApproverId('approver4'),
            approver5: getApproverId('approver5'),
            approver6: getApproverId('approver6'),
            apv_cc: selectedCcValues,
        };

        function sendApiRequest() {
            api_gp('/admins/apv/update/', 'post', api_data, (done) => {
                alert("임시저장이 완료되었습니다.");
                location.href = "/admins/apv/";
            });
        }

        sendApiRequest();
    }


    // 결재전송 (첨부파일저장 + 필수필드누락경고)
    function apv_send_progress() {
        let apvCcElement = document.getElementById('apv_cc');
        let selectedCcValues = getSelectedCC(apvCcElement);

        let api_data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pk: nullapply(apv_click_id),
            apv_category_id: nullapply(categoryId),
            apv_status: '진행',
            doc_no: nullapply($('#doc_no').val()),
            doc_title: nullapply($('#doc_title').val()),
            leave_reason: nullapply($('#leave_reason').val()),
            period_from: nullapply($('#period_from').val()),
            period_from_half: nullapply($('#period_from_half').val()),
            period_to: nullapply($('#period_to').val()),
            period_to_half: nullapply($('#period_to_half').val()),
            period_count: nullapply($('#period_count').val()),
            special_comment: nullapply($('#special_comment').val()),
            attached_files: [],
            approver1: getApproverId('approver1'),
            approver2: getApproverId('approver2'),
            approver3: getApproverId('approver3'),
            approver4: getApproverId('approver4'),
            approver5: getApproverId('approver5'),
            approver6: getApproverId('approver6'),
            apv_cc: selectedCcValues,
        };

        let attachedFiles = document.getElementById('attached_files').files;
        let fileReadCount = 0;

        function sendApiRequest() {
            api_gp('/admins/apv/update/', 'post', api_data, (done) => {
                alert("결재 전송이 완료되었습니다.");
                location.href = "/admins/apv/";
            });
        }

        function readFileAndAddToApiData(file, index) {
            let reader = new FileReader();
            reader.onload = function(event) {
                let fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: event.target.result.split(',')[1] // Base64 데이터 부분만 추출
                };
                api_data.attached_files.push(fileData);
                fileReadCount++;
                if (fileReadCount === attachedFiles.length) {
                    sendApiRequest();
                }
            };
            reader.readAsDataURL(file);
        }

        function validateApiData(data, requiredFields) {
            for (let { key, message } of requiredFields) {
                if (data[key] === null || data[key] === undefined || data[key] === '') {
                    alert(message);
                    return false;
                }
            }
            return true;
        }

        function checkForDuplicateApprovers(ccList, approvers) {
            for (let approver of approvers) {
                if (approver && ccList.includes(String(approver))) {
                    return true;
                }
            }
            return false;
        }

        let requiredFields = [
            { key: 'apv_category_id', message: '카테고리가 누락되었습니다.' },
            { key: 'doc_title', message: '문서제목이 입력되지 않았습니다.' },
            { key: 'leave_reason', message: '휴가종류가 선택되지 않았습니다.' },
            { key: 'period_from', message: '시작기간이 선택되지 않았습니다.' },
            { key: 'period_to', message: '종료기간이 선택되지 않았습니다.' },
            { key: 'period_count', message: '기간 일수가 누락되었습니다.' },
            { key: 'approver1', message: '최소 한명의 승인자가 필요합니다.' }
            // 필요한 필수 항목과 메시지를 여기에 추가
        ];

        if (!validateApiData(api_data, requiredFields)) {
            return;
        }

        let approvers = [
            api_data.approver1, api_data.approver2, api_data.approver3,
            api_data.approver4, api_data.approver5, api_data.approver6
        ];

        if (checkForDuplicateApprovers(selectedCcValues, approvers)) {
            alert('승인자는 참조목록에 포함될 수 없습니다.');
            return;
        }

        if (attachedFiles.length > 0) {
            for (let i = 0; i < attachedFiles.length; i++) {
                readFileAndAddToApiData(attachedFiles[i], i);
            }
        } else {
            sendApiRequest();
        }
    }

    function apv_status_delete() {
        if (confirm('기안을 삭제하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                apv_id: nullapply(apv_click_id),
                apv_status: '삭제',
                }

            api_gp('/admins/apv/status_update/', 'post', api_data, (done) => {
                    alert("삭제가 완료되었습니다.");
                    location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

    function apv_delete() {
        if (confirm('전자결재를 완전히 삭제하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: nullapply(apv_click_id),
                }

            api_gp('/admins/apv/delete/', 'post', api_data, (done) => {
                    alert("완전 삭제가 완료되었습니다.");
                    location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }



</script>