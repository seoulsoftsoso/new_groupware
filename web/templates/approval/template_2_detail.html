{% load static %}
<!DOCTYPE html>

<meta charset="UTF-8">
{% include 'admins/admin_header.html' %}
<style>
    /* 모바일웹 텍스트 줄바꿈 방지 */
    .table td, .table th {
        white-space: nowrap;
    }

    .status-banner {
        position: absolute;
        top: 90px;
        right: 50px;
        font-size: 60px;
        font-weight: bold;
        color: red;
        border: 10px double red;
        padding: 10px 20px;
        transform: rotate(10deg);
        background-color: rgba(255, 0, 0, 0.2);
    }

    .desktop_hide {
        display: none;
    }

    @media (max-width: 900px) {

        input[id="doc_title"] {
            font-size: 20px !important;
        }

        div[id="comment_list"] {
            padding-left: 10px;
            padding-top: 10px;
        }

        .col-lg-2, .col-lg-3, .col-lg-7, .col-lg-12 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .basic_info_area, .approval_info_area, .cc_info_area, .detail_info_area, .comment_info_area {
            margin-right: 0 !important;
        }

        .comment_info_area {
            padding: 1% !important;
        }

        .user_comment {
            font-size: 14px !important;
        }

        div[id="comment_write"] {
            padding-left: 2% !important;
            padding-bottom: 2% !important;
        }

        .user_profile {
            width: 36px !important;
            height: 36px !important;
        }

        .cc_box {
            height: auto !important;
            max-height: 180px !important;
        }

        .control-buttons {
            display: flex;
            width: 100%;
            margin-bottom: 70px !important;
            justify-content: space-between;
            gap:10px;
        }
        .control-buttons div {
            width: 1000px !important;
            margin-right: 0 !important;
            margin-left: 0 !important;
        }
        .mobile_align_left {
            justify-content: flex-start !important;
            padding-top: 5px;
            padding-left: 10px !important;
        }
        textarea[id="special_comment"] {
            max-width: 100% !important;
        }
        .desktop_hide {
            display: block;
        }
        div[id="printPage"] {
            display: none;
        }

        .status-banner {
            position: absolute;
            top: 90px;
            right: 20px;
            font-size: 24px;
        }
    }
</style>
<body>
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

        {% include 'admins/index_sidemenu.html' %}

        <!-- header -->
        <div class="layout-page" style="">
            {% include 'admins/topnav.html' %}

            <div class="status-banner d-none" id="document_status"></div>

            <div class="d-flex justify-content-between flex-xl-row flex-md-column flex-sm-row flex-column pb-2" style="padding: 0 2% 0 2%;">
                <div>
                    <div class="d-flex svg-illustration mb-2 gap-2">
                        <a href="{% url 'apv_list' %}">
                            <strong style="color: #000; font-size: x-large; font-family: Pretendard;"></i><i class="fa-regular fa-file-lines" style="color: #000000;"></i>&nbsp; 전자결재</strong></a>
                    </div>
                </div>
            </div>

            <div style="padding: 0 2% 0 2%;">
                <div style="border: 1px solid #ddd; padding: 1% 0 1% 0;">

                    <div class="template-layout container-fluid">
                        <div class="d-flex justify-content-center">
                            <input class="form-control bg-white px-0" id="doc_title" style="color: #000; font-size: 30px; font-weight: 700; border: none; margin-bottom: 10px;" disabled>
                        </div>

                        <div class="d-flex flex-wrap" style="overflow: hidden;">
                            <!-- 좌측 개인정보 -->
                            <div class="col-md-3 col-lg-3 mb-3">
                                <div class="d-flex align-items-center p-2">
                                    <i class="fa-regular fa-file fa-lg" style="color: #000;"></i>
                                    <span style="color: #000; font-size: 18px; padding-left: 10px;">기본 정보</span>
                                </div>
                                <div class="basic_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0px">
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">문서번호</div>
                                        <input class="form-control" id="doc_no" placeholder="자동으로 생성됩니다" disabled>
                                    </div>
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">작성일</div>
                                        <input class="form-control" id="create_date" disabled>
                                    </div>
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">작성자</div>
                                        <input class="form-control" id="username_md" disabled>
                                    </div>
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">부 서</div>
                                        <input class="form-control" id="team" disabled>
                                    </div>
                                </div>
                            </div>

                            <!-- 우측 결재라인 -->
                            <div class="col-md-7 col-lg-7 mb-3">
                                <div class="d-flex align-items-center p-2">
                                    <i class="fa-solid fa-user-check fa-lg" style="color: #000;"></i>
                                    <span style="color: #000; font-size: 18px; padding-left: 10px;">결재선 정보</span>
                                </div>
                                <div class="approval_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0;">
                                    <div class="d-flex justify-content-start" style="height:237px;">
                                        <div class="justify-content-start align-items-center px-3" id="approval_flow" style="display: flex; width: 100%; overflow-x: auto; white-space: nowrap;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-lg-2 mb-3">
                                <div class="d-flex align-items-center p-2">
                                    <i class="fa-solid fa-user-plus fa-lg" style="color: #000;"></i>
                                    <span style="color: #000; font-size: 18px; padding-left: 10px;">참조자</span>
                                </div>
                                <div class="cc_info_area p-2" style="border: 1px solid #ddd; margin: auto 20px auto 0; overflow: hidden;">
                                    <div class="d-flex justify-content-start cc_box" style="width: 100%; height:220px; overflow-y: auto;">
                                        <div class="d-flex justify-content-start w-100" id="apv_cc">
                                            <ul style="width: 100%; list-style-type: none; padding: 0 2px;"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 하단 세부정보 -->
                        <div class="col-12 col-md-12 col-lg-12 my-4">
                            <div class="d-flex align-items-center p-2">
                                <i class="fa-regular fa-file-lines fa-lg" style="color: #000;"></i>
                                <span style="color: #000; font-size: 18px; padding-left: 10px;">세부 정보</span>
                            </div>
                            <div class="detail_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0">

                                <div class="d-flex justify-content-start align-items-center my-3 px-2 flex-wrap">
                                    <div class="d-flex justify-content-start flex-wrap">
                                        <div class="row justify-content-center align-items-center m-1 flex-wrap mobile_align_left" style="color: #000; font-size: 16px; width:100px;">관련 사업</div>
                                        <div class="m-1">
                                            <input class="form-control" id="related_project" disabled>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-start flex-wrap">
                                        <div class="row justify-content-center align-items-center m-1 flex-wrap mobile_align_left" style="color: #000; font-size: 16px; width:100px;">결제 방법</div>
                                        <div class="m-1">
                                            <input class="form-control" id="payment_method" disabled>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-start flex-wrap">
                                        <div class="row justify-content-center align-items-center m-1 mobile_align_left" style="color: #000; font-size: 16px; width:100px;">요청 기한</div>
                                        <div class="d-flex align-items-center m-1">
                                            <input id="period_to" placeholder="클릭하여 선택" class="form-control" name="period_to" autocomplete="off" type="text" disabled/>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-start my-3 px-2 flex-wrap">
                                    <div class="d-flex addrowBtn flex-column">
                                        <div class="row justify-content-center align-items-start mx-1 mobile_align_left" style="color: #000; font-size: 16px; width:100px;">세부 항목</div>
                                        <div class="d-flex justify-content-center my-1 mobile_align_left">
                                            <span class="row align-items-center mx-1 desktop_hide" style="font-size: 12px;"> * 모바일 이용시 가로화면에서 더 크게 보입니다. </span>
                                        </div>
                                    </div>

                                    <div class="mb-3" id="detail_items" style="border: 1px solid #D9DEE3; border-radius: 6px;">
                                        <div id="table_container"></div>

                                    </div>
                                </div>

                                <div class="d-flex justify-content-start my-3 px-2 flex-wrap">
                                    <div class="row justify-content-center align-items-center m-1 mobile_align_left" style="color: #000; font-size: 16px; width:100px;">상세 설명</div>
                                    <textarea class="form-control" id="special_comment" style="max-width:90%; height:100px;" disabled></textarea>
                                </div>

                                <div class="d-flex justify-content-start my-3 px-2 flex-wrap">
                                    <div class="row justify-content-center align-items-center mx-1 mobile_align_left" style="color: #000; font-size: 16px; width: 100px; min-height: 40px;">관련 첨부</div>
                                    <div id="attached_files" class="my-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 코멘트 -->
                        <div class="col-12 col-md-12 col-lg-12 my-4">
                            <div class="d-flex align-items-center p-2">
                                <i class="fa-solid fa-comment-dots fa-lg" style="color: #000;"></i>
                                <span style="color: #000; font-size: 18px; padding-left: 10px;">추가 의견</span>
                            </div>
                            <div class="comment_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0; padding: 1.5%;">
                                <div class="d-flex justify-content-start" id="comment_list" style="flex-direction: column; margin-bottom: 20px;"></div>
                                <div class="d-flex" id="comment_write">
                                    <img class="user_profile" src="/data/{{ request.user.profile_image }}" alt="프로필 사진" style="border-radius: 50%; width: 50px; height: 50px; margin-right: 10px;">
                                    <textarea placeholder="추가 의견은 이곳에 남겨보세요" rows="10" cols="30" style="height: 60px; width: 80%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                                    <button class="btn btn-outline-secondary mx-2 p-0" style="width: 80px;" onclick="create_comment()"> 등록 </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between" style="padding: 0 2% 0 2%;">
                <div class="d-flex justify-content-start my-3">
                    <div type="button" class="btn btn-outline-success m-2 px-1" id="printPage" style="width: 150px;" onclick="apv_print_page()">인쇄</div>
                </div>
                <div class="d-flex justify-content-end my-3 control-buttons">
                    <div type="button" class="btn btn-outline-danger m-2 px-1 d-none" id="selfCancel" style="width: 150px;" onclick="apv_return_temp()"> 기안 취소 </div>
                    <div type="button" class="btn btn-outline-danger m-2 px-1 d-none" id="userReject" style="width: 150px;" onclick="apv_user_reject()"> 결재 반려 </div>
                    <div type="button" class="btn btn-outline-info m-2 px-1 d-none" id="userApprove" style="width: 150px;" onclick="apv_user_approve()"> 결재 승인 </div>
                    <div type="button" class="btn btn-outline-warning m-2 px-1" style="width: 150px;" onclick="location.href='/admins/apv/'">목록 보기 </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
{% include 'admins/admin_footer.html' %}

<script>

    let currentUserId = {{ request.user.id }};
    let username = '{{ request.user }}';
    let userteam = '{{ request.user.department_position }}';
    let categoryId = {% if category_no %} {{ category_no }} {% else %} null {% endif %};
    let documentId = {% if document_id %} {{ document_id }} {% else %} null {% endif %};
    let isSuperUser = {{ request.user.is_superuser|yesno:"true,false" }};
    let categoryName = '{{ category_name }}';
    let currentUrl = window.location.href;
    let urlCategory = currentUrl.split('/')[6];
    let apv_category_id = null;

    document.addEventListener('DOMContentLoaded', function () {
        comment_hotkey();
    });

    $(function () {
        load_apv_detail();
    });

    function preventAccess() {
        if(parseInt(urlCategory) !== parseInt(apv_category_id)) {
            alert("잘못된 접근입니다.");
            window.location.href = '/admins/apv/';
        }
    }

    function load_apv_detail() {
        let query = "?apv_id=" + documentId;
        api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
            draw_apv_detail(done);
        })
    }

    function draw_apv_detail(done) {
        // console.log("draw_apv_detail: ", done);
        let data = done.results[0];
        next_approver = done.next_approver;
        currentUserId = done.current_user_id;
        created_by_id = data.created_by.id;
        apv_category_id = data.apv_category.id;
        preventAccess();

        // 진행상태에서 기안승인/반려/취소 버튼 보이기
        if (data.apv_status === '진행') {
            if (next_approver === currentUserId) {
                document.getElementById('userApprove').classList.remove('d-none');
                document.getElementById('userReject').classList.remove('d-none');
            }
            if (created_by_id === currentUserId) {
                document.getElementById('selfCancel').classList.remove('d-none');
            }
        }

        document.getElementById('doc_title').value = data.doc_title;
        document.getElementById('doc_no').value = data.doc_no;
        document.getElementById('create_date').value = data.updated_at;
        document.getElementById('username_md').value = data.created_by.username;
        document.getElementById('team').value = data.created_by.department_position;
        document.getElementById('related_project').value = data.related_project;
        document.getElementById('payment_method').value = data.payment_method;
        document.getElementById('period_to').value = data.period_to;
        document.getElementById('special_comment').value = data.special_comment;
        if (data.apv_status !== "진행") {
            document.getElementById('document_status').classList.remove('d-none');
            document.getElementById('document_status').textContent = '결재 ' + data.apv_status;
        }

        draw_apv_approval_flow(data);
        draw_apv_cc_users(data);
        draw_apv_attached_files(data);
        draw_comments(data);

        // 테이블 데이터 그리기
        let tableContainer = document.getElementById("table_container");
        let tbody = tableContainer.querySelector("tbody");
        tbody.innerHTML = ""; // 기존 테이블 데이터 초기화

        let items = data.sub_items;
        rowCount = items.length; // rowCount를 불러온 데이터 수만큼 설정

        items.forEach((item, index) => {
            let row = document.createElement("tr");
            let price = item.price ? formatNumber(item.price) : '';
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><input class="form-control" type="text" id="desc3${index + 1}" value="${item.desc3}" disabled></td>
                <td><input class="form-control" type="text" id="desc1${index + 1}" value="${item.desc1}" disabled></td>
                <td><input class="form-control" type="text" id="desc2${index + 1}" value="${item.desc2}" disabled></td>
                <td><input class="form-control" type="text" id="price${index + 1}" value="${price}" oninput="formatInput(event); calculateTotal()" disabled></td>
                <td><input class="form-control" type="text" id="remarks${index + 1}" value="${item.remarks}" disabled></td>
            `;
            tbody.appendChild(row);
        });
        calculateTotal(); // 총액 다시 계산
    }

    function draw_apv_attached_files(data) {
        let attachedFilesDiv = document.getElementById('attached_files');
        attachedFilesDiv.innerHTML = '';

        if (data.attachments.length === 0) {
            attachedFilesDiv.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%;">첨부파일이 없습니다.</div>';
            return;
        }

        let iconClassMap = {
            'default': 'fa-regular fa-file fa-lg',
            'txt': 'fa-regular fa-file-lines fa-lg',
            'hwp': 'fa-regular fa-file-lines fa-lg',
            'hwpx': 'fa-regular fa-file-lines fa-lg',
            'jpg': 'fa-regular fa-file-image fa-lg',
            'png': 'fa-regular fa-file-image fa-lg',
            'pdf': 'fa-regular fa-file-powerpoint fa-lg',
            'doc': 'fa-regular fa-file-word fa-lg',
            'docx': 'fa-regular fa-file-word fa-lg',
            'ppt': 'fa-regular fa-file-powerpoint fa-lg',
            'pptx': 'fa-regular fa-file-powerpoint fa-lg',
            'xls': 'fa-regular fa-file-excel fa-lg',
            'xlsx': 'fa-regular fa-file-excel fa-lg',
            'zip': 'fa-regular fa-file-zipper fa-lg',
        };

        // 첨부 파일 데이터를 순회하여 링크 요소를 생성
        data.attachments.forEach((attachment, index) => {
            let fileLink = document.createElement('a');
            fileLink.href = attachment.file;

            let decodedUrl = decodeURIComponent(attachment.file);
            let fileName = decodedUrl.split('/').pop(); // URL에서 파일명 추출
            let fileExtension = fileName.split('.').pop().toLowerCase(); // 파일명에서 확장자 추출 및 소문자로 변환

            // 아이콘 클래스 설정
            let iconClass = iconClassMap[fileExtension] || iconClassMap['default'];
            let iconElement = document.createElement('i');
            iconElement.className = iconClass;
            iconElement.style.marginRight = '8px'; // 아이콘과 텍스트 사이에 여백 추가

            // 링크 텍스트 설정
            {#fileLink.textContent = `첨부${index + 1} : ` + fileName;#}
            fileLink.textContent = fileName;
            fileLink.insertBefore(iconElement, fileLink.firstChild);

            // 동적 확장자를 포함한 다운로드 파일명 설정
            fileLink.setAttribute('download', `파일_${index + 1}.${fileExtension}`);

            // 링크 텍스트 스타일 설정
            fileLink.style.color = '#343a40';
            fileLink.style.display = 'inline-block'; // 인라인 블록으로 설정하여 아이콘과 텍스트가 같은 줄에 오게 함
            fileLink.style.fontSize = '16px'; // 글자 크기 설정
            fileLink.classList.add('attached_hover'); // 클래스 추가

            // 링크 요소를 블록으로 표시
            let fileContainer = document.createElement('div');
            fileContainer.appendChild(fileLink);
            fileContainer.style.display = 'block'; // 각 파일을 블록으로 표시

            // 첨부 파일 div에 링크 요소 추가
            attachedFilesDiv.appendChild(fileContainer);
        });
    }


    function draw_apv_cc_users(data) {
        let apvCcDiv = document.getElementById('apv_cc');
        let apvCcList = apvCcDiv.querySelector('ul');
        apvCcList.innerHTML = ''; // 기존 내용을 비움

        if (!data.apv_cc || data.apv_cc.length === 0) {
            apvCcList.innerHTML = '<li style="padding: 20px; auto; auto; 20px;">참조자가 없습니다</li>';
            return;
        }

        let createCcUserDiv = (username, departmentName, profile_image) => {
            return `
            <li class="w-100" style="background-color: rgba(255, 171, 0, 0.3); display: flex; align-items: center; padding: 10px; border-radius: 6px; margin: 4px 0;">
                <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; margin-right: 10px;">
                    <img src="${profile_image}" alt="Avatar"
                         style="width: 100%; height: 100%;">
                </div>
                <div><span style="color:#222;">${departmentName}<br/>${username}</span></div>
            </li>
        `;
        };

        data.apv_cc.forEach(cc => {
            apvCcList.innerHTML += createCcUserDiv(cc.username, cc.departmentName || '', cc.profile_image);
        });
    }


    function draw_apv_approval_flow(data) {
        let approvalFlowDiv = document.getElementById('approval_flow');
        approvalFlowDiv.innerHTML = ''; // 기존 내용을 비움

        let createApproverDiv = (title, name, date, status, imageSrc) => {
            let statusBadge;
            if (status === '승인' || status === '완료') {
                statusBadge = 'text-bg-success';
            } else if (status === '반려') {
                statusBadge = 'text-bg-danger';
            } else {
                statusBadge = 'text-bg-primary';
            }

            let imageStyle = '';
            if (status === '승인' || status === '완료') {
                imageStyle = 'border: 4px solid #71DD37;';
            } else if (status === '대기') {
                imageStyle = 'border: 4px solid #696CFF;';
            } else if (status === '반려') {
                imageStyle = 'border: 4px solid #FF3E1D;';
            }

            return `
            <div class="px-3" style="text-align: center;">
                <div class="my-1" style="font-size: 14px; font-weight: bold; color: #555;">${title}</div>
                <img class="mb-3" src="${imageSrc}" alt="${name}"
                     style="border-radius: 50%; width: 80px; height: 80px; object-fit: cover; display: block; margin: 0 auto; ${imageStyle}">
                <div class="my-0" style="font-weight: bold; white-space: nowrap;">${name}</div>
                <div class="my-0" style="font-size: 14px; color: #555;">${date}</div>
                <div class="my-2" style="font-size: 16px; color: #555;"><span class="badge ${statusBadge}">${status}</span></div>
            </div>
        `;
        };

        let approvers = [
            {
                title: '작성자',
                name: data.created_by.username + ' ' + data.created_by.job_position,
                date: data.updated_at,
                status: '완료',
                imageSrc: data.created_by.profile_image,
            }
        ];

        for (let i = 1; i <= 6; i++) {
            let approverName = data.approvers[0]?.[`approver${i}_name`];
            let approverStatus = data.approvers[0]?.[`approver${i}_status`];
            let approverImg = data.approvers[0]?.[`approver${i}_img`];
            let approverDate = data.approvers[0]?.[`approver${i}_date`];
            if (approverDate === null) {
                approverDate = '결재 대기중'
            }

            if (approverName) {
                approvers.push({
                    title: `승인자${i}`,
                    name: approverName,
                    date: approverDate,
                    status: approverStatus,
                    imageSrc: approverImg,
                });
            }
        }

        approvers.forEach((approver, index) => {
            if (approver.name) {
                approvalFlowDiv.innerHTML += createApproverDiv(approver.title, approver.name, approver.date, approver.status, approver.imageSrc);
                if (index < approvers.length - 1 && approvers[index + 1].name) {
                    approvalFlowDiv.innerHTML += `<div style="font-size: 24px; color: #999; margin: 0 15px 0 15px;">
                                                  <i class="fa-solid fa-arrow-right-long fa-xl"></i></div>`;
                }
            }
        });
    }

    function apv_delete() {
        if (confirm('전자결재를 삭제하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: nullapply(documentId),
            }

            api_gp('/admins/apv/delete/', 'post', api_data, (done) => {
                alert(txt.delete_ed);
                location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

    function draw_comments(data) {
        let commentListDiv = document.getElementById('comment_list');
        commentListDiv.innerHTML = ''; // 기존 내용을 비움

        if (!data.comments || data.comments.length === 0) {
            commentListDiv.innerHTML = '<div style="font-size: 16px; color: #999;">등록된 추가 의견이 없습니다.</div>';
            return;
        }

        let formatDateTime = (dateString) => {
            let date = new Date(dateString);
            let year = date.getFullYear();
            let month = String(date.getMonth() + 1).padStart(2, '0');
            let day = String(date.getDate()).padStart(2, '0');
            let hours = date.getHours();
            let minutes = String(date.getMinutes()).padStart(2, '0');
            let period = hours < 12 ? '오전' : '오후';
            hours = hours % 12 || 12; // 12시간제로 변경

            return `${year}-${month}-${day} ${period} ${String(hours).padStart(2, '0')}:${minutes}`;
        };

        let createCommentDiv = (comment) => {
            let profile_image = comment.created_by.profile_image;
            let username = comment.created_by.username;
            let date = "";
            if (comment.created_at === comment.updated_at) {
                date = formatDateTime(comment.created_at);
            } else {
                date = formatDateTime(comment.created_at) + '  (최근 수정됨: ' + formatDateTime(comment.updated_at) + ')';
            }
            let content = comment.content.replace(/\n/g, '<br>'); // 줄바꿈을 <br>로 변환
            let comment_id = comment.id;
            let created_by_id = comment.created_by.id;

            let editDeleteButtons = '';
            if (created_by_id === currentUserId) {
                editDeleteButtons = `
                <button id="edit_button_${comment_id}" onclick="editComment(${comment_id})" style="background: none; border: none; cursor: pointer;">
                    <i class="fa-solid fa-eraser fa-sm" style="color: #999;"></i>
                </button>
                <button id="delete_button_${comment_id}" onclick="deleteComment(${comment_id})" style="margin-left: -5px; background: none; border: none; cursor: pointer;">
                    <i class="fa-solid fa-trash-can fa-sm" style="color: #999;"></i>
                </button>
            `;
            }

            return `
                <div id="comment_${comment_id}" style="display: flex; align-items: start; margin-bottom: 20px;">
                    <img class="user_profile" src="${profile_image}" alt="프로필 사진"
                         style="border-radius: 50%; width: 50px; height: 50px; margin-right: 10px;">
                    <div class="user_comment w-100" style="font-size: 16px;">
                        <strong>${username}</strong> <span style="color: #999; margin-left: 10px;">${date}${editDeleteButtons}</span>
                        <br>
                        <span id="comment_content_${comment_id}" style="color: #343a40;">${content}</span>

                    </div>
                </div>
            `;
        };

        let fragment = document.createDocumentFragment();
        data.comments.forEach(comment => {
            let commentDiv = document.createElement('div');
            commentDiv.innerHTML = createCommentDiv(comment);
            fragment.appendChild(commentDiv);
        });
        commentListDiv.appendChild(fragment);
    }

    function create_comment() {
        let textarea = document.querySelector('#comment_write textarea');
        let content = textarea.value;
        let api_data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            document: documentId,
            content: content,
        };

        api_gp('/admins/apv/comment/create/', 'post', api_data, (done) => {
            if (done.error) {
                alert(done.message || '댓글 등록에 실패했습니다.');
                return;
            }

            let query = "?apv_id=" + documentId;
            api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
                let data = done.results[0];
                draw_comments(data);
                textarea.value = ''; // 댓글 등록 후 textarea 초기화
            });
        });
    }

    function editComment(comment_id) {
        let contentSpan = document.getElementById(`comment_content_${comment_id}`);
        if (!contentSpan) {
            console.error(`Element with id comment_content_${comment_id} not found.`);
            return;
        }

        let originalContent = contentSpan.textContent.trim();
        {#contentSpan.classList.add('d-flex');#}
        contentSpan.innerHTML = `
            <textarea id="edit_content_${comment_id}" style="height: auto; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${originalContent}</textarea>
            <button class="btn btn-outline-secondary my-2" onclick="saveComment(${comment_id})">저장</button>
            <button class="btn btn-outline-danger m-0" onclick="cancelEdit(${comment_id}, \`${originalContent}\`)">취소</button>
        `;

        // 수정, 삭제 버튼 숨김 처리
        document.getElementById(`edit_button_${comment_id}`).style.display = 'none';
        document.getElementById(`delete_button_${comment_id}`).style.display = 'none';
    }

    function saveComment(comment_id) {
        let newContent = document.getElementById(`edit_content_${comment_id}`).value;
        let api_data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            comment_id: comment_id,
            content: newContent,
        };

        api_gp('/admins/apv/comment/update/', 'post', api_data, (done) => {
            if (done.error) {
                alert(done.message || '댓글 수정에 실패했습니다.');
                return;
            }

            let query = "?apv_id=" + documentId;
            api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
                let data = done.results[0];
                draw_comments(data);
            });
        });

        // 수정, 삭제 버튼 보이도록 처리
        document.getElementById(`edit_button_${comment_id}`).style.display = 'inline';
        document.getElementById(`delete_button_${comment_id}`).style.display = 'inline';
    }

    function cancelEdit(comment_id, originalContent) {
        let contentSpan = document.getElementById(`comment_content_${comment_id}`);
        contentSpan.innerHTML = `${originalContent}`;

        // 수정, 삭제 버튼 보이도록 처리
        document.getElementById(`edit_button_${comment_id}`).style.display = 'inline';
        document.getElementById(`delete_button_${comment_id}`).style.display = 'inline';
    }

    function deleteComment(comment_id) {
        if (!confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
            return;
        }

        let api_data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            comment_id: comment_id,
        };

        api_gp('/admins/apv/comment/delete/', 'post', api_data, (done) => {
            if (done.error) {
                alert(done.message || '댓글 삭제에 실패했습니다.');
                return;
            }

            let query = "?apv_id=" + documentId;
            api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
                let data = done.results[0];
                draw_comments(data);
            });
        });
    }

    function comment_hotkey() {
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            // console.log('모바일에서는 실행되지 않는 기능입니다..');
            return;
        }

        let textarea = document.querySelector('#comment_write textarea');
        if (textarea) {
            textarea.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    create_comment();
                }
            });
        } else {
            console.warn('Textarea를 찾을 수 없음');
        }

        let observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                mutation.addedNodes.forEach(function (node) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        let newTextarea = node.querySelector('#comment_write textarea');
                        if (newTextarea) {
                            newTextarea.addEventListener('keydown', function (event) {
                                if (event.key === 'Enter' && !event.shiftKey) {
                                    event.preventDefault();
                                    create_comment();
                                }
                            });
                        }
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    function apv_return_temp() {
        if (confirm('기안을 취소하시겠습니까?\n전자결재가 임시상태로 변경되며 모든 승인과 첨부파일은 초기화됩니다.')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                apv_id: nullapply(documentId),
                approver_action: 'return_temp',
            }

            api_gp('/admins/apv/detail/', 'post', api_data, (done) => {
                alert("기안이 취소되었습니다.");
                location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

    function apv_user_approve() {
        if (confirm('결재를 승인하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                apv_id: nullapply(documentId),
                approver_action: 'approve',
            }

            api_gp('/admins/apv/detail/', 'post', api_data, (done) => {
                alert("결재를 승인하였습니다.");
                location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

    function apv_user_reject() {
        if (confirm('결재를 반려하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                apv_id: nullapply(documentId),
                approver_action: 'reject'
            }

            api_gp('/admins/apv/detail/', 'post', api_data, (done) => {
                alert("결재를 반려하였습니다.");
                location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

    let rowCount = 0;
    let maxRows = 20;

    function addRow() {
        let tableContainer = document.getElementById("table_container");
        let tbody = tableContainer.querySelector("tbody");

        if (tbody.childElementCount === 0) {
            rowCount = 0;  // 테이블이 비어있을 때만 rowCount 초기화
        }
        if (rowCount < maxRows) {
            rowCount++;
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${rowCount}</td>
                <td><input class="form-control" type="text" id="desc3${rowCount}"></td>
                <td><input class="form-control" type="text" id="desc1${rowCount}"></td>
                <td><input class="form-control" type="text" id="desc2${rowCount}"></td>
                <td><input class="form-control" type="text" id="price${rowCount}" oninput="formatInput(event); calculateTotal()"></td>
                <td><input class="form-control" type="text" id="remarks${rowCount}"></td>
            `;
            tbody.appendChild(row);
            calculateTotal();
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        let tableContainer = document.getElementById("table_container");

        let table = document.createElement("table");
        table.classList.add("table", "table-sm", "table-striped", "m-0");

        let thead = document.createElement("thead");
        thead.innerHTML = `
            <tr>
                <th id="item_no" style="color: #000; font-size: small; width: 3%;">No</th>
                <th id="desc3" style="text-align: center; color: #000; font-size: small; width: 12%;">관련일자</th>
                <th id="desc1" style="text-align: center; color: #000; font-size: small; width: 35%;">내 용</th>
                <th id="desc2" style="text-align: center; color: #000; font-size: small; width: 15%;">지출처</th>
                <th id="price" style="text-align: center; color: #000; font-size: small; width: 10%;">금 액(원)</th>
                <th id="remarks" style="text-align: center; color: #000; font-size: small; width: 25%;">비 고</th>
            </tr>
        `;
        table.appendChild(thead);

        let tbody = document.createElement("tbody");
        table.appendChild(tbody);

        let tfoot = document.createElement("tfoot");
        tfoot.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: end; color: #000; font-size: small; font-weight: bold; border-bottom: 0;">합계</td>
                <td id="amount" style="text-align: center; color: #000; font-size: small; font-weight: bold; border-bottom: 0;">0 원</td>
                <td style="border-bottom: 0;"></td>
            </tr>
        `;
        table.appendChild(tfoot);
        tableContainer.appendChild(table);
    });


    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function unformatNumber(num) {
        return num.replace(/,/g, '');
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('input[id^="price"]').forEach(input => {
            let value = parseFloat(unformatNumber(input.value)) || 0;
            total += value;
        });
        document.getElementById("amount").textContent = formatNumber(total) + ' 원';
    }

    function formatInput(event) {
        let input = event.target;
        let value = unformatNumber(input.value);
        if (!isNaN(value) && value !== "") {
            input.value = formatNumber(value);
        } else {
            input.value = "";
        }
    }

    function apv_print_page(){
        let newWindow = window.open(`/admins/apv/print/${categoryId}/${documentId}`, 'print_page', 'width=1200, height=1000');

        if (newWindow && newWindow.innerWidth) {
            newWindow.document.documentElement.webkitRequestFullscreen();
        }
    }

</script>
