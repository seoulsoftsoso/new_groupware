{% load static %}
<!DOCTYPE html>

<meta charset="UTF-8">
{% include 'admins/admin_header.html' %}
<style>
    /* 모바일웹 텍스트 줄바꿈 방지 */
    .table td, .table th {
        white-space: nowrap;
    }

    @media (max-width: 1000px) {
        .control-buttons {
            height: 40px;
        }

    }
</style>
<body>

<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

        {% include 'admins/index_sidemenu.html' %}

        <!-- header -->
        <div class="layout-page" style="">
            {% include 'admins/topnav.html' %}

            <div class="d-flex justify-content-between flex-xl-row flex-md-column flex-sm-row flex-column px-3 pb-2">
                <div class="mb-xl-0 mb-4">
                    <div class="d-flex svg-illustration mb-2 gap-2">
                        <a href="{% url 'apv_list' %}">
                            <strong style="color: #000; font-size: x-large; margin-left: 20px; font-family: Pretendard;"></i><i class="fa-regular fa-file-lines" style="color: #000000;"></i>&nbsp; 전자결재</strong></a>
                    </div>
                </div>
            </div>

            <div class="px-4">
                <div id="template_include" style="border: 1px solid #ddd; padding: 2% 0 2% 0;"></div>

                <div class="d-flex justify-content-end py-4">
                    <div type="button" class="btn btn-outline-danger mx-2" style="width: 150px;"
                         onclick="apv_delete()"> 삭 제
                    </div>
                    <div type="button" class="btn btn-outline-secondary mx-2" style="width: 150px;"
                         onclick="apv_tempsave()"> 임시 저장
                    </div>
                    <div type="button" class="btn btn-outline-info mx-2" style="width: 150px;"
                         onclick="apv_modal_approvalsend()"> 결재 전송
                    </div>
                    <a href="{% url 'apv_list' %}" class="btn btn-outline-warning mx-2" style="width: 150px;">목록 보기</a>
                </div>
            </div>


        </div>
    </div>
</div>

</body>
{% include 'admins/admin_footer.html' %}

<script>

    let currentUrl = window.location.href;
    let apv_click_id = currentUrl.split("/").slice(-2, -1)[0];

    $(function () {
        load_apv_detail()
    });

    function loadTemplateScripts() {

    }

    function load_apv_detail() {
        let query = "?apv_id=" + apv_click_id;
        api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
            draw_apv_detail(done);
        })
    }

    function draw_apv_detail(done) {
        console.log("draw_apv_temp_update: ", done);
        let data = done.results[0];

        categoryId = data.apv_category.id;
        fetch(`/admins/apv/detail_temp/${categoryId}`)
            .then(response => response.text())
            .then(templateData => {
                loadTemplateScripts();
                document.getElementById('template_include').innerHTML = templateData;
                document.getElementById('doc_title').value = data.doc_title;
                document.getElementById('doc_no').value = data.doc_no;
                document.getElementById('create_date').value = data.updated_at;
                document.getElementById('username_md').value = data.created_by.username;
                document.getElementById('team').value = data.created_by.department_position;
                document.getElementById('approver1').value = data.approvers[0]?.approver1_name ? data.approvers[0].approver1_name + ' (' + data.approvers[0].approver1_team + ')' : '';
                document.getElementById('approver2').value = data.approvers[0]?.approver2_name ? data.approvers[0].approver2_name + ' (' + data.approvers[0].approver2_team + ')' : '';
                document.getElementById('approver3').value = data.approvers[0]?.approver3_name ? data.approvers[0].approver3_name + ' (' + data.approvers[0].approver3_team + ')' : '';
                document.getElementById('approver4').value = data.approvers[0]?.approver4_name ? data.approvers[0].approver4_name + ' (' + data.approvers[0].approver4_team + ')' : '';
                document.getElementById('approver5').value = data.approvers[0]?.approver5_name ? data.approvers[0].approver5_name + ' (' + data.approvers[0].approver5_team + ')' : '';
                document.getElementById('approver6').value = data.approvers[0]?.approver6_name ? data.approvers[0].approver6_name + ' (' + data.approvers[0].approver6_team + ')' : '';
                document.getElementById('leave_reason').value = data.leave_reason;
                document.getElementById('period_from').value = data.period_from;
                document.getElementById('period_to').value = data.period_to;
                document.getElementById('period_count').value = data.period_count;
                document.getElementById('special_comment').value = data.special_comment;

                let apvCcSelect = document.getElementById('apv_cc');
                let selectedCcIds = data.apv_cc.map(cc => cc.user_id);
                Array.from(apvCcSelect.options).forEach(option => {
                    if (selectedCcIds.includes(parseInt(option.value))) {
                        option.selected = true;
                    } else {
                        option.selected = false;
                        option.style.display = 'none';
                    }
                });

                let attachedFilesDiv = document.getElementById('attached_files');
                attachedFilesDiv.innerHTML = ''; // 초기화
                data.attachments.forEach((attachment, index) => {
                    let fileLink = document.createElement('a');
                    fileLink.href = attachment.file;

                    let decodedUrl = decodeURIComponent(attachment.file);
                    let fileName = decodedUrl.split('/').pop(); // URL에서 파일명 추출
                    let fileExtension = fileName.split('.').pop(); // 파일명에서 확장자 추출

                    fileLink.textContent = `첨부${index + 1} : ` + fileName;
                    fileLink.setAttribute('download', `파일_${index + 1}.${fileExtension}`); // 동적 확장자 설정
                    fileLink.style.display = 'block';
                    attachedFilesDiv.appendChild(fileLink);
                });
            })

            .catch(error => {
                console.error('Error loading category detail:', error);
            });
    }

    function apv_delete() {
        if (confirm('전자결재를 작성하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: nullapply(apv_click_id),
                }

            api_gp('/admins/apv/delete/', 'post', api_data, (done) => {
                    alert(txt.delete_ed);
                    location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

</script>