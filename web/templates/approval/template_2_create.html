{% load static %}
<!DOCTYPE html>

<meta charset="UTF-8">
{% include 'admins/admin_header.html' %}
<style>
    /* 모바일웹 텍스트 줄바꿈 방지 */
    .table td, .table th {
        white-space: nowrap;
    }

    .approver_group2 {
        display: block;
    }
    .show-more {
        display: none;
    }
    .desktop_hide {
        display: none;
    }

    @media (max-width: 900px) {
        .col-lg-3, .col-lg-6, .col-lg-12 {
                flex: 0 0 100%;
                max-width: 100%;
            }

        .basic_info_area, .approval_info_area, .cc_info_area,
        .detail_info_area, .check_info_area {
            margin-right: 0 !important;
        }

        .control-buttons {
            display: flex;
            width: 100%;
            margin-bottom: 70px !important;
            justify-content: space-between;
            gap:10px;
        }
        .control-buttons div {
            width: 1000px !important;
            margin-right: 0 !important;
            margin-left: 0 !important;
        }

        input[id="doc_title"] {
            font-size: 20px !important;
        }

        input[id="approver1"],
        input[id="approver2"],
        input[id="approver3"],
        input[id="approver4"],
        input[id="approver5"],
        input[id="approver6"] {
            width: 180px !important;
        }

        .cc_box {
            height: 130px !important;
        }
        select[id="apv_cc"] {
            width: 190px !important;
            height: 100px !important;
            margin-right: 10px;
        }
        .mobile_align_left {
            justify-content: flex-start !important;
        }
        .approver_group2 {
            display: none;
        }
        .show-more {
            display: block;
        }
        .addrowBtn {
            display: inline-block !important;
        }
        .desktop_hide {
            display: block;
        }
        textarea[id="special_comment"] {
            max-width: 100% !important;
        }
    }
</style>
<body>
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">

        {% include 'admins/index_sidemenu.html' %}

        <!-- header -->
        <div class="layout-page" style="">
            {% include 'admins/topnav.html' %}

            <div class="d-flex justify-content-between flex-xl-row flex-md-column flex-sm-row flex-column pb-2" style="padding: 0 2% 0 2%;">
                <div>
                    <div class="d-flex svg-illustration mb-2 gap-2">
                        <a href="{% url 'apv_list' %}">
                            <strong style="color: #000; font-size: x-large; font-family: Pretendard;"></i><i class="fa-regular fa-file-lines" style="color: #000000;"></i>&nbsp; 전자결재</strong></a>
                    </div>
                </div>
            </div>

            <div style="padding: 0 2% 0 2%;">
                <div style="border: 1px solid #ddd; padding: 1% 0 1% 0;">

                    <div class="template-layout container-fluid">
                        <div class="d-flex justify-content-center">
                            <input class="form-control px-0" id="doc_title" style="color: #000; font-size: 30px; font-weight: 700; border: none; margin-bottom: 10px;">
                        </div>

                        <div class="d-flex flex-wrap" style="overflow: hidden;">
                            <!-- 좌측 개인정보 -->
                            <div class="col-md-3 col-lg-3 mb-3">
                                <div class="d-flex align-items-center p-2">
                                    <i class="fa-regular fa-file fa-lg" style="color: #000;"></i>
                                    <span style="color: #000; font-size: 18px; padding-left: 10px;">기본 정보</span>
                                </div>
                                <div class="basic_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0px">
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">문서번호</div>
                                        <input class="form-control" id="doc_no" placeholder="자동으로 생성됩니다" disabled>
                                    </div>
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">작성일</div>
                                        <input class="form-control" id="create_date" disabled>
                                    </div>
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">작성자</div>
                                        <input class="form-control" id="username_md" disabled>
                                    </div>
                                    <div class="d-flex justify-content-start my-3 px-3">
                                        <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">부 서</div>
                                        <input class="form-control" id="team" disabled>
                                    </div>
                                </div>
                            </div>

                            <!-- 우측 결재라인 -->
                            <div class="col-md-6 col-lg-6 mb-3">
                                <div class="d-flex align-items-center p-2">
                                    <i class="fa-solid fa-user-check fa-lg" style="color: #000;"></i>
                                    <span style="color: #000; font-size: 18px; padding-left: 10px;">결재선 정보</span>
                                </div>
                                <div class="approval_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0; overflow: hidden;">
                                    <div class="d-flex flex-wrap" style="min-height:237px;">
                                        <div class="approver_group1">
                                            <div class="d-flex justify-content-start my-3">
                                                <div class="d-flex justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">결재자 1</div>
                                                <input list="approver_list" class="form-control" id="approver1" name="approver_list" style="max-width:200px;">
                                                <datalist id="approver_list">
                                                    {% for position, name, id in approver_list %}
                                                        <option value="{{ name }} ({{ position }})" data-approver-id="{{ id }}"></option>
                                                    {% endfor %} </datalist>
                                            </div>
                                            <div class="d-flex justify-content-start my-3">
                                                <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">결재자 2</div>
                                                <input list="approver_list" class="form-control" id="approver2" name="approver_list" style="width:200px;">
                                                <datalist id="approver_list">
                                                    {% for position, name, id in approver_list %}
                                                        <option value="{{ name }} ({{ position }})" data-approver-id="{{ id }}"></option>
                                                    {% endfor %} </datalist>
                                            </div>
                                            <div class="d-flex justify-content-start my-3">
                                                <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">결재자 3</div>
                                                <input list="approver_list" class="form-control" id="approver3" name="approver_list" style="width:200px;">
                                                <datalist id="approver_list">
                                                    {% for position, name, id in approver_list %}
                                                        <option value="{{ name }} ({{ position }})" data-approver-id="{{ id }}"></option>
                                                    {% endfor %} </datalist>
                                            </div>
                                            <div class="d-flex justify-content-start mx-2">
                                                <button id="show-more" class="btn show-more">더 보기...</button>
                                            </div>
                                        </div>
                                        <div class="approver_group2">
                                            <div class="d-flex justify-content-start my-3">
                                                <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">결재자 4</div>
                                                <input list="approver_list" class="form-control" id="approver4" name="approver_list" style="width:200px;">
                                                <datalist id="approver_list">
                                                    {% for position, name, id in approver_list %}
                                                        <option value="{{ name }} ({{ position }})" data-approver-id="{{ id }}"></option>
                                                    {% endfor %} </datalist>
                                            </div>
                                            <div class="d-flex justify-content-start my-3">
                                                <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">결재자 5</div>
                                                <input list="approver_list" class="form-control" id="approver5" name="approver_list" style="width:200px;">
                                                <datalist id="approver_list">
                                                    {% for position, name, id in approver_list %}
                                                        <option value="{{ name }} ({{ position }})" data-approver-id="{{ id }}"></option>
                                                    {% endfor %} </datalist>
                                            </div>
                                            <div class="d-flex justify-content-start my-3">
                                                <div class="row justify-content-center align-items-center mx-1" style="color: #000; font-size: 16px; width:100px;">결재자 6</div>
                                                <input list="approver_list" class="form-control" id="approver6" name="approver_list" style="width:200px;">
                                                <datalist id="approver_list">
                                                    {% for position, name, id in approver_list %}
                                                        <option value="{{ name }} ({{ position }})" data-approver-id="{{ id }}"></option>
                                                    {% endfor %} </datalist>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="col-md-3 col-lg-3 mb-3">
                                <div class="d-flex align-items-center p-2">
                                    <i class="fa-solid fa-user-check fa-lg" style="color: #000;"></i>
                                    <span style="color: #000; font-size: 18px; padding-left: 10px;">참조자</span>
                                </div>
                                <div class="cc_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0; overflow: hidden;">
                                    <div class="d-flex cc_box" style="height:237px;">
                                        <div class="d-flex justify-content-start my-3">
                                            <div class="row justify-content-center align-items-start mt-1 mx-1" style="color: #000; font-size: 16px; width:100px;">참조자</div>
                                            <select class="form-control" id="apv_cc" name="approver_list" style="width:240px;" multiple>
                                                {% for position, name, id in approver_list %}
                                                    <option value="{{ id }}">{{ position }} - {{ name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 하단 세부정보 -->
                        <div class="col-12 col-md-12 col-lg-12 my-4">
                            <div class="d-flex align-items-center p-2">
                                <i class="fa-regular fa-file-lines fa-lg" style="color: #000;"></i>
                                <span style="color: #000; font-size: 18px; padding-left: 10px;">지출결의 세부사항</span>
                            </div>
                            <div class="detail_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0">

                                <div class="d-flex justify-content-start align-items-center my-3 px-2 flex-wrap">
                                    <div class="d-flex justify-content-start flex-wrap">
                                        <div class="row justify-content-center align-items-center m-1 flex-wrap mobile_align_left" style="color: #000; font-size: 16px; width:100px;">관련 사업</div>
                                        <div class="m-1">
                                            <input class="form-control" id="related_project">
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-start flex-wrap">
                                        <div class="row justify-content-center align-items-center m-1 flex-wrap mobile_align_left" style="color: #000; font-size: 16px; width:100px;">결제 방법</div>
                                        <div class="m-1">
                                            <input class="form-control" id="payment_method">
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-start flex-wrap">
                                        <div class="row justify-content-center align-items-center m-1 mobile_align_left" style="color: #000; font-size: 16px; width:100px;">요청 기한</div>
                                        <div class="d-flex align-items-center m-1">
                                            <input id="period_to" placeholder="클릭하여 선택" class="form-control" name="period_to" autocomplete="off" type="text"/>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-start my-3 px-2 flex-wrap">
                                    <div class="d-flex addrowBtn flex-column">
                                        <div class="row justify-content-center align-items-start mx-1 mobile_align_left" style="color: #000; font-size: 16px; width:100px;">세부 항목</div>
                                        <div class="d-flex justify-content-center my-1 mobile_align_left">
                                            <button type="button" id="add_row" class="btn btn-sm btn-outline-secondary" style="width: 30px; height: 30px;">+</button>
                                            <button type="button" id="remove_row" class="btn btn-sm btn-outline-secondary mx-1" style="width: 30px; height: 30px;">-</button>
                                            <span class="row align-items-center mx-1 desktop_hide" style="font-size: 12px;"> * 모바일 이용시 가로화면에서 더 크게 보입니다. </span>
                                        </div>
                                    </div>
                                    <div class="mb-3" id="detail_items" style="border: 1px solid #D9DEE3; border-radius: 6px;">
                                        <div id="table_container"></div>

                                    </div>
                                </div>

                                <div class="d-flex justify-content-start my-3 px-2 flex-wrap">
                                    <div class="row justify-content-center align-items-center m-1 mobile_align_left" style="color: #000; font-size: 16px; width:100px;">상세 설명</div>
                                    <textarea class="form-control" id="special_comment" style="max-width:90%; height:100px;"></textarea>
                                </div>

                                <div class="d-flex justify-content-start my-3 px-2 flex-wrap">
                                    <div class="row justify-content-center align-items-center mx-1 mobile_align_left" style="color: #000; font-size: 16px; width: 100px; min-height: 40px;">관련 첨부</div>
                                    <input type="file" class="form-control" id="attached_files" name="attached_files" style="width:500px;" multiple>
                                    <span class="row align-items-center mx-3"> * 첨부파일은 임시저장에서 제외, 결재 전송시에만 첨부 (기안취소시 기존 첨부파일은 남아있으니 재첨부할 필요 없음)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-12 col-lg-12 my-4">
                            <div class="d-flex align-items-center p-2">
                                <i class="fa-solid fa-list-check fa-lg" style="color: #000;"></i>
                                <span style="color: #000; font-size: 18px; padding-left: 10px;">참고사항</span>
                            </div>
                            <div class="check_info_area" style="border: 1px solid #ddd; margin: auto 20px auto 0">
                                <ul class="m-2" style="color:#000">
                                    <li>기타 필요한 내용은 '상세 설명'란에 기입</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="padding: 0 2% 0 2%;">
                <div class="d-flex justify-content-end my-3 control-buttons">
                    <div type="button" class="btn btn-outline-danger m-2 px-1 d-none" style="width: 150px;" id="deleteBtn" onclick="apv_delete()"> 삭 제 </div>
                    <div type="button" class="btn btn-outline-secondary m-2 px-1" style="width: 150px;" onclick="apv_tempsave()"> 임시 저장 </div>
                    <div type="button" class="btn btn-outline-info m-2 px-1" style="width: 150px;" onclick="apv_send_progress()"> 결재 전송 </div>
                    <div type="button" class="btn btn-outline-warning m-2 px-1" style="width: 150px;" onclick="location.href='/admins/apv/'">목록 보기</div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
{% include 'admins/admin_footer.html' %}

<script>

    let currentUserId = {{ request.user.id }};
    let username = '{{ request.user }}';
    let userteam = '{{ request.user.department_position }}';
    let categoryId = {% if category_no %} {{ category_no }} {% else %} null {% endif %};
    let documentId = {% if document_id %} {{ document_id }} {% else %} null {% endif %};
    let isSuperUser = {{ request.user.is_superuser|yesno:"true,false" }};
    let categoryName = '{{ category_name }}';
    let currentUrl = window.location.href;
    let urlCategory = currentUrl.split('/')[6];
    let apv_category_id = null;

    $(document).ready(function () {
        $('#period_to').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        });

        loadCreateDate();
        checkApproverList();

        if(documentId) {
            load_apv_temp_data();
            if (documentId) {
                document.getElementById('deleteBtn').classList.remove('d-none');
            }
        }
    });

    function preventAccess() {
        if(parseInt(urlCategory) !== parseInt(apv_category_id)) {
            alert("잘못된 접근입니다.");
            window.location.href = '/admins/apv/';
        }
    }

    function checkApproverList() {
        let approvers = ['approver1', 'approver2', 'approver3', 'approver4', 'approver5', 'approver6'];
        approvers.forEach(function(approverId) {
            document.getElementById(approverId).addEventListener('blur', function() {
                let input = this.value;
                let dataList = document.getElementById('approver_list');
                let options = Array.from(dataList.options).map(option => option.value);

                if (!options.includes(input) && input !== "") {
                    alert('입력된 값이 정확하지 않습니다. 드랍다운목록에서 선택해주시기 바랍니다.');
                    this.value = ''; // 입력된 값을 초기화
                }
            });
        });
    }

    function loadCreateDate() {
        let createDateInput = document.getElementById('create_date');
        let days = ['일', '월', '화', '수', '목', '금', '토'];
        let now = new Date();
        let year = now.getFullYear();
        let month = ('0' + (now.getMonth() + 1)).slice(-2);
        let day = ('0' + now.getDate()).slice(-2);
        let weekDay = days[now.getDay()];
        let formattedDate = year + '-' + month + '-' + day + ' (' + weekDay + ')';
        let simepleDate = year.toString().slice(-2) + month + day
        createDateInput.value = formattedDate;

        document.getElementById('username_md').value = username;
        document.getElementById('team').value = userteam;
        document.getElementById('doc_title').value = '['+ categoryName +'] ' + userteam + ' ' + username + ' ' + simepleDate;
    }

    function getApproverId(approverInputId) {
        let approverName = $(`#${approverInputId}`).val();
        let option = $(`#approver_list option`).filter(function() {
            return $(this).val() === approverName;
        });

        return option.length ? option.data('approver-id') : null;
    }

    function getSelectedCC(selectElement) {
        let selectedValues = [];
        let selectedOptions = selectElement && selectElement.options;

        for (let i = 0; i < selectedOptions.length; i++) {
            if (selectedOptions[i].selected) {
                selectedValues.push(selectedOptions[i].value);
            }
        }

        return selectedValues.length > 0 ? selectedValues : null;
    }

    function load_apv_temp_data() {
        let query = "?apv_id=" + documentId;
        api_gp("/admins/apv/detail/" + query, "get", {}, (done) => {
            draw_apv_temp_data(done);
        })
    }

    function draw_apv_temp_data(done) {
        console.log("draw_apv_temp_update: ", done);
        let data = done.results[0];
        apv_category_id = data.apv_category.id;
        preventAccess();

        document.getElementById('doc_title').value = data.doc_title;
        document.getElementById('doc_no').value = data.doc_no;
        document.getElementById('create_date').value = data.updated_at;
        document.getElementById('username_md').value = data.created_by.username;
        document.getElementById('team').value = data.created_by.department_position;
        document.getElementById('approver1').value = data.approvers[0]?.approver1_name ? data.approvers[0].approver1_name.split(' ')[0] + ' (' + data.approvers[0].approver1_team + ')' : '';
        document.getElementById('approver2').value = data.approvers[0]?.approver2_name ? data.approvers[0].approver2_name.split(' ')[0] + ' (' + data.approvers[0].approver2_team + ')' : '';
        document.getElementById('approver3').value = data.approvers[0]?.approver3_name ? data.approvers[0].approver3_name.split(' ')[0] + ' (' + data.approvers[0].approver3_team + ')' : '';
        document.getElementById('approver4').value = data.approvers[0]?.approver4_name ? data.approvers[0].approver4_name.split(' ')[0] + ' (' + data.approvers[0].approver4_team + ')' : '';
        document.getElementById('approver5').value = data.approvers[0]?.approver5_name ? data.approvers[0].approver5_name.split(' ')[0] + ' (' + data.approvers[0].approver5_team + ')' : '';
        document.getElementById('approver6').value = data.approvers[0]?.approver6_name ? data.approvers[0].approver6_name.split(' ')[0] + ' (' + data.approvers[0].approver6_team + ')' : '';
        document.getElementById('related_project').value = data.related_project;
        document.getElementById('payment_method').value = data.payment_method;
        document.getElementById('period_to').value = data.period_to;
        document.getElementById('special_comment').value = data.special_comment;

        let apvCcSelect = document.getElementById('apv_cc');
        let selectedCcIds = data.apv_cc.map(cc => cc.user_id);
        Array.from(apvCcSelect.options).forEach(option => {
            if (selectedCcIds.includes(parseInt(option.value))) {
                option.selected = true;
            } else {
                option.selected = false;
            }
        });

        // 테이블 데이터 그리기
        let tableContainer = document.getElementById("table_container");
        let tbody = tableContainer.querySelector("tbody");
        tbody.innerHTML = ""; // 기존 테이블 데이터 초기화

        let items = data.sub_items;
        rowCount = items.length; // rowCount를 불러온 데이터 수만큼 설정

        items.forEach((item, index) => {
            let row = document.createElement("tr");
            let price = item.price ? formatNumber(item.price) : '';
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><input class="form-control" type="text" id="desc3${index + 1}" value="${item.desc3}"></td>
                <td><input class="form-control" type="text" id="desc1${index + 1}" value="${item.desc1}"></td>
                <td><input class="form-control" type="text" id="desc2${index + 1}" value="${item.desc2}"></td>
                <td><input class="form-control" type="text" id="price${index + 1}" value="${price}" oninput="formatInput(event); calculateTotal()"></td>
                <td><input class="form-control" type="text" id="remarks${index + 1}" value="${item.remarks}"></td>
            `;
            tbody.appendChild(row);
        });

        if (items.length === 0) {
            addRow(); // 데이터가 없을 경우 기본으로 1번 줄 생성
        }
        calculateTotal(); // 총액 다시 계산
    }


    // 임시저장 (첨부파일저장안함 + 필수필드없음)
    function apv_tempsave() {
        let apvCcElement = document.getElementById('apv_cc');
        let selectedCcValues = getSelectedCC(apvCcElement);
        let tableData = getTableData();

        let api_data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pk: nullapply(documentId),
            apv_category_id: categoryId,
            apv_status: '임시',
            doc_title: nullapply($('#doc_title').val()),
            related_project: nullapply($('#related_project').val()),
            payment_method: nullapply($('#payment_method').val()),
            period_to: nullapply($('#period_to').val()),
            special_comment: nullapply($('#special_comment').val()),
            approver1: getApproverId('approver1'),
            approver2: getApproverId('approver2'),
            approver3: getApproverId('approver3'),
            approver4: getApproverId('approver4'),
            approver5: getApproverId('approver5'),
            approver6: getApproverId('approver6'),
            apv_cc: selectedCcValues,
            table_data: tableData
        };

        function sendApiRequest(pk) {
            if(pk) {
                send_url = '/admins/apv/update/'
            } else {
                send_url = '/admins/apv/create/'
            }
            api_gp(send_url, 'post', api_data, (done) => {
                location.href = "/admins/apv/";
                alert("임시저장이 완료되었습니다.");
            });
        }
        sendApiRequest(api_data.pk);
    }

    // 결재전송 (첨부파일저장 + 필수필드누락경고)
    function apv_send_progress() {
        if (confirm('승인 요청을 전송하시겠습니까?')) {
            let apvCcElement = document.getElementById('apv_cc');
            let selectedCcValues = getSelectedCC(apvCcElement);
            let tableData = getTableData();

            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: nullapply(documentId),
                apv_category_id: categoryId,
                apv_status: '진행',
                doc_no: nullapply($('#doc_no').val()),
                doc_title: nullapply($('#doc_title').val()),
                related_project: nullapply($('#related_project').val()),
                payment_method: nullapply($('#payment_method').val()),
                period_to: nullapply($('#period_to').val()),
                special_comment: nullapply($('#special_comment').val()),
                attached_files: [],
                approver1: getApproverId('approver1'),
                approver2: getApproverId('approver2'),
                approver3: getApproverId('approver3'),
                approver4: getApproverId('approver4'),
                approver5: getApproverId('approver5'),
                approver6: getApproverId('approver6'),
                apv_cc: selectedCcValues,
                table_data: tableData
            };

            let attachedFiles = document.getElementById('attached_files').files;
            let fileReadCount = 0;

            function sendApiRequest(pk) {
                if(pk) {
                    send_url = '/admins/apv/update/'
                } else {
                    send_url = '/admins/apv/create/'
                }
                api_gp(send_url, 'post', api_data, (done) => {
                    location.href = "/admins/apv/";
                    alert("결재 전송이 완료되었습니다.");
                });
            }


            function readFileAndAddToApiData(file, index) {
                let reader = new FileReader();
                reader.onload = function(event) {
                    let fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        content: event.target.result.split(',')[1] // Base64 데이터 부분만 추출
                    };
                    api_data.attached_files.push(fileData);
                    fileReadCount++;
                    if (fileReadCount === attachedFiles.length) {
                        sendApiRequest();
                    }
                };
                reader.readAsDataURL(file);
            }

            function validateApiData(data, requiredFields) {
                for (let { key, message } of requiredFields) {
                    if (data[key] === null || data[key] === undefined || data[key] === '') {
                        alert(message);
                        return false;
                    }
                }
                return true;
            }

            function checkForDuplicateApprovers(ccList, approvers) {
                if (!Array.isArray(ccList) || ccList.length === 0) return false;
                for (let approver of approvers) {
                    if (approver && ccList.includes(String(approver))) {
                        return true;
                    }
                }
                return false;
            }

            let requiredFields = [
                { key: 'doc_title', message: '문서제목이 입력되지 않았습니다.' },
                { key: 'approver1', message: '최소 한명의 승인자가 필요합니다.' }
                // 필요한 필수 항목과 메시지를 여기에 추가
            ];

            if (!validateApiData(api_data, requiredFields)) {
                return;
            }

            let approvers = [
                api_data.approver1, api_data.approver2, api_data.approver3,
                api_data.approver4, api_data.approver5, api_data.approver6
            ];

            if (checkForDuplicateApprovers(selectedCcValues, approvers)) {
                alert('승인자는 참조목록에 포함될 수 없습니다.');
                return;
            }

            if (attachedFiles.length > 0) {
                for (let i = 0; i < attachedFiles.length; i++) {
                    readFileAndAddToApiData(attachedFiles[i], i);
                }
            } else {
                sendApiRequest(api_data.pk);
            }
        } else {
            alert(txt.cancel);
        }
    }

    function apv_delete() {
        if (confirm('임시저장된 문서를 삭제하시겠습니까?')) {
            let api_data = {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                pk: nullapply(documentId),
                }

            api_gp('/admins/apv/delete/', 'post', api_data, (done) => {
                    alert("삭제가 완료되었습니다.");
                    location.href = "/admins/apv/";
            });

        } else {
            alert(txt.cancel);
        }
    }

    document.getElementById('show-more').addEventListener('click', function() {
        let additionalApprovers = document.querySelector('.approver_group2');
        additionalApprovers.style.display = 'block';
        this.style.display = 'none';
    });


    let rowCount = 0;
    let maxRows = 20;

    function addRow() {
        let tableContainer = document.getElementById("table_container");
        let tbody = tableContainer.querySelector("tbody");

        if (tbody.childElementCount === 0) {
            rowCount = 0;  // 테이블이 비어있을 때만 rowCount 초기화
        }
        if (rowCount < maxRows) {
            rowCount++;
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${rowCount}</td>
                <td><input class="form-control" type="text" placeholder="YYYY-MM-DD" id="desc3${rowCount}"></td>
                <td><input class="form-control" type="text" id="desc1${rowCount}"></td>
                <td><input class="form-control" type="text" id="desc2${rowCount}"></td>
                <td><input class="form-control" type="text" id="price${rowCount}" oninput="formatInput(event); calculateTotal()"></td>
                <td><input class="form-control" type="text" id="remarks${rowCount}"></td>
            `;
            tbody.appendChild(row);
            calculateTotal();
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        let tableContainer = document.getElementById("table_container");
        let addRowButton = document.getElementById("add_row");
        let removeRowButton = document.getElementById("remove_row");

        let table = document.createElement("table");
        table.classList.add("table", "table-sm", "table-striped", "m-0");

        let thead = document.createElement("thead");
        thead.innerHTML = `
            <tr>
                <th id="item_no" style="color: #000; font-size: small; width: 3%;">No</th>
                <th id="desc3" style="text-align: center; color: #000; font-size: small; width: 12%;">관련일자</th>
                <th id="desc1" style="text-align: center; color: #000; font-size: small; width: 35%;">내 용</th>
                <th id="desc2" style="text-align: center; color: #000; font-size: small; width: 15%;">지출처</th>
                <th id="price" style="text-align: center; color: #000; font-size: small; width: 10%;">금 액(원)</th>
                <th id="remarks" style="text-align: center; color: #000; font-size: small; width: 25%;">비 고</th>
            </tr>
        `;
        table.appendChild(thead);

        let tbody = document.createElement("tbody");
        table.appendChild(tbody);

        let tfoot = document.createElement("tfoot");
        tfoot.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: end; color: #000; font-size: small; font-weight: bold;">합계</td>
                <td id="amount" style="text-align: center; color: #000; font-size: small; font-weight: bold;">0 원</td>
                <td></td>
            </tr>
        `;
        table.appendChild(tfoot);
        tableContainer.appendChild(table);

        addRowButton.addEventListener("click", addRow);
        removeRowButton.addEventListener("click", function() {
            if (rowCount > 1) {
                tbody.removeChild(tbody.lastChild);
                rowCount--;
                calculateTotal();
            }
        });

        for (let i = 0; i < 1; i++) {
            addRow();
        }
    });

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function unformatNumber(num) {
        return num.replace(/,/g, '');
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('input[id^="price"]').forEach(input => {
            let value = parseFloat(unformatNumber(input.value)) || 0;
            total += value;
        });
        document.getElementById("amount").textContent = formatNumber(total) + ' 원';
    }

    function formatInput(event) {
        let input = event.target;
        let value = unformatNumber(input.value);
        if (!isNaN(value) && value !== "") {
            input.value = formatNumber(value);
        } else {
            input.value = "";
        }
    }

    function getTableData() {
        let rows = document.querySelectorAll('#table_container table tbody tr');
        let items = [];

        rows.forEach((row, index) => {
            let desc3 = row.querySelector(`#desc3${index + 1}`).value;
            let desc1 = row.querySelector(`#desc1${index + 1}`).value;
            let desc2 = row.querySelector(`#desc2${index + 1}`).value;
            let price = row.querySelector(`#price${index + 1}`).value;
            let remarks = row.querySelector(`#remarks${index + 1}`).value;

            items.push({
                item_no: index + 1,
                desc3: desc3,
                desc1: desc1,
                desc2: desc2,
                price: parseFloat(price.replace(/,/g, '')), // Remove commas for number conversion
                remarks: remarks
            });
        });

        return JSON.stringify(items);
    }

</script>
