{% load static %}
<style>
   #change_clr:hover,
   #change_clr:focus {
       background-color: #9da8b5;
   }
   #change_clr:active {
       background-color: #9da8b5;
   }
</style>
<body>
     <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
            <div class="app-brand demo" style="margin-left: 25px; margin-bottom: 10px; ">
                <a href="{% url 'adminIndex' %}" class="app-brand-link">
                    <img src="{% static 'img/logo.jpg' %}">
                </a>
            </div>


                <div style="margin-left: 50px;">
                    <div style="margin-bottom: 20px; text-align: left">
                        <span id="currentDate"></span>
                    </div>
                    <div style="margin-top: -20px; margin-bottom: 20px; width: 100%; text-align: left">
                        <strong style="font-size: large;">ÎÇòÏùò Í∑ºÌÉú ÌòÑÌô©</strong>
                    </div>

                    <div>
                        <div style="margin-top: 10px">
                            <span>üïí Ïò§Îäò Ï¥ù Í∑ºÎ¨¥ ÏãúÍ∞Ñ</span>
                            <div style="text-align: left; margin-left: 25px">
                                <h10 id="todayWorkTime">0h 0m 0s</h10>
                            </div>
                        </div>
                        <div style="margin-top: 10px; width: auto">
                            <span>üïí Ïù¥Î≤àÏ£º ÎàÑÏ†Å ÏãúÍ∞Ñ</span>
                            <div style="text-align: left; margin-left: 25px">
                                <h10 id="weekWorkTime">0h 0m 0s</h10>
                            </div>
                        </div>
                    </div>

                    <div class="work-check" style="display: flex; flex-direction: row; margin-top: 20px">
                        <button class="btn btn-primary me-2" id="checkInBtn">Ï∂úÍ∑º</button>
                        <button class="btn btn-primary me-2" id="checkOutBtn">Ìá¥Í∑º</button>
                    </div>
                </div>
                     <div style="border-bottom: #9da8b5 solid 1px; margin-top: 30px; margin-left: 25px; width: 80%;"></div>
                <div class="menu-inner-shadow"></div>
                <ul class="menu-inner py-1 ps" style="margin-left: 25px;">
                    <li class="menu-item" style="margin-top: 30px; width: 100%;">
                        <a href="{% url 'adminNotice' %}" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/icon-park-outline_volume-notice.png' %}" style="margin-right: 8px"> <!-- Font Awesome bell icon -->
                                <span data-i18n="Í≥µÏßÄÏÇ¨Ìï≠">Í≥µÏßÄÏÇ¨Ìï≠</span>
                            </div>
                        </a>
                    </li>
                     <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="{%  url 'adminBoard' %}" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/wpf_note.png' %}" style="margin-right: 8px">
                                <span data-i18n="Í≤åÏãúÌåê">Í≤åÏãúÌåê</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="javascript:void(0);" class="menu-link menu-toggle" style=" text-align: left; margin-left: -10px" id="change_clr">
                            <img src="{% static 'admin/img/indexImg/ic_outline-work-history.png'%}" style="margin-right: 8px">
                            <div class="text-truncate">Í∑ºÌÉúÍ¥ÄÎ¶¨</div>
                        </a>
                        <ul class="menu-sub">
                            <li class="menu-item" style="margin-left: -15px;">
                                <a href="{% url 'adminWorkSchedule' %}" class="menu-link">
                                    <div class="text-truncate">ÏùºÏùºÍ∑ºÌÉúÍ¥ÄÎ¶¨</div>
                                </a>
                            </li>
                        </ul>
                         <ul class="menu-sub">
                            <li class="menu-item" style="margin-left: -15px;">
                                <a href="{% url 'monthWorkSchedule' %}" class="menu-link">
                                    <div class="text-truncate">ÏõîÎ≥ÑÍ∑ºÌÉúÍ¥ÄÎ¶¨</div>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/icon-park-outline_vacation.png'%}" style="margin-right: 8px">
                                <span data-i18n="Ìú¥Í∞ÄÍ¥ÄÎ¶¨">Ìú¥Í∞ÄÍ¥ÄÎ¶¨</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/material-symbols_business-center-outline.png' %}" style="margin-right: 8px">
                                <span data-i18n="Ï∂úÏû•Í¥ÄÎ¶¨">Ï∂úÏû•Í¥ÄÎ¶¨</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="{% url 'vehicleMain' %}" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/ri_car-line.png' %}" style="margin-right: 8px">
                                <span data-i18n="Î≤ïÏù∏Ï∞®ÎüâÍ¥ÄÎ¶¨">Î≤ïÏù∏Ï∞®ÎüâÍ¥ÄÎ¶¨</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/uil_calender.png' %}" style="margin-right: 8px">
                                <span data-i18n="Ï∫òÎ¶∞Îçî">Ï∫òÎ¶∞Îçî</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/lets-icons_paper-alt.png' %}" style="margin-right: 8px">
                                <span data-i18n="Ï†ÑÏûêÍ≤∞Ïû¨">Ï†ÑÏûêÍ≤∞Ïû¨</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/ph_floppy-disk-bold.png' %}" style="margin-right: 8px">
                                <span data-i18n="ÏûêÎ£åÏã§">ÏûêÎ£åÏã§</span>
                            </div>
                        </a>
                    </li>
                   <li class="menu-item" style="margin-top: 10px; margin-bottom: 30px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/icon-park-outline_system.png' %}" style="margin-right: 8px">
                                <span data-i18n="Ï°∞ÏßÅÍ¥ÄÎ¶¨">Ï°∞ÏßÅÍ¥ÄÎ¶¨</span>
                            </div>
                        </a>
                    </li>
                <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                    <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                </div>
                    <div class="ps__rail-y" style="top: 0px; right: 4px;">
                        <div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 0px;"></div>
                    </div>
                </ul>
     </aside>
</body>

<script>
    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    const token = '53d407fad3208b';
    const today = new Date();

    function getCurrentDate() {
        var today = new Date();
        var year = today.getFullYear();
        var month = (today.getMonth() + 1).toString().padStart(2, '0');
        var day = today.getDate().toString().padStart(2, '0');

        return year + '-' + month + '-' + day;
    }
    document.getElementById('currentDate').innerHTML = getCurrentDate();

    function getCookie(name) {
        let cookieArr = document.cookie.split(";");

        for (let i = 0; i < cookieArr.length; i++) {
            let cookiePair = cookieArr[i].split("=");

            if (name == cookiePair[0].trim()) {
                return decodeURIComponent(cookiePair[1]);
            }
        }

        return null;
    }

    function formatTime(sec) {
        let hours = Math.floor(sec / 3600);
        let minutes = Math.floor((sec % 3600) / 60);
        let seconds = sec % 60;

        return `${hours}h ${minutes}m ${seconds}s`;
    }


    document.addEventListener('DOMContentLoaded', function () {
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÇ¨Ïö©ÏûêÏùò ÎßàÏßÄÎßâ Ï∂úÌá¥Í∑º Í∏∞Î°ùÏùÑ ÏöîÏ≤≠
        $.ajax({
            url: "{% url 'last_attendance' %}",
            type: "GET",
            data: {
                user_id: getCookie('user_id')
            },
            success: function (response) {
                //console.log('res', response.attendanceTime)

                let date = new Date(response.date);
                let day = date.getDate();



                if (response.is_offwork) {
                    //console.log('Ïó¨Í∏∞')
                    checkInBtn.disabled = false;
                    checkOutBtn.disabled = true;
                } else {
                    //console.log('Ïó¨Í∏∞11')
                    checkInBtn.disabled = true;
                    checkOutBtn.disabled = false;

                    let [hours, minutes, seconds] = response.attendanceTime.split(':');
                    let resDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, seconds);
                    let diff = today - resDate;
                    let diffSec = diff / 1000;

                   // console.log(`Ï∞®Ïù¥: ${diffSec}Ï¥à`);

                    let intervalId = null;
                    let weekIntervalId = null;
                    //let diffSec = new Date(response.attendanceTime);
                    let weekSec = 0;

                    //console.log('diff', diffSec)

                    function startCounting() {
                        let startTime = localStorage.getItem('startTime');
                        if (!startTime) {
                            startTime = new Date();
                            localStorage.setItem('startTime', startTime);
                        } else {
                            startTime = new Date(startTime);
                        }

                        let weekStartTime = localStorage.getItem('weekStartTime');
                        if (!weekStartTime) {
                            weekStartTime = new Date();
                            localStorage.setItem('weekStartTime', weekStartTime);
                        } else {
                            weekStartTime = new Date(weekStartTime);
                        }


                        let diffSec = Math.floor((new Date() - startTime) / 1000);
                        let weekSec = Math.floor((new Date() - weekStartTime) / 1000);

                        document.getElementById('todayWorkTime').innerHTML = formatTime(diffSec);
                        document.getElementById('weekWorkTime').innerHTML = formatTime(weekSec);

                        intervalId = setInterval(function () {
                            diffSec++;
                            document.getElementById('todayWorkTime').innerHTML = formatTime(diffSec);
                        }, 1000);

                        weekIntervalId = setInterval(function () {
                            weekSec++;
                            localStorage.setItem('weekTime', weekSec);
                            document.getElementById('weekWorkTime').innerHTML = formatTime(weekSec);
                        }, 1000);
                    }


                    function stopCounting() {
                        clearInterval(intervalId);
                        clearInterval(weekIntervalId);
                        localStorage.removeItem('startTime');
                        localStorage.setItem('endTime', new Date());
                    }





                    document.getElementById('checkInBtn').addEventListener('click', function () {
                        startCounting();
                    });

                    document.getElementById('checkOutBtn').addEventListener('click', function () {
                        stopCounting();
                    });

                    startCounting();

                }
            }
        });
    });

    $('#checkInBtn').click(() => {

        const se = document.createElement('script');
        se.src = `https://ipinfo.io/?token=${token}&callback=checkInFunction`;
        document.body.appendChild(se);
        document.body.removeChild(se);
    });

     $('#checkOutBtn').click(() => {

        const se = document.createElement('script');
        se.src = `https://ipinfo.io/?token=${token}&callback=checkOutFunction`;
        document.body.appendChild(se);
        document.body.removeChild(se);
    });

    //Ï∂úÍ∑ºÎ≤ÑÌäº Ìï®Ïàò
    function checkInFunction(data) {

        var attendance_ip = data.ip

        var formdata = {
            ip: attendance_ip
        }

         $.ajax({
             url: "{% url 'check_in' %}",
             type: "POST",
             data: formdata,
             headers: { "X-CSRFToken": '{{ csrf_token }}' },
             success: function (response) {
                 Swal.fire({
                     title: 'Success!',
                     text: 'Ï∂úÍ∑ºÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.',
                     icon: 'success',
                     confirmButtonText: 'ÌôïÏù∏'
                 }).then((result) => {
                     if (result.isConfirmed) {
                         location.reload();
                     }
                 });

                 if (today.getDay() === 1) {
                     console.log("Ï£ºÍ∞Ñ Í∑ºÎ¨¥ ÏãúÍ∞Ñ Ï¥àÍ∏∞Ìôî");
                     localStorage.removeItem('weekTime');
                     localStorage.removeItem('weekStartTime');
                 }

                 checkInBtn.disabled = true;
                 checkOutBtn.disabled = false;
             }
         });
    }

    // Ìá¥Í∑ºÎ≤ÑÌäº Ìï®Ïàò
    function checkOutFunction(data) {

        var attendance_ip = data.ip

        var formdata = {
            offwork_ip: attendance_ip
        }

         $.ajax({
             url: "{% url 'check_out' %}",
             type: "POST",
             data: formdata,
             headers: { "X-CSRFToken": '{{ csrf_token }}' },
             success: function (response) {
                 Swal.fire({
                     title: 'Success!',
                     text: 'Ìá¥Í∑ºÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.',
                     icon: 'success',
                     confirmButtonText: 'ÌôïÏù∏'
                 }).then((result) => {
                     if (result.isConfirmed) {
                         location.reload();
                     }
                 });
                 checkInBtn.disabled = false;
                 checkOutBtn.disabled = true;
             }
         });
    }


    window.onload = function() {
    var workTime = localStorage.getItem('workTime');
    var weekTime = localStorage.getItem('weekTime');
    if (workTime) {
        document.getElementById('todayWorkTime').innerHTML = formatTime(workTime);
    }
    if (weekTime){
        document.getElementById('weekWorkTime').innerHTML = formatTime(weekTime);
    }
};
</script>