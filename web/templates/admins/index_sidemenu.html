{% load static %}
<style>
   #change_clr:hover,
   #change_clr:focus {
       background-color: #9da8b5;
   }
   #change_clr:active {
       background-color: #9da8b5;
   }
</style>
<body>
     <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
            <div class="app-brand demo" style="margin-left: 25px; margin-bottom: 10px; ">
                <a href="{% url 'adminIndex' %}" class="app-brand-link">
                    <img src="{% static 'img/logo.jpg' %}">
                </a>
            </div>


                <div style="margin-left: 50px;">
                    <div style="margin-bottom: 20px; text-align: left">
                        <span id="currentDate"></span>
                    </div>
                    <div style="margin-top: -20px; margin-bottom: 20px; width: 100%; text-align: left">
                        <strong style="font-size: large;">ë‚˜ì˜ ê·¼íƒœ í˜„í™©</strong>
                    </div>

                    <div>
                        <div style="margin-top: 10px">
                            <span>ğŸ•’ ì˜¤ëŠ˜ ì´ ê·¼ë¬´ ì‹œê°„</span>
                            <div style="text-align: left; margin-left: 25px">
                                <h10 id="todayWorkTime">0h 0m 0s</h10>
                            </div>
                        </div>
                        <div style="margin-top: 10px; width: auto">
                            <span>ğŸ•’ ì´ë²ˆì£¼ ëˆ„ì  ì‹œê°„</span>
                            <div style="text-align: left; margin-left: 25px">
                                <h10 id="weekWorkTime">0h 0m 0s</h10>
                            </div>
                        </div>
                    </div>

                    <div class="work-check" style="display: flex; flex-direction: row; margin-top: 20px">
                        <button class="btn btn-primary me-2" id="checkInBtn">ì¶œê·¼</button>
                        <button class="btn btn-primary me-2" id="checkOutBtn">í‡´ê·¼</button>
                    </div>
                </div>
                     <div style="border-bottom: #9da8b5 solid 1px; margin-top: 30px; margin-left: 25px; width: 80%;"></div>
                <div class="menu-inner-shadow"></div>
                <ul class="menu-inner py-1 ps" style="margin-left: 25px;">
                    <li class="menu-item" style="margin-top: 30px; width: 100%;">
                        <a href="{% url 'adminNotice' %}" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/icon-park-outline_volume-notice.png' %}" style="margin-right: 8px"> <!-- Font Awesome bell icon -->
                                <span data-i18n="ê³µì§€ì‚¬í•­">ê³µì§€ì‚¬í•­</span>
                            </div>
                        </a>
                    </li>
                     <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="{%  url 'adminBoard' %}" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/wpf_note.png' %}" style="margin-right: 8px">
                                <span data-i18n="ê²Œì‹œíŒ">ê²Œì‹œíŒ</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="javascript:void(0);" class="menu-link menu-toggle" style=" text-align: left; margin-left: -10px" id="change_clr">
                            <img src="{% static 'admin/img/indexImg/ic_outline-work-history.png'%}" style="margin-right: 8px">
                            <div class="text-truncate">ê·¼íƒœê´€ë¦¬</div>
                        </a>
                        <ul class="menu-sub">
                            <li class="menu-item" style="margin-left: -15px;">
                                <a href="{% url 'adminWorkSchedule' %}" class="menu-link">
                                    <div class="text-truncate">ì¼ì¼ê·¼íƒœê´€ë¦¬</div>
                                </a>
                            </li>
                        </ul>
                         <ul class="menu-sub">
                            <li class="menu-item" style="margin-left: -15px;">
                                <a href="{% url 'monthWorkSchedule' %}" class="menu-link">
                                    <div class="text-truncate">ì›”ë³„ê·¼íƒœê´€ë¦¬</div>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/icon-park-outline_vacation.png'%}" style="margin-right: 8px">
                                <span data-i18n="íœ´ê°€ê´€ë¦¬">íœ´ê°€ê´€ë¦¬</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/material-symbols_business-center-outline.png' %}" style="margin-right: 8px">
                                <span data-i18n="ì¶œì¥ê´€ë¦¬">ì¶œì¥ê´€ë¦¬</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="{% url 'vehicleMain' %}" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/ri_car-line.png' %}" style="margin-right: 8px">
                                <span data-i18n="ë²•ì¸ì°¨ëŸ‰ê´€ë¦¬">ë²•ì¸ì°¨ëŸ‰ê´€ë¦¬</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/uil_calender.png' %}" style="margin-right: 8px">
                                <span data-i18n="ìº˜ë¦°ë”">ìº˜ë¦°ë”</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/lets-icons_paper-alt.png' %}" style="margin-right: 8px">
                                <span data-i18n="ì „ìê²°ì¬">ì „ìê²°ì¬</span>
                            </div>
                        </a>
                    </li>
                    <li class="menu-item" style="margin-top: 10px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/ph_floppy-disk-bold.png' %}" style="margin-right: 8px">
                                <span data-i18n="ìë£Œì‹¤">ìë£Œì‹¤</span>
                            </div>
                        </a>
                    </li>
                   <li class="menu-item" style="margin-top: 10px; margin-bottom: 30px; width: 100%;">
                        <a href="" class="menu-link"
                           style="display: block; text-align: left; margin-left: -10px" id="change_clr">
                            <div class="text-truncate">
                                <img src="{% static 'admin/img/indexImg/icon-park-outline_system.png' %}" style="margin-right: 8px">
                                <span data-i18n="ì¡°ì§ê´€ë¦¬">ì¡°ì§ê´€ë¦¬</span>
                            </div>
                        </a>
                    </li>
                <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                    <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                </div>
                    <div class="ps__rail-y" style="top: 0px; right: 4px;">
                        <div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 0px;"></div>
                    </div>
                </ul>
     </aside>
</body>

<script>
    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    const token = '53d407fad3208b';
    const today = new Date();
    let attendanceTime;
    let is_offwork;
    let endDate;
    let startDate;
    let nextSunday;
    let weeklyWorkTime;
    let dayInterval;
    let weekInterval;

    function getCurrentDate() {
        var year = today.getFullYear();
        var month = (today.getMonth() + 1).toString().padStart(2, '0');
        var day = today.getDate().toString().padStart(2, '0');

        return year + '-' + month + '-' + day;
    }
    document.getElementById('currentDate').innerHTML = getCurrentDate();

    function getCookie(name) {
        const cookieValue = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return cookieValue ? decodeURIComponent(cookieValue[2]) : null;
    }

    function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/';
    }

    function deleteCookie(name) {
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
    }


    function formatTime(sec) {
        let hours = Math.floor(sec / 3600);
        let minutes = Math.floor((sec % 3600) / 60);
        let seconds = sec % 60;

        return `${hours}h ${minutes}m ${seconds}s`;
    }

     $('#checkInBtn').click(() => {

        const se = document.createElement('script');
        se.src = `https://ipinfo.io/?token=${token}&callback=checkInFunction`;
        document.body.appendChild(se);
        document.body.removeChild(se);
    });

     $('#checkOutBtn').click(() => {

        const se = document.createElement('script');
        se.src = `https://ipinfo.io/?token=${token}&callback=checkOutFunction`;
        document.body.appendChild(se);
        document.body.removeChild(se);
    });

    //ì¶œê·¼ë²„íŠ¼ í•¨ìˆ˜
    function checkInFunction(data) {

        var attendance_ip = data.ip

        var formdata = {
            ip: attendance_ip
        }

         $.ajax({
             url: "{% url 'check_in' %}",
             type: "POST",
             data: formdata,
             headers: { "X-CSRFToken": '{{ csrf_token }}' },
             success: function (response) {
                 Swal.fire({
                     title: 'Success!',
                     text: 'ì¶œê·¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                     icon: 'success',
                     confirmButtonText: 'í™•ì¸'
                 }).then((result) => {
                     if (result.isConfirmed) {
                         location.reload();
                     }
                 });
                 checkInBtn.disabled = true;
                 checkOutBtn.disabled = false;

             }
         });
    }

    // í‡´ê·¼ë²„íŠ¼ í•¨ìˆ˜
    function checkOutFunction(data) {

        var attendance_ip = data.ip

        var formdata = {
            offwork_ip: attendance_ip
        }

         $.ajax({
             url: "{% url 'check_out' %}",
             type: "POST",
             data: formdata,
             headers: { "X-CSRFToken": '{{ csrf_token }}' },
             success: function (response) {
                 Swal.fire({
                     title: 'Success!',
                     text: 'í‡´ê·¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                     icon: 'success',
                     confirmButtonText: 'í™•ì¸'
                 }).then((result) => {
                     if (result.isConfirmed) {
                         location.reload();
                     }
                 });
                 checkInBtn.disabled = false;
                 checkOutBtn.disabled = true;
             }
         });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ìì˜ ë§ˆì§€ë§‰ ì¶œí‡´ê·¼ ê¸°ë¡ì„ ìš”ì²­
        $.ajax({
            url: "{% url 'last_attendance' %}",
            type: "GET",
            data: {
                user_id: getCookie('user_id')
            },
            success: function (response) {
                {#console.log('res', response)#}
                attendanceTime = new Date(response.date + "T" + response.attendanceTime);
                is_offwork = response.is_offwork;
                endDate = new Date(response.endDate);
                startDate = new Date(response.startDate);
                nextSunday = new Date(response.nextSunday);
                weeklyWorkTime = parseFloat(response.weeklyWorkTime);

                if (response.is_offwork) {
                    checkInBtn.disabled = false;
                    checkOutBtn.disabled = true;
                } else {
                    checkInBtn.disabled = true;
                    checkOutBtn.disabled = false;

                    var dailyWorkTime = (endDate - attendanceTime) / 1000;

                    weeklyWorkTime += dailyWorkTime;

                    {#console.log("ì¼ì¼ ", dailyWorkTime);#}
                    {#console.log("ëˆ„ì  ", weeklyWorkTime);#}

                    dayInterval = setInterval(function () {
                        dailyWorkTime++;
                        document.getElementById('todayWorkTime').innerHTML = formatTime(dailyWorkTime);
                    }, 1000);

                    weekInterval = setInterval(function () {
                        weeklyWorkTime++;
                        document.getElementById('weekWorkTime').innerHTML = formatTime(weeklyWorkTime);
                    }, 1000);
                }
            }
        });
    });
</script>