<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
<body style="overflow: hidden;">
<!-- {#{% extends 'index.html' %}#} -->
{% load static %}

<!-- {#{% block title %}#}
{#    <title>BOM ì¡°íšŒ</title>#}
{#{% endblock title %}#}
{##}
{#{% block content %}#} -->
<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px"/>
</div>
<!-- ê²€ìƒ‰ -->
<div class="card m-2">
    <div class="card-body p-2">
        <!-- ë³¸ë¬¸ -->
   <div class="card m-2">
        <div class="card-body p-2">
            <!-- ë³¸ë¬¸ -->
            <div class="content-search row no-gutters align-items-center">
                <form class="col-11" method="GET" id="lookup_search">
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ë¸Œëœë“œ</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control brand-dropdown" id="search_brand">
                                </select>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ì œí’ˆêµ°</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control" id="search_item-group">
                                </select>
                            </div>
                        </div>

                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>í’ˆë²ˆ</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control item_code-dropdown" id="search_item-code">
                                </select>
                            </div>
                        </div>
                              <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>ë‚˜ì´ìŠ¤ë²ˆí˜¸</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control item_nice-dropdown" id="search_item-nice">
                                </select>
                            </div>

                    </div>
                        <div class="content-input-group col-4 mt-2">
                            <div class="content-input-group-input input-group">
                                <input class="form-control" id="multiSearch" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                                "/>
                              <div class="input-group-append">
                         <button class="btn btn-outline-secondary" type="button" onclick="nation1.page =1; BOM_search()"> ğŸ”</button>

                            </div>
                            </div>
                            </div>
                        </div>

                </form>
                  <div class="col-1 px-0">
                      <button class="btn button-search w-100" form="lookup_search">ê²€ìƒ‰</button>
                  </div>
            </div>
        </div>
    </div>

<!-- í…Œì´ë¸” -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- ë³¸ë¬¸ -->

        {# Todo hjlim : Table Line ìˆ˜ ì§€ì • #}
        <div class="content-table col-12" style="overflow-x:auto; overflow-y:hidden;height:1110px;">
            <table
                    id="data-table-BOM_lookup"
                    class="table table-sm text-center"
            >
                <thead>
                 <tr>
                            <th>ìˆœë²ˆ</th>
                            <th>ë¸Œëœë“œ</th>
                            <th>ì œí’ˆêµ°</th>
                            <th>í’ˆëª…</th>
                            <th>í’ˆë²ˆ</th>
                            <th>ë‚˜ì´ìŠ¤ë²ˆí˜¸</th>
                            <th>í’ˆëª…ìƒì„¸</th>
                            <th>í˜•íƒœ</th>
                            <th>ì„¤ê³„ë„ë©´</th>
                            <th>ìµœì¢…ë“±ë¡ì¼</th>
                            <th>ìµœì´ˆ ë“±ë¡ì</th>
                            <th>ìµœì¢… ë³€ê²½ì</th>
                            <th>ìµœì¢… ë³€ê²½ì¼</th>
                        </tr>
                </thead>
                <tbody id="bom-lookup-tbody"></tbody>
            </table>

            <div class="col-12 d-flex justify-content-end mt-2">
                <div class="col-1 px-0">
                    <button class="btn button-search rounded-0 w-100 h-100"
                            onclick="excel_export()"
                    >
                        ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="row no-gutters d-flex justify-content-center" id="item_nation"
                 style="margin-top: -20px;">
            </div>

        </div>
    </div>
</div>
<script
        src="{% static 'js/api_BOMmaster.js' %}"
        type="text/javascript"
></script>
{#<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.min.js" integrity="sha512-BMIFH0QGwPdinbGu7AraCzG9T4hKEkcsbbr+Uqv8IY3G5+JTzs7ycfGbz7Xh85ONQsnHYrxZSXgS1Pdo9r7B6w=="#}
{#        crossorigin="anonymous" referrerpolicy="no-referrer">#}
{#</script>#}
<script lang="javascript" src="https://cdn.jsdelivr.net/gh/gitbrent/xlsx-js-style@master/dist/xlsx.bundle.js"></script>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>
<script>

    let nation_data1 = {
        cname : 'nation1',  // ì¸ìŠ¤í„´ìŠ¤ ëª…ê³¼ ì¼ì¹˜í•´ì•¼í•¨
        table_id: 'item_nation',
        range: 5,
        page_size: 10,
    };

    let nation1 = new Pnations(nation_data1, BOM_search);  // ì¸ìŠ¤í„´ìŠ¤ ëª…

    var popupWindow;
    var bom_lookup_id_idx = null;
    var bom_lookup_columns = [
        "out-at",
        "customer",
        "item-code",
        "item-name",
        "item-type",
        "item-model",
        "item-item-division",
        "item-unit",
        "current-amount",
        "out-amount",
        "etc",
        "purpose",
    ];

    $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
    });
    {#$(".datepicker").datepicker("setDate", "today");#}

    // click on "ê²€ìƒ‰" on the right side of "ê·¸ë£¹ì½”ë“œ"
    $("#lookup_search").submit(function (e) {
        e.preventDefault();
        nation1.page = 1;
        bom_lookup_id_idx = null;
        BOM_search();
    });


    function BOM_search() {
        let query = "&page=" + nation1.page
        let brand = $("#search_brand option:selected").text()
        if(brand !== "ì„ íƒ ë° ê²€ìƒ‰" && brand !== "") query += `&brand=${brand}`
        let item_group = $("#search_item-group option:selected").text()
        if(item_group !== "ì„ íƒ ë° ê²€ìƒ‰" && item_group !== "") query += `&item_group=${item_group}`
        let item_code = $("#search_item-code option:selected").text()
        if(item_code !== "ì„ íƒ ë° ê²€ìƒ‰" && item_code !== "") query += `&item_code=${item_code}`
        let item_nice = $("#search_item-nice option:selected").text()
        if(item_nice !== "ì„ íƒ ë° ê²€ìƒ‰" && item_nice !== "") query += `&nice=${item_nice}`
        let multiSearch = $("#multiSearch").val()
        api_gp(`/bom/master10/?search=${multiSearch}` + query, "GET", {}, (data) => {
            BOM_lookup_draw_out_table(data);
        });
    }


    $(function () {
        refresh();

        // Table Export
        $(parent.document).find("#excel-export").click(() =>
            init_excel_export($("#data-table-BOM_lookup"), "BOMì¡°íšŒ")
        );
    });

    function refresh() {
        set_naming();
        BOM_lookup_init();
        {#BOM_lookup_load_table();#}
        BOM_search();
    }

    function set_naming(){
        let enterprise_name = get_userinfo().enterprise_name;
        if (enterprise_name == '(ì£¼)ê±´ê°•ìƒí™œì—°êµ¬ì†Œ'){
            $("#n_bom_search").text("ì¡°íšŒ");
            $("#n_bom_code").text("ì½”ë“œ");

            $("#n_bom_model1").text("ì œí’ˆêµ°");
            $("#n_bom_model2").text("ì œí’ˆêµ°");
        }

        if (enterprise_name == 'ì˜¨êµìœ¡') {
            $("#n_bom_code").text("í’ˆë²ˆ");
        }
    }


    function BOM_lookup_load_table() {
        var param = null;

        api_lookup_BOMmaster(param, (data) => {
            BOM_lookup_draw_out_table(data);
        });
    }

    function BOM_lookup_draw_out_table(done) {
        console.table(done);
        let data = done.results;

        let num = (((nation1.page*1) - 1) * nation_data1["page_size"]) + 1 ;

        let rows = "";
        let list_num = data.length;
        for (let i = 0; i < data.length; i++) {
            let bom = data[i];
            let created_date = bom.created_at;
            let updated_date = bom.updated_at;

            let row =
                "<tr id='" +
                bom.id +
                "' style='cursor:pointer;' data-details=" +
                '\'{"product_name":"' +
                bom.product_name +
                '", "level":"' +
                bom.level +
                '", "item":"' +
                bom.item +
                '",' +
                '"part":"' +
                bom.part +
                '", "part_num":"' +
                bom.part_num +
                '", "capacity":"' +
                bom.capacity +
                '",' +
                '"size":"' +
                bom.size +
                '", "voltage":"' +
                bom.voltage +
                '", "band":"' +
                bom.band +
                '", ' +
                '"unit":"' +
                bom.unit +
                '", "tnb":"' +
                bom.tnb +
                '", "lnr":"' +
                bom.lnr +
                '", ' +
                '"required_amount":"' +
                bom.required_amount +
                '", "location":"' +
                bom.location +
                '", "manufacturer":"' +
                bom.manufacturer +
                '", ' +
                '"customer":"' +
                bom.customer +
                '", "standard":"' +
                bom.standard +
                '", "weight":"' +
                bom.weight +
                '", ' +
                '"etc":"' +
                bom.etc +
                '", "package":"' +
                bom.package +
                '", "enable":"' +
                bom.enable +
                '", ' +
                '"storage":"' +
                bom.storage +
                '", "item_name":"' +
                bom.item_name +
                "\" }'>";
              row += "<td>" + (num + i) + "</td>";
                row += "<td name='item-brand'>" + nullapply(bom?.brand?.name)+ "</td>";  // BOM ì½”ë“œ
                row += "<td name='item-family'>" + nullapply(bom?.item_group?.name) + "</td>";  // BOM ì½”ë“œ
                row += `<td data-toggle='tooltip' title='${bom.bom_number}' name='bom_number'>` + (bom.bom_number ? bom.bom_number.length > 10 ? bom.bom_number.slice(0,10)+ "..." : bom.bom_number: "") + "</td>";  // BOM ì½”ë“œ
                row += `<td data-toggle='tooltip' title='${bom.product_name}' name='product_name'>` + (bom.product_name ? bom.product_name.length > 10 ? bom.product_name.slice(0,10)+ "..." : bom.product_name: "") + "</td>";  // ìƒì‚°ì œí’ˆëª…

                row += `<td data-toggle='tooltip' title='${bom.nice_number}' name='item-nice'>` + (bom.nice_number ? bom.nice_number.length > 10 ? bom.nice_number.slice(0,10)+ "..." : bom.nice_number: "") + "</td>";  // ëª¨ë¸
                row += `<td data-toggle='tooltip' title='${bom.detail}' name='item-detail'>` + (bom.detail ? bom.detail.length > 10 ? bom.detail.slice(0,10)+ "..." : bom.detail: "") + "</td>";  // ëª¨ë¸
                row += "<td name='item-shape'>" + nullapply(bom?.shape) + "</td>";  // ëª¨ë¸
                row += `<td name='item-file'>${bom.file !== null ? `<a href=${bom.file} download=""><img src='../../../static/img/pdf_icon.png' width='20' height='20'/></a>`: ""}</td>`
                row += "<td name='version'>" + (bom.version ? bom.version : "") + "</td>";  // ë²„ì „
                row += "<td name='created_by'>" + bom.created_by + "</td>";
                row += "<td name='updated_by'>" + bom.updated_by + "</td>";
                row +=
                    "<td name='updated_at'>" +
                    updated_date.substring(0, 4) +
                    "-" +
                    updated_date.substring(5, 7) +
                    "-" +
                    updated_date.substring(8, 10) +
                    "</td>";


            // {#row += "<td class='d-none' data-item='product_name'>" + bom.product_name + "</td>"; // ìƒì‚°ì œí’ˆëª…#}
            // {#row += "<td class='d-none' data-item='level'>" + bom.level + "</td>";   // ë ˆë²¨#}
            // {#row += "<td class='d-none' data-item='item'>" + bom.item + "</td>";   // item ì½”ë“œ#}
            // {#row += "<td class='d-none' data-item='part'>" + bom.part + "</td>";   // part#}
            // {#row += "<td class='d-none' data-item='part_num'>" + bom.part_num + "</td>";   // part no#}
            // {#row += "<td class='d-none' data-item='capacity'>" + bom.capacity + "</td>";   // ìš©ëŸ‰#}
            // {#row += "<td class='d-none' data-item='size'>" + bom.size + "</td>";   // ì‚¬ì´ì¦ˆ#}
            // {#row += "<td class='d-none' data-item='voltage'>" + bom.voltage + "</td>";   // ì „ì••#}
            // {#row += "<td class='d-none' data-item='band'>" + bom.band + "</td>";   // í—ˆìš©ë²”ìœ„#}
            // {#row += "<td class='d-none' data-item='unit'>" + bom.unit + "</td>";   // ë‹¨ìœ„#}
            // {#row += "<td class='d-none' data-item='tnb'>" + bom.tnb + "</td>";   // T/B#}
            // {#row += "<td class='d-none' data-item='lnr'>" + bom.lnr + "</td>";   // L/R#}
            // {#row += "<td class='d-none' data-item='required_amount'>" + bom.required_amount + "</td>";   // ì†Œìš”ëŸ‰#}
            // {#row += "<td class='d-none' data-item='location'>" + bom.location + "</td>";   // ìì¬ìœ„ì¹˜#}
            // {#row += "<td class='d-none' data-item='manufacturer'>" + bom.manufacturer + "</td>";   // ê±°ë˜ì²˜#}
            // {#row += "<td class='d-none' data-item='customer'>" + bom.customer + "</td>";   // ê³ ê°ì‚¬#}
            // {#row += "<td class='d-none' data-item='standard'>" + bom.standard + "</td>";   // ì‚¬ì–‘#}
            // {#row += "<td class='d-none' data-item='weight'>" + bom.weight + "</td>";   // ì¤‘ëŸ‰#}
            // {#row += "<td class='d-none' data-item='etc'>" + bom.etc + "</td>";   // ë¹„ê³ #}
            // {#row += "<td class='d-none' data-item='package'>" + bom.package + "</td>";   // Package#}
            // {#row += "<td class='d-none' data-item='enable'>" + bom.enable + "</td>";   // ì‚¬ìš©êµ¬ë¶„#}
            row += "</tr>";

            rows += row;
        }
        spinner();

        nation1.nation_display(done);
        $("#bom-lookup-tbody").html(rows);

        if (bom_lookup_id_idx != null){
            $("#" + bom_lookup_id_idx).addClass('clicked');
        }


        $("#bom-lookup-tbody > tr").on("click", function () {
            // {#bom_lookup_columns.forEach((item) => {#}
            // {#    if ((item === 'item-code') || (item === 'customer') || (item === 'item-item-division') || (item === 'item-unit')) {#}
            // {#        $("#" + item + "").val($(this).find("[data-item='" + item + "_id']").text()).trigger('change');#}
            // {#    } else {#}
            // {#        $("#" + item + "").val($(this).find("[data-item='" + item + "']").text());#}
            // {#    }#}
            // {##}
            // {# });#}
            bom_lookup_id_idx = $(this).attr("id");
            let url = "/BOM/lookup/popup";
            let name = "BOM ì¡°íšŒ";
            let option = "width=1000, height=600, location=no";
            popupWindow = window.open(url, name, option);
        });

        // table click highlight
        $(".content-table tbody tr").on("click", function () {
            $(this).parent().find("tr").removeClass("clicked");
            $(this).addClass("clicked");
        });

        {#//Table pagination#}
        {#$('.pagination-container').remove();#}
        {#$('.table tbody').paginathing();#}
    }

    function BOM_lookup_init() {
        function make_dropdown(data, selectors) {
            let list = "<option value=''>ì„ íƒ ë° ê²€ìƒ‰</option>";
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                if (selectors === "#BOM_lookup_product_name") {
                    list +=
                        "<option value='" +
                        item.id +
                        "'>" +
                        item.product_name +
                        "</option>";
                } else if (selectors === ".bom-dropdown") {
                    list +=
                        "<option value='" +
                        item.id +
                        "'>" +
                        item.bom_name +
                        "</option>";
                } else if(selectors === ".item_code-dropdown"){
                    list +=
                          "<option value='" +
                        item.id +
                        "'>" +
                        item.code +
                        "</option>";

                } else if(selectors === ".item_nice-dropdown"){
                    list +=
                          "<option value='" +
                        item.id +
                        "'>" +
                        item.nice_number +
                        "</option>";

                }
                else {
                    list +=
                        "<option value='" + item.id + "'>" + item.name + "</option>";
                }
            }
            $(selectors).html(list);
            $(selectors).select2({width: "100%"});
        }

        // ìƒì‚°ì œí’ˆëª…
        api_gp(
            "/bom/master_select/",
            "GET",
            {},
            (data) => {
                make_dropdown(data, "#BOM_lookup_product_name");
            },
            handle_error,
            (xhr, status) => {
            }
        );

        // ê³ ê°ì‚¬
        api_gp("/customers_select/", "GET", {},
            (data) => {
                make_dropdown(data, "#BOM_lookup_customer");
            },
            handle_error,
            (xhr, status) => {
            }
        );
            api_gp('/items_part/', 'GET', {}, (data) => {
            make_dropdown(data, '.item_code-dropdown');
            make_dropdown(data, '.item_name-dropdown');
            make_dropdown(data, ".item_nice-dropdown")
        });

        // ëª¨ë¸
        api_gp("/codes_select/?group=116&enable=true", "GET", {}, (data) => {
            make_dropdown(data, ".model-dropdown");
        });
        api_gp("/codes_select/?group=127&enable=true", "GET", {}, (data) => {
            make_dropdown(data, "#search_brand");
        });
        api_gp("/codes_select/?group=128&enable=true", "GET", {}, (data) => {
            make_dropdown(data, "#search_item-group");
        });

    }
    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    function excel_export(){
        if (!bom_lookup_id_idx){
            alert("BOMì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        let columns = ['level', 'item', 'part', 'part_num', 'capacity', 'size', 'voltage', 'band',
        'unit', 'tnb', 'lnr', 'required_amount', 'location', 'manufacturer', 'customer', 'etc',
            'weight', 'standard', 'package', 'storage', 'item_name' ];
        let now_tr_details = $('#bom-lookup-tbody #' + bom_lookup_id_idx).data('details');
        let now_columns = [];

        columns.forEach((item) => {
            if ( now_tr_details[item] !== '-1' ) {
                now_columns[item] = now_tr_details[item];
            }
        });
        var sorted_columns = [];
        for (var columnss in now_columns) {
          sorted_columns.push([columnss, now_columns[columnss]]);
        }

        sorted_columns.sort(function(a, b) {
          return a[1] - b[1];
        });
        console.log(sorted_columns);


        let title_merge_flag_col = 1;
        let tt_merge_flag_row = 4;
        let ut_merge_flag_row = 13;
        let ut_merge_flag_col = 0;
        let ut_style_flag_row = 13;
        let bc_counter = 0;
        let blank_cell = {
            v: '',
            s: {
                border:{
                    right: {style: "thin"},
                    left: {style: "thin"},
                    top: {style: "thin"},
                    bottom: {style: "thin"},
                }
            }
        }

        let dt = new Date();

        let filename = "BOMì¡°íšŒ-" + $('.clicked td[name="bom_number"]').text() + "-" + dt.getFullYear()+'-'+(dt.getMonth()+1)+'-'+dt.getDate();

        var ws = XLSX.utils.aoa_to_sheet([]);
        let wb = XLSX.utils.book_new();

        let top_table_info = {'bom_number': $('.clicked td[name="bom_number"]').text(), 'product_name' : $('.clicked td[name="product_name"]').text(),
                                'detail': $('.clicked td[name="detail"]').text(), 'created_at': $('.clicked td[name="created_at"]').text(),
                                'created_by': $('.clicked td[name="created_by"]').text(), 'item_division': $('.clicked td[name="item_division"]').text(),
                                'model_name': $('.clicked td[name="model_name"]').text(), 'master_customer': $('.clicked td[name="master_customer"]').text()}

        api_gp('/myinfo/', "GET", {}, (done)=>{
            let data = done.results;
            top_table_info['enterprise_name'] = data[0].company_name;
            top_table_info['licensee_number'] = data[0].licensee_number;
            top_table_info['address'] = data[0].address;

            let model_name = 'ëª¨ë¸';
            let enterprise_name = get_userinfo().enterprise_name;
            if (enterprise_name == '(ì£¼)ê±´ê°•ìƒí™œì—°êµ¬ì†Œ') {
                model_name = 'ì œí’ˆêµ°';
            }

            XLSX.utils.sheet_add_aoa(ws, [['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸', '', top_table_info["licensee_number"], '', '', 'ìƒí˜¸', '', top_table_info["enterprise_name"], '', ''],
                ['ì£¼ì†Œ', '', top_table_info["address"], '', '', '', '', '', '', ''],
                ['í’ˆë²ˆ', '', top_table_info["bom_number"], '', '', 'í’ˆëª…', '', top_table_info["product_name"], '', ''],
                ['í’ˆëª…ìƒì„¸', '', top_table_info["detail"], '', '', 'ì‘ì„±ë‚ ì§œ', '', top_table_info["created_at"], '', ''],
                ['ì‘ì„±ì', '', top_table_info["created_by"], '', '', 'ìì¬ë¶„ë¥˜', '', top_table_info["item_division"], '', ''],
                [model_name, '', top_table_info["model_name"], '', '', 'ê³ ê°ì‚¬', '', top_table_info["master_customer"], '', ''],]
            , {origin: {r: 4, c: 0}});

            if (enterprise_name == '(ì£¼)ê±´ê°•ìƒí™œì—°êµ¬ì†Œ'){
                XLSX.utils.sheet_add_aoa(ws, [['ë ˆ      ì‹œ      í”¼']], {origin: {r: 0, c: 2}});
            } else{
                XLSX.utils.sheet_add_aoa(ws, [['B      O      M']], {origin: {r: 0, c: 2}});
            }
            XLSX.utils.sheet_add_aoa(ws, [['ë‚´  ìš©']], {origin: {r: 11, c: 0}});
            XLSX.utils.sheet_add_aoa(ws, [['ìˆœë²ˆ']], {origin: {r: 13,c: 0}})
        })


        let merge = [
            { s: { r: 0, c: 2}, e: {r: 1, c: 7} },
            {#{ s: { r: ut_merge_flag_row, c: 1}, e: {r: ut_merge_flag_row, c: 2} }, {s: { r: ut_merge_flag_row, c: 3}, e: {r: ut_merge_flag_row, c: 5} },#}
        ];

        for(tt_merge_flag_row; tt_merge_flag_row < 10; tt_merge_flag_row++){
            if(tt_merge_flag_row === 5){
                merge.push({ s: { r: tt_merge_flag_row, c: 0}, e: {r: tt_merge_flag_row, c: 1} }, { s: { r: tt_merge_flag_row, c: 2}, e: {r: tt_merge_flag_row, c: 9} },)
            }
            merge.push({ s: { r: tt_merge_flag_row, c: 0}, e: {r: tt_merge_flag_row, c: 1} }, { s: { r: tt_merge_flag_row, c: 2}, e: {r: tt_merge_flag_row, c: 4} }, { s: { r: tt_merge_flag_row, c: 5}, e: {r: tt_merge_flag_row, c: 6} }, { s: { r: tt_merge_flag_row, c: 7}, e: {r: tt_merge_flag_row, c: 9} },)
        }

        api_gp("/bom/?master__id=" + bom_lookup_id_idx, "GET", {}, (data)=>{
            let list_num = 1;
            for(let i = 0; i <= data.length; i++){
                ut_merge_flag_col = 0;
                ut_style_flag_row = ut_merge_flag_row + i;
                if(ut_merge_flag_row + i !== 13) XLSX.utils.sheet_add_aoa(ws, [[list_num++]], {origin: {r: ut_merge_flag_row + i,c: ut_merge_flag_col}})
                if(data.length === 0) {
                    for (let j = 1; j <= 10; j++)
                    XLSX.utils.sheet_add_aoa(ws, [[list_num++]], {
                        origin: {
                            r: ut_merge_flag_row + i + j,
                            c: ut_merge_flag_col
                        }
                    })
                }
                for (let item in sorted_columns) {
                    let korean_header = '';
                    switch(sorted_columns[item][0]) {
                        case 'item': ut_merge_flag_col = ut_merge_flag_col+2; title_merge_flag_col = ut_merge_flag_col - 1; bc_counter=1; korean_header = "í’ˆë²ˆ"; break;
                        case 'item_name': ut_merge_flag_col = ut_merge_flag_col+3; title_merge_flag_col = ut_merge_flag_col - 2; bc_counter=2; korean_header = "í’ˆëª…"; break;
                        case 'required_amount': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ì†Œìš”ëŸ‰"; break;
                        case 'level': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ë ˆë²¨"; break;
                        case 'part': ut_merge_flag_col = ut_merge_flag_col+2; title_merge_flag_col = ut_merge_flag_col - 1; bc_counter=1; korean_header = "PART"; break;
                        case 'part_num': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "PART no"; break;
                        case 'capacity': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ìš©ëŸ‰"; break;
                        case 'size': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ì‚¬ì´ì¦ˆ"; break;
                        case 'voltage': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ì „ì••"; break;
                        case 'band': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "í—ˆìš©ë²”ìœ„"; break;
                        case 'unit': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ë‹¨ìœ„"; break;
                        case 'tnb': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "T / B"; break;
                        case 'lnr': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "L / R"; break;
                        case 'location': ut_merge_flag_col = ut_merge_flag_col+2; title_merge_flag_col = ut_merge_flag_col - 1; bc_counter=1; korean_header = "ìì¬ ìœ„ì¹˜"; break;
                        case 'manufacturer': ut_merge_flag_col = ut_merge_flag_col+2; title_merge_flag_col = ut_merge_flag_col - 1; bc_counter=1; korean_header = "ê±°ë˜ì²˜"; break;
                        case 'customer': ut_merge_flag_col = ut_merge_flag_col+2; title_merge_flag_col = ut_merge_flag_col - 1; bc_counter=1; korean_header = "ê³ ê°ì‚¬"; break;
                        case 'standard': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ì‚¬ì–‘"; break;
                        case 'weight': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "ì¤‘ëŸ‰"; break;
                        case 'etc': ut_merge_flag_col = ut_merge_flag_col+3; title_merge_flag_col = ut_merge_flag_col - 2; bc_counter=2; korean_header = "ë¹„ê³ "; break;
                        case 'package': ut_merge_flag_col = ut_merge_flag_col+1; title_merge_flag_col = ut_merge_flag_col; korean_header = "Package"; break;
                        case 'storage': ut_merge_flag_col = ut_merge_flag_col+2; title_merge_flag_col = ut_merge_flag_col - 1; bc_counter=1; korean_header = "ìƒì‚°ê³µì •(ì°½ê³ )"; break;
                        default: break;
                    }
                    if(data.length === 0) {
                        XLSX.utils.sheet_add_aoa(ws, [[korean_header]], {origin: {r: ut_merge_flag_row + i,c: title_merge_flag_col}})
                        if(bc_counter !== 0){
                            for(let k = 1; k <= bc_counter; k++){
                                ws[XLSX.utils.encode_cell({r: ut_merge_flag_row + i, c: title_merge_flag_col + k})] = blank_cell
                            }
                        }
                        if(ut_merge_flag_col === 0) title_merge_flag_col = 0;
                        ut_style_flag_row = 23;
                        merge.push({ s: { r: ut_merge_flag_row + i, c: title_merge_flag_col}, e: {r: ut_merge_flag_row + i, c: ut_merge_flag_col} },);
                        for(let j = 1; j <= 10; j++) {
                            merge.push({
                                s: {r: ut_merge_flag_row + i + j, c: title_merge_flag_col},
                                e: {r: ut_merge_flag_row + i + j, c: ut_merge_flag_col}
                            },);
                            ws[XLSX.utils.encode_cell({r: ut_merge_flag_row + i + j, c: title_merge_flag_col})] = blank_cell
                            if(bc_counter !== 0){
                                for(let k = 1; k <= bc_counter; k++){
                                    ws[XLSX.utils.encode_cell({r: ut_merge_flag_row + i + j, c: title_merge_flag_col + k})] = blank_cell
                                }
                            }
                        }
                        bc_counter = 0;
                        continue;
                    }

                    if(ut_merge_flag_row + i === 13) {
                        XLSX.utils.sheet_add_aoa(ws, [[korean_header]], {origin: {r: ut_merge_flag_row + i,c: title_merge_flag_col}})
                        if(sorted_columns[item][0] === 'item') XLSX.utils.sheet_add_aoa(ws, [[data[i][sorted_columns[item][0]].code]], {origin: {r: ut_merge_flag_row + 1,c: title_merge_flag_col}})
                        XLSX.utils.sheet_add_aoa(ws, [[data[i][sorted_columns[item][0]]]], {origin: {r: ut_merge_flag_row + 1,c: title_merge_flag_col}})
                    }
                    else if(i === data.length) {
                        merge.push({ s: { r: ut_merge_flag_row + i, c: title_merge_flag_col}, e: {r: ut_merge_flag_row + i, c: ut_merge_flag_col} },);
                        if(bc_counter !== 0){
                        for(let k = 1; k <= bc_counter; k++){
                                ws[XLSX.utils.encode_cell({r: ut_merge_flag_row + i, c: title_merge_flag_col + k})] = blank_cell
                            }
                        }
                        bc_counter = 0;
                        continue;
                    }
                    if(sorted_columns[item][0] === 'item') XLSX.utils.sheet_add_aoa(ws, [[data[i][sorted_columns[item][0]].code]], {origin: {r: ut_merge_flag_row + i+1,c: title_merge_flag_col}});
                    if (!data[i][sorted_columns[item][0]] && sorted_columns[item][0] !== 'item') ws[XLSX.utils.encode_cell({r: ut_merge_flag_row + i+1,c: title_merge_flag_col})] = blank_cell;
                    else if (data[i][sorted_columns[item][0]] !== null && sorted_columns[item][0] !== 'item') XLSX.utils.sheet_add_aoa(ws, [[data[i][sorted_columns[item][0]]]], {origin: {r: ut_merge_flag_row + i+1,c: title_merge_flag_col}});

                    if(ut_merge_flag_col === 0) title_merge_flag_col = 0;
                    merge.push({ s: { r: ut_merge_flag_row + i, c: title_merge_flag_col}, e: {r: ut_merge_flag_row + i, c: ut_merge_flag_col} },);
                    if(bc_counter !== 0){
                        for(let k = 1; k <= bc_counter; k++){
                            ws[XLSX.utils.encode_cell({r: ut_merge_flag_row + i, c: title_merge_flag_col + k})] = blank_cell
                        }
                    }
                    bc_counter = 0;
                }
            }
            merge.push({ s: { r: 11, c: 0}, e: {r: 12, c: title_merge_flag_col} },)
        })
        ws["!merges"] = merge;
        setTimeout(function (){
            for (let i in ws) {
                let cell = XLSX.utils.decode_cell(i);
                if ((cell.c === 0 && (4 <= cell.r && cell.r <= 9)) || (cell.c === 5 && (4 <= cell.r && cell.r <= 9))) {
                    ws[i].s = { // background color
                        font: {
                            name: "ë§‘ì€ ê³ ë”•",
                            sz: "10",
                        },
                        alignment: {
                            vertical: "center",
                            horizontal: "center",
                        },
                        fill: {
                            patternType: "solid",
                            bgColor: {rgb: "E4DFEC"},
                            fgColor: {rgb: "E4DFEC"}
                        },
                        border: {
                            right: {style: "thin"},
                            left: {style: "thin"},
                            top: {style: "thin"},
                            bottom: {style: "thin"},
                        }
                    };
                }
                else if (cell.r === 13 && (0 <= cell.c && cell.c <= title_merge_flag_col)){
                    ws[i].s = { // background color
                        font: {
                            name: "ë§‘ì€ ê³ ë”•",
                            sz: "10",
                        },
                        alignment: {
                            vertical: "center",
                            horizontal: "center",
                        },
                        fill: {
                            patternType: "solid",
                            bgColor: {rgb: "DCE6F1"},
                            fgColor: {rgb: "DCE6F1"}
                        },
                        border: {
                            right: {style: "thin"},
                            left: {style: "thin"},
                            top: {style: "thin"},
                            bottom: {style: "thin"},
                        }
                    };
                }
                else if ((14 <= cell.r && cell.r <= ut_style_flag_row) && (0 <= cell.c && cell.c <= ut_merge_flag_col)){
                    ws[i].s = {
                        font: {
                            name: "ë§‘ì€ ê³ ë”•",
                            sz: "9",
                        },
                        alignment: {
                            vertical: "center",
                            horizontal: "center",
                        },
                        border: {
                            right: {style: "thin"},
                            left: {style: "thin"},
                            top: {style: "thin"},
                            bottom: {style: "thin"},
                        }
                    };
                }
                else{
                    ws[i].s = { // styling for all cells
                        font: {
                            name: "ë§‘ì€ ê³ ë”•",
                            sz: "10",
                        },
                        alignment: {
                            vertical: "center",
                            horizontal: "center",
                        },
                        border: {
                            right: {style: "thin"},
                            left: {style: "thin"},
                            top: {style: "thin"},
                            bottom: {style: "thin"},
                        }
                    };
                }
            }
            ws["C1"].s = {
                font: {
                    name: "ë§‘ì€ ê³ ë”•",
                    sz: "20",
                    bold: true,
                },
                alignment: {
                    vertical: "center",
                    horizontal: "center",
                },
            };

            ws["A12"].s = {
                font: {
                    name: "ë§‘ì€ ê³ ë”•",
                    sz: "12",
                    bold: true,
                },
                alignment: {
                    vertical: "center",
                    horizontal: "center",
                },
            };
            wb.SheetNames.push('test'); // create new worksheet
            wb.Sheets['test'] = ws; // set workseet data to the cell data
            var wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'binary' }); //workbook output
            saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), filename + ".xlsx") // save workbook
        }, 3000)
    }
    function spinner() {
        $("#spinner").remove();
    }

</script>
<!-- {#{% endblock %}#} -->
</body>
</html>
