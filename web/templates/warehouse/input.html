<!DOCTYPE html>
<html>
  <header>{% include "header.html" %}</header>

  <body>
    <!-- {#{% extends 'index.html' %}#} -->
    {% load static %}

    <!-- {#{% block title %}#}
    {# <title>자재입고</title>#}
    {#{% endblock title %}#}
    {##}
    {#{% block content %}#} -->

<div class="spinner" id="spinner">
  <img src="../../../static/img/spinner.gif" width="150px" height="150px" />
</div>

    <div class="card m-2">
      <div class="card-body p-2">
        <!-- 본문 -->
        <form
          class="content-search row no-gutters align-items-center content-input-group"
          id="material_input_main-search-form"
          onsubmit="input_submit(event)"
        >
          <div class="content-title col-1 align-self-stretch">검색</div>
          <div class="col-11">
            <div class="row no-gutters">
              <div class="content-input-group col-5 px-0">
                <div class="content-input-group-header">
                  <label>입고기간</label>
                </div>
                <div class="input-group input-daterange">
                  <input
                    type="text"
                    class="form-control created_at_after datepicker"
                    autocomplete="off"
                    name="startdate"
                    id="startdate"
                    autocomplete="off"
                    onchange="datepicker_controller()"
                  />
                  <div class="input-group-addon px-3">~</div>
                  <input
                    type="text"
                    class="form-control created_at_before datepicker"
                    autocomplete="off"
                    name="enddate"
                    id="enddate"
                    autocomplete="off"
                    onchange="datepicker_controller()"
                  />
                </div>
              </div>
              <div class="content-input-group col-3 px-0">
                <div class="content-input-group-header">
                  <label>구매처</label>
                </div>
                <div class="content-input-group-input">
                  <select
                    class="form-control customer-search-dropdown"
                    name="customer"
                  ></select>
                </div>
              </div>
              <div class="content-input-group col-3 px-0">
                <div class="content-input-group-header">
                  <label>품명</label>
                </div>
                <div class="content-input-group-input">
                  <select
                    class="form-control material_search_input_item-name-dropdown"
                    name="item-name-search"
                  ></select>
                </div>
              </div>
              <div class="col-1 px-0">
                <button
                  class="btn button-search rounded-0 w-100 h-100"
                  type="submit"
                >
                  검색
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- 내용 -->
    <div class="card m-2">
      <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        <form class="content-content w-100" id="material_input_main-form">
          <div class="row no-gutters w-100 mb-2">
            <div class="col-1 content-title">입고등록</div>
            <div class="col-11">
              <div class="row no-gutters">
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>입하일자<strong>*</strong></label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control datepicker"
                      autocomplete="off"
                      type="text"
                      name="in-at"
                      id="in-at"
                    />
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>품번<strong>*</strong></label>
                  </div>
                  <div class="content-input-group-input">
                    <select
                      class="form-control material_input_item-code-dropdown"
                      name="item-code"
                      id="material_input_item-code"
                    ></select>
                  </div>
                </div>
                <!-- 품명, 모델, 품목, 자재구분-->
                <div class="content-input-group col-3">
                  <div class="content-input-group-header">
                    <label>품명</label>
                  </div>
                  <div class="content-input-group-input">
                    <select
                      class="form-control material_input_item-name-dropdown"
                      name="item-name"
                    ></select>
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>모델</label>
                  </div>
                  <div class="content-input-group-input">
                    <select
                      class="form-control model-dropdown"
                      name="item-model"
                    ></select>
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>품종</label>
                  </div>
                  <div class="content-input-group-input">
                    <select 
                      class="form-control item-type-dropdown"
                      name="item-type"
                    ></select>
                  </div>
                </div>
                <div class="content-input-group col-3">
                  <div class="content-input-group-header">
                    <label>자재구분</label>
                  </div>
                  <div class="content-input-group-input">
                    <select
                      class="form-control item-division-dropdown"
                      name="item-item_division"
                    ></select>
                  </div>
                </div>
                <div class="content-input-group col-4">
                  <div class="content-input-group-header">
                    <label>구매처</label>
                  </div>
                  <div class="content-input-group-input">
                    <select  
                      class="form-control customer-dropdown"
                      name="customer"
                    ></select>
                  </div>
                </div>
                <!-- {# <div class="content-input-group col-2">#}
                                {# <div class="content-input-group-header" style="background-color: darkgrey;">#}
                                    {# -->
                <!-- 현재 동작 X -->
                <!-- {# <label>품명<strong>*</strong></label>#}
                                    {#
                                </div>#}
                                {# <div class="content-input-group-input">#}
                                    {# <select class="form-control item-name-dropdown" name="item-name"
                                        id="item-name">#}
                                        {# </select>#}
                                    {# </div>#}
                                {# </div>#}
                            {# <div class="content-input-group col-2">#}
                                {# <div class="content-input-group-header" style="background-color: darkgrey;">#}
                                    {# -->
                <!-- 현재 동작 X -->
                <!-- {# <label>품목</label>#}
                                    {#
                                </div>#}
                                {# <div class="content-input-group-input">#}
                                    {# <select class="form-control item-type-dropdown" name="item-type"
                                        id="item-type">#}
                                        {# </select>#}
                                    {# </div>#}
                                {# </div>#} -->
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>단위</label>
                  </div>
                  <div class="content-input-group-input">
                    <select 
                      class="form-control unit-dropdown"
                      name="item-unit"
                    ></select>
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>자재생산일자</label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control datepicker"
                      autocomplete="off"
                      type="text"
                      name="item-created-at"
                    />
                  </div>
                </div>
              </div>
              <div class="row no-gutters">
                <!-- {# <div class="content-input-group col-2">#}
                                {# <div class="content-input-group-header" style="background-color: darkgrey;">#}
                                    {# -->
                <!-- 현재 동작 X -->
                <!-- {# <label>모델</label>#}
                                    {#
                                </div>#}
                                {# <div class="content-input-group-input">#}
                                    {# <select class="form-control model-dropdown" name="item-model" id="item-model">#}
                                        {# </select>#}
                                    {# </div>#}
                                {# </div>#}
                            {# <div class="content-input-group col-4">#}
                                {# <div class="content-input-group-header" style="background-color: darkgrey;">#}
                                    {# -->
                <!-- 현재 동작 X -->
                <!-- {# <label>자재구분</label>#}
                                    {#
                                </div>#}
                                {# <div class="content-input-group-input">#}
                                    {# <select class="form-control item-division-dropdown" name="item-item-division"
                                        id="item-item-division">#}
                                        {# </select>#}
                                    {# </div>#}
                                {# </div>#} -->

                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>포장수량<strong>*</strong></label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control"
                      name="package-amount"
                      id="package-amount"
                    />
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>입하수량<strong>*</strong></label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control"
                      name="receive-amount"
                      id="material_input_receive-amount"
                      onchange="in_amount_calc()"
                    />
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>불량수량<strong>*</strong></label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control"
                      name="in-faulty-amount"
                      id="material_input_in-faulty-amount"
                      onchange="in_amount_calc()"
                    />
                  </div>
                </div>
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>입고수량</label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control"
                      name="in-amount"
                      id="material_input_in-amount"
                      disabled
                    />
                  </div>
                </div>
                <div class="content-input-group col-4">
                  <div class="content-input-group-header">
                    <label>창고저장위치</label>
                  </div>
                  <div class="content-input-group-input">
                    <input class="form-control" name="location" />
                  </div>
                </div>
              </div>
              <div class="row no-gutters">
                <div class="content-input-group col-2">
                  <div class="content-input-group-header">
                    <label>검사일자</label>
                  </div>
                  <div class="content-input-group-input">
                    <input
                      class="form-control datepicker"
                      autocomplete="off"
                      type="text"
                      name="check-at"
                      id="check-at"
                    />
                  </div>
                </div>
                <div class="content-input-group col-4">
                  <div class="content-input-group-header">
                    <label>기타</label>
                  </div>
                  <div class="content-input-group-input">
                    <input class="form-control" name="etc" />
                  </div>
                </div>
              </div>
              <div class="row no-gutters"></div>
            </div>
          </div>
          <div class="row no-gutters w-100 justify-content-end">
            <div class="col-1 px-0 mr-2">
              <button
                class="btn button-custom2 w-100"
                type="button"
                onclick="material_input_add()"
              >
                입고등록
              </button>
            </div>
            <div class="col-1 px-0 mr-2">
              <button
                class="btn button-custom2 w-100"
                type="button"
                onclick="material_input_edit()"
              >
                입고수정
              </button>
            </div>
            <div class="col-1 px-0 mr-2">
              <button
                class="btn button-custom2 w-100"
                type="button"
                onclick="material_input_remove()"
              >
                입고삭제
              </button>
            </div>
            <!--                    <div class="col-1 px-0">-->
            <!--                        <a class="btn button-custom2 w-100" role="button">저장</a>-->
            <!--                    </div>-->
          </div>
        </form>
      </div>
    </div>

    <!-- 테이블 -->
    <div class="card m-2">
      <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        <div class="content-table col-12">
          <table
            id="material_input_data-table"
            class="table table-sm text-center"
            style="min-width: 1300px"
          >
            <thead>
              <tr>
                <th>순번</th>
                <th>입하번호</th>
                <th>구매처</th>
                <th>품번</th>
                <th>품명</th>
                <th>품종</th>
                <th>모델</th>
                <th>자재구분</th>
                <th>자재생산일자</th>
                <th>검사일자</th>
                <th>입하일자</th>
                <th>단위</th>
                <th>포장수량</th>
                <th>입하수량</th>
                <th>불량 수량</th>
                <th>입고 수량</th>
                <th>창고 위치</th>
                <!-- {# <th>입고 처리자</th>#} -->
                <th>기타</th>
              </tr>
            </thead>
            <tbody id="material_input-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- 테이블 건수 조회 -->
    <div class="card m-2">
      <div class="row no-gutters card-body p-2">
        <label class="mb-0"
          >(<strong id="material_input_table_row">0</strong>) 건 로딩</label
        >
      </div>
    </div>

    <script
      src="{% static 'js/api_warehouse.js' %}"
      type="text/javascript"
    ></script>
    <script
      src="{% static 'js/api_codemaster.js' %}"
      type="text/javascript"
    ></script>
    <script>
      let matarial_input_list = [];
      var material_input_id_idx;
      var material_input_columns = [
        "customer",
        "item-code",
        "item-name",
        "item-type",
        "item-model",
        "item-item_division",
        "check-at",
        "in-at",
        "item-unit",
        "package-amount",
        "receive-amount",
        "in-faulty-amount",
        "in-amount",
        "location",
        "etc",
        "item-created-at",
      ];
      // let filters = ['factory', 'process', 'enable', 'name'];

      $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
      });
      $(".datepicker").datepicker("setDate", "today");

      // ANCHOR material_input_draw_in_table
      function material_input_draw_in_table(data) {
        console.log("data", data);
        $("#material_input_table_row").text(data.length); // 로딩된 데이터 갯수 세기
        let rows = "";
        let list_num = 1;
        for (let i = 0; i < data.length; i++) {
          let material = data[i];
          let created_date = material.created_at;
          let updated_date = material.updated_at;

          // append it
          let row = "<tr id='" + material.id + "' style='cursor:pointer;'>";
          row += "<td>" + list_num++ + "</td>";
          row += "<td data-item='num'>" + material.num + "</td>"; // 입하번호
          row +="<td data-item='customer' property='" +(material.item && material.item.purchase_from? material.item.purchase_from.id: "") +"'>" +(material.item && material.item.purchase_from? material.item.purchase_from.name: "") +"</td>"; // 구매처
          row +="<td data-item='item-code' property='" +(material.item ? material.item.id : "") +"'>" +(material.item ? material.item.code : "") +"</td>"; // 품번
          row +="<td data-item='item-name' property='" +(material.item ? material.item.id : "") +"'>" +(material.item ? material.item.name : "") +"</td>"; // 품명
          row +="<td data-item='item-type' property='" +(material.item.type ? material.item.type.id : "") +"'>" +(material.item.type ? material.item.type.name : "") +"</td>"; // 품목
          row +="<td data-item='item-model' property='" +(material.item.model ? material.item.model.id : "") +"'>" +(material.item.model ? material.item.model.name : "") +"</td>"; // 모델
          row +="<td data-item='item-item-division' property='" +(material.item.item_division? material.item.item_division.id: "") +"'>" +(material.item.item_division? material.item.item_division.name: "") +"</td>"; // 자재구분
          row +="<td data-item='item-created-at'>" +nullapply(material.item_created_at) +"</td>"; // 자재생산일자
          row +="<td data-item='check-at'>" +nullapply(material.check_at) +"</td>"; // 검사일자
          row +="<td data-item='in-at'>" + material.in_at + "</td>"; // 입하일자
          row +="<td data-item='item-unit' property='" +(material.item.unit ? material.item.unit.id : "") +"'>" +(material.item.unit ? material.item.unit.name : "") +"</td>"; // 단위
          row +="<td data-item='package-amount'>" +material.package_amount +"</td>"; // 포장수량
          row +="<td data-item='receive-amount'>" +material.receive_amount +"</td>"; // 입하수량
          row +="<td data-item='in-faulty-amount'>" +material.in_faulty_amount +"</td>"; // 불량수량
          row += "<td data-item='in-amount'>" + material.in_amount + "</td>"; // 입고수량
          row +="<td data-item='location'>" +nullapply(material.location) +"</td>"; // 창고위치
          //                row += "<td data-item='num'>" + material.num + "</td>";   // 입고 처리자   TODO: 뭔지 모르겠다
          row +="<td data-item='etc'>" +(material.etc ? material.etc : "") +"</td>"; // 기타

          // {#row += "<td class='d-none' data-item='customer_id'>" + (material.item.purchase_from ? material.item.purchase_from.id : '') + "</td>";   // 기타#}
          //     {#row += "<td class='d-none' data-item='item-code_id'>" + (material.item ? material.item.id : '') + "</td>";   // 기타#}
          //         {#row += "<td class='d-none' data-item='item-unit_id'>" + (material.item.unit ? material.item.unit.id : '') + "</td>";   // 기타#}

          row += "</tr>";

          rows += row;
        }
        spinner();
        $("#material_input-tbody").html(rows);
        $("#material_input-tbody > tr").on("click", function () {
          // flush pre-filtered
          // for (let fi in todos) $(todos[fi]).val("").trigger("change");
          // fixed = [];
          // filter_options();

          material_input_columns.forEach((item) => {
            if (
              item === "customer" || item === "item-code" || item === "item-name" || item === "item-type" || item === "item-model" ||
              item === "item-item_division" || item === "item-unit"
            ) {
              // {#console.table(item + ' : ' + $(this).find("[data-item='" + item + "_id']").text());# }
              $("#material_input_main-form [name='" + item + "']")
                .val(
                  $(this)
                    .find("[data-item='" + item + "']")
                    .attr("property")
                )
                .trigger("change");
            } else {
              $("#material_input_main-form [name='" + item + "']").val(
                $(this)
                  .find("[data-item='" + item + "']")
                  .text()
              );
            }
          });

          $(".material_input_item-name-dropdown")
            .val($(this).find("[data-item='item-name']").attr("property"))
            .trigger("change");
          $(".item-type-dropdown")
            .val($(this).find("[data-item='item-type']").attr("property"))
            .trigger("change");
          $(".model-dropdown")
            .val($(this).find("[data-item='item-model']").attr("property"))
            .trigger("change");
          $(".item-division-dropdown")
            .val(
              $(this).find("[data-item='item-item-division']").attr("property")
            )
            .trigger("change");

          material_input_id_idx = $(this).attr("id");
        });

        // table click highlight
        $("#material_input-tbody tr").on("click", function () {
          $(this).parent().find("tr").removeClass("clicked");
          $(this).addClass("clicked");
        });

        //Table pagination
        $('.pagination-container').remove();
        $('.table tbody').paginathing();

        console.log("draw table success");
      }

      let warehouse_code;
      $(function () {
        // warehouse code
        const urlParams = new URLSearchParams(window.location.search);
        warehouse_code = urlParams.get("code");

        refresh();

        // Table Export
        $(parent.document).find("#excel-export").click(() =>
          init_excel_export($("#material_input_data-table"), "자재입고")
        );
      });

      function refresh() {
        material_input_load_table();
        material_input_init();
      }

      function material_input_load_table() {
        warehouse_in_list(warehouse_code, (data) => {
          matarial_input_list = data;
          material_input_draw_in_table(data);
        });

        material_input_init();
      }

      function material_input_init() {
        function make_dropdown(data, selectors) {
          // console.log('-----------material_input_init_make_dropdown-------------')
          // console.log(data);
          let list = "<option value=''>선택</option>";
          for (let i = 0; i < data.length; i++) {
            let item = data[i];
            if (selectors === ".bom-dropdown") {
              list +=
                "<option value='" +item.id +"'>" +item.bom_name +"</option>";
            } else if (selectors === ".material_input_item-code-dropdown") {
              list +="<option value='" +item.id +"'" +
                " data-customer='" +(item.sales_to ? item.sales_to.id : "") +"'" +
                " data-unit='" +(item.unit ? item.unit.id : "") +"'" +
                " data-name='" +(item.name ? item.id : "") +"'" +
                " data-type='" +(item.type ? item.type.id : "") +"'" +
                " data-model='" +(item.model ? item.model.id : "") +"'" +
                " data-item_division='" +(item.item_division ? item.item_division.id : "") +"'>" + item.code +"</option>";
            }  else if (selectors === ".material_input_item-name-dropdown") {
              list +="<option value='" +item.id +"'" +
                " data-customer='" +(item.sales_to ? item.sales_to.id : "") +"'" +
                " data-unit='" +(item.unit ? item.unit.id : "") +"'" +
                " data-name='" +(item.name ? item.id : "") +"'" +
                " data-type='" +(item.type ? item.type.id : "") +"'" +
                " data-model='" +(item.model ? item.model.id : "") +"'" +
                " data-item_division='" +(item.item_division ? item.item_division.id : "") +"'>" + item.name +"</option>";
            } else {
              list +=
                "<option value='" + item.id + "'>" + item.name + "</option>";
            }
          }
          $(selectors).html(list);

          if (
            selectors === ".customer-dropdown" ||
            selectors === ".unit-dropdown"
          ) {
            $(selectors).select2({ width: "100%" }).prop("disabled", true);
          } else {
            $(selectors).select2({ width: "100%" });
          }
        }

        api_gp("/items/", "GET", {}, (data) => {
          items = data;
          // filter_options();

          make_dropdown(data, '.material_input_item-code-dropdown');
          make_dropdown(data, '.material_search_input_item-name-dropdown');
          make_dropdown(data, '.material_input_item-name-dropdown');
          make_dropdown(data, '.item-name-dropdown');

          $('.material_input_item-code-dropdown').on('select2:select', function (e) { // items 품번을 선택했을때 작동을 함
              let select2_data = e.params.data;

              if (select2_data.id === '') {
                $(".customer-dropdown").val("").trigger("change");
                $(".unit-dropdown").val("").trigger("change");
                $(".material_input_item-name-dropdown").val("").trigger("change");
                $(".item-type-dropdown").val("").trigger("change");
                $(".model-dropdown").val("").trigger("change");
                $(".item-division-dropdown").val("").trigger("change");
              } else { 
                  let name_value = $(this).val();
                  let unit_value = $(this).find("option:selected").data("unit");
                  let type_value = $(this).find("option:selected").data("type");
                  let model_value = $(this).find("option:selected").data("model");
                  let item_division_value = $(this).find("option:selected").data("item_division");
                  let customer_value = $(this).find("option:selected").data("customer");

                  $(".material_input_item-name-dropdown").val(name_value).trigger('change');
                  $(".customer-dropdown").val(customer_value).trigger('change');  
                  $(".unit-dropdown").val(unit_value).trigger('change');
                  $(".item-type-dropdown").val(type_value).trigger('change');
                  $(".model-dropdown").val(model_value).trigger('change');
                  $(".item-division-dropdown").val(item_division_value).trigger('change');
              }
          });

          $('.material_input_item-name-dropdown').on('select2:select', function (e) { // items 품명을 선택했을때 작동을 함
            let select2_data = e.params.data;
              
              if (select2_data.id === '') {
                $(".customer-dropdown").val("").trigger("change");
                $(".unit-dropdown").val("").trigger("change");
                $(".material_input_item-code-dropdown").val("").trigger("change");
                $(".item-type-dropdown").val("").trigger("change");
                $(".model-dropdown").val("").trigger("change");
                $(".item-division-dropdown").val("").trigger("change");
              } else { 
                  let code_value = $(this).val();
                  let unit_value = $(this).find("option:selected").data("unit");
                  let type_value = $(this).find("option:selected").data("type");
                  let model_value = $(this).find("option:selected").data("model");
                  let item_division_value = $(this).find("option:selected").data("item_division");
                  let customer_value = $(this).find("option:selected").data("customer");

                  $(".material_input_item-code-dropdown").val(code_value).trigger('change');
                  $(".customer-dropdown").val(customer_value).trigger('change');  
                  $(".unit-dropdown").val(unit_value).trigger('change');
                  $(".item-type-dropdown").val(type_value).trigger('change');
                  $(".model-dropdown").val(model_value).trigger('change');
                  $(".item-division-dropdown").val(item_division_value).trigger('change');
              }
          });
        });
        

        api_gp("/customers/", "GET", {}, (data) => {
          make_dropdown(data, ".customer-dropdown");
          make_dropdown(data, ".customer-search-dropdown");
        });

        api_gp("/bom/master/", "GET", {}, (data) => {
          make_dropdown(data, ".bom-dropdown");
        });

        api_gp("/codes/?group=115&enable=true", "GET", {}, (data) => {
          types = data;
          // filter_options();
          make_dropdown(data, '.item-type-dropdown');
        });

        api_gp("/codes/?group=116&enable=true", "GET", {}, (data) => {
          models = data;
          // filter_options();
          make_dropdown(data, '.model-dropdown');
        });

        api_gp("/codes/?group=118&enable=true", "GET", {}, (data) => {
          idiv = data;
          // filter_options();
          make_dropdown(data, '.item-division-dropdown');
        });

        api_gp("/codes/?group=105&enable=true", "GET", {}, (data) => {
          make_dropdown(data, ".unit-dropdown");
        });
      }

      // let items, types, models, idiv;

      // function make_filtering_value(t) {
      //   try {
      //     let target = t.select2("data");
      //     return target.length === 0 || target[0].id !== ""
      //       ? target[0].text
      //       : "";
      //   } catch (e) {
      //     return "";
      //   }
      // }

      // function filter_options() {
      //   let data = items;
      //   let dtypes = types;
      //   let dmodels = models;
      //   let didiv = idiv;

      //   if (
      //     data === undefined ||
      //     dtypes === undefined ||
      //     dmodels === undefined ||
      //     didiv === undefined
      //   )
      //     return;

      //   // get data
      //   let code = $(".material_input_item-code-dropdown").val();
      //   let name = make_filtering_value(
      //     $(".material_input_item-name-dropdown")
      //   );
      //   let type_name = make_filtering_value($(".item-type-dropdown"));
      //   let model_name = make_filtering_value($(".model-dropdown"));
      //   let item_division_name = make_filtering_value(
      //     $(".item-division-dropdown")
      //   );

      //   // filtering
      //   if (code !== "") data = data.filter((x) => x.code === code);
      //   if (name !== "") data = data.filter((x) => x.name === name);
      //   dtypes = dtypes.filter((x) =>
      //     data
      //       .filter((y) => y.type !== null)
      //       .map((y) => y.type.name)
      //       .includes(x.name)
      //   );
      //   dmodels = dmodels.filter((x) =>
      //     data
      //       .filter((y) => y.model !== null)
      //       .map((y) => y.model.name)
      //       .includes(x.name)
      //   );
      //   didiv = didiv.filter((x) =>
      //     data
      //       .filter((y) => y.item_division !== null)
      //       .map((y) => y.item_division.name)
      //       .includes(x.name)
      //   );

      //   console.log(data);
      //   console.log(dtypes);
      //   console.log(dmodels);
      //   console.log(didiv);

      //   for (let todo_idx in todos) {
      //     let todo = todos[todo_idx];

      //     if (fixed.includes(todo)) continue;

      //     let inp = data;
      //     if (todo === ".item-type-dropdown") inp = dtypes;
      //     else if (todo === ".item-division-dropdown") inp = didiv;
      //     else if (todo === ".model-dropdown") inp = dmodels;
      //     filter_dropdown(inp, todo);
      //   }

      //   // auto complete for single item
      //   if (
      //     fixed.includes(".item-type-dropdown") &&
      //     fixed.includes(".item-division-dropdown") &&
      //     fixed.includes(".model-dropdown") &&
      //     fixed.includes(".material_input_item-name-dropdown")
      //   ) {
      //     if (
      //       !fixed.includes(".material_input_item-code-dropdown") &&
      //       data.length === 1
      //     ) {
      //       fixed.push(".material_input_item-code-dropdown");
      //       $(".material_input_item-code-dropdown")
      //         .val(data[0].id)
      //         .trigger("change");
      //     }
      //   }
      // }

      // // let fixed = new Set();
      // let fixed = [];
      // let todos = [
      //   ".material_input_item-name-dropdown",
      //   ".material_input_item-code-dropdown",
      //   ".item-type-dropdown",
      //   ".item-division-dropdown",
      //   ".model-dropdown",
      // ];
      // //let todos = ['.material_input_item-name-dropdown', '.material_input_item-code-dropdown'];
      // $(
      //   ".material_input_item-name-dropdown, .item-type-dropdown, .item-division-dropdown, .model-dropdown, .material_input_item-code-dropdown"
      // )
      //   //$('.material_input_item-name-dropdown, .item-type-dropdown, .item-division-dropdown, .model-dropdown, .material_input_item-code-dropdown')
      //   .on("select2:select", function (e) {
      //     let target = undefined; // find target
      //     for (let todo_idx in todos) {
      //       let todo = todos[todo_idx];
      //       if ($(todo)[0] === $(this)[0]) {
      //         target = todo;
      //         break;
      //       }
      //     }

      //     // remove filters
      //     let idx = fixed.indexOf(target);
      //     if (idx !== -1) {
      //       let adjusted_idx = Math.min(idx + 1, fixed.length);
      //       let fixed_r = fixed.slice(adjusted_idx);
      //       for (let fri in fixed_r)
      //         $(fixed_r[fri]).val(null).trigger("change");
      //       fixed = fixed.slice(0, adjusted_idx);
      //       //
      //     } else fixed.push(target);

      //     console.log(fixed);
      //     filter_options();
      //     // Do something
      //   });

      // function filter_dropdown(data, selectors) {
      //   // 품번가지고 등록하는 것은 맞음
      //   // TODO: 모두 length == 1 인 경우 snap

      //   // 필터링한 데이터(item 데이터들)를 가져옴
      //   let res = data.map((x) => {
      //     let name = undefined;

      //     /*
      //           if (selectors === '.model-dropdown' && x.model !== null) name = x.model.name;
      //           if (selectors === '.item-type-dropdown' && x.type !== null) name = x.type.name;
      //           if (selectors === '.item-division-dropdown' && x.item_division !== null) name = x.item_division.name;
      //            */
      //     if (selectors === ".material_input_item-code-dropdown") name = x.code;
      //     else if (selectors === ".material_input_item-name-dropdown")
      //       name = x.name;
      //     else name = x.name;

      //     if (name !== undefined) return { id: x.id, text: name };
      //   });

      //   res.unshift({ id: "", text: "선택" });

      //   // rebuild select2
      //   $(selectors).empty();
      //   $(selectors).select2({ data: res });
      // }

      function material_input_get_form_data() {
        let data = {};
        material_input_columns.forEach((item) => {
          if (item === "enable")
            data[item] =
              $('#material_input_main-form [name="' + item + '"]').val() ===
              "사용";
          else
            data[item.replace(/-/gi, "_")] = $(
              '#material_input_main-form [name="' + item + '"]'
            ).val();
        });

        // TODO:
        data.item = data["item_code"];
        data.warehouse = warehouse_code;

        return data;
      }

      function material_input_add() {
        let data = material_input_get_form_data();
        api_gp("/wh/in/", "POST", data, (data) => {
          alert("성공적으로 등록하였습니다.");
          material_input_load_table();
        });
      }

      function material_input_edit() {
        let data = material_input_get_form_data();
        api_gp(
          "/wh/in/" + material_input_id_idx + "/",
          "PATCH",
          data,
          (data) => {
            alert("성공적으로 수정하였습니다.");
            material_input_load_table();
          }
        );
      }

      function material_input_remove() {
        let data = material_input_get_form_data();
        api_gp(
          "/wh/in/" + material_input_id_idx + "/",
          "DELETE",
          data,
          (data) => {
            alert("성공적으로 삭제하였습니다.");
            material_input_load_table();
          }
        );
      }

      function in_amount_calc() {
        $("#material_input_in-amount").val(
          $("#material_input_receive-amount").val() -
            $("#material_input_in-faulty-amount").val()
        );
      }

      function datepicker_controller() {
        let startdate = $("#startdate").datepicker("option", "minDate").val();
        let enddate = $("#enddate").datepicker("option", "maxDate").val();

        startdate = startdate.split("-");
        enddate = enddate.split("-");

        min_date = new Date(startdate[0], startdate[1] - 1, startdate[2]);
        max_date = new Date(enddate[0], enddate[1] - 1, enddate[2]);

        if (min_date > max_date) {
          alert("시작일이 종료일을 넘어갈수 없습니다.");
          $("#enddate").datepicker("setDate", null);
        }
      }

      // ANCHOR  input_submit
      function input_submit(e) {
        e.preventDefault();
        const options = {
          start_date: e.target["startdate"].value,
          end_date: e.target["enddate"].value,
          purchase_id: e.target["customer"].value,
          item_id: e.target["item-name-search"].value,
        };

        const filter_matarial_list = ({
          start_date,
          end_date,
          purchase_id,
          item_id,
        }) => (matarial_input_object) => {
          let is_passed = true;
          if (start_date && end_date)
            is_passed =
              new Date(start_date).getTime() <=
                new Date(matarial_input_object.in_at).getTime() &&
              new Date(matarial_input_object.in_at).getTime() <=
                new Date(end_date).getTime();
          if (purchase_id)
            is_passed =
              Number(purchase_id) ===
              Number(matarial_input_object.item.purchase_from.id);
          if (item_id)
            is_passed =
              Number(item_id) === Number(matarial_input_object.item.id);
          return is_passed;
        };

        material_input_draw_in_table(
          matarial_input_list.filter(filter_matarial_list(options))
        );

        return false;
      }


      function spinner(){
        $("#spinner").remove();
      }
    </script>
    {#{% endblock %}#}
  </body>
</html>
