<!DOCTYPE HTML>
<html>
<header>
    {% include "header.html" %}
</header>
<body>


<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px" />
</div>

    <!-- 검색 -->
    <form class="card m-2" id="temp_volt_monitoring_manage_search-form">
        <div class="card-body p-2">
            <!-- 본문 -->
            <div class="content-search row no-gutters align-items-center content-input-group">
                <div class="content-title col-1 align-self-stretch">
                    조회
                </div>
                <div class="col-11">
                    <div class="row no-gutters">
                        <div class="content-input-group col-3 px-0">
                            <div class="content-input-group-header">
                                <label>기업명</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control search_order_company_select" name="company_name" id="search_company_name" ></select>
                            </div>
                        </div>
                        <div class="content-input-group col-3 px-0">
                            <div class="content-input-group-header">
                                <label>공장명</label>
                            </div>
                            <div class="content-input-group-input">
                                <select class="form-control" name="factory__id" id="factory_select">
                                </select>
                            </div>
                        </div>
                        <div class="content-input-group col-2 px-0">
                            <div class="content-input-group-header">
                                <label>PC 명</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" name="name">
                            </div>
                        </div>
                        <div class="col-1 ml-auto px-0">
                            <button class="btn button-search rounded-0 w-100 h-100" type="button" onclick="temp_volt_monitoring_manage_load_table(true);return false;">검색</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- 내용 -->
    <form class="card m-2" id="temp_volt_monitoring_manage_main-form">
        <div class="row no-gutters card-body p-2">
            <!-- 본문 -->
            <div class="content-content w-100">
                <div class="row no-gutters w-100 mb-2">
                    <div class="col-1 content-title">
                        관리장비 등록
                    </div>
                    <div class="col-11">
                        <div class="row no-gutters">
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>공장명<strong>*</strong></label>
                                </div>
                                <div class="content-input-group-input">
                                    <select class="form-control " name="factory" id="factory_selects">
                                    </select>
                                </div>
                            </div>
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>PC명</label>
                                </div>
                                <div class="content-input-group-input">
                                    <input class="form-control" name="name">
                                </div>
                            </div>
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>PC 모델</label>
                                </div>
                                <div class="content-input-group-input">
                                    <input class="form-control" name="model">
                                </div>
                            </div>
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>시리얼 No</label>
                                </div>
                                <div class="content-input-group-input">
                                    <input class="form-control" name="serial">
                                </div>
                            </div>
                        </div>
                        <div class="row no-gutters">
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>기업명<strong>*</strong></label>
                                </div>
                                <div class="content-input-group-input">
                                    <select class="form-control order_company_select" name="company" id="company"></select>
                                </div>
                            </div>
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>맥 주소</label>
                                </div>
                                <div class="content-input-group-input">
                                    <input type="text" class="form-control" name="mac">
                                </div>
                            </div>
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>온도 허용범위</label>
                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="temp_threshold_low">
                                        <div class="input-group-addon px-3 py-2">~</div>
                                        <input type="text" class="form-control" name="temp_threshold_high">
                                    </div>
                                </div>
                            </div>
                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>전압 허용범위</label>
                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="voltage_threshold_low">
                                        <div class="input-group-addon px-3 py-2">~</div>
                                        <input type="text" class="form-control" name="voltage_threshold_high">
                                    </div>
                                </div>
                            </div>

                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>3.3V 허용범위</label>
                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="voltage_3v_threshold_low">
                                        <div class="input-group-addon px-3 py-2">~</div>
                                        <input type="text" class="form-control" name="voltage_3v_threshold_high">
                                    </div>
                                </div>
                            </div>

                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>5V 허용범위</label>
                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="voltage_5v_threshold_low">
                                        <div class="input-group-addon px-3 py-2">~</div>
                                        <input type="text" class="form-control" name="voltage_5v_threshold_high">
                                    </div>
                                </div>
                            </div>

                            <div class="content-input-group col-3">
                                <div class="content-input-group-header">
                                    <label>12V 허용범위</label>
                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="voltage_12v_threshold_low">
                                        <div class="input-group-addon px-3 py-2">~</div>
                                        <input type="text" class="form-control" name="voltage_12v_threshold_high">
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="row no-gutters">
                        <div class="content-input-group col-6">
                                <div class="content-input-group-header">
                                    <label>관리자 메일</label>
                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="admin_email_1" placeholder="메일1">
                                        <div class="input-group-addon px-3 py-2">  </div>
                                        <input type="text" class="form-control" name="admin_email_2" placeholder="메일2">
                                    </div>

                                </div>
                                <div class="content-input-group-input">
                                    <div class="input-group-addon px-3 py-2" style="color: red"> <strong>문제 발생 PC에 대해 관리자에게 메일을 발송합니다</strong> </div>
                                </div>

                            </div>
                        </div>
                        <div class="row no-gutters">
                            <div class="content-input-group col-4">
                                <div class="content-input-group-header">
                                    <label>기타</label>
                                </div>
                                <div class="content-input-group-input">
                                    <input class="form-control" name="etc">
                                </div>
                            </div>
                            <div class="content-input-group col-2">
                                <div class="content-input-group-header">
                                    <label>위험경보관리</label>
                                </div>
                                <input class="checkbox" style="width: 32px; height: 32px;" type="checkbox" name="alert" checked="checked"/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row no-gutters w-100 justify-content-end">
                     <div class="col-1 px-0 mr-2">
                        <button class="btn button-custom2 w-100" type="button" onclick="form_blank();">초기화</button>
                    </div>
                    <div class="col-1 px-0 mr-2">
                        <button class="btn button-custom2 w-100" role="button" onclick="temp_volt_monitoring_manage_add(); return false;">등록</button>
                    </div>
                    <div class="col-1 px-0 mr-2">
                        <button class="btn button-custom2 w-100" role="button" onclick="temp_volt_monitoring_manage_edit(); return false;">수정</button>
                    </div>
                    <div class="col-1 px-0">
                        <button class="btn button-custom2 w-100" role="button" onclick="temp_volt_monitoring_manage_remove(); return false;">삭제</button>
                    </div>
                </div>
            </div>
        </div>
    </form>


    <!-- 테이블 -->
    <div class="card m-2">
        <div class="row no-gutters card-body p-2">
            <!-- 본문 -->
            <div class="content-table col-12">
                <table id="temp_volt_monitoring_manage_data-table" class="table table-sm text-center" style="min-width: 1300px;">
                    <thead>
                    <tr>
                        <th rowspan="2">순번</th>
                        <th rowspan="2">등록일</th>
                        <th rowspan="2">공장명</th>
                        <th rowspan="2">PC명</th>
                        <th rowspan="2">PC 모델</th>
                        <th rowspan="2">시리얼 No</th>
                        <th rowspan="2">기업명</th>
                        <th rowspan="2">온도 허용범위</th>
                        <th rowspan="2">전압 허용범위</th>
                        <th rowspan="2">3.3V 허용범위</th>
                        <th rowspan="2">5V 허용범위</th>
                        <th rowspan="2">12V 허용범위</th>
                        <th colspan="2">관리자 메일
                        <th rowspan="2">위험경보</th>
                        <th rowspan="2">등록자</th>
                        <th rowspan="2">기타</th>
                        <tr>
                        <th>메일1</th>
                        <th>메일2</th>
                        </tr>

                    </tr>
                    </thead>
                    <tbody id="temp_volt_monitoring_manage_main-tbody"></tbody>
                </table>
            </div>

        </div>
    </div>
    <!-- 테이블 건수 조회 -->
    <div class="card m-2">
        <div class="row no-gutters card-body p-2">
            <label class="mb-0">(<strong id="temp_volt_monitoring_manage_table_row">0</strong>) 건 로딩</label>
        </div>
    </div>
    <script>
    
    var temp_volt_monitoring_id_idx;
    var temp_volt_monitoring_columns = ['factory', 'name', 'model', 'serial', 'mac', 'voltage_threshold_low', 'voltage_threshold_high',
        'voltage_3v_threshold_low', 'voltage_3v_threshold_high', 'voltage_5v_threshold_low', 'voltage_5v_threshold_high',
        'voltage_12v_threshold_low', 'voltage_12v_threshold_high', 'temp_threshold_low', 'temp_threshold_high', 'etc', 'alert',
        'admin_email_1', 'admin_email_2', 'company'];
    var temp_volt_monitoring_filters = ['company_name', 'factory__id', 'name'];  // TODO Type PC로 변경
    
    function form_blank() {
            temp_volt_monitoring_columns.forEach((item) => {
              $('#temp_volt_monitoring_manage_main-form [name="' + item + '"]').val(null).trigger("change");
          });
      }

    function get_checkbox_value(e){
        let val = $('input:checkbox[name="alert"]').is(":checked");
        return val;
    }   

    function temp_volt_monitoring_manage_load_table(is_search) {
        // TODO 발주기업 유무 작업
        // 기업(enterprise)이 아이뉴텍이 아니면서 발주기업이 등록되어 있으면 선택 불가능
        if (get_userinfo().enterprise_name !== "(주)아이뉴텍" && get_userinfo().order_company !== null){ 
            $("#search_company_name").attr("disabled",true);
            $("#company").attr("disabled", true);
        }

        function mock(data) {

            $('#temp_volt_monitoring_manage_table_row').text(data.length); // 로딩된 데이터 갯수 세기

            let rows = "";
            let list_num = 1;
            
            for (let i = 0; i < data.length; i++) {
                let item = data[i];

                // append it
                let row = "<tr id='" + item.id + "' style='cursor:pointer;'>";
                row += "<td>" + (list_num++) + "</td>";
                row += "<td data-item='created_at'>" + item.created_at.substring(0, 4) + "-" + item.created_at.substring(5, 7) + "-" + item.created_at.substring(8, 10) + "</td>"; // 등록일
                row += "<td data-item='factory' property='" + (item.factory ? item.factory.id : "") + "'>" + (item.factory ? item.factory.name : "") + "</td>"; // 공장명
                // row += "<td data-item='facilities' property='" + (item.facilities ? item.facilities.id : "") + "'>" + (item.facilities ? item.facilities.name : "") + "</td>";  // PC 명
                row += "<td data-item='name' property='" + nullapply(item.name) + "'>" + nullapply(item.name) + "</td>";
                row += "<td data-item='model' property='" + nullapply(item.model) + "'>" + nullapply(item.model) + "</td>";
                row += "<td data-item='serial' property='" + nullapply(item.serial) + "'>" + nullapply(item.serial) + "</td>";
                row += "<td data-item='company' property='" + (item.order_company ? item.order_company.id: "") + "'>" + (item.order_company ? item.order_company.name : "")  + "</td>";
                row += "<td data-item='threshold'>" + ((item.temp_threshold_low || item.temp_threshold_low == 0) ? item.temp_threshold_low : "") + "~" + ((item.temp_threshold_high || item.temp_threshold_high ==0) ? item.temp_threshold_high : "") + "</td>"; // 온도 허용범위
                row += "<td data-item='voltage'>" + ((item.voltage_threshold_low || item.voltage_threshold_low == 0) ? item.voltage_threshold_low : "") + "~" + ((item.voltage_threshold_high || item.voltage_threshold_high == 0) ? item.voltage_threshold_high : "") + "</td>"; // 전압 허용범위
                row += "<td data-item='voltage3'>" + ((item.voltage_3v_threshold_low || item.voltage_3v_threshold_low == 0) ? item.voltage_3v_threshold_low : "") + "~" + ((item.voltage_3v_threshold_high || item.voltage_3v_threshold_high == 0) ? item.voltage_3v_threshold_high : "") + "</td>"; // 3.3V 허용범위
                row += "<td data-item='voltage5'>" + ((item.voltage_5v_threshold_low || item.voltage_5v_threshold_low == 0) ? item.voltage_5v_threshold_low : "") + "~" + ((item.voltage_5v_threshold_high || item.voltage_5v_threshold_high == 0)? item.voltage_5v_threshold_high : "") + "</td>"; // 5V 허용범위
                row += "<td data-item='voltage12'>" + ((item.voltage_12v_threshold_low || item.voltage_12v_threshold_low == 0) ? item.voltage_12v_threshold_low : "") + "~" + ((item.voltage_12v_threshold_high || item.voltage_12v_threshold_high == 0) ? item.voltage_12v_threshold_high : "") + "</td>"; // 12V 허용범위
                // 메일1
                row += "<td data-item='admin_email_1' property='" + nullapply(item.admin_email_1) + "'>" + nullapply(item.admin_email_1) + "</td>";
                row += "<td data-item='admin_email_2' property='" + nullapply(item.admin_email_2) + "'>" + nullapply(item.admin_email_2) + "</td>";
                // 메일2
                row += "<td data-item='alert'>" + "<input class='checkbox' type='checkbox' disabled style='width:24px; height:24px;' " + (item.alert === "true" ? "checked" : "") + "/>"+ "</td>";  // 위험경보 check box
                row += "<td data-item='created_by'>" + item.created_by + "</td>";  // 등록자

                row += "<td data-item='etc'>" + (item.etc ? item.etc : "") + "</td>";

                // 안보이는 정보들
                row += "<td class='d-none' data-item='mac' property='" + nullapply(item.mac) + "'>" + nullapply(item.mac)  + "</td>";
                

                // {#row += "<td class='d-none' data-item='factory_id'>" + (item.factory ? item.factory.id : "") + "</td>";#}
                // {#row += "<td class='d-none' data-item='facilities_id'>" + (item.facilities ? item.facilities.id : "") + "</td>";#}
                // {#row += "<td class='d-none' data-item='type_id'>" + (item.type ? item.type.id : "") + "</td>";#}

                row += "</tr>";

                rows += row;
            }
            spinner();
                $('#temp_volt_monitoring_manage_main-tbody').html(rows);

            $('#temp_volt_monitoring_manage_main-tbody > tr').on('click', function () {
                temp_volt_monitoring_columns.forEach((item) => {
                    if (item === 'factory' || item === 'company') {
                        $("#temp_volt_monitoring_manage_main-form [name='" + item + "']").val($(this).find("[data-item='" + item + "']").attr('property')).trigger('change');
                    } else if (item === 'voltage_threshold_low') {
                        let thresholds = $(this).find("[data-item='voltage']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_threshold_low']").val(thresholds[0]);
                    } else if (item === 'voltage_threshold_high') {
                        let thresholds = $(this).find("[data-item='voltage']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_threshold_high']").val(thresholds[1]);
                    } else if (item === 'voltage_3v_threshold_low') {
                        let thresholds = $(this).find("[data-item='voltage3']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_3v_threshold_low']").val(thresholds[0]);
                    } else if (item === 'voltage_3v_threshold_high') {
                        let thresholds = $(this).find("[data-item='voltage3']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_3v_threshold_high']").val(thresholds[1]);
                    } else if (item === 'voltage_5v_threshold_low') {
                        let thresholds = $(this).find("[data-item='voltage5']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_5v_threshold_low']").val(thresholds[0]);
                    } else if (item === 'voltage_5v_threshold_high') {
                        let thresholds = $(this).find("[data-item='voltage5']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_5v_threshold_high']").val(thresholds[1]);
                    } else if (item === 'voltage_12v_threshold_low') {
                        let thresholds = $(this).find("[data-item='voltage12']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_12v_threshold_low']").val(thresholds[0]);
                    } else if (item === 'voltage_12v_threshold_high') {
                        let thresholds = $(this).find("[data-item='voltage12']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='voltage_12v_threshold_high']").val(thresholds[1]);
                    } else if (item === 'temp_threshold_low') {
                        let thresholds = $(this).find("[data-item='threshold']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='temp_threshold_low']").val(thresholds[0]);
                    } else if (item === 'temp_threshold_high') {
                        let thresholds = $(this).find("[data-item='threshold']").text().split('~')
                        $("#temp_volt_monitoring_manage_main-form [name='temp_threshold_high']").val(thresholds[1]);
                    } else if (item === 'alert') {
                        let warning = $(this).find("[data-item='alert']").children().is(":checked");
                        $('#temp_volt_monitoring_manage_main-form [name="alert"]').prop('checked', warning ? 'checked' : '');
                    } else {
                        $("#temp_volt_monitoring_manage_main-form [name='" + item + "']").val($(this).find("[data-item='" + item + "']").text());
                    }
                });
                temp_volt_monitoring_id_idx = $(this).attr('id');
            });

            // table click highlight
            $('#temp_volt_monitoring_manage_main-tbody tr').on('click', function () {
                $(this).parent().find('tr').removeClass('clicked');
                $(this).addClass('clicked');
            });


            //Table pagination
            $('.pagination-container').remove();
            $('.table tbody').paginathing();
        }

        // filter
        let query_params = "?";
        if (is_search) {
            temp_volt_monitoring_filters.forEach((item) => {
                let val = "";
                if (item === "name") {
                    val = $("#temp_volt_monitoring_manage_search-form [name='" + item + "']").val();
                } else {
                    val = $("#temp_volt_monitoring_manage_search-form [name='" + item + "'] :selected").val();
                }
                if (val !== "선택" && val !== "") query_params += "&" + item + "=" + val;
            });
        }
        console.log("query_params::", query_params);

        api_gp('/sensor_pc/' + query_params, 'GET', {}, (data) => {  // TODO API
            mock(data);
        });
    }

    function temp_volt_monitoring_manage_init() {
        function make_dropdown(data, selectors) {
            let list = "<option value=''>선택</option>";
            for (let i = 0; i < data.length; i++) {
                let item = data[i];
                if (selectors === '#factory_select' ) {
                    list += "<option value='" + item.id + "'>" + item.name +  "</option>";
                }
                else if (selectors === '#factory_selects') {
                    list += "<option value='" + item.id + "'>" + item.name + "</option>";
                }
                else if (selectors === '.order_company_select') {
                list += "<option value='" + item.id + "'>" + item.name + "</option>";
                }
                else if (selectors === '.search_order_company_select') {
                    list += "<option value='" + item.id + "'>" + item.name + "</option>";
                }
                else if (selectors === '#type_select') {  // PC명
                list += "<option value='" + item.id + "'>" + item.name + "</option>";
                }
            }
            $(selectors).html(list);
            $(selectors).select2({width: '100%'});
        }

        // factory dropdown
        api_gp('/codes_select/?group=104&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '#factory_select');
            make_dropdown(data, '#factory_selects');
        });

        // facilities dropdown
        api_gp('/facilities/', 'GET', {}, (data) => {
            make_dropdown(data, '#facilities_select');
        });

        // order_company dropdown
        api_gp('/order/company/', 'GET', {}, (data) => {
            make_dropdown(data, '.search_order_company_select');
            make_dropdown(data, '.order_company_select');
        });

        // type dropdown
        api_gp('/codes/?group=123&enable=true', 'GET', {}, (data) => {
            make_dropdown(data, '#type_select');
        });

        // main table
        temp_volt_monitoring_manage_load_table();
    }

    // 함수 등록 버튼 눌렀을때 각 컬럼 값  return
    function temp_volt_monitoring_manage_get_form_data() {
        let data = {};

        temp_volt_monitoring_columns.forEach((item) => {
            if (item === 'enable') data[item] = $('#temp_volt_monitoring_manage_main-form [name="' + item + '"]').val() === "사용";
            else if(item === 'alert') data[item] = $('#temp_volt_monitoring_manage_main-form [name="' + item + '"]').is(":checked");
            else data[item] = $('#temp_volt_monitoring_manage_main-form [name="' + item + '"]').val();
        });
        console.dir("dir data::",data);
        console.log("logdata:::",data);
        return data;
    }

    function temp_volt_monitoring_manage_add() {
        let data = temp_volt_monitoring_manage_get_form_data();
        api_gp('/sensor_pc/', 'POST', data, (data) => {
            alert("성공적으로 등록하였습니다.");
            temp_volt_monitoring_manage_load_table();
        });
    }

    function temp_volt_monitoring_manage_edit() {
        let data = temp_volt_monitoring_manage_get_form_data();
        console.log("edit data:: ", data);
        api_gp('/sensor_pc/' + temp_volt_monitoring_id_idx + '/', 'PATCH', data, (data) => {
            alert("성공적으로 수정하였습니다.");
            temp_volt_monitoring_manage_load_table();
        });
    }

    function temp_volt_monitoring_manage_remove() {
        let data = temp_volt_monitoring_manage_get_form_data();
        api_gp('/sensor_pc/' + temp_volt_monitoring_id_idx + '/', 'DELETE', data, (data) => {
            alert("성공적으로 삭제하였습니다.");
            temp_volt_monitoring_manage_load_table();
        });
    }

    $(() => {
        refresh();

        // Table export
        $(parent.document).find("#excel-export").click(() => init_excel_export($('#temp_volt_monitoring_manage_data-table'), '온도전압 장비관리'));
    });

    function refresh() {
        temp_volt_monitoring_manage_init();

    }

    function spinner(){
     $("#spinner").remove();
    }

    </script>
<!-- {#{% endblock %}#} -->
</body>
</html>
