<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
<body style="overflow: auto;">
{% load static %}

<div class="spinner" id="spinner">
    <img src="../../../static/img/spinner.gif" width="150px" height="150px"/>
</div>

<div class="card m-2">
    <div class="card-body p-2">
        <!-- 본문 -->
        <form
                class="content-search row no-gutters align-items-center content-input-group"
                id="fault_manage_main-form"
                onsubmit="return search_submit(event)"
        >
            <div
                    class="content-title col-lg-1 align-self-stretch d-lg-flex d-md-none d-sm-none"
            >
                생산완료공정검색
            </div>
            <div class="col-lg-11 col-md-12">
                <div class="row no-gutters">
                    <div
                            class="content-input-group col-lg-4 col-md-12 px-0 mb-lg-0 mb-md-2 mb-sm-2"
                    >
                        <div class="content-input-group-header">
                            <label>생산일자</label>
                        </div>
                        <div class="content-input-group-input">
                            <div class="input-group input-daterange">
                                <input
                                        type="text"
                                        class="form-control datepicker"
                                        id="fr_date"
                                        name="fr_date"
                                        autocomplete="off"
                                />
                                <div class="input-group-addon px-3">~</div>
                                <input
                                        type="text"
                                        class="form-control datepicker"
                                        id="to_date"
                                        name="to_date"
                                        autocomplete="off"
                                />
                            </div>
                        </div>
                    </div>
                    <div
                            class="content-input-group col-lg-3 col-md-12 px-0 mb-lg-0 mb-md-2 mb-sm-2"
                    >
                         <div class="content-input-group-header">
                            <label>생산제품명</label>
                        </div>
                        <div class="content-input-group-input">
                            <select
                                    class="form-control bom-dropdown-product"
                                    id="product_name"
                            ></select>
                        </div>
                    </div>

                    <div class="col-lg-1 col-md-12 px-0 ml-auto">
                        <button class="btn button-search rounded-0 w-100 h-100">
                            검색
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="card m-2 mx-auto" style="width:75%">
        <div class="row no-gutters card-body p-2">
            <div class="col-12 px-0">
                <!-- 본문 -->
                <div class="content-table col-12 px-0 mb-2" style="overflow-x:auto; overflow-y:hidden; height: 251px;">
                    <table id="BOM_data-table-up" class="table table-sm text-center">
                        <thead>
                        <tr>
                            <th>순번</th>
                            <th>생산제품명</th>
                        </tr>
                        </thead>
                        <tbody id="process_tbody">
                        </tbody>
                    </table>

                    <div class="row no-gutters d-flex justify-content-center" id="item_nation"
                         style="margin-top: -20px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 테이블 -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        <div class="content-input-group align-right col-3 m-2">
            <div class="content-input-group-header">
                <label>불량 사유 수</label>
            </div>
            <div class="content-input-group-input">
                <input disabled class="form-control" id="field_cnt" placeholder='1~15' autocomplete='off' value="5">
            </div>
        </div>
        <div class="col-lg-1 px-0 m-2 ml-auto">
            <button class="btn button-search rounded-0 w-100 h-100" id="clear">
                초기화
            </button>
        </div>
        <div class="content-table col-12" style="overflow-x: auto; overflow-y: scroll; height: auto;">
            <table
                    id="progress_lookup_data-table"
                    class="table table-sm text-center"
            >
                <thead>
                <tr>
                    <th style="width: 5%; z-index: 10">생산제품명</th>
                    <th style="width: 5%; z-index: 9">세부공정</th>
                    <th style="width: 5%; z-index: 9">완료수량</th>
                    <th style="width: 5%; z-index: 9">불량수량</th>
                    <th style="width: 5%; z-index: 9">불량률</th>
                    <th style="width: 5%; z-index: 9">구분</th>
                    <th id="progress_lookup_colspan" colspan="5">
                        불량사유
                    </th>
                    <th style="width: 5%">합계</th>
                    <th style="width: 5%">남은 불량 수량</th>
                </tr>
                </thead>
                <tbody id="progress_lookup_main-tbody">
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        <div class="content-input-group align-right col-3 m-2">
            <div class="content-input-group-header">
                <label>불량사유 세부내역</label>
            </div>
        </div>
        <div class="col-lg-1 px-0 m-2 ml-auto">
            <button class="btn button-search rounded-0 w-100 h-100" id="clear2">
                초기화
            </button>
        </div>
        <div class="content-table col-12" style="overflow-x: auto; overflow-y: hidden; height: auto;">
            <div id="progress_fault_detail_lookup_main-tbody">
            </div>
        </div>
    </div>
</div>
<script src="{% static 'js/api_paginations.js' %}" type="text/javascript"></script>
<script>
    spinner()

    let rowcnt = 1;
    let subprocesses = 1;
    let col_cnt = 5;
    let process_id = null;
    let select_before = null;
    let product_name = "";
    let max_col_cnt = 15;
    let clicked_fault_detail_table = []

    let now = new Date();
    let first_date = new Date(now.getFullYear(), now.getMonth(), 1);

    let nation_data1 = {
        cname : 'nation1',  // 인스턴스 명과 일치해야함
        table_id: 'item_nation',
        range: 5,
        page_size: 5,
    };
    let nation1 = new Pnations(nation_data1, process_search);  // 인스턴스 명

    $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
        todayHighlight: 'true',
    });
    $("#fr_date").datepicker("setDate", first_date);
    $("#to_date").datepicker("setDate", "today");

    $(function () {
        refresh();

        if (get_userinfo().enterprise_manage !== '(주)오큐텍'){
            $('#connect').addClass('d-none');
        }

        // Table Export
        $(parent.document).find("#excel-export").click(() =>
            init_excel_export($("#process_manage_data-table"), "생산공정")
        );
    });

    $("#clear").click(function () {
        $('#process_tbody tr').removeClass('clicked');
        process_id = null;
        col_index = 5;
        rowcnt = 1;
        clicked_fault_detail_table= []
        $("#progress_lookup_main-tbody").empty();
    });

    $("#clear2").click(function () {
        $("#progress_fault_detail_lookup_main-tbody").empty();
        clicked_fault_detail_table = []
    });

    $("#field_cnt").change(function () {
        columns();
    });

    $("#clear").click(function () {
        process_id = null;
        col_cnt = 5;
        $("#field_cnt").val(col_cnt);
        col_index = 5;
        rowcnt = 1;

        $("#progress_lookup_main-tbody").empty();
    });

    $("#save").click(function () {
        faulty_add();
    });


    function refresh() {
        api_gp("/bom/master_select/", "GET", {}, (data) => {
            make_dropdown(data, ".bom-dropdown-product");
        });
        process_search();
    }

    function columns() {
        let field_cnt = $('#field_cnt').val();

        // 숫자 변환
        let num = parseInt(field_cnt);

        if (isNaN(num) == true) {
            $('#field_cnt').val(col_cnt);
        } else {
            // 5~15 까지만 허용하도록 구현
            if (num >= 1 && num <= max_col_cnt) {
                $('#field_cnt').val(num);
                col_cnt = num;

                define_col(num);
            } else {
                $('#field_cnt').val(col_cnt);
            }
        }
    }

    function make_dropdown(data, selectors, trig_data) {
        let list = "<option value=''>선택</option>";
        for (let i = 0; i < data.length; i++) {
            let item = data[i];
            if (selectors === ".bom-dropdown-product") {
                list +=
                    "<option value='" + item.id + "'>" + item.product_name + "</option>";
            } else if (selectors === ".upper-dropdown-product") {
                list +=
                    "<option value='" + item.id + "'>" + item.name + "</option>";
            } else if (selectors === ".lower-dropdown-product") {
                list +=
                    "<option value='" + item.id + "'>" + item.name + "</option>";
            }
        }
        $(selectors).append(list);
        $(selectors).select2({width: "100%"});
        trigger_dropdown(trig_data)
    }

    function search_submit(e) {
        e.preventDefault();
        nation1.page = 1;
        process_id = null;
        col_index = 5;
        rowcnt = 1;

        $("#progress_lookup_main-tbody").empty();

        process_search();
        return false;
    }

    function process_search(){
        let product_name = $('#product_name :selected').text();

        let fr_date = $('#fr_date').val();
        let to_date = $('#to_date').val();

        let query = ";"
        let enterprise_name = get_userinfo().enterprise_name;
        if (enterprise_name == '(주)온교육') {
            query = "?page=" + nation1.page;
        }else{
            query = "?page=" + nation1.page + "&complete=1";;
        }

        if (product_name == '' || product_name == null || product_name == '선택'){
        } else { query += "&bom_master__product_name=" + product_name; }


        if (fr_date == '' || fr_date == null || fr_date == '선택'){
        } else { query += "&actual_fr_date=" + fr_date; }

        if (to_date == '' || to_date == null || to_date == '선택'){
        } else { query += "&actual_to_date=" + to_date; }

        {#console.log(query);#}

        api_gp("/process/has_fault_select" + query, 'GET', {}, (done) => {
            process_table_draw(done);
        });
    }

    function process_table_draw(done) {
        {#console.table(done);#}

        let data = done.results;
        let num = (((nation1.page*1) - 1) * nation_data1["page_size"]) + 1 ;
        let rows = "";

        for (let i = 0; i < data.length; i++) {
            let item = data[i];

            // append it
            let row = "<tr id='" + item.id + "' style='cursor:pointer;'>";
            row += "<td>" + (num + i) + "</td>";
            row += "<td class='d-none' name='bom_id'>" + item.id + "</td>";
            row += "<td name='bom_name'>" + item.bom_master.product_name + "</td>";  // 생산제품명
            row += "</tr>";
            rows += row;
        }

        spinner();

        nation1.nation_display(done);
        $('#process_tbody').html(rows);

        // click check
        if (process_id != null){
            $("#process_tbody #" + process_id).addClass('clicked');
        }

        $('#process_tbody > tr').on('click', function () {
            // table click highlight
            $(this).parent().find('tr').removeClass('clicked');
            $(this).addClass('clicked');

            rowcnt = 1;
            col_cnt = 5;
            clicked_fault_detail_table = []
            $('#field_cnt').val(col_cnt);

            process_id = $(this).attr("id");
            if (process_id !== select_before) {
                $("#progress_fault_detail_lookup_main-tbody").empty();
            }
            select_before = process_id

            product_name = $(this).find("[name=bom_name]").text();

            fault_table_load();
        });
    }

    function calc_rate(num1, num2){
        if (num1 == 0 || num2 == 0) return "0.00%"

        let rate = (num2 / num1 * 100).toFixed(2);
        if (isNaN(rate)) rate = "0.00%"
        else rate = String(rate) + "%";

        return rate
    }

    function fault_table_load(){
        api_gp("/process/sub_lookup/?process=" + process_id, "GET", {}, (data) => {

            subprocesses = data.length;
            let rows = "";

            for (let i = 0; i < data.length; i++){
                let item = data[i];


                let row = "";
                let remain = (item.faulty_amount ? item.faulty_amount : 0) - (item.fault_reason ? item.fault_reason.amount_sum : 0);
                let faulty_rate = calc_rate((item.complete_amount ? item.complete_amount : 0), (item.faulty_amount ? item.faulty_amount : 0));

                col_cnt = (item.fault_reason ? item.fault_reason.col_cnt : 5)

                if (item.faulty_amount == 0) continue;

                if (!rows) {
                    row += '<tr>'
                    row += '<td rowspan="10000" class="align-middle" id="process_product_name" style="z-index: 10">' + product_name + '</td>'
                    row += '</tr>'
                    row += '<tr class="r' + rowcnt + '">'
                    row += '<td class="d-none r' + rowcnt + '" name="fault_reason_id" rowspan="3">' + (item.fault_reason ? item.fault_reason.id : "") + '</td>'
                    row += '<td class="d-none r' + rowcnt + '" name="subprocess_id" rowspan="3">' + item.id + '</td>'
                    row += '<td class="d-none r' + rowcnt + '" name="remains" rowspan="3">' + (item.faulty_amount ? item.faulty_amount : 0) + '</td>'
                    row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="subprocess_name">' + item.type.name + '</td>'
                    row += '<td class="align-middle" rowspan="3">' + (item.complete_amount ? item.complete_amount.toLocaleString() : 0) + '</td>'
                    row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="subprocess_faulty_amount">' + (item.faulty_amount ? item.faulty_amount.toLocaleString() : 0) + '</td>'
                    row += '<td class="align-middle" rowspan="3">' + faulty_rate + '</td>'
                    row += '<td class="align-middle">대분류</td>'

                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '" name="row_R1" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R1_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R2" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R2_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R3" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R3_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R4" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R4_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R5" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R5_upper" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R6" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R6_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R7" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R7_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R8" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R8_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R9" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R9_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R10" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R10_upper" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R11" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R11_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R12" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R12_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R13" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R13_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R14" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R14_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R15" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R15_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="sum_row">' + (item.fault_reason ? (item.fault_reason.amount_sum ? item.fault_reason.amount_sum.toLocaleString() : 0) : 0) + '</td>'

                    if (!remain) {
                        row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="remain_row">' + remain.toLocaleString() + '</td>'
                    } else {
                        row += '<td class="align-middle r' + rowcnt + '" style="color: red" rowspan="3" name="remain_row">' + remain.toLocaleString() + '</td>'
                    }
                    row += '</tr>'
                    row += '<tr class="r' + rowcnt + '">'
                    row += '<td class="align-middle">소분류</td>'

                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '" name="row_R1" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R1_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R2" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R2_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R3" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R3_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R4" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R4_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R5" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R5_lower" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R6" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R6_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R7" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R7_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R8" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R8_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R9" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R9_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R10" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R10_lower" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R11" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R11_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R12" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R12_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R13" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R13_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R14" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R14_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R15" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R15_lower" disabled></select>' +
                        '</td>'

                    row += '</tr>'
                    row += '<tr class="r' + rowcnt + '">'
                    row += '<td class="align-middle">불량수량</td>'

                    row += '<td name="row_R1" disabled><input disabled name="R1_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R01_amount.toLocaleString() ? item.fault_reason.R01_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R2" disabled><input disabled name="R2_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R02_amount.toLocaleString() ? item.fault_reason.R02_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R3" disabled><input disabled name="R3_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R03_amount.toLocaleString() ? item.fault_reason.R03_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R4" disabled><input disabled name="R4_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R04_amount.toLocaleString() ? item.fault_reason.R04_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R5" disabled><input disabled name="R5_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R05_amount.toLocaleString() ? item.fault_reason.R05_amount.toLocaleString() : 0) : 0) + '"></td>'

                    row += '<td class="d-none" name="row_R6" disabled><input disabled name="R6_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R06_amount.toLocaleString() ? item.fault_reason.R06_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R7" disabled><input disabled name="R7_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R07_amount.toLocaleString() ? item.fault_reason.R07_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R8" disabled><input disabled name="R8_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R08_amount.toLocaleString() ? item.fault_reason.R08_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R9" disabled><input disabled name="R9_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R09_amount.toLocaleString() ? item.fault_reason.R09_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R10" disabled><input disabled name="R10_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R10_amount.toLocaleString() ? item.fault_reason.R10_amount.toLocaleString() : 0) : 0) + '"></td>'

                    row += '<td class="d-none" name="row_R11" disabled><input disabled name="R11_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R11_amount.toLocaleString() ? item.fault_reason.R11_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R12" disabled><input disabled name="R12_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R12_amount.toLocaleString() ? item.fault_reason.R12_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R13" disabled><input disabled name="R13_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R13_amount.toLocaleString() ? item.fault_reason.R13_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R14" disabled><input disabled name="R14_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R14_amount.toLocaleString() ? item.fault_reason.R14_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R15" disabled><input disabled name="R15_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R15_amount.toLocaleString() ? item.fault_reason.R15_amount.toLocaleString() : 0) : 0) + '"></td>'

                    row += '</tr>'

                    rows += row
                    rowcnt = rowcnt + 1
                }else {
                    row += '<tr class="r' + rowcnt + '">'
                    row += '<td class="d-none r' + rowcnt + '" name="fault_reason_id" rowspan="3">' + (item.fault_reason ? item.fault_reason.id : "") + '</td>'
                    row += '<td class="d-none r' + rowcnt + '" name="subprocess_id" rowspan="3">' + item.id + '</td>'
                    row += '<td class="d-none r' + rowcnt + '" name="remains" rowspan="3">' + (item.faulty_amount ? item.faulty_amount : 0) + '</td>'
                    row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="subprocess_name">' + item.type.name + '</td>'
                    row += '<td class="align-middle" rowspan="3">' + (item.complete_amount ? item.complete_amount.toLocaleString() : 0) + '</td>'
                    row += '<td class="align-middle" rowspan="3">' + (item.faulty_amount ? item.faulty_amount.toLocaleString() : 0) + '</td>'
                    row += '<td class="align-middle" rowspan="3">' + faulty_rate + '</td>'
                    row += '<td class="align-middle">대분류</td>'

                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '" name="row_R1" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R1_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R2" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R2_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R3" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R3_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R4" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R4_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R5" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R5_upper" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R6" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R6_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R7" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R7_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R8" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R8_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R9" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R9_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R10" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R10_upper" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R11" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R11_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R12" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R12_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R13" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R13_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R14" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R14_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R15" disabled>' +
                        '<select class="form-control upper-dropdown-product" name="R15_upper" disabled></select>' +
                        '</td>'
                    row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="sum_row">' + (item.fault_reason ? (item.fault_reason.amount_sum ? item.fault_reason.amount_sum.toLocaleString() : 0) : 0) + '</td>'

                    if (!remain) {
                        row += '<td class="align-middle r' + rowcnt + '" rowspan="3" name="remain_row">' + remain.toLocaleString() + '</td>'
                    } else {
                        row += '<td class="align-middle r' + rowcnt + '" style="color: red" rowspan="3" name="remain_row">' + remain.toLocaleString() + '</td>'
                    }
                    row += '</tr>'
                    row += '<tr class="r' + rowcnt + '">'
                    row += '<td class="align-middle">소분류</td>'

                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '" name="row_R1" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R1_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R2" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R2_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R3" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R3_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R4" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R4_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle r' + rowcnt + '"  name="row_R5" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R5_lower" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R6" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R6_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R7" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R7_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R8" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R8_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R9" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R9_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R10" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R10_lower" disabled></select>' +
                        '</td>'

                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R11" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R11_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R12" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R12_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R13" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R13_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R14" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R14_lower" disabled></select>' +
                        '</td>'
                    row += '<td class="content-input-group-input align-middle d-none r' + rowcnt + '"  name="row_R15" disabled>' +
                        '<select class="form-control lower-dropdown-product" name="R15_lower" disabled></select>' +
                        '</td>'

                    row += '</tr>'
                    row += '<tr class="r' + rowcnt + '">'
                    row += '<td class="align-middle">불량수량</td>'

                    row += '<td name="row_R1" disabled><input disabled name="R1_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R01_amount ? item.fault_reason.R01_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R2" disabled><input disabled name="R2_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R02_amount ? item.fault_reason.R02_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R3" disabled><input disabled name="R3_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R03_amount ? item.fault_reason.R03_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R4" disabled><input disabled name="R4_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R04_amount ? item.fault_reason.R04_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td name="row_R5" disabled><input disabled name="R5_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R05_amount ? item.fault_reason.R05_amount.toLocaleString() : 0) : 0) + '"></td>'

                    row += '<td class="d-none" name="row_R6" disabled><input disabled name="R6_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R06_amount ? item.fault_reason.R06_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R7" disabled><input disabled name="R7_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R07_amount ? item.fault_reason.R07_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R8" disabled><input disabled name="R8_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R08_amount ? item.fault_reason.R08_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R9" disabled><input disabled name="R9_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R09_amount ? item.fault_reason.R09_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R10" disabled><input disabled name="R10_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R10_amount ? item.fault_reason.R10_amount.toLocaleString() : 0) : 0) + '"></td>'

                    row += '<td class="d-none" name="row_R11" disabled><input disabled name="R11_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R11_amount ? item.fault_reason.R11_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R12" disabled><input disabled name="R12_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R12_amount ? item.fault_reason.R12_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R13" disabled><input disabled name="R13_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R13_amount ? item.fault_reason.R13_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R14" disabled><input disabled name="R14_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R14_amount ? item.fault_reason.R14_amount.toLocaleString() : 0) : 0) + '"></td>'
                    row += '<td class="d-none" name="row_R15" disabled><input disabled name="R15_amount" class="form-control text-center amount r' + rowcnt + '"' +
                        'onkeyup="_chkNumber(this, 2)" onchange="in_amount_calc(' + rowcnt + ')" value="' + (item.fault_reason ? (item.fault_reason.R15_amount ? item.fault_reason.R15_amount.toLocaleString() : 0) : 0) + '"></td>'

                    rows += row
                    rowcnt = rowcnt + 1
                }
            }
            spinner();
            $('#progress_lookup_main-tbody').html(rows)

            api_gp("/codes_select/?group=125&enable=true", "GET", {}, (ddata) => {
                make_dropdown(ddata, ".upper-dropdown-product", data);
            });

            api_gp("/codes_select/?group=126&enable=true", "GET", {}, (ddata) => {
                make_dropdown(ddata, ".lower-dropdown-product", data);
            });

            define_col()
            $("#field_cnt").val(col_cnt)
            $('#progress_lookup_main-tbody > tr').on('click', function () {
                // table click highlight
                let clicked_row = $(this).attr("class")
                $(this).parent().find('tr').removeClass('clicked');
                $("." + clicked_row).addClass('clicked')
                if(clicked_row.includes("clicked")) return;
                if (!clicked_fault_detail_table.includes(clicked_row)) {
                    draw_fault_detail_table(clicked_row)
                    clicked_fault_detail_table.push(clicked_row)
                }
                else {
                    $(this).find("tr").empty()
                    clicked_fault_detail_table = clicked_fault_detail_table.filter(clicked_data => clicked_data !== clicked_row)
                }
                clicked_fault_detail_table.push(clicked_row)
            });
        });
    }

    function draw_fault_detail_table(clicked_row){
        let rows = "";

        let row = '<div class="card content-table col-12 m-2" style="height: auto; overflow-y: hidden;  overflow-x: hidden;">'
        row += '<table id="progress_lookup_data-table" class="table table-sm text-center">'
        row += '<thead>'
        row += '<tr>'
        row += '<th style="width: 5%">제품명</th>'
        row += '<th style="width: 5%; z-index: 10">세부공정명</th>'
        row += '<th style="width: 5%">구분</th>'
        row += '<th id="progress_lookup_colspan" colspan="' + col_cnt + '"> 불량사유 </th>'
        row += '<th style="width: 5%">합계</th>';
        row += '</tr>'
        row += '</thead>'
        row += '<tbody>'
        row += '<tr>'
        row += '<td rowspan="4" class="align-middle">' + $("#process_product_name").html() + '</td>'
        row += '<td rowspan="4" class="align-middle">' + $("." + clicked_row + "[name=subprocess_name]").html() + '</td>'
        row += '<td class="align-middle">대분류</td>'
        for (let i = 1; i <= col_cnt; i++)
            row += '<td class="align-middle">' +
                ($("." + clicked_row + " > [name=R" + i + "_upper] option:selected").text() ? $("." + clicked_row + " > [name=R" + i + "_upper] option:selected").text() : '') +
                '</td>'
        row += '<td rowspan="3" class="align-middle">' +
            ($("." + clicked_row + "[name=sum_row]").html() ? $("." + clicked_row + "[name=sum_row]").html() : 0) +
            '</td>'
        row += '</tr>'
        row += '<tr>'
        row += '<td class="align-middle">소분류</td>'
        for (let i = 1; i <= col_cnt; i++)
            row += '<td class="align-middle">' +
                ($("." + clicked_row + " > [name=R" + i + "_lower] option:selected").text() ? $("." + clicked_row + " > [name=R" + i + "_lower] option:selected").text() : "") +
                '</td>'
        row += '</tr>'
        row += '<tr>'
        row += '<td class="align-middle">불량수량</td>'
        for (let i = 1; i <= col_cnt; i++)
            row += '<td class="align-middle">' +
                ($("." + clicked_row + "[name=R" + i + "_amount]").val() ? $("." + clicked_row + "[name=R" + i + "_amount]").val() : 0) +
                '</td>'
        row += '</tr>'
        row += '<tr>'
        row += '<td class="align-middle">불량률</td>'
        for (let i = 1; i <= col_cnt; i++)
            row += '<td class="align-middle">' +
                calc_rate(($("." + clicked_row + "[name=remains]").html() ? $("." + clicked_row + "[name=remains]").html() : 0), ($("." + clicked_row + "[name=R" + i + "_amount]").val() ? $("." + clicked_row + "[name=R" + i + "_amount]").val() : 0)) +
                '</td>'
        row += '<td class="align-middle">' +
            calc_rate(($("." + clicked_row + "[name=remains]").html() ? $("." + clicked_row + "[name=remains]").html() : 0), ($("." + clicked_row + "[name=sum_row]").html() ? $("." + clicked_row + "[name=sum_row]").html() : 0)) +
            '</td>'
        row += '</tr>'
        row += '</tbody>'
        row += '</table>'
        row += '</div>'

        rows = row;

        $('#progress_fault_detail_lookup_main-tbody').append(rows)
    }

    function trigger_dropdown(trig_data){
        for (let row = 1; row < rowcnt; row++){
            let item = trig_data[row-1]
            $('.r' + row + ' > [name=R1_upper]').val((item.fault_reason ? (item.fault_reason.R01_upper ? item.fault_reason.R01_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R2_upper]').val((item.fault_reason ? (item.fault_reason.R02_upper ? item.fault_reason.R02_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R3_upper]').val((item.fault_reason ? (item.fault_reason.R03_upper ? item.fault_reason.R03_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R4_upper]').val((item.fault_reason ? (item.fault_reason.R04_upper ? item.fault_reason.R04_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R5_upper]').val((item.fault_reason ? (item.fault_reason.R05_upper ? item.fault_reason.R05_upper.id : '') : '')).trigger('change')

            $('.r' + row + ' > [name=R6_upper]').val((item.fault_reason ? (item.fault_reason.R06_upper ? item.fault_reason.R06_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R7_upper]').val((item.fault_reason ? (item.fault_reason.R07_upper ? item.fault_reason.R07_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R8_upper]').val((item.fault_reason ? (item.fault_reason.R08_upper ? item.fault_reason.R08_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R9_upper]').val((item.fault_reason ? (item.fault_reason.R09_upper ? item.fault_reason.R09_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R10_upper]').val((item.fault_reason ? (item.fault_reason.R10_upper ? item.fault_reason.R10_upper.id : '') : '')).trigger('change')

            $('.r' + row + ' > [name=R11_upper]').val((item.fault_reason ? (item.fault_reason.R11_upper ? item.fault_reason.R11_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R12_upper]').val((item.fault_reason ? (item.fault_reason.R12_upper ? item.fault_reason.R12_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R13_upper]').val((item.fault_reason ? (item.fault_reason.R13_upper ? item.fault_reason.R13_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R14_upper]').val((item.fault_reason ? (item.fault_reason.R14_upper ? item.fault_reason.R14_upper.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R15_upper]').val((item.fault_reason ? (item.fault_reason.R15_upper ? item.fault_reason.R15_upper.id : '') : '')).trigger('change')


            $('.r' + row + ' > [name=R1_lower]').val((item.fault_reason ? (item.fault_reason.R01_lower ? item.fault_reason.R01_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R2_lower]').val((item.fault_reason ? (item.fault_reason.R02_lower ? item.fault_reason.R02_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R3_lower]').val((item.fault_reason ? (item.fault_reason.R03_lower ? item.fault_reason.R03_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R4_lower]').val((item.fault_reason ? (item.fault_reason.R04_lower ? item.fault_reason.R04_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R5_lower]').val((item.fault_reason ? (item.fault_reason.R05_lower ? item.fault_reason.R05_lower.id : '') : '')).trigger('change')

            $('.r' + row + ' > [name=R6_lower]').val((item.fault_reason ? (item.fault_reason.R06_lower ? item.fault_reason.R06_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R7_lower]').val((item.fault_reason ? (item.fault_reason.R07_lower ? item.fault_reason.R07_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R8_lower]').val((item.fault_reason ? (item.fault_reason.R08_lower ? item.fault_reason.R08_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R9_lower]').val((item.fault_reason ? (item.fault_reason.R09_lower ? item.fault_reason.R09_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R10_lower]').val((item.fault_reason ? (item.fault_reason.R10_lower ? item.fault_reason.R10_lower.id : '') : '')).trigger('change')

            $('.r' + row + ' > [name=R11_lower]').val((item.fault_reason ? (item.fault_reason.R11_lower ? item.fault_reason.R11_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R12_lower]').val((item.fault_reason ? (item.fault_reason.R12_lower ? item.fault_reason.R12_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R13_lower]').val((item.fault_reason ? (item.fault_reason.R13_lower ? item.fault_reason.R13_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R14_lower]').val((item.fault_reason ? (item.fault_reason.R14_lower ? item.fault_reason.R14_lower.id : '') : '')).trigger('change')
            $('.r' + row + ' > [name=R15_lower]').val((item.fault_reason ? (item.fault_reason.R15_lower ? item.fault_reason.R15_lower.id : '') : '')).trigger('change')
        }
    }

    function define_col(){
        if (col_cnt >= 16) return;
        $('#progress_lookup_colspan').attr('colspan', col_cnt);

        for(var i=1; i<=col_cnt; i++) {
            for (var j=0; j<subprocesses*3; j++) {
                $('td[name=row_R' + (i) + ']').eq(j).removeClass('d-none');
            }
        }
        for(var i=col_cnt+1; i<=15; i++) {
            for (var j=0; j<subprocesses*3; j++) {
                $('td[name=row_R' + (i) + ']').eq(j).addClass('d-none');
            }
        }
    }

    function in_amount_calc(rowcnt) {
        var amounts = $('.r'+ rowcnt +'.amount').length;
        let remains = $('.r' + rowcnt +'[name=remains]').html()
		var amount = 0;

        for(var i=0; i<amounts; i++) {
            amount += parseFloat(($('.r'+ rowcnt +'.amount').eq(i).val() ? $('.r'+ rowcnt +'.amount').eq(i).val() : 0));
        }

        let sum = _numberWithCommas(
            parseFloat(String(amount).replace(/[\{\}\[\]\/?,;:|\)*~`!^\+_<>@\#$%&\\\=\(\'\"]/g, ''))
        );

        let remain = parseFloat(remains) - parseFloat(sum);

        sum = parseFloat(sum.replace(/[\{\}\[\]\/?,;:|\)*~`!^\+_<>@\#$%&\\\=\(\'\"]/g, '')).toFixed(12);

        $('.r' + rowcnt +'[name=sum_row]').html(parseFloat(sum).toLocaleString());
        $('.r' + rowcnt +'[name=remain_row]').html(parseFloat(remain).toLocaleString());

        if ($('.r' + rowcnt +'[name=remain_row]').html() !== '0') {
            $('.r' + rowcnt +'[name=remain_row]').css('color', 'red')
        }
        else if (($('.r' + rowcnt +'[name=remain_row]').html() === '0')) {
            $('.r' + rowcnt +'[name=remain_row]').css('color', 'black')
        }
    }

    function spinner() {
        $("#spinner").hide();
    }

</script>
</body>
</html>