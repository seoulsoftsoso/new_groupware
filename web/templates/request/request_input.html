<!DOCTYPE html>
<html>
<header>{% include "header.html" %}</header>
<!-- 의뢰서작성 -->

<body style="overflow: hidden;">

{% load static %}
{{ re.media }}
<!-- 의뢰서폼 -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <!-- 본문 -->
        {#        <form id="main_retoLocaleString()uest" class="content-content w-100">#}
        <div class="content-content w-100">
            <!-- TODO: submit 시 validation 구현 -->
            {% csrf_token %}
            <div class="row no-gutters w-100 mb-2">
                <div class="col-1 content-title">거래처정보</div>
                <div class="col-11">
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>거래처코드<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                {{ re.cu_code_sch }}
                                {#                                <select#}
                                {#                                        class="form-control customer_code"#}
                                {#                                        id="customer_code"#}
                                {#                                ></select>#}
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>거래처명<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                {{ re.cu_name_sch }}
                                {#                                <select#}
                                {#                                        class="form-control customer_name"#}
                                {#                                        id="customer_name"#}
                                {#                                ></select>#}
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>사업자번호<strong>*</strong></label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="licensee_number"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>대표자명</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="customer_owner_name"/>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>업태</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="business_conditions"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>종목</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="business_event"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>우편번호</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="office_post_code"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>주소</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="office_address"/>
                            </div>
                        </div>
                    </div>
                    <div class="row no-gutters">
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>회사전화번호</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="office_phone"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>팩스번호</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="office_fax_number"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>담당자</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="person_in_charge"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>직급</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="charge_level"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>담당자 연락처</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="charge_phone"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header">
                                <label>E-mail</label>
                            </div>
                            <div class="content-input-group-input">
                                <input class="form-control" id="email"/>
                            </div>
                        </div>
                        <div class="content-input-group col-3">
                            <div class="content-input-group-header col-2">
                                <label>비고</label>
                            </div>
                            <div class="content-input-group-input col-10">
                                <input class="form-control" id="customer_note"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="card m-2">
    <div class="row no-gutters card-body p-2">
        <div class="row no-gutters w-100 mb-2">
            <div class="col-1 content-title">의뢰항목</div>
            <div class="col-11">
                <div class="row no-gutters">
                    <div class="content-input-group col-3">
                        <div class="content-input-group-header">
                            <label>품번<strong>*</strong></label>
                        </div>
                        <div class="content-input-group-input">
                            {{ re.it_code_sch }}
                            {#                            <select#}
                            {#                                    class="form-control item_code"#}
                            {#                                    id="item_code"#}
                            {#                            ></select>#}
                        </div>
                    </div>
                    <div class="content-input-group col-3">
                        <div class="content-input-group-header">
                            <label>품명<strong>*</strong></label>
                        </div>
                        <div class="content-input-group-input">
                            {{ re.it_name_sch }}
                            {#                            <select#}
                            {#                                    class="form-control item_name"#}
                            {#                                    id="item_name"#}
                            {#                            ></select>#}
                        </div>
                    </div>
                    <div class="content-input-group col-3">
                        <div class="content-input-group-header">
                            <label>품명상세</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="item_detail"/>
                        </div>
                    </div>
                    <div class="content-input-group col-3">
                        <div class="content-input-group-header">
                            <label>단위</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="item_unit"/>
                        </div>
                    </div>
                </div>
                <div class="row no-gutters">
                    <div class="content-input-group col-3">
                        <div class="content-input-group-header">
                            <label>수량<strong>*</strong></label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="item_quantity" onkeyup="_chkNumber(this, 3)"/>
                        </div>
                    </div>
                    <div class="content-input-group col-3">
                        <div class="content-input-group-header">
                            <label>첨부파일</label>
                        </div>
                        <div class="content-input-group-input d-flex">
                            <label id="file_name" class="form-control w-100 h-100"
                                   style="font-size:12px;text-overflow: ellipsis; overflow:hidden;white-space: nowrap"> </label>
                            <label for="item_file" class="btn-sm btn-light text-center h-100"
                                   style="font-size:12px; color: #002060; font-weight: bold; border-radius:0px;
                                width:40%;height:100%; border-top:solid 1px #d9d9d9; border-bottom: solid 1px #d9d9d9 "
                            >첨부</label>
                            <input class="form-control w-100 h-100 d-none" type="file" id="item_file"/>

                        </div>
                    </div>
                    <div class="content-input-group col-6">
                        <div class="content-input-group-header">
                            <label>비고</label>
                        </div>
                        <div class="content-input-group-input">
                            <input class="form-control" id="item_remark"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Button -->
        <div class="row no-gutters w-100 mt-3 justify-content-end">
            <div class="col-1 px-0 mr-2">
                <button
                        class="btn button-custom2 w-100"
                        type="button"
                        onclick="refresh_data();"
                >
                    초기화

                </button>
            </div>
            <div class="col-1 px-0 mr-2">
                <button
                        class="btn button-custom2 w-100"
                        type="button"
                        onclick="add();"
                >
                    항목추가
                </button>
            </div>
            <div class="col-1 px-0 mr-2">
                <button
                        class="btn button-custom2 w-100"
                        type="button"
                        onclick="modify();"
                >
                    항목수정
                </button>
            </div>
            <div class="col-1 px-0">
                <button
                        class="btn button-custom2 w-100"
                        type="button"
                        onclick="remove();"
                >
                    항목삭제
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 의뢰 항목 테이블 -->
<div class="card m-2">
    <div class="row no-gutters card-body p-2">

        <!-- 본문 -->
        <div class="content-table col-12" style="overflow-y: scroll; height:400px;">
            <table
                    id="detail_table"
                    class="table table-sm text-center"
            >
                <thead>
                <tr>
                    <th>순번</th>
                    <th>품번</th>
                    <th>품명</th>
                    <th>품명상세</th>
                    <th>단위</th>
                    <th>수량</th>
                    <th>첨부파일</th>
                    <th>비고</th>
                </tr>
                </thead>
                <tbody id="detail_tbody"></tbody>
            </table>
        </div>

    </div>
</div>
<div class="card m-2">

    {# NOTE #}
    <div class="card-body col-12 p-0">
        <div class="row no-gutters card-body p-2">
            <div class="content-title col-1 align-self-stretch">NOTE</div>
            {#            <form id="main_form" class="col-11 w-100">#}
            <div class="col-11 w-100">
                <div class="row no-gutters">
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>납기희망일</label>
                        </div>
                        <div
                                class="content-input-group-input"
                        >
                            <input id="due_date" class="form-control datepicker"/>
                        </div>
                    </div>
                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>결제조건</label>
                        </div>
                        <div
                                class="content-input-group-input"
                        >
                            <input id="pay_option" class="form-control"/>
                        </div>
                    </div>

                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>품질보증기한</label>
                        </div>
                        <div
                                class="content-input-group-input"
                        >
                            <input id="guarantee_date" class="form-control datepicker"/>

                        </div>
                    </div>
                </div>
                <div class="row no-gutters">

                    <div class="content-input-group col-4 px-0">
                        <div class="content-input-group-header">
                            <label>납품장소</label>
                        </div>
                        <div
                                class="content-input-group-input"
                        >
                            <input id="deliver_place" class="form-control"/>
                        </div>
                    </div>
                    <div class="content-input-group col-8 px-0">
                        <div class="content-input-group-header">
                            <label>비고</label>
                        </div>
                        <div
                                class="content-input-group-input"
                        >
                            <input id="note" class="form-control"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Button -->
        <div class="row no-gutters w-100 mt-1 pb-2 pr-1 justify-content-end">
            <div class="col-1 px-0 mr-1">
                <button class="btn button-custom2 w-100"
                        type="button"
                        onclick="submit();">
                    의뢰서등록
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script src="{% static 'js/api_codemaster.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_customer.js' %}" type="text/javascript"></script>
<script src="{% static 'js/api_request.js' %}" type="text/javascript"></script>

<script>
    // hjlim : 추후 View 별 화면높이 조절에 사용예정
    {% comment %}let msg = {tabID: tabID, cmd: "150"};
    msg= tabID + "," + "150";
    localStorage.setItem("tabID", msg);{% endcomment %}

    let list_num = 1;
    let selected_tr = null;

    $(".datepicker").datepicker({
        format: "yyyy-mm-dd",
        minViewMode: 0,
        maxViewMode: 2,
        autoclose: true,
        language: "ko",
    });
    $(".datepicker").datepicker("setDate", "today");

    <!-- File Upload -->
    let dict_files = {};
    let item_file = document.querySelector('#item_file');

    item_file.onchange = function () {
        // file_name
        let fileSelector = document.getElementById('item_file');
        if (!fileCheck(fileSelector)) {
            return;
        }
        let file = fileSelector.files[0];
        if (file === undefined) file = '';
        if (file != '') {
            $("#file_name").text(file.name);
        }
    };

    function isNumber(value) {
        return typeof value === 'number' && isFinite(value);
    }

    function check_unexpected_value(param) {
        if (param === undefined || param === '' || param === 'null' || param === 'undefined') {
            param = null;
        }

        return param;
    }

    $(function () {
        refresh();
    });


    function refresh() {
        get_note_info();
    }


    function reset_customer_info() {
        let option1 = new Option('', '', true, true);
        $('#id_cu_code_sch').append(option1).trigger('change');

        let option2 = new Option('', '', true, true);
        $('#id_cu_name_sch').append(option2).trigger('change');

        $("#licensee_number").val("");  // 사업자번호
        $("#customer_owner_name").val("");  // 대표자명
        $("#business_conditions").val("");  // 업태
        $("#business_event").val("");  // 종목
        $("#office_post_code").val("");  //  우편번호
        $("#office_address").val("");  // 주소
        $("#office_phone").val("");  // 회사전화번호
        $("#office_fax_number").val("");  // 팩스번호
        $("#person_in_charge").val("");  // 담당자
        $("#charge_level").val("");  // 직급
        $("#charge_phone").val("");  // 담당자 연락처
        $("#email").val("");  // 이메일
        $("#customer_note").val("");  // 비고
    }


    function reset_item_info() {
        let option1 = new Option('', '', true, true);
        $('#id_it_code_sch').append(option1).trigger('change');

        let option2 = new Option('', '', true, true);
        $('#id_it_name_sch').append(option2).trigger('change');

        $("#item_detail").val("");  // 품명상세
        $("#item_unit").val("");  // 단위
        $("#item_quantity").val("");  // 수량

        $("#item_file").val("");  // 파일선택
        $('#file_name').text("");
        $("#item_remark").val("");  // 비고
    }


    function get_note_info() {
        api_gp('/request/request_read/?last=true&', 'GET', {}, (done) => {
            //console.table(done.results[0]);
            let item = done.results[0];

            if (item) {
                $("#pay_option").val(item.pay_option);  // 결제조건
                $("#due_date").datepicker("setDate", "today");  // 납기일
                $("#guarantee_date").val(item.guarantee_date);  // 품질보증기한
                $("#deliver_place").val(item.deliver_place);  // 남품장소
                $("#note").val(item.note);  // 비고
            }
        });
    }


    function reset_all_data() {
        reset_customer_info();
        reset_item_info();
        $('#detail_tbody').html("");

        list_num = 1;
        selected_tr = null;
        dict_files = {};
    }


    function refresh_data() {

        // Todo hjlim : 거래처 로그인시 별개 처리
        reset_all_data();
    }

    // ac 클릭시 값 셋팅

    $('#id_cu_code_sch').on('select2:select', function (e) { // 거래처 코드를 선택했을때 작동을 함
        let select2_data = e.params.data;

        let cu_id_sch = select2_data.id;

        // 여기서 id 가지고 read 조회 해본다음에, 거기서 값 가져다가...
        let query = "?cu_id_sch=" + cu_id_sch;

        loading_start();
        api_gp("/basic_information/customers_read/" + query, "GET", {}, (done) => {
            loading_finish();

            let data = done.results;
            let item = data[0];

            let id = item.id;
            let name = item.name;

            let option1 = new Option(name, id, true, true);
            $('#id_cu_name_sch').append(option1).trigger('change');

            let licensee_number = (item.licensee_number ? item.licensee_number : '')// 사업자번호
            $("#licensee_number").val(licensee_number).trigger('change');

            let owner_name = (item.owner_name ? item.owner_name : '');  // 대표자명
            $("#customer_owner_name").val(owner_name).trigger('change');

            let business_conditions = (item.business_conditions ? item.business_conditions : "");  // 업태
            $("#business_conditions").val(business_conditions).trigger('change');

            let business_event = (item.business_event ? item.business_event : "");  // 종목
            $("#business_event").val(business_event).trigger('change');

            let postal_code = (item.postal_code ? item.postal_code : "");  //  우편번호
            $("#office_post_code").val(postal_code).trigger('change');

            let address = (item.address ? item.address : "");  // 주소
            $("#office_address").val(address).trigger('change');

            let office_phone = (item.office_phone ? item.office_phone : "");  // 회사전화번호
            $("#office_phone").val(office_phone).trigger('change');

            let office_fax = (item.office_fax ? item.office_fax : "");  // 팩스번호
            $("#office_fax_number").val(office_fax).trigger('change');

            let charge_name = (item.charge_name ? item.charge_name : "");  // 담당자
            $("#person_in_charge").val(charge_name).trigger('change');

            let charge_level = (item.charge_level ? item.charge_level : "");  // 직급
            $("#charge_level").val(charge_level).trigger('change');

            let charge_phone = (item.charge_phone ? item.charge_phone : "");  // 담당자 연락처
            $("#charge_phone").val(charge_phone).trigger('change');

            let email = (item.email ? item.email : "");  // 이메일
            $("#email").val(email).trigger('change');

            let etc = (item.etc ? item.etc : "");  // 비고
            $("#customer_note").val(etc).trigger('change');
        });
    });

    $('#id_cu_name_sch').on('select2:select', function (e) { // 거래처명 선택시
        let select2_data = e.params.data;

        let cu_id_sch = select2_data.id;

        let query = "?cu_id_sch=" + cu_id_sch;

        loading_start();
        api_gp("/basic_information/customers_read/" + query, "GET", {}, (done) => {
            loading_finish();

            let data = done.results;
            let item = data[0];

            let id = item.id;
            let code = item.code;

            let option1 = new Option(code, id, true, true);
            $('#id_cu_code_sch').append(option1).trigger('change');

            let licensee_number = (item.licensee_number ? item.licensee_number : '')// 사업자번호
            $("#licensee_number").val(licensee_number).trigger('change');

            let owner_name = (item.owner_name ? item.owner_name : '');  // 대표자명
            $("#customer_owner_name").val(owner_name).trigger('change');

            let business_conditions = (item.business_conditions ? item.business_conditions : "");  // 업태
            $("#business_conditions").val(business_conditions).trigger('change');

            let business_event = (item.business_event ? item.business_event : "");  // 종목
            $("#business_event").val(business_event).trigger('change');

            let postal_code = (item.postal_code ? item.postal_code : "");  //  우편번호
            $("#office_post_code").val(postal_code).trigger('change');

            let address = (item.address ? item.address : "");  // 주소
            $("#office_address").val(address).trigger('change');

            let office_phone = (item.office_phone ? item.office_phone : "");  // 회사전화번호
            $("#office_phone").val(office_phone).trigger('change');

            let office_fax = (item.office_fax ? item.office_fax : "");  // 팩스번호
            $("#office_fax_number").val(office_fax).trigger('change');

            let charge_name = (item.charge_name ? item.charge_name : "");  // 담당자
            $("#person_in_charge").val(charge_name).trigger('change');

            let charge_level = (item.charge_level ? item.charge_level : "");  // 직급
            $("#charge_level").val(charge_level).trigger('change');

            let charge_phone = (item.charge_phone ? item.charge_phone : "");  // 담당자 연락처
            $("#charge_phone").val(charge_phone).trigger('change');

            let email = (item.email ? item.email : "");  // 이메일
            $("#email").val(email).trigger('change');

            let etc = (item.etc ? item.etc : "");  // 비고
            $("#customer_note").val(etc).trigger('change');
        });
    });

    let click_it_code = null;
    let click_it_name = null;

    $('#id_it_code_sch').on('select2:select', function (e) {  // 품번 선택시
        let select2_data = e.params.data;
        let it_id_sch = select2_data.id
        let query = "?it_id_sch=" + it_id_sch;

        loading_start();
        api_gp("/basic_information/items_read/" + query, "GET", {}, (done) => {
            loading_finish();

            let data = done.results;
            let item = data[0];

            let id = item.id;
            let name = item.name;

            click_it_code = item.code;
            click_it_name = name;

            let option1 = new Option(name, id, true, true); // 품명
            $('#id_it_name_sch').append(option1).trigger('change');

            let detail = nullapply(item.detail);  // 품명상세
            $("#item_detail").val(detail).trigger('change');

            let unit = (item.unit_id ? item.unit_name : "");  // 단위
            $("#item_unit").val(unit).trigger('change');
        });
    });

    $('#id_it_name_sch').on('select2:select', function (e) {
        let select2_data = e.params.data;
        let it_id_sch = select2_data.id
        let query = "?it_id_sch=" + it_id_sch;

        loading_start();
        api_gp("/basic_information/items_read/" + query, "GET", {}, (done) => {
            loading_finish();

            let data = done.results;
            let item = data[0];

            let id = item.id;
            let name = item.name;
            let code = item.code;

            click_it_code = code;
            click_it_name = name;

            let option1 = new Option(code, id, true, true); // 품번
            $('#id_it_code_sch').append(option1).trigger('change');

            let detail = nullapply(item.detail);  // 품명상세
            $("#item_detail").val(detail).trigger('change');

            let unit = (item.unit_id ? item.unit_name : "");  // 단위
            $("#item_unit").val(unit).trigger('change');
        });
    });


    function add() {
        $('#detail_tbody').find("tr").removeClass("clicked");

        let item_id = $('#id_it_code_sch').val();
        if (item_id == null || item_id == '') {
            alert("품번을 먼저 선택해 주세요.");
            return;
        }


        let item_code = click_it_code;
        let item_name = click_it_name;

        let item_detail = $('#item_detail').val();
        let item_unit = $('#item_unit').val();

        let item_quantity = $('#item_quantity').val();
        item_quantity = parseFloat(item_quantity.replace(/,/g, ""));
        if (!isNumber(item_quantity)) {
            alert("수량을 선택해 주세요.");
            return;
        }
        if (item_quantity <= 0) {
            alert("수량이 0보다 작을 수 없습니다")
            return;
        }

        // 첨부파일
        let fileSelector = document.getElementById('item_file');
        let file_name = "";
        let file = fileSelector.files[0];
        if (file === undefined) file = '';

        {#console.log('item_id1', item_id);#}

        if (file !== '') {
            dict_files[item_id] = file;
            file_name = file.name;
            {#console.log('file1', file);#}
        }

        let item_remark = $('#item_remark').val();

        $('#detail_tbody').append("<tr>" +
            "<td>" + (list_num++) + "</td>" +
            "<td class='d-none' name='item_id'>" + item_id + "</td>" +  // 품번 ID
            "<td name='item_code'>" + item_code + "</td>" +  // 품번
            "<td name='item_name'>" + item_name + "</td>" +  // 품명
            "<td name='item_detail'>" + item_detail + "</td>" +  // 품명상세
            "<td name='item_unit'>" + item_unit + "</td>" +  // 품명단위
            "<td name='item_quantity'>" + item_quantity.toLocaleString() + "</td>" +  // 수량

            "<td name='item_file' style='max-width:100px; font-size:12px;text-overflow: ellipsis; overflow:hidden;white-space: nowrap'>" + file_name + "</td>" +  // 첨부파일
            "<td name='item_remarks'>" + item_remark + "</td>" +  // 비고
            "</tr>");

        // table click highlight
        $("#detail_tbody tr").off('click').on('click', function () {
            $(this).parent().find("tr").removeClass("clicked");
            $(this).addClass("clicked");
            selected_tr = $(this);

            let item_id = "";
            item_id = $(this).find("td[name=item_id]").text(); // 품번 ID

            let item_code = "";
            item_code = $(this).find("td[name=item_code]").text();

            let item_name = "";
            item_name = $(this).find("td[name=item_name]").text();

            let option1 = new Option(item_code, item_id, true, true); // 품번
            $('#id_it_code_sch').append(option1).trigger('change');

            let option2 = new Option(item_name, item_id, true, true); // 품명
            $('#id_it_name_sch').append(option2).trigger('change');


            let item_detail = "";
            item_detail = $(this).find("td[name=item_detail]").text();
            $("#item_detail").val(item_detail);  // 품명상세

            let item_unit = "";
            item_unit = $(this).find("td[name=item_unit]").text();
            $("#item_unit").val(item_unit);  // 품명단위

            let item_quantity = "";
            item_quantity = $(this).find("td[name=item_quantity]").text();
            $("#item_quantity").val(item_quantity);  // 수량

            $('#file_name').text('');
            $('#item_file').val('');

            let item_remark = "";
            item_remark = $(this).find("td[name=item_remark]").text();
            $("#item_remark").val(item_remark);  // 비고

        });

        reset_item_info();
    }


    function modify() {
        let item_id = $('#id_it_code_sch').val();
        if (item_id == null || item_id == '') {
            alert("품번을 선택해 주세요.");
            return;
        }

        let item_code = click_it_code;
        let item_name = click_it_name;

        let item_detail = $('#item_detail').val();
        let item_unit = $('#item_unit').val();

        let item_quantity = $('#item_quantity').val();
        item_quantity = parseFloat(item_quantity.replace(/,/g, ""));
        if (!isNumber(item_quantity)) {
            alert("수량을 선택해 주세요.");
            return;
        }
        if (item_quantity <= 0) {
            alert("수량이 0보다 작을 수 없습니다")
            return;
        }

        // 첨부파일
        let fileSelector = document.getElementById('item_file');
        let file_name = "";
        let file = fileSelector.files[0];
        if (file === undefined) file = '';

        {#console.log('item_id1', item_id);#}

        if (file !== '') {
            dict_files[item_id] = file;
            file_name = file.name;
            {#console.log('file1', file);#}
        }

        console.log('파일네임은');
        console.log(file_name);

        $('#file_name').text('');
        $('#item_file').val('');

        let item_remark = $('#item_remark').val();

        selected_tr.find("td[name=item_id]").text(item_id);  // 품번 ID
        selected_tr.find("td[name=item_code]").text(item_code);  // 품번
        selected_tr.find("td[name=item_name]").text(item_name);  // 품명
        selected_tr.find("td[name=item_detail]").text(item_detail);  // 품명상세
        selected_tr.find("td[name=item_unit]").text(item_unit);  // 품명단위
        selected_tr.find("td[name=item_quantity]").text(item_quantity.toLocaleString());  // 수량

        let old_file_name = selected_tr.find("td[name=item_file]").text();

        // 파일이 널이 아니고, 기존꺼랑 다를때만 변경
        if (file_name != '' && file_name != old_file_name) {
            //console.log('첨부파일 비어있지 않고, 기존에 첨부한 파일명하고도 다름.');
            selected_tr.find("td[name=item_file]").text(file_name);  // 파일
        }

        selected_tr.find("td[name=item_remark]").text(item_remark);  // 비고
        alert("성공적으로 수정하였습니다.");
    }


    function remove() {
        if (!selected_tr) {
            alert("삭제할 항목을 선택해 주세요.");
            return;
        }

        selected_tr.remove();

        let table = $('#detail_tbody tr');
        for (let i = 0; i < table.length; i++) {
            let tr = table.eq(i);
            tr.find("td:eq(0)").text(i + 1);  // 순번
        }

        list_num = table.length + 1;
        reset_item_info();

        selected_tr = null;

        // 첨부파일
        let item_id = $('#item_code option:selected').val();
        let fileSelector = document.getElementById('item_file');
        let file_name = "";
        let file = fileSelector.files[0];
        if (file === undefined) file = '';

        {#console.log('item_id1', item_id);#}

        if (file !== '') {
            dict_files[item_id] = null;
            {#console.log('file1', file);#}
        }

        $('#file_name').text('');
        $('#item_file').val('');

        alert("항목을 삭제하였습니다.");
    }


    function submit() {
        let length = $('#detail_tbody tr').length;
        if (length <= 0) {
            alert("항목을 먼저 추가해 주세요")
            return;
        }

        //let customer_code = $('#customer_code').val();
        let customer_code = $('#id_cu_code_sch').val();
        customer_code = check_unexpected_value(customer_code);

        if (customer_code == null) {
            alert("거래처 코드를 선택해 주세요.");
            return;
        }

        let licensee_number = $('#licensee_number').val();
        licensee_number = check_unexpected_value(licensee_number);

        if (licensee_number == null) {
            alert("사업자번호를 입력해 주세요.");
            return;
        }

        let form = get_form();
        if (form == null) {
            return;
        }

        let del = confirm("의뢰서를 등록하시겠습니까?");
        if (!del) return;

        // 여기에 의뢰서 등록... api_gp
        // 의뢰서 먼저 등록하고, 그거의 의뢰서 id 를 받아와서
        // 의뢰서 아이템을 아이템 개수 만큼 등록...

        api_request_post2(form, (done) => {
            // 방금 등록한 아이디를 가져다가 외래키로 해서
            let fk = done.id;
            form.append("fk", fk);

            // 리퀘아이템도 등록
            api_request_post3(form, (done) => {
                alert("성공적으로 등록하였습니다.");
                reset_all_data();
            });

        });

        {% comment %}
        api_request_post(form, () => {
            alert("성공적으로 등록하였습니다.");
            reset_all_data();
        });
        {% endcomment %}
    }


    function get_form() {
        let form = new FormData();

        //let customer_code = ($('#customer_code').val() ? $('#customer_code').val() : '');
        let customer_code = ($('#id_cu_code_sch').val() ? $('#id_cu_code_sch').val() : '');

        let licensee_number = ($('#licensee_number').val() ? $('#licensee_number').val() : '');
        let customer_owner_name = ($('#customer_owner_name').val() ? $('#customer_owner_name').val() : '');
        let business_conditions = ($('#business_conditions').val() ? $('#business_conditions').val() : '');
        let business_event = ($('#business_event').val() ? $('#business_event').val() : '');
        let office_post_code = ($('#office_post_code').val() ? $('#office_post_code').val() : '');
        let office_address = ($('#office_address').val() ? $('#office_address').val() : '');
        let office_phone = ($('#office_phone').val() ? $('#office_phone').val() : '');
        let office_fax_number = ($('#office_fax_number').val() ? $('#office_fax_number').val() : '');
        let person_in_charge = ($('#person_in_charge').val() ? $('#person_in_charge').val() : '');
        let charge_level = ($('#charge_level').val() ? $('#charge_level').val() : '');
        let charge_phone = ($('#charge_phone').val() ? $('#charge_phone').val() : '');
        let email = ($('#email').val() ? $('#email').val() : '');
        let customer_note = ($('#customer_note').val() ? $('#customer_note').val() : '');

        let due_date = ($('#due_date').val() ? $('#due_date').val() : '');
        let pay_option = ($('#pay_option').val() ? $('#pay_option').val() : '');
        let guarantee_date = ($('#guarantee_date').val() ? $('#guarantee_date').val() : '');
        let deliver_place = ($('#deliver_place').val() ? $('#deliver_place').val() : '');
        let note = ($('#note').val() ? $('#note').val() : '');

        form.append("code", customer_code);
        form.append("licensee_number", licensee_number);
        form.append("owner_name", customer_owner_name);
        form.append("business_conditions", business_conditions);
        form.append("business_event", business_event);
        form.append("postal_code", office_post_code);
        form.append("address", office_address);
        form.append("office_phone", office_phone);
        form.append("office_fax", office_fax_number);
        form.append("charge_name", person_in_charge);
        form.append("charge_level", charge_level);
        form.append("charge_phone", charge_phone);
        form.append("email", email);
        form.append("etc", customer_note);

        form.append("due_date", due_date);
        form.append("pay_option", pay_option);
        form.append("guarantee_date", guarantee_date);
        form.append("deliver_place", deliver_place);
        form.append("note", note);
        form.append("itemCnt", 0);

        form.append("csrfmiddlewaretoken", '{{ csrf_token }}')

        // Get Sub Data
        $('#detail_table > tbody > tr').each(function (index, tr) {
            {#console.log(index);#}
            tr = $(this);
            {#console.log(tr);#}

            let item_id = tr.find("td[name=item_id]").text();  // 품번 ID

            let item_detail = tr.find("td[name=item_detail]").text();  // 품명상세
            let item_unit = tr.find("td[name=item_unit]").text();  // 품명단위

            let item_quantity = tr.find("td[name=item_quantity]").text().replace(/,/g, "");  // 수량
            let item_remarks = tr.find("td[name=item_remarks]").text();

            form.append("item_id[" + index + "]", item_id);
            form.append("item_detail[" + index + "]", item_detail);
            form.append("item_unit[" + index + "]", item_unit);

            form.append("item_quantity[" + index + "]", item_quantity);
            form.append("item_remarks[" + index + "]", item_remarks);

            {#console.log('item_id2', item_id);#}
            let file = dict_files[item_id];
            if (file !== '') {
                form.append("file[" + index + "]", file);
                {#console.log('file2', file);#}
            }

            form.append("itemCnt", index + 1);

        });

        return form;
    }


    function api_request_post(allData, done_callback) {
        $.ajax({
            type: "POST",
            url: "/request_input/",
            headers: {
                "Authorization": get_token()
            },
            processData: false,
            contentType: false,
            data: allData
        })
            .done(function () {
                done_callback();
            })
            .fail(handle_error);
    }

    function api_request_post2(allData, done_callback) {
        $.ajax({
            type: "POST",
            url: "/request/request_create/",
            headers: {
                "Authorization": get_token()
            },
            processData: false,
            contentType: false,
            data: allData
        })
            .done(function (json) {
                done_callback(json);
            })
            .fail(handle_error);
    }

    function api_request_post3(allData, done_callback) {
        $.ajax({
            type: "POST",
            url: "/request/request_items_create/",
            headers: {
                "Authorization": get_token()
            },
            processData: false,
            contentType: false,
            data: allData
        })
            .done(function (json) {
                done_callback(json);
            })
            .fail(handle_error);
    }


    function get_fname(_url) {
        let url = decodeURI(_url);
        let arSplitUrl = url.split("/");    //   "/" 로 전체 url 을 나눈다
        let nArLength = arSplitUrl.length - 1;

        if (nArLength == undefined || nArLength == null || nArLength == -1) {
            return '';
        }

        let sFileName = arSplitUrl[nArLength];   // 나누어진 배열의 맨 끝이 파일명이다
        console.log('sFileName', sFileName);

        if (sFileName == 'undefined') {
            return '';
        }


        return sFileName;
    }


    function fileCheck(file) {
        // 사이즈체크
        var maxSize = 1 * 1024 * 1024 //1MB
        var fileSize = 0;

        console.log(file)
        fileSize = file.files[0].size;
        if (fileSize > maxSize) {
            alert("파일 사이즈는 1MB 이내로 등록 가능합니다.");
            return false;
        }
        return true;
    }

</script>